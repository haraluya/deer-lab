name: Deploy to Firebase

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
    
    - name: Build application
      env:
        NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
        NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
        NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
        NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
        NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
        NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
      run: |
        echo "üöÄ Starting build process..."
        
        # Ê™¢Êü•Áí∞Â¢ÉËÆäÊï∏
        echo "Checking environment variables..."
        if [ -z "$NEXT_PUBLIC_FIREBASE_API_KEY" ]; then
          echo "‚ùå NEXT_PUBLIC_FIREBASE_API_KEY is not set"
          exit 1
        fi
        echo "‚úÖ Environment variables are set"
        
        # Âü∑Ë°åÂª∫ÁΩÆ
        echo "üì¶ Running Next.js build..."
        npm run build
        
        # Ê™¢Êü•Âª∫ÁΩÆÁµêÊûú
        if [ ! -d "out" ]; then
          echo "‚ùå Build failed: out directory not found"
          exit 1
        fi
        
        # Âü∑Ë°åË∑ØÂæë‰øÆÊ≠£
        echo "üîß Running path fix script..."
        node scripts/fix-paths.js
        
        echo "‚úÖ Build process completed successfully"
    
    - name: Verify build output
      run: |
        echo "Checking out directory..."
        ls -la out/
        echo "Number of files in out directory:"
        find out -type f | wc -l
        echo "Checking for index.html..."
        if [ -f "out/index.html" ]; then
          echo "‚úÖ index.html exists"
          head -5 out/index.html
        else
          echo "‚ùå index.html not found"
          exit 1
        fi
    
    - name: Build Firebase Functions
      run: |
        if [ -d "functions" ]; then
          echo "Building Firebase Functions..."
          cd functions
          npm ci
          npm run build
          cd ..
        else
          echo "No functions directory found, skipping functions build"
        fi
    
    - name: Deploy to Firebase
      run: firebase deploy --token "${{ secrets.FIREBASE_TOKEN }}"
