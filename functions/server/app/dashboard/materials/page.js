(()=>{var e={};e.id=7020,e.ids=[7020],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},84770:e=>{"use strict";e.exports=require("crypto")},80665:e=>{"use strict";e.exports=require("dns")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},32694:e=>{"use strict";e.exports=require("http2")},98216:e=>{"use strict";e.exports=require("net")},19801:e=>{"use strict";e.exports=require("os")},55315:e=>{"use strict";e.exports=require("path")},35816:e=>{"use strict";e.exports=require("process")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},41401:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>i.a,__next_app__:()=>m,originalPathname:()=>u,pages:()=>d,routeModule:()=>h,tree:()=>o}),s(25203),s(22834),s(62510),s(35866);var r=s(23191),a=s(88716),l=s(37922),i=s.n(l),n=s(95231),c={};for(let e in n)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(c[e]=()=>n[e]);s.d(t,c);let o=["",{children:["dashboard",{children:["materials",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,25203)),"D:\\APP\\deer-lab\\src\\app\\dashboard\\materials\\page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(s.bind(s,22834)),"D:\\APP\\deer-lab\\src\\app\\dashboard\\layout.tsx"],metadata:{icon:[async e=>(await Promise.resolve().then(s.bind(s,73881))).default(e)],apple:[],openGraph:[],twitter:[],manifest:void 0}}]},{layout:[()=>Promise.resolve().then(s.bind(s,62510)),"D:\\APP\\deer-lab\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,35866,23)),"next/dist/client/components/not-found-error"],metadata:{icon:[async e=>(await Promise.resolve().then(s.bind(s,73881))).default(e)],apple:[],openGraph:[],twitter:[],manifest:void 0}}],d=["D:\\APP\\deer-lab\\src\\app\\dashboard\\materials\\page.tsx"],u="/dashboard/materials/page",m={require:s,loadChunk:()=>Promise.resolve()},h=new r.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/dashboard/materials/page",pathname:"/dashboard/materials",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:o}})},72942:(e,t,s)=>{Promise.resolve().then(s.bind(s,53256))},72257:(e,t,s)=>{"use strict";s.d(t,{Z:()=>r});let r=(0,s(62881).Z)("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]])},53256:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>E});var r=s(10326),a=s(17577),l=s(35047),i=s(76),n=s(78880),c=s(90445),o=s(31304),d=s(54791),u=s(13898),m=s(48705),h=s(28932),x=s(99102),p=s(72257),g=s(83855),b=s(88307),j=s(57671),f=s(94019),y=s(15919),N=s(12714),v=s(69508),k=s(50949),C=s(85999),w=s(41156),S=s(91664),P=s(10143),$=s(9280),z=s(41190),q=s(29752),Z=s(38443),A=s(25889),L=s(58580);function M(){let e=(0,l.useRouter)();(0,l.useSearchParams)();let[t,s]=(0,a.useState)([]),[M,E]=(0,a.useState)([]),[U,O]=(0,a.useState)(!0),[_,D]=(0,a.useState)(!1),[I,F]=(0,a.useState)(!1),[R,X]=(0,a.useState)(!1),[T,V]=(0,a.useState)(null),[W,J]=(0,a.useState)(new Set),[G,Q]=(0,a.useState)(""),[B,Y]=(0,a.useState)(""),[H,K]=(0,a.useState)(""),[ee,et]=(0,a.useState)(!1),[es,er]=(0,a.useState)(!1),[ea,el]=(0,a.useState)({}),[ei,en]=(0,a.useState)(!1),[ec,eo]=(0,a.useState)(!1),[ed,eu]=(0,a.useState)(!1),[em,eh]=(0,a.useState)(null),[ex,ep]=(0,a.useState)(!1),[eg,eb]=(0,a.useState)(!1),ej=(0,a.useCallback)(async()=>{let e=new Map;try{if(!c.db)throw Error("Firebase 未初始化");(await (0,i.getDocs)((0,i.collection)(c.db,"suppliers"))).forEach(t=>{e.set(t.id,t.data().name)})}catch(e){console.error("Failed to fetch suppliers for mapping:",e)}return e},[]),ef=(0,a.useCallback)(async e=>{O(!0);try{if(!c.db)throw Error("Firebase 未初始化");let t=(0,i.collection)(c.db,"materials"),r=(await (0,i.getDocs)(t)).docs.map(t=>{let s=t.data(),r=s.supplierRef,a=r?e.get(r.id)||"讀取失敗":"未指定";return{id:t.id,refPath:t.ref.path,code:s.code,name:s.name,category:s.category,subCategory:s.subCategory,supplierRef:s.supplierRef,supplierName:a,safetyStockLevel:s.safetyStockLevel||0,costPerUnit:s.costPerUnit||0,unit:s.unit,currentStock:s.currentStock||0,notes:s.notes}});r.sort((e,t)=>{let s=e.category||"",r=t.category||"";if(s!==r)return s.localeCompare(r,"zh-TW");let a=e.subCategory||"",l=t.subCategory||"";return a!==l?a.localeCompare(l,"zh-TW"):e.name.localeCompare(t.name,"zh-TW")}),s(r)}catch(e){console.error("Failed to fetch materials:",e),C.Am.error("讀取物料資料失敗。")}finally{O(!1)}},[]),ey=e=>(e.currentStock||0)<(e.safetyStockLevel||0),eN=(0,a.useCallback)(()=>{let e=new Map,s=new Map;t.forEach(t=>{t.category&&t.subCategory&&(e.has(t.category)||e.set(t.category,new Set),e.get(t.category).add(t.subCategory),s.has(t.subCategory)||s.set(t.subCategory,new Set),s.get(t.subCategory).add(t.category))});let r=t;if(G.trim()){let e=G.toLowerCase().trim();r=t.filter(t=>t.name.toLowerCase().includes(e)||t.code.toLowerCase().includes(e)||t.category?.toLowerCase().includes(e)||t.subCategory?.toLowerCase().includes(e)||t.supplierName.toLowerCase().includes(e))}let a=new Set,l=new Set;r.forEach(e=>{e.category&&a.add(e.category),e.subCategory&&l.add(e.subCategory)});let i=new Set,n=new Set;if(B&&H){let t=e.get(B),r=s.get(H);if(t?.has(H)&&r?.has(B))i.add(B),n.add(H);else{if(B){i.add(B);let t=e.get(B);t&&t.forEach(e=>{l.has(e)&&n.add(e)})}if(H){n.add(H);let e=s.get(H);e&&e.forEach(e=>{a.has(e)&&i.add(e)})}}}else if(B){i.add(B);let t=e.get(B);t&&t.forEach(e=>{l.has(e)&&n.add(e)})}else if(H){n.add(H);let e=s.get(H);e&&e.forEach(e=>{a.has(e)&&i.add(e)})}else i=a,n=l;return{categories:Array.from(i).sort(),subCategories:Array.from(n).sort()}},[t,G,B,H,ee]),ev=e=>{eh(e),ep(!0)},ek=e=>{V(e),D(!0)},eC=e=>{V(e),F(!0)},ew=async()=>{if(T)try{let e=(0,n.$C)(),t=(0,n.V1)(e,"deleteMaterial");await t({materialId:T.id}),C.Am.success(`物料 ${T.name} 已成功刪除。`);let s=await ej();await ef(s)}catch(e){console.error("Error deleting material:",e),C.Am.error("刪除物料時發生錯誤。")}finally{F(!1),V(null)}},eS=async()=>{if(0===W.size){C.Am.info("請至少選擇一個物料進行刪除。");return}try{let e=(0,n.$C)(),s=(0,n.V1)(e,"deleteMaterial"),r=t.filter(e=>W.has(e.id)),a=C.Am.loading(`正在刪除 ${r.length} 個物料...`);for(let e of r)await s({materialId:e.id});C.Am.success(`成功刪除 ${r.length} 個物料。`,{id:a}),J(new Set);let l=await ej();await ef(l)}catch(e){console.error("Error batch deleting materials:",e),C.Am.error("批量刪除物料時發生錯誤。")}finally{X(!1)}},eP=(0,a.useCallback)(()=>{let e=t;if(G.trim()){let t=G.toLowerCase().trim();console.log("搜尋條件:",t),e=e.filter(e=>{let s=e.name.toLowerCase().includes(t),r=e.code.toLowerCase().includes(t),a=e.category?.toLowerCase().includes(t),l=e.subCategory?.toLowerCase().includes(t),i=e.supplierName.toLowerCase().includes(t),n=s||r||a||l||i;return n&&console.log("找到匹配:",e.name,{nameMatch:s,codeMatch:r,categoryMatch:a,subCategoryMatch:l,supplierMatch:i}),n})}B&&(e=e.filter(e=>e.category===B)),H&&(e=e.filter(e=>e.subCategory===H)),ee&&(e=e.filter(e=>ey(e))),e.sort((e,t)=>{let s=e.category||"",r=t.category||"";if(s!==r)return s.localeCompare(r,"zh-TW");let a=e.subCategory||"",l=t.subCategory||"";return a!==l?a.localeCompare(l,"zh-TW"):e.name.localeCompare(t.name,"zh-TW")}),console.log("篩選結果:",{searchTerm:G.trim(),totalMaterials:t.length,filteredCount:e.length,selectedCategory:B,selectedSubCategory:H}),E(e)},[t,G,B,H,ee]),e$=e=>{Q(e),eP()},ez=e=>{Y(B===e?"":e)},eq=e=>{K(H===e?"":e)},eZ=()=>{V(null),D(!0)},eA=async()=>{let e=await ej();await ef(e)},eL=e=>{J(t=>{let s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})},eM=e=>{try{let t={id:e.id,name:e.name,code:e.code,type:"material",supplierId:e.supplierRef?.id||"",supplierName:e.supplierName||"未指定",unit:e.unit||"",quantity:1,costPerUnit:e.costPerUnit||0,currentStock:e.currentStock||0},s=localStorage.getItem("purchaseCart"),r=[];if(s)try{r=JSON.parse(s)}catch(e){console.error("解析採購車資料失敗:",e)}let a=r.findIndex(t=>t.id===e.id&&"material"===t.type);a>=0?(r[a].quantity+=1,C.Am.success(`已增加 ${e.name} 的數量`)):(r.push(t),C.Am.success(`已將 ${e.name} 加入採購車`)),localStorage.setItem("purchaseCart",JSON.stringify(r))}catch(e){console.error("添加到採購車失敗:",e),C.Am.error("添加到採購車失敗")}},eE=(e,t)=>{el(s=>({...s,[e]:t}))},eU=async()=>{if(0===t.filter(e=>void 0!==ea[e.id]&&ea[e.id]!==e.currentStock).map(e=>({itemRefPath:`materials/${e.id}`,currentStock:e.currentStock,newStock:ea[e.id]})).length){C.Am.info("庫存數量沒有變更，無需儲存。"),er(!1),el({});return}eo(!0)},eO=async()=>{let e=t.filter(e=>void 0!==ea[e.id]&&ea[e.id]!==e.currentStock).map(e=>({itemRefPath:`materials/${e.id}`,currentStock:e.currentStock,newStock:ea[e.id]})),s=C.Am.loading("正在儲存盤點結果...");try{let t=(0,n.$C)(),r=(0,n.V1)(t,"performStocktake");await r({items:e}),C.Am.success("盤點結果儲存成功，庫存已更新。",{id:s}),el({}),er(!1),eo(!1);let a=await ej();await ef(a)}catch(t){let e=t instanceof Error?t.message:"儲存盤點失敗";C.Am.error(e,{id:s})}},e_=()=>{el({}),er(!1)},{categories:eD,subCategories:eI}=(0,a.useMemo)(()=>eN(),[eN]);return(0,r.jsxs)("div",{className:"container mx-auto py-10 materials-page",children:[r.jsx("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8",children:(0,r.jsxs)("div",{children:[r.jsx("h1",{className:"text-3xl font-bold text-orange-600",children:es?"盤點模式中":"物料管理"}),r.jsx("p",{className:"text-muted-foreground mt-2",children:es?"進行庫存盤點作業":"管理系統中的所有物料資料"})]})}),r.jsx("div",{className:"lg:hidden mb-6",children:r.jsx("div",{className:"grid grid-cols-2 gap-3 mb-3",children:es?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(S.z,{onClick:eU,className:"w-full",children:[r.jsx(m.Z,{className:"mr-2 h-4 w-4"}),"儲存盤點"]}),r.jsx(S.z,{variant:"outline",onClick:e_,className:"w-full",children:"取消"})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(S.z,{variant:"outline",onClick:()=>eb(!0),className:"w-full",children:[r.jsx(h.Z,{className:"mr-2 h-4 w-4"}),"物料分類"]}),(0,r.jsxs)(S.z,{variant:"outline",onClick:()=>eu(!0),className:"w-full",children:[r.jsx(x.Z,{className:"mr-2 h-4 w-4"}),"匯入/匯出"]}),(0,r.jsxs)(S.z,{variant:"outline",onClick:()=>er(!0),className:"w-full",children:[r.jsx(p.Z,{className:"mr-2 h-4 w-4"}),"盤點模式"]}),(0,r.jsxs)(S.z,{onClick:eZ,className:"w-full bg-orange-600 hover:bg-orange-700",children:[r.jsx(g.Z,{className:"mr-2 h-4 w-4"}),"新增物料"]})]})})}),r.jsx("div",{className:"hidden lg:block mb-6",children:r.jsx("div",{className:"flex flex-wrap items-center gap-2 justify-end",children:es?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(S.z,{onClick:eU,children:[r.jsx(m.Z,{className:"mr-2 h-4 w-4"}),"儲存盤點"]}),r.jsx(S.z,{variant:"outline",onClick:e_,children:"取消"})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(S.z,{variant:"outline",onClick:()=>eb(!0),children:[r.jsx(h.Z,{className:"mr-2 h-4 w-4"}),"物料分類"]}),(0,r.jsxs)(S.z,{variant:"outline",onClick:()=>eu(!0),children:[r.jsx(x.Z,{className:"mr-2 h-4 w-4"}),"匯入/匯出"]}),(0,r.jsxs)(S.z,{variant:"outline",onClick:()=>er(!0),children:[r.jsx(p.Z,{className:"mr-2 h-4 w-4"}),"盤點模式"]}),(0,r.jsxs)(S.z,{onClick:eZ,className:"bg-orange-600 hover:bg-orange-700",children:[r.jsx(g.Z,{className:"mr-2 h-4 w-4"}),"新增物料"]})]})})}),r.jsx(q.Zb,{className:"mb-6 border-0 shadow-lg bg-gradient-to-r from-orange-50 to-orange-100",children:r.jsx(q.aY,{className:"pt-6",children:(0,r.jsxs)("div",{className:"relative",children:[r.jsx(b.Z,{className:"absolute left-3 top-3 h-4 w-4 text-orange-600"}),r.jsx(z.I,{placeholder:"搜尋物料名稱、代號、分類或供應商...",value:G,onChange:e=>e$(e.target.value),className:"pl-10 border-input focus:border-orange-500 focus:ring-orange-500"})]})})}),r.jsx("div",{className:"mb-6",children:(0,r.jsxs)("div",{className:"flex flex-wrap gap-2",children:[t.filter(e=>ey(e)).length>0&&(0,r.jsxs)(Z.C,{variant:ee?"default":"secondary",className:`cursor-pointer transition-colors ${ee?"bg-red-600 hover:bg-red-700 text-white":"bg-red-100 hover:bg-red-200 text-red-800 border-red-300"}`,onClick:()=>{et(!ee)},children:["安全庫存 (",t.filter(e=>ey(e)).length,")"]}),eD.map(e=>r.jsx(Z.C,{variant:B===e?"default":"secondary",className:`cursor-pointer transition-colors ${B===e?"bg-blue-600 hover:bg-blue-700 text-white":"bg-blue-100 hover:bg-blue-200 text-blue-800 border-blue-300"}`,onClick:()=>ez(e),children:e},e)),eI.map(e=>r.jsx(Z.C,{variant:H===e?"default":"secondary",className:`cursor-pointer transition-colors ${H===e?"bg-green-600 hover:bg-green-700 text-white":"bg-green-100 hover:bg-green-200 text-green-800 border-green-300"}`,onClick:()=>eq(e),children:e},e))]})}),W.size>0&&!es&&r.jsx("div",{className:"mb-6",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsxs)(S.z,{variant:"outline",size:"sm",onClick:()=>{if(0===W.size){C.Am.info("請至少選擇一個物料加入採購車。");return}try{let e=localStorage.getItem("purchaseCart"),s=e?JSON.parse(e):[],r=t.filter(e=>W.has(e.id));r.forEach(e=>{let t=s.find(t=>t.id===e.id&&"material"===t.type);t?t.quantity+=1:s.push({id:e.id,name:e.name,code:e.code,type:"material",supplierId:e.supplierRef?.id||"",supplierName:e.supplierName,unit:e.unit||"個",quantity:1,costPerUnit:e.costPerUnit||0,currentStock:e.currentStock||0})}),localStorage.setItem("purchaseCart",JSON.stringify(s)),window.dispatchEvent(new CustomEvent("purchaseCartUpdated")),C.Am.success(`已將 ${r.length} 個物料加入採購車`),J(new Set)}catch(e){console.error("加入採購車失敗:",e),C.Am.error("加入採購車失敗")}},className:"flex items-center gap-2",children:[r.jsx(j.Z,{className:"h-4 w-4"}),"加入採購車 (",W.size,")"]}),(0,r.jsxs)(S.z,{variant:"destructive",size:"sm",onClick:()=>X(!0),className:"flex items-center gap-2",children:[r.jsx(f.Z,{className:"h-4 w-4"}),"批量刪除 (",W.size,")"]})]})}),U&&r.jsx("div",{className:"flex justify-center items-center py-20",children:(0,r.jsxs)("div",{className:"text-center",children:[r.jsx("div",{className:"w-10 h-10 border-4 border-border rounded-full animate-spin border-t-primary mx-auto mb-4"}),r.jsx("p",{className:"text-muted-foreground",children:"載入中..."})]})}),!U&&(0,r.jsxs)(r.Fragment,{children:[r.jsx("div",{className:"lg:hidden space-y-4",children:M.map(t=>r.jsx(q.Zb,{className:`relative transition-colors duration-200 ${ey(t)?"bg-pink-50":""}`,children:(0,r.jsxs)(q.aY,{className:"p-4",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between",children:[(0,r.jsxs)("div",{className:`flex-1 ${es?"":"cursor-pointer"}`,onClick:es?void 0:()=>e.push(`/dashboard/materials/${t.id}`),children:[r.jsx("div",{className:"font-medium text-foreground text-sm",children:t.name}),(0,r.jsxs)("div",{className:"text-xs text-muted-foreground",children:["代號: ",t.code]})]}),(0,r.jsxs)(P.h_,{children:[r.jsx(P.$F,{asChild:!0,children:r.jsx(S.z,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",children:r.jsx(y.Z,{className:"h-4 w-4"})})}),(0,r.jsxs)(P.AW,{align:"end",children:[r.jsx(P.Ju,{children:"操作"}),(0,r.jsxs)(P.Xi,{onClick:()=>ev(t),children:[r.jsx(N.Z,{className:"mr-2 h-4 w-4"}),"查看詳情"]}),(0,r.jsxs)(P.Xi,{onClick:()=>ek(t),children:[r.jsx(v.Z,{className:"mr-2 h-4 w-4"}),"編輯"]}),r.jsx(P.VD,{}),(0,r.jsxs)(P.Xi,{onClick:()=>eC(t),className:"text-red-600",children:[r.jsx(f.Z,{className:"mr-2 h-4 w-4"}),"刪除"]})]})]})]}),(0,r.jsxs)("div",{className:"mt-3 space-y-2",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[r.jsx("span",{className:"text-muted-foreground",children:"分類:"}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-1",children:[t.category&&r.jsx(Z.C,{variant:"outline",className:"text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 border-blue-300",children:t.category}),t.subCategory&&r.jsx(Z.C,{variant:"outline",className:"text-xs bg-green-100 hover:bg-green-200 text-green-800 border-green-300",children:t.subCategory})]})]}),!es&&(0,r.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[r.jsx("span",{className:"text-muted-foreground",children:"供應商:"}),r.jsx("span",{children:t.supplierName})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[r.jsx("span",{className:"text-muted-foreground",children:es?"應有庫存:":"目前庫存:"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsxs)("span",{className:ey(t)?"text-red-600 font-medium":"",children:[t.currentStock||0," ",t.unit]}),ey(t)&&r.jsx(k.Z,{className:"h-3 w-3 text-red-600"})]})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[r.jsx("span",{className:"text-muted-foreground",children:"安全庫存:"}),(0,r.jsxs)("span",{children:[t.safetyStockLevel||0," ",t.unit]})]}),!es&&(0,r.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[r.jsx("span",{className:"text-muted-foreground",children:"成本:"}),(0,r.jsxs)("span",{children:["$",t.costPerUnit||0]})]})]}),es&&r.jsx("div",{className:`mt-3 pt-3 border-t ${(ea[t.id]??t.currentStock??0)>(t.currentStock??0)?"bg-green-50 -mx-4 -mb-4 px-4 pb-4":(ea[t.id]??t.currentStock??0)<(t.currentStock??0)?"bg-pink-50 -mx-4 -mb-4 px-4 pb-4":""}`,children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[r.jsx("span",{className:"text-sm font-medium",children:"現有庫存:"}),r.jsx(z.I,{type:"number",inputMode:"numeric",value:ea[t.id]??t.currentStock??0,onChange:e=>eE(t.id,Number(e.target.value)),className:"w-20 h-8 text-sm"}),r.jsx("span",{className:"text-sm text-muted-foreground",children:t.unit})]})}),!es&&r.jsx("div",{className:"mt-3 pt-3 border-t",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[r.jsx($.X,{checked:W.has(t.id),onCheckedChange:()=>eL(t.id)}),(0,r.jsxs)(S.z,{variant:"outline",size:"sm",onClick:()=>eM(t),className:"h-8 px-2 text-xs border-amber-200 text-amber-600 hover:bg-amber-50",children:[r.jsx(j.Z,{className:"h-3 w-3 mr-1"}),"加入採購車"]})]}),(0,r.jsxs)("div",{className:"text-sm text-muted-foreground",children:["$",t.costPerUnit||0]})]})})]})},t.id))}),r.jsx("div",{className:"hidden lg:block",children:r.jsx(q.Zb,{children:(0,r.jsxs)(w.iA,{children:[r.jsx(w.xD,{children:(0,r.jsxs)(w.SC,{children:[r.jsx(w.ss,{className:"w-12",children:!es&&(0,r.jsxs)("div",{className:"flex items-center gap-2",title:"全選所有物料",children:[r.jsx($.X,{checked:W.size===M.length&&M.length>0,onCheckedChange:e=>{e?J(new Set(M.map(e=>e.id))):J(new Set)}}),r.jsx("span",{className:"text-xs text-muted-foreground",children:"全選"})]})}),r.jsx(w.ss,{children:"物料資訊"}),r.jsx(w.ss,{children:"分類"}),!es&&r.jsx(w.ss,{children:"供應商"}),r.jsx(w.ss,{children:es?"應有庫存":"庫存"}),es&&r.jsx(w.ss,{children:"現有庫存"}),!es&&r.jsx(w.ss,{children:"成本"}),r.jsx(w.ss,{className:"w-12",children:"操作"})]})}),r.jsx(w.RM,{children:M.map(t=>(0,r.jsxs)(w.SC,{className:`hover:bg-orange-50 transition-colors duration-200 ${ey(t)?"bg-pink-50":""}`,children:[r.jsx(w.pj,{onClick:e=>e.stopPropagation(),children:!es&&r.jsx($.X,{checked:W.has(t.id),onCheckedChange:()=>eL(t.id)})}),(0,r.jsxs)(w.pj,{className:es?"":"cursor-pointer",onClick:es?void 0:()=>e.push(`/dashboard/materials/${t.id}`),children:[r.jsx("div",{className:"font-medium text-foreground",children:t.name}),(0,r.jsxs)("div",{className:"text-xs text-muted-foreground",children:["代號: ",t.code]})]}),r.jsx(w.pj,{className:es?"":"cursor-pointer",onClick:es?void 0:()=>e.push(`/dashboard/materials/${t.id}`),children:(0,r.jsxs)("div",{className:"flex flex-wrap gap-1",children:[t.category&&r.jsx(Z.C,{variant:"outline",className:"text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 border-blue-300",children:t.category}),t.subCategory&&r.jsx(Z.C,{variant:"outline",className:"text-xs bg-green-100 hover:bg-green-200 text-green-800 border-green-300",children:t.subCategory})]})}),!es&&r.jsx(w.pj,{className:es?"":"cursor-pointer",onClick:es?void 0:()=>e.push(`/dashboard/materials/${t.id}`),children:t.supplierName}),(0,r.jsxs)(w.pj,{className:es?"":"cursor-pointer",onClick:es?void 0:()=>e.push(`/dashboard/materials/${t.id}`),children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsxs)("span",{className:ey(t)?"text-red-600 font-medium":"",children:[t.currentStock||0," ",t.unit]}),ey(t)&&r.jsx(k.Z,{className:"h-3 w-3 text-red-600"})]}),(0,r.jsxs)("div",{className:"text-xs text-muted-foreground",children:["安全庫存: ",t.safetyStockLevel||0," ",t.unit]})]}),es&&r.jsx(w.pj,{className:(ea[t.id]??t.currentStock??0)>(t.currentStock??0)?"bg-green-50":(ea[t.id]??t.currentStock??0)<(t.currentStock??0)?"bg-pink-50":"",children:r.jsx(z.I,{type:"number",inputMode:"numeric",value:ea[t.id]??t.currentStock??0,onChange:e=>eE(t.id,Number(e.target.value)),className:"w-20 h-8 text-sm"})}),!es&&(0,r.jsxs)(w.pj,{className:es?"":"cursor-pointer",onClick:es?void 0:()=>e.push(`/dashboard/materials/${t.id}`),children:["$",t.costPerUnit||0]}),r.jsx(w.pj,{children:(0,r.jsxs)(P.h_,{children:[r.jsx(P.$F,{asChild:!0,children:r.jsx(S.z,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:e=>e.stopPropagation(),children:r.jsx(y.Z,{className:"h-4 w-4"})})}),(0,r.jsxs)(P.AW,{align:"end",children:[r.jsx(P.Ju,{children:"操作"}),(0,r.jsxs)(P.Xi,{onClick:()=>eM(t),children:[r.jsx(j.Z,{className:"mr-2 h-4 w-4"}),"加入採購車"]}),(0,r.jsxs)(P.Xi,{onClick:()=>ev(t),children:[r.jsx(N.Z,{className:"mr-2 h-4 w-4"}),"查看詳情"]}),(0,r.jsxs)(P.Xi,{onClick:()=>ek(t),children:[r.jsx(v.Z,{className:"mr-2 h-4 w-4"}),"編輯"]}),r.jsx(P.VD,{}),(0,r.jsxs)(P.Xi,{onClick:()=>eC(t),className:"text-red-600",children:[r.jsx(f.Z,{className:"mr-2 h-4 w-4"}),"刪除"]})]})]})})]},t.id))})]})})}),0===M.length&&!U&&(0,r.jsxs)("div",{className:"text-center py-20",children:[r.jsx("div",{className:"w-12 h-12 border-4 border-border rounded-full animate-spin border-t-primary mx-auto mb-4"}),r.jsx("p",{className:"text-muted-foreground",children:"沒有找到符合條件的物料"})]})]}),r.jsx(o.Z,{isOpen:_,onOpenChange:D,materialData:T,onMaterialUpdate:eA}),em&&r.jsx(L.O,{isOpen:ex,onOpenChange:ep,title:em.name,subtitle:`物料代號: ${em.code}`,sections:[{title:"基本資訊",color:"blue",fields:[{label:"物料代號",value:em.code},{label:"物料名稱",value:em.name},{label:"主分類",value:em.category||"未分類"},{label:"細分分類",value:em.subCategory||"未分類"},{label:"供應商",value:em.supplierName},{label:"單位",value:em.unit||"未指定"}]},{title:"庫存資訊",color:"green",fields:[{label:"目前庫存",value:`${em.currentStock||0} ${em.unit||""}`},{label:"安全庫存",value:`${em.safetyStockLevel||0} ${em.unit||""}`},{label:"單位成本",value:`$${em.costPerUnit||0}`}]},...em.notes?[{title:"備註",color:"yellow",fields:[{label:"備註",value:em.notes}]}]:[]],actions:(0,r.jsxs)(r.Fragment,{children:[r.jsx(S.z,{variant:"outline",onClick:()=>ep(!1),children:"關閉"}),(0,r.jsxs)(S.z,{onClick:()=>{ep(!1),ek(em)},children:[r.jsx(v.Z,{className:"mr-2 h-4 w-4"}),"編輯"]})]})}),r.jsx(u.Q,{isOpen:I,onOpenChange:F,onConfirm:ew,title:"確認刪除",description:`您確定要刪除物料「${T?.name}」嗎？此操作無法復原。`}),r.jsx(u.Q,{isOpen:R,onOpenChange:X,onConfirm:eS,title:"確認批量刪除",description:`您確定要刪除選取的 ${W.size} 個物料嗎？此操作無法復原。`}),r.jsx(u.Q,{isOpen:ec,onOpenChange:eo,onConfirm:eO,title:"確認盤點結果",description:`您確定要更新 ${t.filter(e=>void 0!==ea[e.id]&&ea[e.id]!==e.currentStock).length} 個物料的庫存嗎？此操作將直接修改庫存資料。`}),r.jsx(d.J,{isOpen:eg,onOpenChange:eb}),r.jsx(A.Z,{isOpen:ed,onOpenChange:eu,onImport:async(e,t,s)=>{let r=(0,n.$C)();try{console.log("開始匯入物料資料:",{totalRecords:e.length,sampleData:e.slice(0,3).map(e=>({name:e.name,code:e.code,supplierName:e.supplierName,hasSupplierName:!!e.supplierName}))});let t=new Map;if(!c.db)throw Error("Firebase 未初始化");(await (0,i.getDocs)((0,i.collection)(c.db,"suppliers"))).forEach(e=>{let s=e.data();t.set(s.name,e.id),console.log(`供應商映射: ${s.name} -> ${e.id}`)});let a=new Map;(await (0,i.getDocs)((0,i.collection)(c.db,"materials"))).forEach(e=>{let t=e.data();t.code&&a.set(t.code,e.id)});let l=Math.ceil(e.length/20),o=0,d=0,u=0;for(let i=0;i<l;i++){let c=20*i,m=Math.min(c+20,e.length),h=e.slice(c,m);for(let e of h)try{let s;if(e.supplierName&&""!==e.supplierName.trim()){let r=e.supplierName.trim();s=t.get(r),console.log(`尋找供應商: "${r}" -> ${s||"未找到"}`),s||console.warn(`找不到供應商: "${r}"`)}let l=void 0!==e.currentStock&&null!==e.currentStock&&""!==String(e.currentStock)?Number(e.currentStock):0,i=void 0!==e.safetyStockLevel&&null!==e.safetyStockLevel&&""!==String(e.safetyStockLevel)?Number(e.safetyStockLevel):0,c=void 0!==e.costPerUnit&&null!==e.costPerUnit&&""!==String(e.costPerUnit)?Number(e.costPerUnit):0,o={code:e.code,name:e.name,category:e.category||"",subCategory:e.subCategory||"",supplierId:s,currentStock:l,safetyStockLevel:i,costPerUnit:c,unit:e.unit||"個",notes:e.notes||""};if(console.log(`處理物料 ${e.name} 的完整資料:`,{code:o.code,name:o.name,category:o.category,subCategory:o.subCategory,supplierId:o.supplierId,currentStock:o.currentStock,safetyStockLevel:o.safetyStockLevel,costPerUnit:o.costPerUnit,unit:o.unit,notes:o.notes}),a.get(e.code)){console.log(`物料代號 ${e.code} 已存在，執行更新操作`);let t=(0,n.V1)(r,"updateMaterialByCode");await t(o),u++}else{console.log(`物料代號 ${e.code} 不存在，執行新增操作`);let t=(0,n.V1)(r,"createMaterial");await t(o),d++}}catch(e){throw console.error("處理物料資料失敗:",e),e}o+=h.length,s?.(o,e.length),i<l-1&&await new Promise(e=>setTimeout(e,500))}console.log("物料匯入結果:",`成功處理 ${o} 筆資料 (新增: ${d}, 更新: ${u})`),eA()}catch(e){throw console.error("匯入物料失敗:",e),e}},onExport:async()=>t.map(e=>({code:e.code,name:e.name,category:e.category,subCategory:e.subCategory,supplierName:e.supplierName,safetyStockLevel:e.safetyStockLevel,costPerUnit:e.costPerUnit,unit:e.unit,currentStock:e.currentStock,notes:e.notes})),title:"物料資料",description:"匯入或匯出物料資料，支援 Excel 和 CSV 格式。匯入時會智能匹配物料代號：如果代號不存在則新增，如果代號已存在則更新覆蓋有填入的欄位。",color:"yellow",showUpdateOption:!0,maxBatchSize:500,sampleData:[{code:"MAT001",name:"示例物料",category:"原料",subCategory:"基礎原料",supplierName:"示例供應商",safetyStockLevel:100,costPerUnit:10.5,unit:"kg",currentStock:50,notes:"示例備註"}],fields:[{key:"code",label:"物料代號",required:!1,type:"string"},{key:"name",label:"物料名稱",required:!0,type:"string"},{key:"category",label:"主分類",required:!1,type:"string"},{key:"subCategory",label:"細分分類",required:!1,type:"string"},{key:"supplierName",label:"供應商",required:!1,type:"string"},{key:"safetyStockLevel",label:"安全庫存",required:!1,type:"number"},{key:"costPerUnit",label:"單位成本",required:!1,type:"number"},{key:"unit",label:"單位",required:!1,type:"string"},{key:"currentStock",label:"目前庫存",required:!1,type:"number"},{key:"notes",label:"備註",required:!1,type:"string"}]})]})}function E(){return r.jsx(a.Suspense,{fallback:r.jsx("div",{children:"Loading..."}),children:r.jsx(M,{})})}},25203:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>r});let r=(0,s(68570).createProxy)(String.raw`D:\APP\deer-lab\src\app\dashboard\materials\page.tsx#default`)}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[8948,9654,5540,8693,692,9516,3128,4108,4334,9536,4791,2083],()=>s(41401));module.exports=r})();