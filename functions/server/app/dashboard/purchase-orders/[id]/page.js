(()=>{var e={};e.id=3604,e.ids=[3604],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},84770:e=>{"use strict";e.exports=require("crypto")},80665:e=>{"use strict";e.exports=require("dns")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},32694:e=>{"use strict";e.exports=require("http2")},98216:e=>{"use strict";e.exports=require("net")},19801:e=>{"use strict";e.exports=require("os")},55315:e=>{"use strict";e.exports=require("path")},35816:e=>{"use strict";e.exports=require("process")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},21626:(e,s,t)=>{"use strict";t.r(s),t.d(s,{GlobalError:()=>i.a,__next_app__:()=>x,originalPathname:()=>o,pages:()=>m,routeModule:()=>h,tree:()=>d}),t(96333),t(22834),t(62510),t(35866);var r=t(23191),a=t(88716),l=t(37922),i=t.n(l),c=t(95231),n={};for(let e in c)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(n[e]=()=>c[e]);t.d(s,n);let d=["",{children:["dashboard",{children:["purchase-orders",{children:["[id]",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(t.bind(t,96333)),"D:\\APP\\deer-lab\\src\\app\\dashboard\\purchase-orders\\[id]\\page.tsx"]}]},{}]},{}]},{layout:[()=>Promise.resolve().then(t.bind(t,22834)),"D:\\APP\\deer-lab\\src\\app\\dashboard\\layout.tsx"],metadata:{icon:[async e=>(await Promise.resolve().then(t.bind(t,73881))).default(e)],apple:[],openGraph:[],twitter:[],manifest:void 0}}]},{layout:[()=>Promise.resolve().then(t.bind(t,62510)),"D:\\APP\\deer-lab\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(t.t.bind(t,35866,23)),"next/dist/client/components/not-found-error"],metadata:{icon:[async e=>(await Promise.resolve().then(t.bind(t,73881))).default(e)],apple:[],openGraph:[],twitter:[],manifest:void 0}}],m=["D:\\APP\\deer-lab\\src\\app\\dashboard\\purchase-orders\\[id]\\page.tsx"],o="/dashboard/purchase-orders/[id]/page",x={require:t,loadChunk:()=>Promise.resolve()},h=new r.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/dashboard/purchase-orders/[id]/page",pathname:"/dashboard/purchase-orders/[id]",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:d}})},36983:(e,s,t)=>{Promise.resolve().then(t.bind(t,2360))},30361:(e,s,t)=>{"use strict";t.d(s,{Z:()=>r});let r=(0,t(62881).Z)("CircleCheckBig",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]])},2360:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>D});var r=t(10326),a=t(17577),l=t(35047),i=t(76),c=t(90445),n=t(78880),d=t(85999),m=t(27467),o=t(77506),x=t(86333),h=t(30361);let u=(0,t(62881).Z)("Truck",[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]]);var g=t(98091),p=t(57671),j=t(38787),b=t(79635),f=t(37358),N=t(48705),y=t(83855),v=t(94019),w=t(40617),C=t(63685),A=t(29752),q=t(41156),k=t(38443),P=t(91664),S=t(41190),Z=t(82015),z=t(24118),$=t(74723),O=t(770),I=t(74064),_=t(9969);let E=O.Ry({items:O.IX(O.Ry({id:O.Z_(),name:O.Z_(),code:O.Z_(),unit:O.Z_(),itemRef:O.Yj(),quantity:O.oQ.number().min(0,"數量不能為負數"),receivedQuantity:O.oQ.number().min(0,"數量不能為負數")}))});function F({isOpen:e,onOpenChange:s,onSuccess:t,purchaseOrder:a}){let l=(0,$.cI)({resolver:(0,I.F)(E),defaultValues:{items:a.items.map(e=>({...e,receivedQuantity:e.quantity}))}}),{fields:i}=(0,$.Dq)({control:l.control,name:"items"}),c=async e=>{l.clearErrors();let r=d.Am.loading("正在處理入庫...");try{let l=(0,n.$C)(),i=(0,n.V1)(l,"receivePurchaseOrderItems"),c={purchaseOrderId:a.id,items:e.items.map(e=>({itemRefPath:e.itemRef?.path||e.itemRef,receivedQuantity:e.receivedQuantity}))};console.log("=== 採購單入庫除錯日誌 ==="),console.log("採購單 ID:",a.id),console.log("採購單狀態:",a.status),console.log("發送 payload:",JSON.stringify(c,null,2));let m=await i(c);console.log("Cloud Function 回應:",JSON.stringify(m,null,2)),m.data&&console.log("入庫成功，更新結果:",m.data),d.Am.success("收貨入庫成功，庫存已更新。",{id:r}),t(),s(!1)}catch(s){console.error("=== 入庫操作失敗 ==="),console.error("錯誤類型:",s?.constructor?.name),console.error("錯誤訊息:",s instanceof Error?s.message:s),console.error("完整錯誤物件:",s);let e=s instanceof Error?s.message:"入庫操作失敗";d.Am.error(e,{id:r})}};return r.jsx(z.Vq,{open:e,onOpenChange:s,children:(0,r.jsxs)(z.cZ,{className:"max-w-3xl","aria-describedby":"receive-dialog-description",children:[(0,r.jsxs)(z.fK,{children:[r.jsx(z.$N,{children:"收貨與入庫確認"}),r.jsx(z.Be,{id:"receive-dialog-description",children:"請確認以下採購項目的實際到貨數量。系統將根據您填寫的數量更新庫存。"})]}),r.jsx(_.l0,{...l,children:(0,r.jsxs)("form",{onSubmit:l.handleSubmit(c),children:[r.jsx("div",{className:"max-h-[60vh] overflow-y-auto pr-4",children:(0,r.jsxs)(q.iA,{children:[r.jsx(q.xD,{children:(0,r.jsxs)(q.SC,{children:[r.jsx(q.ss,{children:"品項名稱"}),r.jsx(q.ss,{className:"w-[120px]",children:"採購數量"}),r.jsx(q.ss,{className:"w-[150px]",children:"實際收到數量"})]})}),r.jsx(q.RM,{children:i.map((e,s)=>(0,r.jsxs)(q.SC,{children:[(0,r.jsxs)(q.pj,{className:"font-medium",children:[e.name," ",r.jsx("span",{className:"text-muted-foreground font-mono text-xs",children:e.code})]}),(0,r.jsxs)(q.pj,{children:[e.quantity," ",e.unit]}),r.jsx(q.pj,{children:r.jsx($.Qr,{control:l.control,name:`items.${s}.receivedQuantity`,render:({field:e})=>r.jsx(S.I,{type:"number",min:"0",...e})})})]},e.id))})]})}),(0,r.jsxs)(z.cN,{className:"mt-6",children:[r.jsx(P.z,{type:"button",variant:"ghost",onClick:()=>s(!1),children:"取消"}),(0,r.jsxs)(P.z,{type:"submit",disabled:l.formState.isSubmitting,children:[l.formState.isSubmitting&&r.jsx(o.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"確認入庫"]})]})]})})]})})}function D(){let e=(0,l.useRouter)(),{id:s}=(0,l.useParams)(),[$,O]=(0,a.useState)(null),[I,_]=(0,a.useState)(!0),[E,D]=(0,a.useState)(!1),[M,R]=(0,a.useState)(!1),[B,T]=(0,a.useState)([]),[Q,L]=(0,a.useState)([]),[V,G]=(0,a.useState)([]),[K,Y]=(0,a.useState)(""),[U,H]=(0,a.useState)([]),[J,X]=(0,a.useState)(!1),[W,ee]=(0,a.useState)(!1),[es,et]=(0,a.useState)(!1),[er,ea]=(0,a.useState)({name:"",amount:0,quantity:1,unit:"項",description:""}),el=(0,a.useCallback)(async s=>{_(!0);try{if(!c.db)throw Error("Firebase 未初始化");let t=(0,i.doc)(c.db,"purchaseOrders",s),r=await (0,i.QT)(t);if(!r.exists()){d.Am.error("找不到指定的採購單。"),e.push("/dashboard/purchase-orders");return}let a=r.data(),l=a.supplierRef?await (0,i.QT)(a.supplierRef):null,n=a.createdByRef?await (0,i.QT)(a.createdByRef):null,m=a.createdAt?.toDate().toLocaleString("zh-TW",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})||"N/A",o={id:r.id,code:a.code,supplierName:l?.data()?.name||"未知供應商",status:a.status,createdByName:n?.data()?.name||"未知人員",createdAt:m,items:a.items||[],additionalFees:a.additionalFees||[],comments:a.comments||[]};O(o),T([...a.items||[]]),L([...a.additionalFees||[]]),G([...a.comments||[]])}catch(e){console.error("讀取採購單詳情失敗:",e),d.Am.error("讀取採購單詳情失敗。")}finally{_(!1)}},[e]),ei=(e,s)=>{s<1||T(t=>{let r=[...t];return r[e]={...r[e],quantity:s},r})},ec=(e,s)=>{s<0||T(t=>{let r=[...t];return r[e]={...r[e],costPerUnit:s},r})},en=e=>{L(s=>s.filter(s=>s.id!==e)),d.Am.success("已移除其他費用")},ed=async e=>{let t=e.target.files;if(!t||0===t.length)return;let r=Array.from(t),a=d.Am.loading("正在處理圖片...");try{if(r.reduce((e,s)=>e+s.size,0)>10485760){d.Am.error(`總檔案大小不能超過 10MB，請選擇較小的圖片`,{id:a});return}let e=await (0,m.OM)(r,{folder:`purchase-orders/${s}/comments`,maxSize:2,compress:!0,quality:.6}),t=e.filter(e=>e.success),l=e.filter(e=>!e.success);if(t.length>0){let e=t.map(e=>e.url);H(s=>[...s,...e]),d.Am.success(`成功上傳 ${t.length} 張圖片`,{id:a})}if(l.length>0){let e=l.map(e=>e.error).join(", ");d.Am.error(`以下圖片上傳失敗: ${e}`,{id:a})}}catch(e){console.error("圖片處理失敗:",e),d.Am.error(`圖片處理失敗: ${e instanceof Error?e.message:"未知錯誤"}`,{id:a})}e.target.value=""},em=e=>{H(s=>s.filter((s,t)=>t!==e))},eo=async()=>{if(!K.trim()&&0===U.length){d.Am.error("請輸入留言內容或上傳圖片");return}if($&&c.db)try{let e={id:Date.now().toString(),text:K.trim(),images:U,createdAt:new Date().toISOString(),createdBy:$.createdByName||"當前用戶"},s=(0,i.doc)(c.db,"purchaseOrders",$.id),t=[...V,e];await (0,i.r7)(s,{comments:t,updatedAt:i.EK.now()}),G(t),O(e=>e?{...e,comments:t}:null),Y(""),H([]),d.Am.success("留言已新增")}catch(e){console.error("新增留言失敗:",e),d.Am.error("新增留言失敗")}},ex=async e=>{try{let s=V.find(s=>s.id===e);if(!s)return;if(s.images.length>0){let{getStorage:e,ref:r,deleteObject:a}=await Promise.resolve().then(t.bind(t,11552)),l=e(),i=s.images.map(async e=>{try{let s=r(l,e);await a(s)}catch(e){console.error("刪除圖片失敗:",e)}});await Promise.all(i)}let r=V.filter(s=>s.id!==e);if(G(r),$&&c.db){let e=(0,i.doc)(c.db,"purchaseOrders",$.id);await (0,i.r7)(e,{comments:r,updatedAt:i.EK.now()}),O(e=>e?{...e,comments:r}:null)}d.Am.success("留言已刪除")}catch(e){console.error("刪除留言失敗:",e),d.Am.error("刪除留言失敗")}},eh=async()=>{if(!$||!c.db)return;et(!0);let s=d.Am.loading("正在刪除採購單...");try{let r=V.flatMap(e=>e.images);if(r.length>0){let{getStorage:e,ref:s,deleteObject:a}=await Promise.resolve().then(t.bind(t,11552)),l=e(),i=r.map(async e=>{try{let t=s(l,e);await a(t)}catch(e){console.error("刪除圖片失敗:",e)}});await Promise.all(i)}let{doc:a,deleteDoc:l}=await Promise.resolve().then(t.bind(t,76)),i=a(c.db,"purchaseOrders",$.id);await l(i),d.Am.success("採購單已刪除",{id:s}),e.push("/dashboard/purchase-orders")}catch(e){console.error("刪除採購單失敗:",e),d.Am.error("刪除採購單失敗",{id:s})}finally{et(!1),ee(!1)}},eu=async()=>{if(!$||!c.db)return;D(!0);let e=d.Am.loading("正在儲存變更...");try{let s=(0,i.doc)(c.db,"purchaseOrders",$.id);await (0,i.r7)(s,{items:B,additionalFees:Q,updatedAt:i.EK.now()}),O(e=>e?{...e,items:B,additionalFees:Q}:null),d.Am.success("變更已儲存",{id:e})}catch(s){console.error("儲存變更失敗:",s),d.Am.error("儲存變更失敗",{id:e})}finally{D(!1)}},eg=async e=>{if(!$)return;D(!0);let s=d.Am.loading(`正在將狀態更新為 "${e}"...`);try{let t=(0,n.$C)(),r=(0,n.V1)(t,"updatePurchaseOrderStatus");await r({purchaseOrderId:$.id,newStatus:e}),d.Am.success("狀態更新成功。",{id:s}),el($.id)}catch(t){let e=t instanceof Error?t.message:"狀態更新失敗";d.Am.error(e,{id:s})}finally{D(!1)}};return I?r.jsx("div",{className:"flex items-center justify-center h-64",children:r.jsx(o.Z,{className:"h-8 w-8 animate-spin"})}):$?(0,r.jsxs)("div",{className:"container mx-auto p-2 sm:p-4 py-4 sm:py-10",children:[(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-4 mb-4 sm:mb-8",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 sm:gap-4",children:[r.jsx(P.z,{variant:"outline",size:"icon",onClick:()=>e.back(),className:"hover:bg-amber-50 border-amber-200",children:r.jsx(x.Z,{className:"h-4 w-4"})}),(0,r.jsxs)("div",{className:"min-w-0",children:[r.jsx("h1",{className:"text-xl sm:text-3xl font-bold text-amber-600 truncate",children:"採購單詳情"}),r.jsx("p",{className:"text-muted-foreground mt-2 text-sm sm:text-base",children:"查看採購單的詳細資訊"})]})]}),(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:["預報單"===$.status&&(0,r.jsxs)(P.z,{onClick:()=>eg("已訂購"),disabled:E,className:"bg-amber-600 hover:bg-amber-700 w-full sm:w-auto",children:[E?r.jsx(o.Z,{className:"mr-2 h-4 w-4 animate-spin"}):r.jsx(h.Z,{className:"mr-2 h-4 w-4"}),"標示為已訂購"]}),"已訂購"===$.status&&(0,r.jsxs)(P.z,{onClick:()=>R(!0),disabled:E,className:"bg-green-600 hover:bg-green-700 w-full sm:w-auto",children:[r.jsx(u,{className:"mr-2 h-4 w-4"}),"收貨入庫"]}),(0,r.jsxs)(P.z,{onClick:()=>ee(!0),disabled:es,variant:"destructive",className:"bg-red-600 hover:bg-red-700 w-full sm:w-auto",children:[r.jsx(g.Z,{className:"mr-2 h-4 w-4"}),"刪除訂單"]})]})]}),(0,r.jsxs)(A.Zb,{className:"mb-4 sm:mb-6 border-0 shadow-lg bg-gradient-to-r from-background to-amber-10",children:[r.jsx(A.Ol,{className:"pb-3 sm:pb-6",children:(0,r.jsxs)(A.ll,{className:"flex items-center gap-2 text-amber-600 text-lg sm:text-xl",children:[r.jsx(p.Z,{className:"h-5 w-5"}),"採購單資訊"]})}),(0,r.jsxs)(A.aY,{children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6",children:[r.jsx("div",{className:"space-y-2",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[r.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center",children:r.jsx(p.Z,{className:"h-4 w-4 text-white"})}),(0,r.jsxs)("div",{children:[r.jsx("p",{className:"text-sm font-medium text-gray-600",children:"採購單編號"}),r.jsx("p",{className:"text-lg font-bold text-gray-900",children:$.code})]})]})}),r.jsx("div",{className:"space-y-2",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[r.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-lg flex items-center justify-center",children:r.jsx(j.Z,{className:"h-4 w-4 text-white"})}),(0,r.jsxs)("div",{children:[r.jsx("p",{className:"text-sm font-medium text-gray-600",children:"供應商"}),r.jsx("p",{className:"text-lg font-semibold text-gray-900",children:$.supplierName})]})]})}),r.jsx("div",{className:"space-y-2",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[r.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center",children:r.jsx(b.Z,{className:"h-4 w-4 text-white"})}),(0,r.jsxs)("div",{children:[r.jsx("p",{className:"text-sm font-medium text-gray-600",children:"建立人員"}),r.jsx("p",{className:"text-lg font-semibold text-gray-900",children:$.createdByName})]})]})}),r.jsx("div",{className:"space-y-2",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[r.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center",children:r.jsx(f.Z,{className:"h-4 w-4 text-white"})}),(0,r.jsxs)("div",{children:[r.jsx("p",{className:"text-sm font-medium text-gray-600",children:"建立時間"}),r.jsx("p",{className:"text-lg font-semibold text-gray-900",children:$.createdAt})]})]})})]}),r.jsx("div",{className:"mt-6 pt-6 border-t border-gray-200",children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[r.jsx("span",{className:"text-sm font-medium text-gray-600",children:"當前狀態："}),r.jsx(k.C,{variant:(e=>{switch(e){case"已收貨":return"default";case"已訂購":return"secondary";case"預報單":default:return"outline";case"已取消":return"destructive"}})($.status),className:`text-sm font-medium px-3 py-1 ${"預報單"===$.status?"bg-purple-100 text-purple-800 border-purple-200":"已訂購"===$.status?"bg-green-100 text-green-800 border-green-200":"已收貨"===$.status?"bg-gray-600 text-white border-gray-600":"已取消"===$.status?"bg-red-100 text-red-800 border-red-200":"bg-gray-600 text-white border-gray-600"}`,children:$.status})]})})]})]}),(0,r.jsxs)(A.Zb,{className:"mb-4 sm:mb-6 border-0 shadow-lg",children:[(0,r.jsxs)(A.Ol,{className:"pb-3 sm:pb-6",children:[(0,r.jsxs)(A.ll,{className:"flex items-center gap-2 text-lg sm:text-xl",children:[r.jsx(N.Z,{className:"h-5 w-5 text-amber-600"}),"採購項目清單"]}),r.jsx(A.SZ,{children:"此採購單中包含的所有項目列表"})]}),r.jsx(A.aY,{children:$.items.length>0?(0,r.jsxs)("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[(0,r.jsxs)(q.iA,{children:[r.jsx(q.xD,{children:(0,r.jsxs)(q.SC,{className:"bg-gray-50",children:[r.jsx(q.ss,{className:"font-semibold text-gray-700",children:"品項代號"}),r.jsx(q.ss,{className:"font-semibold text-gray-700",children:"品項名稱"}),r.jsx(q.ss,{className:"text-right font-semibold text-gray-700",children:"採購數量"}),r.jsx(q.ss,{className:"text-right font-semibold text-gray-700",children:"單價"}),r.jsx(q.ss,{className:"text-right font-semibold text-gray-700",children:"小計"})]})}),r.jsx(q.RM,{children:B.map((e,s)=>{let t=e.costPerUnit||0,a=t*e.quantity;return(0,r.jsxs)(q.SC,{className:"hover:bg-amber-50/30 transition-colors duration-200",children:[r.jsx(q.pj,{children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center",children:r.jsx(N.Z,{className:"h-4 w-4 text-white"})}),r.jsx("span",{className:"font-mono font-medium text-gray-900",children:e.code})]})}),r.jsx(q.pj,{className:"font-medium text-gray-900",children:e.name}),r.jsx(q.pj,{className:"text-right",children:"已收貨"===$.status?(0,r.jsxs)("span",{className:"font-semibold text-amber-600",children:[e.quantity," ",e.unit]}):(0,r.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[r.jsx(S.I,{type:"number",min:"1",value:e.quantity,onChange:e=>ei(s,parseInt(e.target.value)||1),className:"w-20 text-center border-amber-200 focus:border-amber-500"}),r.jsx("span",{className:"text-sm text-gray-500 whitespace-nowrap",children:e.unit})]})}),r.jsx(q.pj,{className:"text-right",children:"已收貨"===$.status?(0,r.jsxs)("span",{className:"text-gray-600",children:["NT$ ",t.toLocaleString()]}):(0,r.jsxs)("div",{className:"flex items-center justify-end gap-1",children:[r.jsx("span",{className:"text-sm text-gray-500",children:"NT$"}),r.jsx(S.I,{type:"number",min:"0",step:"0.01",value:t,onChange:e=>ec(s,parseFloat(e.target.value)||0),className:"w-24 text-right border-amber-200 focus:border-amber-500"})]})}),r.jsx(q.pj,{className:"text-right",children:(0,r.jsxs)("span",{className:"font-semibold text-amber-600",children:["NT$ ",a.toLocaleString()]})})]},s)})})]}),r.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200",children:(0,r.jsxs)("div",{className:"flex justify-end items-center gap-4",children:[(0,r.jsxs)("div",{className:"text-right",children:[(0,r.jsxs)("div",{className:"text-sm text-gray-600 mb-1",children:["項目總額：NT$ ",B.reduce((e,s)=>e+(s.costPerUnit||0)*s.quantity,0).toLocaleString()]}),(0,r.jsxs)("div",{className:"text-sm text-gray-600 mb-1",children:["其他費用：NT$ ",Q.reduce((e,s)=>e+s.amount*s.quantity,0).toLocaleString()]}),(0,r.jsxs)("div",{className:"text-lg font-bold text-amber-600 border-t border-gray-200 pt-1",children:["總金額：NT$ ",(B.reduce((e,s)=>e+(s.costPerUnit||0)*s.quantity,0)+Q.reduce((e,s)=>e+s.amount*s.quantity,0)).toLocaleString()]})]}),"已收貨"!==$.status&&r.jsx(P.z,{onClick:eu,disabled:E,className:"bg-amber-600 hover:bg-amber-700 text-white",children:E?(0,r.jsxs)(r.Fragment,{children:[r.jsx(o.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"儲存中..."]}):"儲存變更"})]})})]}):(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center py-12 bg-gray-50 rounded-lg",children:[r.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-3",children:r.jsx(N.Z,{className:"h-6 w-6 text-gray-400"})}),r.jsx("h3",{className:"text-base font-medium text-gray-900 mb-1",children:"沒有採購項目"}),r.jsx("p",{className:"text-sm text-gray-500 text-center",children:"此採購單目前沒有包含任何項目"})]})})]}),(0,r.jsxs)(A.Zb,{className:"mb-4 sm:mb-6 border-0 shadow-lg",children:[(0,r.jsxs)(A.Ol,{className:"pb-3 sm:pb-6",children:[(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[(0,r.jsxs)(A.ll,{className:"flex items-center gap-2 text-lg sm:text-xl",children:[r.jsx(N.Z,{className:"h-5 w-5 text-amber-600"}),"其他費用"]}),"已收貨"!==$.status&&(0,r.jsxs)(P.z,{onClick:()=>X(!0),className:"bg-amber-600 hover:bg-amber-700 text-white w-full sm:w-auto",children:[r.jsx(y.Z,{className:"mr-2 h-4 w-4"}),"增加其他費用"]})]}),r.jsx(A.SZ,{children:"運費、關稅或其他額外費用"})]}),r.jsx(A.aY,{children:Q.length>0?r.jsx("div",{className:"space-y-3",children:Q.map(e=>(0,r.jsxs)("div",{className:"flex items-center justify-between p-3 bg-amber-50 rounded-lg border border-amber-200",children:[(0,r.jsxs)("div",{className:"flex-1",children:[r.jsx("div",{className:"font-medium text-gray-900",children:e.name}),e.description&&r.jsx("div",{className:"text-sm text-gray-600 mt-1",children:e.description}),(0,r.jsxs)("div",{className:"text-sm text-gray-500 mt-1",children:[e.quantity," ",e.unit]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsxs)("span",{className:"font-semibold text-amber-600",children:["NT$ ",(e.amount*e.quantity).toLocaleString()]}),"已收貨"!==$.status&&r.jsx(P.z,{variant:"ghost",size:"sm",onClick:()=>en(e.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:r.jsx(v.Z,{className:"h-4 w-4"})})]})]},e.id))}):r.jsx("div",{className:"text-center py-8 text-gray-500",children:"目前沒有其他費用"})})]}),(0,r.jsxs)(A.Zb,{className:"mb-4 sm:mb-6 border-0 shadow-lg bg-gradient-to-r from-amber-50 to-orange-50 border-amber-200",children:[(0,r.jsxs)(A.Ol,{className:"pb-3 sm:pb-6",children:[(0,r.jsxs)(A.ll,{className:"flex items-center gap-2 text-lg sm:text-xl text-amber-800",children:[r.jsx(w.Z,{className:"h-5 w-5"}),"留言記錄",(0,r.jsxs)(k.C,{variant:"secondary",className:"ml-2",children:[V.length," 則留言"]})]}),r.jsx(A.SZ,{children:"採購單相關的留言和備註"})]}),(0,r.jsxs)(A.aY,{children:[(0,r.jsxs)("div",{className:"mb-4 sm:mb-6 p-3 sm:p-4 bg-white rounded-lg border border-amber-200",children:[(0,r.jsxs)("div",{className:"mb-4",children:[r.jsx("label",{className:"text-sm font-medium text-gray-700",children:"新增留言"}),r.jsx(Z.g,{placeholder:"輸入留言內容...",value:K,onChange:e=>Y(e.target.value),className:"mt-1 min-h-[100px] resize-none"})]}),(0,r.jsxs)("div",{className:"mb-4",children:[r.jsx("label",{className:"text-sm font-medium text-gray-700 mb-2 block",children:"上傳圖片"}),(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2",children:[(0,r.jsxs)(P.z,{variant:"outline",onClick:()=>document.getElementById("purchase-image-upload")?.click(),className:"border-amber-300 text-amber-700 hover:bg-amber-50 w-full sm:w-auto",children:[r.jsx(C.Z,{className:"mr-2 h-4 w-4"}),"選擇圖片"]}),r.jsx("input",{id:"purchase-image-upload",type:"file",multiple:!0,accept:"image/*",onChange:ed,className:"hidden"}),r.jsx("span",{className:"text-sm text-gray-500 text-center sm:text-left",children:"可選擇多張圖片 (每張最大 2MB)"})]}),U.length>0&&(0,r.jsxs)("div",{className:"mt-3",children:[(0,r.jsxs)("label",{className:"text-sm font-medium text-gray-700 mb-2 block",children:["已選擇的圖片 (",U.length," 張)"]}),r.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:U.map((e,s)=>(0,r.jsxs)("div",{className:"relative group",children:[r.jsx("img",{src:e,alt:`圖片 ${s+1}`,className:"w-full h-20 sm:h-24 object-cover rounded-lg border cursor-pointer",onClick:()=>{let s=document.createElement("div");s.className="fixed inset-0 z-50 flex items-center justify-center bg-black/80",s.onclick=()=>s.remove();let t=document.createElement("img");t.src=e,t.className="max-w-[90vw] max-h-[90vh] object-contain rounded-lg",t.onclick=e=>e.stopPropagation(),s.appendChild(t),document.body.appendChild(s)}}),r.jsx(P.z,{variant:"destructive",size:"sm",onClick:()=>em(s),className:"absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity h-6 w-6 p-0",children:r.jsx(v.Z,{className:"h-3 w-3"})})]},s))})]})]}),(0,r.jsxs)(P.z,{onClick:eo,disabled:!K.trim()&&0===U.length,className:"bg-amber-600 hover:bg-amber-700 w-full sm:w-auto",children:[r.jsx(w.Z,{className:"mr-2 h-4 w-4"}),"新增留言"]})]}),r.jsx("div",{className:"space-y-4",children:0===V.length?(0,r.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[r.jsx(w.Z,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),r.jsx("p",{children:"尚無留言記錄"})]}):V.map(e=>(0,r.jsxs)("div",{className:"bg-white rounded-lg border border-amber-200 p-3 sm:p-4",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 min-w-0 flex-1",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[r.jsx(b.Z,{className:"h-4 w-4 text-gray-500 flex-shrink-0"}),r.jsx("span",{className:"font-medium text-gray-700 truncate",children:e.createdBy})]}),r.jsx("span",{className:"text-sm text-gray-500",children:new Date(e.createdAt).toLocaleString()})]}),r.jsx(P.z,{variant:"ghost",size:"sm",onClick:()=>ex(e.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50 flex-shrink-0 ml-2",children:r.jsx(g.Z,{className:"h-4 w-4"})})]}),e.text&&r.jsx("div",{className:"mb-3 text-gray-700 whitespace-pre-wrap break-words",children:e.text}),e.images.length>0&&r.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:e.images.map((e,s)=>r.jsx("div",{className:"relative group",children:r.jsx("img",{src:e,alt:`留言圖片 ${s+1}`,className:"w-full h-20 sm:h-24 object-cover rounded-lg border cursor-pointer",onClick:()=>{let s=document.createElement("div");s.className="fixed inset-0 z-50 flex items-center justify-center bg-black/80",s.onclick=()=>s.remove();let t=document.createElement("img");t.src=e,t.className="max-w-[90vw] max-h-[90vh] object-contain rounded-lg",t.onclick=e=>e.stopPropagation(),s.appendChild(t),document.body.appendChild(s)}})},s))})]},e.id))})]})]}),$&&r.jsx(F,{isOpen:M,onOpenChange:R,onSuccess:()=>el($.id),purchaseOrder:$}),r.jsx(z.Vq,{open:J,onOpenChange:X,children:(0,r.jsxs)(z.cZ,{className:"w-[95vw] max-w-md sm:max-w-lg",children:[(0,r.jsxs)(z.fK,{children:[r.jsx(z.$N,{className:"text-lg sm:text-xl",children:"增加其他費用"}),r.jsx(z.Be,{children:"添加運費、關稅或其他額外費用項目"})]}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[r.jsx("label",{className:"text-sm font-medium text-gray-700",children:"費用名稱"}),r.jsx(S.I,{placeholder:"例如：運費、關稅、手續費",value:er.name,onChange:e=>ea(s=>({...s,name:e.target.value}))})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[r.jsx("label",{className:"text-sm font-medium text-gray-700",children:"單價 (NT$)"}),r.jsx(S.I,{type:"number",placeholder:"0",value:er.amount,onChange:e=>ea(s=>({...s,amount:parseFloat(e.target.value)||0}))})]}),(0,r.jsxs)("div",{children:[r.jsx("label",{className:"text-sm font-medium text-gray-700",children:"數量"}),r.jsx(S.I,{type:"number",placeholder:"1",value:er.quantity,onChange:e=>ea(s=>({...s,quantity:parseInt(e.target.value)||1}))})]})]}),(0,r.jsxs)("div",{children:[r.jsx("label",{className:"text-sm font-medium text-gray-700",children:"單位"}),r.jsx(S.I,{placeholder:"例如：次、件、公斤",value:er.unit,onChange:e=>ea(s=>({...s,unit:e.target.value}))})]}),(0,r.jsxs)("div",{children:[r.jsx("label",{className:"text-sm font-medium text-gray-700",children:"描述 (選填)"}),r.jsx(Z.g,{placeholder:"費用的詳細說明...",value:er.description||"",onChange:e=>ea(s=>({...s,description:e.target.value})),rows:3})]})]}),(0,r.jsxs)(z.cN,{className:"flex flex-col sm:flex-row gap-2",children:[r.jsx(P.z,{variant:"outline",onClick:()=>X(!1),className:"w-full sm:w-auto",children:"取消"}),r.jsx(P.z,{onClick:()=>{if(!er.name||er.amount<=0){d.Am.error("請填寫費用名稱和金額");return}let e={id:Date.now().toString(),...er};L(s=>[...s,e]),ea({name:"",amount:0,quantity:1,unit:"項",description:""}),X(!1),d.Am.success("已添加其他費用")},className:"bg-amber-600 hover:bg-amber-700 text-white w-full sm:w-auto",children:"添加費用"})]})]})}),r.jsx(z.Vq,{open:W,onOpenChange:ee,children:(0,r.jsxs)(z.cZ,{className:"w-[95vw] max-w-md sm:max-w-lg",children:[(0,r.jsxs)(z.fK,{children:[r.jsx(z.$N,{className:"text-red-600 text-lg sm:text-xl",children:"刪除採購單"}),r.jsx(z.Be,{children:"此操作將永久刪除此採購單及其所有相關資料，包括："})]}),(0,r.jsxs)("div",{className:"space-y-3",children:[r.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:(0,r.jsxs)("ul",{className:"text-sm text-red-700 space-y-1",children:[r.jsx("li",{children:"• 採購單基本資訊"}),r.jsx("li",{children:"• 所有採購項目"}),r.jsx("li",{children:"• 其他費用項目"}),r.jsx("li",{children:"• 所有留言記錄"}),r.jsx("li",{children:"• 所有相關圖片"})]})}),(0,r.jsxs)("div",{className:"text-sm text-gray-600",children:[r.jsx("strong",{children:"採購單編號："})," ",$?.code]}),(0,r.jsxs)("div",{className:"text-sm text-gray-600",children:[r.jsx("strong",{children:"供應商："})," ",$?.supplierName]}),(0,r.jsxs)("div",{className:"text-sm text-gray-600",children:[r.jsx("strong",{children:"留言數量："})," ",V.length," 則"]}),(0,r.jsxs)("div",{className:"text-sm text-gray-600",children:[r.jsx("strong",{children:"圖片數量："})," ",V.flatMap(e=>e.images).length," 張"]})]}),(0,r.jsxs)(z.cN,{className:"flex flex-col sm:flex-row gap-2",children:[r.jsx(P.z,{variant:"outline",onClick:()=>ee(!1),disabled:es,className:"w-full sm:w-auto",children:"取消"}),r.jsx(P.z,{onClick:eh,disabled:es,variant:"destructive",className:"bg-red-600 hover:bg-red-700 w-full sm:w-auto",children:es?(0,r.jsxs)(r.Fragment,{children:[r.jsx(o.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"刪除中..."]}):(0,r.jsxs)(r.Fragment,{children:[r.jsx(g.Z,{className:"mr-2 h-4 w-4"}),"確認刪除"]})})]})]})})]}):r.jsx("div",{className:"text-center py-10",children:"無法載入採購單資料。"})}},9969:(e,s,t)=>{"use strict";t.d(s,{NI:()=>p,Wi:()=>o,l0:()=>d,lX:()=>g,xJ:()=>u,zG:()=>j});var r=t(10326),a=t(17577),l=t(34214),i=t(74723),c=t(51223),n=t(44794);let d=i.RV,m=a.createContext({}),o=({...e})=>r.jsx(m.Provider,{value:{name:e.name},children:r.jsx(i.Qr,{...e})}),x=()=>{let e=a.useContext(m),s=a.useContext(h),{getFieldState:t}=(0,i.Gc)(),r=(0,i.cl)({name:e.name}),l=t(e.name,r);if(!e)throw Error("useFormField should be used within <FormField>");let{id:c}=s;return{id:c,name:e.name,formItemId:`${c}-form-item`,formDescriptionId:`${c}-form-item-description`,formMessageId:`${c}-form-item-message`,...l}},h=a.createContext({});function u({className:e,...s}){let t=a.useId();return r.jsx(h.Provider,{value:{id:t},children:r.jsx("div",{"data-slot":"form-item",className:(0,c.cn)("grid gap-2",e),...s})})}function g({className:e,...s}){let{error:t,formItemId:a}=x();return r.jsx(n._,{"data-slot":"form-label","data-error":!!t,className:(0,c.cn)("data-[error=true]:text-destructive",e),htmlFor:a,...s})}function p({...e}){let{error:s,formItemId:t,formDescriptionId:a,formMessageId:i}=x();return r.jsx(l.g7,{"data-slot":"form-control",id:t,"aria-describedby":s?`${a} ${i}`:`${a}`,"aria-invalid":!!s,...e})}function j({className:e,...s}){let{error:t,formMessageId:a}=x(),l=t?String(t?.message??""):s.children;return l?r.jsx("p",{"data-slot":"form-message",id:a,className:(0,c.cn)("text-destructive text-sm",e),...s,children:l}):null}},96333:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>r});let r=(0,t(68570).createProxy)(String.raw`D:\APP\deer-lab\src\app\dashboard\purchase-orders\[id]\page.tsx#default`)}};var s=require("../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[8948,9654,5540,8693,9516,4108,4334,5182],()=>t(21626));module.exports=r})();