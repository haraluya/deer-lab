(()=>{var e={};e.id=1148,e.ids=[1148],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},84770:e=>{"use strict";e.exports=require("crypto")},80665:e=>{"use strict";e.exports=require("dns")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},32694:e=>{"use strict";e.exports=require("http2")},98216:e=>{"use strict";e.exports=require("net")},19801:e=>{"use strict";e.exports=require("os")},55315:e=>{"use strict";e.exports=require("path")},35816:e=>{"use strict";e.exports=require("process")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},16437:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>i.a,__next_app__:()=>x,originalPathname:()=>m,pages:()=>o,routeModule:()=>u,tree:()=>c}),s(95521),s(22834),s(62510),s(35866);var a=s(23191),r=s(88716),l=s(37922),i=s.n(l),n=s(95231),d={};for(let e in n)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(d[e]=()=>n[e]);s.d(t,d);let c=["",{children:["dashboard",{children:["work-orders",{children:["[id]",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,95521)),"D:\\APP\\deer-lab\\src\\app\\dashboard\\work-orders\\[id]\\page.tsx"]}]},{}]},{}]},{layout:[()=>Promise.resolve().then(s.bind(s,22834)),"D:\\APP\\deer-lab\\src\\app\\dashboard\\layout.tsx"],metadata:{icon:[async e=>(await Promise.resolve().then(s.bind(s,73881))).default(e)],apple:[],openGraph:[],twitter:[],manifest:void 0}}]},{layout:[()=>Promise.resolve().then(s.bind(s,62510)),"D:\\APP\\deer-lab\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,35866,23)),"next/dist/client/components/not-found-error"],metadata:{icon:[async e=>(await Promise.resolve().then(s.bind(s,73881))).default(e)],apple:[],openGraph:[],twitter:[],manifest:void 0}}],o=["D:\\APP\\deer-lab\\src\\app\\dashboard\\work-orders\\[id]\\page.tsx"],m="/dashboard/work-orders/[id]/page",x={require:s,loadChunk:()=>Promise.resolve()},u=new a.AppPageRouteModule({definition:{kind:r.x.APP_PAGE,page:"/dashboard/work-orders/[id]/page",pathname:"/dashboard/work-orders/[id]",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:c}})},40035:(e,t,s)=>{Promise.resolve().then(s.bind(s,90562))},72257:(e,t,s)=>{"use strict";s.d(t,{Z:()=>a});let a=(0,s(62881).Z)("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]])},41291:(e,t,s)=>{"use strict";s.d(t,{Z:()=>a});let a=(0,s(62881).Z)("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]])},10591:(e,t,s)=>{"use strict";s.d(t,{Z:()=>a});let a=(0,s(62881).Z)("Droplets",[["path",{d:"M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z",key:"1ptgy4"}],["path",{d:"M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97",key:"1sl1rz"}]])},21405:(e,t,s)=>{"use strict";s.d(t,{Z:()=>a});let a=(0,s(62881).Z)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]])},31215:(e,t,s)=>{"use strict";s.d(t,{Z:()=>a});let a=(0,s(62881).Z)("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]])},69508:(e,t,s)=>{"use strict";s.d(t,{Z:()=>a});let a=(0,s(62881).Z)("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]])},81538:(e,t,s)=>{"use strict";s.d(t,{Z:()=>a});let a=(0,s(62881).Z)("Timer",[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]])},50949:(e,t,s)=>{"use strict";s.d(t,{Z:()=>a});let a=(0,s(62881).Z)("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},24061:(e,t,s)=>{"use strict";s.d(t,{Z:()=>a});let a=(0,s(62881).Z)("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]])},94019:(e,t,s)=>{"use strict";s.d(t,{Z:()=>a});let a=(0,s(62881).Z)("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]])},3634:(e,t,s)=>{"use strict";s.d(t,{Z:()=>a});let a=(0,s(62881).Z)("Zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]])},90562:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>Y});var a=s(10326),r=s(17577),l=s(35047),i=s(76),n=s(90445),d=s(85999),c=s(27467),o=s(33741),m=s(49527),x=s(77506),u=s(86333),h=s(62881);let g=(0,h.Z)("Printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]);var p=s(32933),f=s(98091),b=s(48705),j=s(72257),N=s(31215),v=s(69508),y=s(10591),w=s(21405),k=s(94019),M=s(48998),D=s(40617),C=s(63685),S=s(79635),A=s(41291),O=s(50949),T=s(91664),Z=s(29752),z=s(38443),$=s(41156),E=s(29280),Q=s(41190),I=s(44794),_=s(82015),F=s(24118),P=s(48238),q=s(24061),R=s(83855),B=s(37358);let G=(0,h.Z)("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);var K=s(3634),V=s(81538),H=s(96633),L=s(941);function W({isOpen:e,onOpenChange:t,workOrderId:s,workOrderNumber:l,isLocked:c=!1}){let[o,m]=(0,r.useState)([]),[u,h]=(0,r.useState)([]),[g,p]=(0,r.useState)(!0),[b,j]=(0,r.useState)(!1),[v,y]=(0,r.useState)(null),[w,D]=(0,r.useState)(new Set),[C,A]=(0,r.useState)(!1),[_,W]=(0,r.useState)([]),[U,Y]=(0,r.useState)({personnelId:"",startDate:"",startTime:"",endDate:"",endTime:"",notes:""}),[X,J]=(0,r.useState)(null),ee=async(e=0)=>{p(!0);try{if(!n.db)throw Error("Firebase 未初始化");if(!s)throw Error("工單ID未提供");console.log("開始載入工時申報資料，工單ID:",s),console.log("載入人員資料...");let e=(await (0,i.getDocs)((0,i.collection)(n.db,"users"))).docs.map(e=>{let t=e.data();return{id:e.id,name:t.name||"未命名",employeeId:t.employeeId||"",...t}}).filter(e=>e.name&&"未命名"!==e.name);console.log("人員資料載入成功，共",e.length,"人"),m(e),console.log("載入工時記錄...");try{let e=(0,i.query)((0,i.collection)(n.db,"timeEntries"),(0,i.where)("workOrderId","==",s),(0,i.Xo)("createdAt","desc")),t=(await (0,i.getDocs)(e)).docs.map(e=>({id:e.id,...e.data()}));console.log("工時記錄載入成功，共",t.length,"筆記錄"),h(t)}catch(a){console.warn("複合索引查詢失敗，改用簡單查詢:",a);let e=(0,i.query)((0,i.collection)(n.db,"timeEntries"),(0,i.where)("workOrderId","==",s)),t=(await (0,i.getDocs)(e)).docs.map(e=>({id:e.id,...e.data()})).sort((e,t)=>{let s=e.createdAt?.toDate?.()||new Date(e.createdAt||0);return(t.createdAt?.toDate?.()||new Date(t.createdAt||0)).getTime()-s.getTime()});console.log("簡化查詢成功，共",t.length,"筆記錄"),h(t)}d.Am.success("工時資料載入完成")}catch(s){if(console.error("載入資料失敗:",s),e<2&&!s.message?.includes("權限")){console.log(`載入失敗，${2-e} 秒後重試...`),d.Am.loading("載入失敗，正在重試..."),setTimeout(()=>ee(e+1),2e3);return}let t="載入資料失敗";"permission-denied"===s.code?t="權限不足，請檢查登入狀態":"unavailable"===s.code?t="網路連線問題，請檢查網路連線":s.message?.includes("索引")?t="資料庫索引問題，請聯絡系統管理員":s.message&&(t=`載入失敗: ${s.message}`),d.Am.error(t)}finally{p(!1)}},et=(e,t,s,a)=>{if(!e||!t||!s||!a)return 0;let r=new Date(`${e}T${t}`);return(new Date(`${s}T${a}`).getTime()-r.getTime())/36e5},es=async()=>{if(c){d.Am.error("工單已入庫，無法新增工時記錄");return}if(C){if(0===_.length||!U.startDate||!U.startTime||!U.endDate||!U.endTime){d.Am.error("請選擇人員並填寫完整時間資訊");return}let e=[];if(_.forEach(t=>{let s=o.find(e=>e.id===t);s&&er(t,U.startDate,U.startTime,U.endDate,U.endTime)&&e.push(s.name)}),e.length>0){d.Am.error(`以下人員時間有重疊，無法新增：${e.join(", ")}`);return}let t=et(U.startDate,U.startTime,U.endDate,U.endTime);if(t<=0){d.Am.error("結束時間必須晚於開始時間");return}j(!0);try{let e=_.map(async e=>{let a=o.find(t=>t.id===e);if(!a)return;let r={workOrderId:s,workOrderNumber:l,personnelId:e,personnelName:a.name,startDate:U.startDate,startTime:U.startTime,endDate:U.endDate,endTime:U.endTime,startDateTime:i.EK.fromDate(new Date(`${U.startDate}T${U.startTime}`)),endDateTime:i.EK.fromDate(new Date(`${U.endDate}T${U.endTime}`)),duration:t,overtimeHours:ea(t),notes:U.notes,status:"draft",createdAt:i.EK.now(),updatedAt:i.EK.now()};await (0,i.addDoc)((0,i.collection)(n.db,"timeEntries"),r)});await Promise.all(e),d.Am.success(`已批量新增 ${_.length} 筆工時記錄`),W([])}catch(e){console.error("批量新增工時記錄失敗:",e),d.Am.error("批量新增工時記錄失敗")}finally{j(!1),ee()}}else{if(!U.personnelId||!U.startDate||!U.startTime||!U.endDate||!U.endTime){d.Am.error("請填寫完整資訊");return}let e=et(U.startDate,U.startTime,U.endDate,U.endTime);if(e<=0){d.Am.error("結束時間必須晚於開始時間");return}if(er(U.personnelId,U.startDate,U.startTime,U.endDate,U.endTime)){d.Am.error("此時間段與該人員的其他工時記錄重疊，請調整時間");return}let t=o.find(e=>e.id===U.personnelId);if(!t){d.Am.error("找不到指定人員");return}j(!0);try{let a={workOrderId:s,workOrderNumber:l,personnelId:U.personnelId,personnelName:t.name,startDate:U.startDate,startTime:U.startTime,endDate:U.endDate,endTime:U.endTime,startDateTime:i.EK.fromDate(new Date(`${U.startDate}T${U.startTime}`)),endDateTime:i.EK.fromDate(new Date(`${U.endDate}T${U.endTime}`)),duration:e,overtimeHours:ea(e),notes:U.notes,status:"draft",createdAt:i.EK.now(),updatedAt:i.EK.now()};await (0,i.addDoc)((0,i.collection)(n.db,"timeEntries"),a),d.Am.success("工時記錄已新增")}catch(e){console.error("新增工時記錄失敗:",e),d.Am.error("新增工時記錄失敗")}finally{j(!1),ee()}}Y({personnelId:"",startDate:"",startTime:"",endDate:"",endTime:"",notes:""})},ea=e=>Math.max(0,e-8),er=(e,t,s,a,r,l)=>{let i=new Date(`${t}T${s}`),n=new Date(`${a}T${r}`);return u.some(t=>{if(l&&t.id===l||t.personnelId!==e)return!1;let s=new Date(`${t.startDate}T${t.startTime}`);return i<new Date(`${t.endDate}T${t.endTime}`)&&n>s})},el=async e=>{if(c){d.Am.error("工單已入庫，無法編輯工時記錄");return}y(e.id),J({...e,startDate:e.startDate,startTime:e.startTime,endDate:e.endDate,endTime:e.endTime})},ei=async()=>{if(!X||!v)return;let e=et(X.startDate,X.startTime,X.endDate,X.endTime);if(e<=0){d.Am.error("結束時間必須晚於開始時間");return}j(!0);try{await (0,i.r7)((0,i.doc)(n.db,"timeEntries",v),{startDate:X.startDate,startTime:X.startTime,endDate:X.endDate,endTime:X.endTime,startDateTime:i.EK.fromDate(new Date(`${X.startDate}T${X.startTime}`)),endDateTime:i.EK.fromDate(new Date(`${X.endDate}T${X.endTime}`)),duration:e,overtimeHours:ea(e),notes:X.notes,updatedAt:i.EK.now()}),d.Am.success("工時記錄已更新"),y(null),J(null),ee()}catch(e){console.error("更新工時記錄失敗:",e),d.Am.error("更新工時記錄失敗")}finally{j(!1)}},en=async e=>{if(c){d.Am.error("工單已入庫，無法刪除工時記錄");return}if(confirm("確定要刪除這筆工時記錄嗎？"))try{await (0,i.deleteDoc)((0,i.doc)(n.db,"timeEntries",e)),d.Am.success("工時記錄已刪除"),ee()}catch(e){console.error("刪除工時記錄失敗:",e),d.Am.error("刪除工時記錄失敗")}},ed=e=>{let t=new Set(w);t.has(e)?t.delete(e):t.add(e),D(t)},ec=e=>e.substring(0,5),eo=e=>{let t=Math.floor(e),s=Math.round((e-t)*60);return`${t}小時${s>0?`${s}分鐘`:""}`};return a.jsx(F.Vq,{open:e,onOpenChange:t,children:(0,a.jsxs)(F.cZ,{className:"max-w-4xl sm:max-w-4xl max-w-[calc(100vw-1rem)] max-h-[90vh] sm:max-h-[80vh] overflow-y-auto","aria-describedby":"time-tracking-dialog-description",children:[(0,a.jsxs)(F.fK,{children:[(0,a.jsxs)(F.$N,{className:"flex items-center gap-2",children:[a.jsx(M.Z,{className:"h-5 w-5"}),"工時追蹤"]}),a.jsx(F.Be,{id:"time-tracking-dialog-description",children:"記錄工單的工時資訊，包含人員、時間段和備註"})]}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[(0,a.jsxs)(Z.Zb,{className:"relative overflow-hidden bg-gradient-to-br from-blue-50 to-indigo-100 border-2 border-blue-200",children:[a.jsx(Z.Ol,{className:"pb-2",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[a.jsx(Z.ll,{className:"text-sm font-bold text-blue-800",children:"總記錄數"}),a.jsx("div",{className:"p-2 bg-blue-500 rounded-lg",children:a.jsx(P.Z,{className:"h-4 w-4 text-white"})})]})}),(0,a.jsxs)(Z.aY,{children:[a.jsx("div",{className:"text-3xl font-bold text-blue-900 mb-1",children:u.length}),a.jsx("p",{className:"text-xs text-blue-600 font-medium",children:"筆工時記錄"})]}),a.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-transparent to-blue-600/10 pointer-events-none"})]}),(0,a.jsxs)(Z.Zb,{className:"relative overflow-hidden bg-gradient-to-br from-emerald-50 to-green-100 border-2 border-emerald-200",children:[a.jsx(Z.Ol,{className:"pb-2",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[a.jsx(Z.ll,{className:"text-sm font-bold text-emerald-800",children:"總工時"}),a.jsx("div",{className:"p-2 bg-emerald-500 rounded-lg",children:a.jsx(M.Z,{className:"h-4 w-4 text-white"})})]})}),(0,a.jsxs)(Z.aY,{children:[a.jsx("div",{className:"text-3xl font-bold text-emerald-900 mb-1",children:eo(u.reduce((e,t)=>e+t.duration,0))}),a.jsx("p",{className:"text-xs text-emerald-600 font-medium",children:"累計工作時間"})]}),a.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-transparent to-emerald-600/10 pointer-events-none"})]}),(0,a.jsxs)(Z.Zb,{className:"relative overflow-hidden bg-gradient-to-br from-purple-50 to-violet-100 border-2 border-purple-200",children:[a.jsx(Z.Ol,{className:"pb-2",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[a.jsx(Z.ll,{className:"text-sm font-bold text-purple-800",children:"人工總時"}),a.jsx("div",{className:"p-2 bg-purple-500 rounded-lg",children:a.jsx(q.Z,{className:"h-4 w-4 text-white"})})]})}),(0,a.jsxs)(Z.aY,{children:[a.jsx("div",{className:"text-3xl font-bold text-purple-900 mb-1",children:eo(u.reduce((e,t)=>e+t.duration,0))}),a.jsx("p",{className:"text-xs text-purple-600 font-medium",children:"總人工工時"})]}),a.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-transparent to-purple-600/10 pointer-events-none"})]})]}),!c&&(0,a.jsxs)(Z.Zb,{className:"border-2 border-blue-100 bg-gradient-to-br from-blue-50/50 to-indigo-50/50",children:[a.jsx(Z.Ol,{children:(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)(Z.ll,{className:"flex items-center gap-2 text-blue-900",children:[a.jsx(R.Z,{className:"h-4 w-4"}),"新增工時記錄"]}),(0,a.jsxs)(T.z,{variant:C?"default":"outline",size:"sm",onClick:()=>A(!C),className:"gap-2",children:[a.jsx(q.Z,{className:"h-4 w-4"}),C?"批量模式":"單一模式"]})]})}),(0,a.jsxs)(Z.aY,{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx(I._,{className:"text-sm font-medium text-gray-700",children:C?"選擇多個人員":"選擇人員"}),C?a.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:o.map(e=>(0,a.jsxs)("label",{className:"flex items-center gap-2 p-2 rounded-lg border cursor-pointer hover:bg-blue-50 transition-colors",children:[a.jsx("input",{type:"checkbox",checked:_.includes(e.id),onChange:t=>{t.target.checked?W([..._,e.id]):W(_.filter(t=>t!==e.id))},className:"w-4 h-4 text-blue-600 rounded focus:ring-blue-500"}),(0,a.jsxs)("span",{className:"text-sm",children:[e.name,(0,a.jsxs)("span",{className:"text-xs text-gray-500 ml-1",children:["(",e.employeeId,")"]})]})]},e.id))}):(0,a.jsxs)(E.Ph,{value:U.personnelId,onValueChange:e=>Y({...U,personnelId:e}),children:[a.jsx(E.i4,{className:"bg-white",children:a.jsx(E.ki,{placeholder:"選擇人員"})}),a.jsx(E.Bw,{children:o.map(e=>(0,a.jsxs)(E.Ql,{value:e.id,children:[e.name," (",e.employeeId,")"]},e.id))})]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)(I._,{className:"text-sm font-semibold text-gray-800 flex items-center gap-2",children:[a.jsx(B.Z,{className:"h-4 w-4 text-blue-600"}),"工作日期"]}),a.jsx(Q.I,{type:"date",value:U.startDate,onChange:e=>Y({...U,startDate:e.target.value,endDate:e.target.value}),className:"bg-white border-2 border-blue-200 focus:border-blue-500 focus:ring-blue-200"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,a.jsxs)("div",{className:"space-y-4 p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border-2 border-green-200",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-green-500 rounded-lg",children:a.jsx(M.Z,{className:"h-5 w-5 text-white"})}),(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"text-lg font-bold text-green-800",children:"上班時間"}),a.jsx("p",{className:"text-xs text-green-600",children:"設定開始工作時間"})]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[a.jsx(I._,{className:"text-sm font-medium text-green-700",children:"時間 (24小時制)"}),(0,a.jsxs)("div",{className:"relative",children:[a.jsx(Q.I,{type:"time",value:U.startTime,onChange:e=>Y({...U,startTime:e.target.value}),step:"60",className:"text-lg font-mono bg-white border-2 border-green-300 focus:border-green-500 focus:ring-green-200 pl-12 text-black [&::-webkit-calendar-picker-indicator]:opacity-100 [&::-webkit-calendar-picker-indicator]:cursor-pointer [&::-webkit-datetime-edit]:text-black [&::-webkit-datetime-edit-text]:text-black [&::-webkit-datetime-edit-hour-field]:text-black [&::-webkit-datetime-edit-minute-field]:text-black [&::-webkit-datetime-edit-ampm-field]:display-none",style:{colorScheme:"light",color:"#000000 !important",WebkitTextFillColor:"#000000 !important",opacity:1},placeholder:"09:00"}),a.jsx(M.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-green-500"})]}),a.jsx("p",{className:"text-xs text-green-600 bg-green-100 p-2 rounded",children:"格式：HH:MM (例如：09:30, 14:00)"})]})]}),(0,a.jsxs)("div",{className:"space-y-4 p-6 bg-gradient-to-br from-red-50 to-pink-50 rounded-xl border-2 border-red-200",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-red-500 rounded-lg",children:a.jsx(M.Z,{className:"h-5 w-5 text-white"})}),(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"text-lg font-bold text-red-800",children:"下班時間"}),a.jsx("p",{className:"text-xs text-red-600",children:"設定結束工作時間"})]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[a.jsx(I._,{className:"text-sm font-medium text-red-700",children:"時間 (24小時制)"}),(0,a.jsxs)("div",{className:"relative",children:[a.jsx(Q.I,{type:"time",value:U.endTime,onChange:e=>Y({...U,endTime:e.target.value,endDate:U.startDate}),step:"60",className:"text-lg font-mono bg-white border-2 border-red-300 focus:border-red-500 focus:ring-red-200 pl-12 text-black [&::-webkit-calendar-picker-indicator]:opacity-100 [&::-webkit-calendar-picker-indicator]:cursor-pointer [&::-webkit-datetime-edit]:text-black [&::-webkit-datetime-edit-text]:text-black [&::-webkit-datetime-edit-hour-field]:text-black [&::-webkit-datetime-edit-minute-field]:text-black [&::-webkit-datetime-edit-ampm-field]:display-none",style:{colorScheme:"light",color:"#000000 !important",WebkitTextFillColor:"#000000 !important",opacity:1},placeholder:"18:00"}),a.jsx(M.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-red-500"})]}),a.jsx("p",{className:"text-xs text-red-600 bg-red-100 p-2 rounded",children:"格式：HH:MM (例如：17:30, 18:00)"})]})]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)(I._,{className:"text-sm font-semibold text-gray-800 flex items-center gap-2",children:[a.jsx(G,{className:"h-4 w-4 text-purple-600"}),"備註說明"]}),(0,a.jsxs)("div",{className:"relative",children:[a.jsx(Q.I,{placeholder:"輸入工作內容或特殊註意事項...",value:U.notes,onChange:e=>Y({...U,notes:e.target.value}),className:"bg-gradient-to-r from-white to-purple-50 border-2 border-purple-200 focus:border-purple-500 focus:ring-purple-200 pl-10"}),a.jsx(G,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-purple-500"})]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)(I._,{className:"text-sm font-semibold text-gray-800 flex items-center gap-2",children:[a.jsx(K.Z,{className:"h-4 w-4 text-yellow-600"}),"快速設定"]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[(0,a.jsxs)(T.z,{type:"button",variant:"outline",size:"sm",onClick:()=>Y({...U,startTime:"09:00",endTime:"18:00"}),className:"gap-2 bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200 hover:from-blue-100 hover:to-indigo-100",children:[a.jsx(M.Z,{className:"h-3 w-3"}),"日班 9-6"]}),(0,a.jsxs)(T.z,{type:"button",variant:"outline",size:"sm",onClick:()=>Y({...U,startTime:"08:00",endTime:"17:00"}),className:"gap-2 bg-gradient-to-r from-green-50 to-emerald-50 border-green-200 hover:from-green-100 hover:to-emerald-100",children:[a.jsx(M.Z,{className:"h-3 w-3"}),"早班 8-5"]}),(0,a.jsxs)(T.z,{type:"button",variant:"outline",size:"sm",onClick:()=>Y({...U,startTime:"14:00",endTime:"22:00"}),className:"gap-2 bg-gradient-to-r from-purple-50 to-violet-50 border-purple-200 hover:from-purple-100 hover:to-violet-100",children:[a.jsx(M.Z,{className:"h-3 w-3"}),"晚班 2-10"]}),(0,a.jsxs)(T.z,{type:"button",variant:"outline",size:"sm",onClick:()=>Y({...U,startTime:"09:00",endTime:"13:00"}),className:"gap-2 bg-gradient-to-r from-orange-50 to-amber-50 border-orange-200 hover:from-orange-100 hover:to-amber-100",children:[a.jsx(M.Z,{className:"h-3 w-3"}),"上半日"]})]})]}),U.startDate&&U.startTime&&U.endDate&&U.endTime&&(0,a.jsxs)("div",{className:"p-6 bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 rounded-xl border-2 border-orange-200",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-orange-500 rounded-lg",children:a.jsx(V.Z,{className:"h-5 w-5 text-white"})}),(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"text-lg font-bold text-orange-900",children:"工時計算"}),a.jsx("p",{className:"text-xs text-orange-600",children:"自動計算工作時間"})]})]}),(0,a.jsxs)("div",{className:"text-right",children:[a.jsx("div",{className:"text-3xl font-bold text-orange-900",children:eo(et(U.startDate,U.startTime,U.endDate,U.endTime))}),a.jsx("p",{className:"text-xs text-orange-600",children:"總工時"})]})]}),ea(et(U.startDate,U.startTime,U.endDate,U.endTime))>0&&(0,a.jsxs)("div",{className:"flex items-center justify-between p-3 bg-red-100 rounded-lg border border-red-200",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx(O.Z,{className:"h-4 w-4 text-red-600"}),a.jsx("span",{className:"text-sm font-medium text-red-800",children:"加班時数："})]}),a.jsx("div",{className:"text-lg font-bold text-red-800",children:eo(ea(et(U.startDate,U.startTime,U.endDate,U.endTime)))})]})]}),a.jsx(T.z,{onClick:es,disabled:b||(C?0===_.length:!U.personnelId)||!U.startDate||!U.startTime||!U.endDate||!U.endTime,className:"w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700",size:"lg",children:b?(0,a.jsxs)(a.Fragment,{children:[a.jsx(x.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"新增中..."]}):(0,a.jsxs)(a.Fragment,{children:[a.jsx(R.Z,{className:"mr-2 h-4 w-4"}),C?`批量新增 ${_.length} 筆記錄`:"新增工時記錄"]})})]})]}),(0,a.jsxs)(Z.Zb,{children:[(0,a.jsxs)(Z.Ol,{children:[(0,a.jsxs)(Z.ll,{className:"flex items-center gap-2",children:[a.jsx(P.Z,{className:"h-5 w-5"}),"工時記錄"]}),(0,a.jsxs)(Z.SZ,{children:["所有已記錄的工時資訊 ",c&&a.jsx(z.C,{variant:"destructive",className:"ml-2",children:"已鎖定"})]})]}),a.jsx(Z.aY,{children:g?a.jsx("div",{className:"flex justify-center items-center py-8",children:a.jsx(x.Z,{className:"h-6 w-6 animate-spin text-gray-400"})}):0===u.length?(0,a.jsxs)("div",{className:"text-center py-8 text-muted-foreground",children:[a.jsx(M.Z,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),a.jsx("p",{children:"尚無工時記錄"})]}):(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx("div",{className:"hidden md:block overflow-x-auto",children:(0,a.jsxs)($.iA,{children:[a.jsx($.xD,{children:(0,a.jsxs)($.SC,{children:[a.jsx($.ss,{className:"w-[150px]",children:"人員"}),a.jsx($.ss,{children:"開始時間"}),a.jsx($.ss,{children:"結束時間"}),a.jsx($.ss,{children:"工時"}),a.jsx($.ss,{children:"加班"}),a.jsx($.ss,{children:"備註"}),!c&&a.jsx($.ss,{className:"text-right",children:"操作"})]})}),a.jsx($.RM,{children:u.map(e=>a.jsx($.SC,{className:"hover:bg-gray-50",children:v===e.id?(0,a.jsxs)(a.Fragment,{children:[a.jsx($.pj,{children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx(S.Z,{className:"h-4 w-4 text-muted-foreground"}),a.jsx("span",{className:"font-medium",children:e.personnelName})]})}),a.jsx($.pj,{children:(0,a.jsxs)("div",{className:"flex gap-1",children:[a.jsx(Q.I,{type:"date",value:X?.startDate,onChange:e=>J({...X,startDate:e.target.value}),className:"h-8 text-xs"}),a.jsx(Q.I,{type:"time",value:X?.startTime,onChange:e=>J({...X,startTime:e.target.value}),step:"60",className:"h-8 text-xs text-black [&::-webkit-calendar-picker-indicator]:opacity-100 [&::-webkit-datetime-edit]:text-black [&::-webkit-datetime-edit-text]:text-black [&::-webkit-datetime-edit-hour-field]:text-black [&::-webkit-datetime-edit-minute-field]:text-black [&::-webkit-datetime-edit-ampm-field]:display-none",style:{colorScheme:"light",color:"#000000 !important",WebkitTextFillColor:"#000000 !important",opacity:1}})]})}),a.jsx($.pj,{children:(0,a.jsxs)("div",{className:"flex gap-1",children:[a.jsx(Q.I,{type:"date",value:X?.endDate,onChange:e=>J({...X,endDate:e.target.value}),className:"h-8 text-xs"}),a.jsx(Q.I,{type:"time",value:X?.endTime,onChange:e=>J({...X,endTime:e.target.value}),step:"60",className:"h-8 text-xs text-black [&::-webkit-calendar-picker-indicator]:opacity-100 [&::-webkit-datetime-edit]:text-black [&::-webkit-datetime-edit-text]:text-black [&::-webkit-datetime-edit-hour-field]:text-black [&::-webkit-datetime-edit-minute-field]:text-black [&::-webkit-datetime-edit-ampm-field]:display-none",style:{colorScheme:"light",color:"#000000 !important",WebkitTextFillColor:"#000000 !important",opacity:1}})]})}),a.jsx($.pj,{colSpan:2,children:a.jsx(Q.I,{value:X?.notes||"",onChange:e=>J({...X,notes:e.target.value}),placeholder:"備註",className:"h-8 text-xs"})}),a.jsx($.pj,{}),a.jsx($.pj,{className:"text-right",children:(0,a.jsxs)("div",{className:"flex gap-1 justify-end",children:[a.jsx(T.z,{size:"sm",variant:"ghost",onClick:ei,disabled:b,children:a.jsx(N.Z,{className:"h-4 w-4"})}),a.jsx(T.z,{size:"sm",variant:"ghost",onClick:()=>{y(null),J(null)},children:a.jsx(k.Z,{className:"h-4 w-4"})})]})})]}):(0,a.jsxs)(a.Fragment,{children:[a.jsx($.pj,{children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx(S.Z,{className:"h-4 w-4 text-muted-foreground"}),a.jsx("span",{className:"font-medium",children:e.personnelName})]})}),(0,a.jsxs)($.pj,{className:"text-sm",children:[e.startDate," ",ec(e.startTime)]}),(0,a.jsxs)($.pj,{className:"text-sm",children:[e.endDate," ",ec(e.endTime)]}),a.jsx($.pj,{children:a.jsx(z.C,{variant:"outline",className:"bg-blue-50",children:eo(e.duration)})}),a.jsx($.pj,{children:e.overtimeHours&&e.overtimeHours>0?a.jsx(z.C,{variant:"destructive",className:"bg-red-50 text-red-700",children:eo(e.overtimeHours)}):a.jsx("span",{className:"text-gray-400",children:"-"})}),a.jsx($.pj,{className:"text-sm text-gray-600",children:e.notes||"-"}),!c&&a.jsx($.pj,{className:"text-right",children:(0,a.jsxs)("div",{className:"flex gap-1 justify-end",children:[a.jsx(T.z,{size:"sm",variant:"ghost",onClick:()=>el(e),children:a.jsx(G,{className:"h-4 w-4"})}),a.jsx(T.z,{size:"sm",variant:"ghost",onClick:()=>en(e.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:a.jsx(f.Z,{className:"h-4 w-4"})})]})})]})},e.id))})]})}),a.jsx("div",{className:"md:hidden space-y-3",children:u.map(e=>a.jsx(Z.Zb,{className:"overflow-hidden",children:(0,a.jsxs)("div",{className:"p-4 cursor-pointer hover:bg-gray-50",onClick:()=>ed(e.id),children:[(0,a.jsxs)("div",{className:"flex justify-between items-start",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx(S.Z,{className:"h-4 w-4 text-muted-foreground"}),a.jsx("span",{className:"font-medium",children:e.personnelName})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx(z.C,{variant:"outline",className:"bg-blue-50",children:eo(e.duration)}),w.has(e.id)?a.jsx(H.Z,{className:"h-4 w-4 text-gray-400"}):a.jsx(L.Z,{className:"h-4 w-4 text-gray-400"})]})]}),w.has(e.id)&&(0,a.jsxs)("div",{className:"mt-3 pt-3 border-t space-y-2",children:[(0,a.jsxs)("div",{className:"flex justify-between text-sm",children:[a.jsx("span",{className:"text-gray-600",children:"開始："}),(0,a.jsxs)("span",{children:[e.startDate," ",ec(e.startTime)]})]}),(0,a.jsxs)("div",{className:"flex justify-between text-sm",children:[a.jsx("span",{className:"text-gray-600",children:"結束："}),(0,a.jsxs)("span",{children:[e.endDate," ",ec(e.endTime)]})]}),e.overtimeHours&&e.overtimeHours>0&&(0,a.jsxs)("div",{className:"flex justify-between text-sm",children:[a.jsx("span",{className:"text-gray-600",children:"加班："}),a.jsx(z.C,{variant:"destructive",className:"bg-red-50 text-red-700",children:eo(e.overtimeHours)})]}),e.notes&&(0,a.jsxs)("div",{className:"text-sm",children:[a.jsx("span",{className:"text-gray-600",children:"備註："}),a.jsx("p",{className:"mt-1 text-gray-800",children:e.notes})]}),!c&&(0,a.jsxs)("div",{className:"flex gap-2 pt-2",children:[(0,a.jsxs)(T.z,{size:"sm",variant:"outline",onClick:t=>{t.stopPropagation(),el(e)},className:"flex-1",children:[a.jsx(G,{className:"h-4 w-4 mr-1"}),"編輯"]}),(0,a.jsxs)(T.z,{size:"sm",variant:"outline",onClick:t=>{t.stopPropagation(),en(e.id)},className:"flex-1 text-red-600 hover:text-red-700 hover:bg-red-50",children:[a.jsx(f.Z,{className:"h-4 w-4 mr-1"}),"刪除"]})]})]})]})},e.id))})]})})]})]})]})})}let U=[{value:"預報",label:"預報",color:"bg-orange-100 text-orange-800 border-orange-200"},{value:"進行",label:"進行",color:"bg-blue-100 text-blue-800 border-blue-200"},{value:"完工",label:"完工",color:"bg-green-100 text-green-800 border-green-200"},{value:"入庫",label:"入庫",color:"bg-purple-100 text-purple-800 border-purple-200"}];function Y(){let e=(0,l.useParams)(),t=(0,l.useRouter)(),h=e.id,[P,q]=(0,r.useState)(null),[R,B]=(0,r.useState)([]),[G,K]=(0,r.useState)([]),[V,H]=(0,r.useState)(!0),[L,Y]=(0,r.useState)(!1),[X,J]=(0,r.useState)(!1),[ee,et]=(0,r.useState)(!1),[es,ea]=(0,r.useState)({status:"",qcStatus:"",actualQuantity:0,targetQuantity:0,notes:""}),[er,el]=(0,r.useState)([]),[ei,en]=(0,r.useState)(""),[ed,ec]=(0,r.useState)([]),[eo,em]=(0,r.useState)(!1),[ex,eu]=(0,r.useState)(!1),[eh,eg]=(0,r.useState)(!1),[ep,ef]=(0,r.useState)(!1),[eb,ej]=(0,r.useState)({}),[eN,ev]=(0,r.useState)(!1),[ey,ew]=(0,r.useState)(!1),[ek,eM]=(0,r.useState)(!1),[eD,eC]=(0,r.useState)(!1),eS=e=>{if(0===e)return"0";let t=parseFloat(e.toFixed(6));return t%1==0?t.toString():parseFloat(t.toFixed(6)).toString()},eA=(e,t)=>{let s=parseFloat(parseFloat(t||"0").toFixed(6));ej(t=>({...t,[e]:s}))},eO=async()=>{if(P&&n.db)try{let e=P.billOfMaterials.map(e=>({...e,usedQuantity:void 0!==eb[e.id]?parseFloat(eb[e.id].toFixed(6)):parseFloat((e.usedQuantity||0).toFixed(6))})),t=(0,i.doc)(n.db,"workOrders",h);await (0,i.r7)(t,{billOfMaterials:e,updatedAt:i.EK.now()}),q(t=>t?{...t,billOfMaterials:e}:null),ej({}),ef(!1),d.Am.success("使用數量已更新")}catch(e){(0,o.vU)("更新使用數量失敗",e),d.Am.error("更新使用數量失敗")}},eT=e=>P?P.billOfMaterials.map(t=>{if(["fragrance","pg","vg","nicotine"].includes(t.category)&&t.ratio){let s=parseFloat((t.ratio/100*e).toFixed(6));return{...t,quantity:s,usedQuantity:parseFloat((t.usedQuantity||s).toFixed(6))}}return t}):[],eZ=e=>{ea(t=>({...t,targetQuantity:e}));let t=eT(e);q(e=>e?{...e,billOfMaterials:t}:null)},ez=async()=>{if(P&&n.db){ew(!0);try{let e=(0,i.doc)(n.db,"workOrders",h);for(let t of(await (0,i.r7)(e,{status:"完工",updatedAt:i.EK.now()}),P.billOfMaterials.filter(e=>(e.usedQuantity||0)>0))){let e=t.usedQuantity||0;if("fragrance"===t.category){let s=(0,i.doc)(n.db,"fragrances",t.id);try{let a=await (0,i.QT)(s);if(a.exists()){let r=a.data().currentStock||0,l=Math.max(0,parseFloat((r-e).toFixed(6)));await (0,i.r7)(s,{currentStock:l,updatedAt:i.EK.now()}),(0,o.fF)(`香精庫存已扣除: ${t.name}`,{currentStock:r,newStock:l,usedQuantity:e})}}catch(e){(0,o.vU)(`更新香精庫存失敗: ${t.name}`,e),d.Am.error(`更新香精 ${t.name} 庫存失敗`)}}else{let s=(0,i.doc)(n.db,"materials",t.id);try{let a=await (0,i.QT)(s);if(a.exists()){let r=a.data().currentStock||0,l=Math.max(0,parseFloat((r-e).toFixed(6)));await (0,i.r7)(s,{currentStock:l,updatedAt:i.EK.now()}),(0,o.fF)(`物料庫存已扣除: ${t.name}`,{currentStock:r,newStock:l,usedQuantity:e})}}catch(e){(0,o.vU)(`更新物料庫存失敗: ${t.name}`,e),d.Am.error(`更新物料 ${t.name} 庫存失敗`)}}}q(e=>e?{...e,status:"完工"}:null),ev(!1),Y(!1),d.Am.success("工單已完工，庫存已扣除")}catch(e){(0,o.vU)("完工操作失敗",e),d.Am.error("完工操作失敗")}finally{ew(!1)}}},e$=async()=>{if(P&&n.db){eC(!0);try{let e=(0,i.doc)(n.db,"workOrders",h);await (0,i.r7)(e,{status:"入庫",updatedAt:i.EK.now()}),q(e=>e?{...e,status:"入庫"}:null),eM(!1),d.Am.success("工單已入庫")}catch(e){(0,o.vU)("入庫操作失敗",e),d.Am.error("入庫操作失敗")}finally{eC(!1)}}},eE=(0,r.useCallback)(async()=>{if(h&&n.db)try{let e=(0,i.query)((0,i.collection)(n.db,"timeEntries"),(0,i.where)("workOrderId","==",h),(0,i.Xo)("createdAt","desc")),t=(await (0,i.getDocs)(e)).docs.map(e=>({id:e.id,...e.data()}));B(t)}catch(e){(0,o.vU)("載入工時記錄失敗",e)}},[h]),eQ=(0,r.useCallback)(async()=>{if(h&&n.db){H(!0);try{let e=await (0,i.QT)((0,i.doc)(n.db,"workOrders",h));if(e.exists()){let t=e.data();(0,o.fF)("工單資料載入成功",{id:h,data:t}),(0,o.fF)("產品快照",t.productSnapshot);let s=await (0,i.getDocs)((0,i.collection)(n.db,"materials")),a=await (0,i.getDocs)((0,i.collection)(n.db,"fragrances")),r=s.docs.map(e=>({id:e.id,...e.data()})),l=a.docs.map(e=>({id:e.id,...e.data()}));[...r,...l],q({id:e.id,code:t.code,productSnapshot:{code:t.productSnapshot?.code||"",name:t.productSnapshot?.name||"",seriesName:t.productSnapshot?.seriesName||"未指定",fragranceName:t.productSnapshot?.fragranceName||"未指定",fragranceCode:t.productSnapshot?.fragranceCode||"未指定",nicotineMg:t.productSnapshot?.nicotineMg||0},billOfMaterials:(t.billOfMaterials||[]).map(e=>{let t=null;return"fragrance"===e.category&&(t=l.find(t=>t.id===e.id||t.code===e.code||t.name===e.name)),t||(t=r.find(t=>t.id===e.id||t.code===e.code||t.name===e.name)),{id:e.id||e.materialId||"",name:e.name||e.materialName||"",code:e.code||e.materialCode||"",type:e.type||("fragrance"===e.category?"fragrance":"material"),quantity:e.quantity||e.requiredQuantity||0,unit:e.unit||"個",ratio:e.ratio||0,isCalculated:void 0===e.isCalculated||e.isCalculated,category:e.category||"other",usedQuantity:e.usedQuantity||e.quantity||e.requiredQuantity||0,currentStock:t&&t.currentStock||0}}),targetQuantity:t.targetQuantity||0,actualQuantity:t.actualQuantity||0,status:t.status||"預報",qcStatus:t.qcStatus||"未檢驗",createdAt:t.createdAt,createdByRef:t.createdByRef,createdByName:t.createdByName||"",notes:t.notes||"",timeRecords:t.timeRecords||[],comments:t.comments||[]}),el(t.comments||[])}else d.Am.error("找不到工單"),t.push("/dashboard/work-orders")}catch(e){console.error("載入工單失敗:",e),d.Am.error("載入工單失敗")}finally{H(!1)}}},[h,n.db,t]);(0,r.useCallback)(async()=>{try{if(!n.db)return;let e=(await (0,i.getDocs)((0,i.collection)(n.db,"users"))).docs.map(e=>({id:e.id,...e.data()})).filter(e=>e.isActive).map(e=>({id:e.id,name:e.name,employeeId:e.employeeId}));K(e)}catch(e){console.error("載入人員資料失敗:",e)}},[]);let eI=async e=>{let t=e.target.files;if(!t||0===t.length)return;let s=Array.from(t),a=d.Am.loading("正在處理圖片...");try{if(s.reduce((e,t)=>e+t.size,0)>10485760){d.Am.error(`總檔案大小不能超過 10MB，請選擇較小的圖片`,{id:a});return}let e=await (0,c.OM)(s,{folder:`work-orders/${h}/comments`,maxSize:2,compress:!0,quality:.6}),t=e.filter(e=>e.success),r=e.filter(e=>!e.success);if(t.length>0){let e=t.map(e=>e.url);ec(t=>[...t,...e]),d.Am.success(`成功上傳 ${t.length} 張圖片`,{id:a})}if(r.length>0){let e=r.map(e=>e.error).join(", ");d.Am.error(`以下圖片上傳失敗: ${e}`,{id:a})}}catch(e){console.error("圖片處理失敗:",e),d.Am.error(`圖片處理失敗: ${e instanceof Error?e.message:"未知錯誤"}`,{id:a})}e.target.value=""},e_=e=>{ec(t=>t.filter((t,s)=>s!==e))},eF=(0,r.useCallback)(async()=>{if(P&&n.db){eg(!0);try{let e=P.productSnapshot;console.log("重新載入BOM表 - 工單中的產品快照:",e);let t=null;if(e.fragranceCode&&"未指定"!==e.fragranceCode){console.log("重新載入BOM表 - 開始查詢香精:",e.fragranceCode);let s=(0,i.query)((0,i.collection)(n.db,"fragrances"),(0,i.where)("code","==",e.fragranceCode)),a=await (0,i.getDocs)(s);a.empty?console.log("重新載入BOM表 - 在香精集合中找不到對應的香精:",e.fragranceCode):(t=a.docs[0].data(),console.log("重新載入BOM表 - 成功獲取香精配方資料:",{code:t.code,name:t.name,percentage:t.percentage,pgRatio:t.pgRatio,vgRatio:t.vgRatio}))}else console.log("重新載入BOM表 - 香精代號未指定或為空");let s={name:e.name,fragranceName:e.fragranceName,fragranceCode:e.fragranceCode,nicotineMg:e.nicotineMg,fragranceFormula:t||null};console.log("重新載入BOM表 - 最終使用的產品資料:",s);let a=await eP(s,P.targetQuantity),r=P.billOfMaterials,l=a.map(e=>{let t=r.find(t=>t.id===e.id);return{...e,usedQuantity:t?.usedQuantity||e.usedQuantity,currentStock:t?.currentStock||e.currentStock||0}}),c=await (0,i.getDocs)((0,i.collection)(n.db,"materials")),o=await (0,i.getDocs)((0,i.collection)(n.db,"fragrances")),m=c.docs.map(e=>({id:e.id,...e.data()})),x=o.docs.map(e=>({id:e.id,...e.data()})),u=l.map(e=>{let t=null;return"fragrance"===e.category&&(t=x.find(t=>t.id===e.id||t.code===e.code||t.name===e.name)),t||(t=m.find(t=>t.id===e.id||t.code===e.code||t.name===e.name)),{...e,currentStock:t?t.currentStock||0:e.currentStock||0}}),g=(0,i.doc)(n.db,"workOrders",h);await (0,i.r7)(g,{billOfMaterials:u,updatedAt:i.EK.now()}),await eQ(),d.Am.success("BOM表已重新載入")}catch(e){console.error("重新載入BOM表失敗:",e),d.Am.error("重新載入BOM表失敗")}finally{eg(!1)}}},[P,n.db,h,eQ]),eP=async(e,t)=>{if(!n.db)return[];console.log("重新載入BOM表 - 開始重新計算物料需求:",{productData:{name:e.name,fragranceName:e.fragranceName,fragranceCode:e.fragranceCode,nicotineMg:e.nicotineMg},targetQuantity:t});let s=(await (0,i.getDocs)((0,i.collection)(n.db,"materials"))).docs.map(e=>({id:e.id,...e.data()})),a=(await (0,i.getDocs)((0,i.collection)(n.db,"fragrances"))).docs.map(e=>({id:e.id,...e.data()})),r=[...s,...a];console.log("重新載入BOM表 - 載入的物料列表:",s.length,"個"),console.log("重新載入BOM表 - 載入的香精列表:",a.length,"個"),console.log("重新載入BOM表 - 合併後的總物料列表:",r.length,"個");let l=new Map;if(console.log("重新載入BOM表 - 檢查香精配方資料:",e.fragranceFormula),!e.fragranceFormula)return console.error("重新載入BOM表 - 錯誤：沒有香精配方資料"),d.Am.error("抓取錯誤：沒有香精配方資料"),[];let{percentage:c,pgRatio:o,vgRatio:x}=e.fragranceFormula;if(console.log("重新載入BOM表 - 香精配方資料:",{percentage:c,pgRatio:o,vgRatio:x}),!c||c<=0)return console.error("重新載入BOM表 - 錯誤：香精比例為0或無效"),d.Am.error("抓取錯誤：香精比例為0或無效"),[];let u={fragrance:c,pg:o,vg:x};if(console.log("重新載入BOM表 - 直接使用香精詳情中的配方比例（避免浮點數精度問題）:",{香精:c+"%",PG:o+"%",VG:x+"%",總計:c+o+x+"%"}),console.log("重新載入BOM表 - 最終使用香精比例:",u),e.fragranceName&&"未指定"!==e.fragranceName){let s=u.fragrance/100*t,r=a.find(t=>t.code===e.fragranceCode||t.name===e.fragranceName);console.log("重新載入BOM表 - 香精匹配結果:",{fragranceCode:e.fragranceCode,fragranceName:e.fragranceName,foundFragrance:r?{id:r.id,code:r.code,name:r.name,currentStock:r.currentStock}:null,allFragrances:a.map(e=>({code:e.code,name:e.name,currentStock:e.currentStock}))});let i=r&&r.currentStock||0,n=i>=s;l.set("fragrance",{id:r?r.id:e.fragranceCode||"fragrance",name:e.fragranceName,code:e.fragranceCode,type:"fragrance",quantity:s,unit:"KG",ratio:u.fragrance,isCalculated:!0,category:"fragrance",usedQuantity:s,currentStock:i}),console.log("重新載入BOM表 - 添加香精:",e.fragranceName,s,"比例:",u.fragrance,"庫存:",i,"充足:",n)}else console.log("重新載入BOM表 - 香精名稱未指定或為空，跳過香精添加");let h=(0,m.n)(r,"pg");if(h){let e=u.pg/100*t;l.set(h.id,{id:h.id,name:h.name,code:h.code,type:"material",quantity:e,unit:h.unit||"KG",ratio:u.pg,isCalculated:!0,category:"pg",usedQuantity:e,currentStock:h.currentStock||0}),console.log("重新載入BOM表 - 添加PG:",h.name,e,"比例:",u.pg,"庫存:",h.currentStock)}else console.warn("重新載入BOM表 - 找不到PG物料");let g=(0,m.n)(r,"vg");if(g){let e=u.vg/100*t;l.set(g.id,{id:g.id,name:g.name,code:g.code,type:"material",quantity:e,unit:g.unit||"KG",ratio:u.vg,isCalculated:!0,category:"vg",usedQuantity:e,currentStock:g.currentStock||0}),console.log("重新載入BOM表 - 添加VG:",g.name,e,"比例:",u.vg,"庫存:",g.currentStock)}else console.warn("重新載入BOM表 - 找不到VG物料");let p=(0,m.n)(r,"nicotine");if(p){let s=e.nicotineMg&&e.nicotineMg>0?t*e.nicotineMg/250:0;l.set(p.id,{id:p.id,name:p.name,code:p.code,type:"material",quantity:s,unit:p.unit||"KG",ratio:0,isCalculated:!0,category:"nicotine",usedQuantity:s,currentStock:p.currentStock||0}),console.log("重新載入BOM表 - 添加尼古丁:",p.name,s,"濃度:",e.nicotineMg,"庫存:",p.currentStock)}console.log("重新載入BOM表 - 專屬材料名稱:",P?.billOfMaterials?.filter(e=>"specific"===e.category).map(e=>e.name)),(P?.billOfMaterials?.filter(e=>"specific"===e.category)||[]).forEach(e=>{let t=s.find(t=>t.id===e.id||t.code===e.code||t.name===e.name);l.set(e.id,{...e,quantity:0,usedQuantity:e.usedQuantity||0,currentStock:t?t.currentStock||0:e.currentStock||0}),console.log("重新載入BOM表 - 保持專屬材料:",e.name,"需求量: 0",e.unit,"庫存:",t?t.currentStock:e.currentStock)}),console.log("重新載入BOM表 - 通用材料名稱:",P?.billOfMaterials?.filter(e=>"common"===e.category).map(e=>e.name)),(P?.billOfMaterials?.filter(e=>"common"===e.category)||[]).forEach(e=>{let t=s.find(t=>t.id===e.id||t.code===e.code||t.name===e.name);l.set(e.id,{...e,quantity:0,usedQuantity:e.usedQuantity||0,currentStock:t?t.currentStock||0:e.currentStock||0}),console.log("重新載入BOM表 - 保持通用材料:",e.name,"需求量: 0",e.unit,"庫存:",t?t.currentStock:e.currentStock)});let f=Array.from(l.values());return f.sort((e,t)=>{let s=["fragrance","pg","vg","nicotine","specific","common","other"],a=s.indexOf(e.category||"other"),r=s.indexOf(t.category||"other");return a!==r?a-r:(e.name||"").localeCompare(t.name||"")}),console.log("重新載入BOM表 - 最終物料需求:",f),f},eq=async()=>{if(!ei.trim()&&0===ed.length){d.Am.error("請輸入留言內容或上傳圖片");return}if(P&&n.db)try{let e={id:Date.now().toString(),text:ei.trim(),images:ed,createdAt:new Date().toISOString(),createdBy:"當前用戶"},t=(0,i.doc)(n.db,"workOrders",h),s=[...er,e];await (0,i.r7)(t,{comments:s,updatedAt:i.EK.now()}),el(s),q(e=>e?{...e,comments:s}:null),en(""),ec([]),d.Am.success("留言已新增")}catch(e){console.error("新增留言失敗:",e),d.Am.error("新增留言失敗")}},eR=async e=>{try{let t=er.find(t=>t.id===e);if(!t)return;if(t.images.length>0){let{getStorage:e,ref:a,deleteObject:r}=await Promise.resolve().then(s.bind(s,11552)),l=e(),i=t.images.map(async e=>{try{let t=a(l,e);await r(t)}catch(e){console.error("刪除圖片失敗:",e)}});await Promise.all(i)}let a=er.filter(t=>t.id!==e);if(el(a),P&&n.db){let e=(0,i.doc)(n.db,"workOrders",h);await (0,i.r7)(e,{comments:a,updatedAt:i.EK.now()}),q(e=>e?{...e,comments:a}:null)}d.Am.success("留言已刪除")}catch(e){console.error("刪除留言失敗:",e),d.Am.error("刪除留言失敗")}},eB=async()=>{if(!P||!n.db){console.error("缺少必要資料:",{workOrder:!!P,db:!!n.db}),d.Am.error("缺少必要資料，無法刪除工單");return}eu(!0);let e=d.Am.loading("正在刪除工單...");try{console.log("開始刪除工單:",P.id);let a=er.flatMap(e=>e.images);if(console.log("需要刪除的圖片數量:",a.length),a.length>0){let{getStorage:e,ref:t,deleteObject:r}=await Promise.resolve().then(s.bind(s,11552)),l=e(),i=a.map(async(e,s)=>{try{console.log(`刪除圖片 ${s+1}/${a.length}:`,e);let i=t(l,e);await r(i),console.log(`圖片 ${s+1} 刪除成功`)}catch(e){console.error(`刪除圖片 ${s+1} 失敗:`,e)}});await Promise.all(i),console.log("所有圖片刪除完成")}console.log("刪除工單文檔:",P.id);let{doc:r,deleteDoc:l}=await Promise.resolve().then(s.bind(s,76)),i=r(n.db,"workOrders",P.id);await l(i),console.log("工單文檔刪除成功"),d.Am.success("工單已刪除",{id:e}),console.log("刪除完成，準備跳轉到工單列表"),t.push("/dashboard/work-orders")}catch(t){console.error("刪除工單失敗:",t),d.Am.error(`刪除工單失敗: ${t instanceof Error?t.message:"未知錯誤"}`,{id:e})}finally{console.log("清理狀態"),eu(!1),em(!1)}},eG=async()=>{if(P&&n.db){J(!0);try{let e=eT(es.targetQuantity),t=(0,i.doc)(n.db,"workOrders",h);await (0,i.r7)(t,{status:es.status,qcStatus:es.qcStatus,actualQuantity:es.actualQuantity,targetQuantity:es.targetQuantity,notes:es.notes,billOfMaterials:e,updatedAt:i.EK.now()}),q(t=>t?{...t,status:es.status,qcStatus:es.qcStatus,actualQuantity:es.actualQuantity,targetQuantity:es.targetQuantity,notes:es.notes,billOfMaterials:e}:null),Y(!1),d.Am.success("工單資料已更新")}catch(e){console.error("更新工單失敗:",e),d.Am.error("更新工單失敗")}finally{J(!1)}}},eK=R.reduce((e,t)=>e+60*t.duration,0),eV=()=>{if(!P)return"";let e=e=>e%1==0?e.toString():parseFloat(e.toFixed(3)).toString(),t=P.billOfMaterials.filter(e=>["fragrance","pg","vg","nicotine"].includes(e.category)),s=P.billOfMaterials.filter(e=>"specific"===e.category),a=P.billOfMaterials.filter(e=>"common"===e.category);return`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>工單列印 - ${P.code}</title>
        <style>
          @media print {
            @page {
              size: A4;
              margin: 1cm;
            }
          }
          
                     body {
             font-family: 'Microsoft JhengHei', Arial, sans-serif;
             margin: 0;
             padding: 15px;
             font-size: 16px;
             line-height: 1.3;
             color: #000;
           }
          
          .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 3px solid #000;
            padding-bottom: 10px;
          }
          
                     .title {
             font-size: 32px;
             font-weight: bold;
             margin-bottom: 8px;
           }
           
           .subtitle {
             font-size: 24px;
             font-weight: bold;
             margin-bottom: 12px;
           }
          
                                .top-info {
             display: grid;
             grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
             gap: 8px;
             margin-bottom: 15px;
           }
           
           .top-info-item {
             border: 3px solid #000;
             padding: 8px;
             text-align: center;
             border-radius: 5px;
             background-color: #f8f8f8;
           }
           
           .top-info-label {
             font-size: 16px;
             font-weight: bold;
             margin-bottom: 6px;
             color: #333;
           }
           
           .top-info-value {
             font-size: 20px;
             font-weight: bold;
             color: #000;
           }
           
           .main-content {
             display: grid;
             grid-template-columns: 2fr 1fr;
             gap: 15px;
             margin-bottom: 15px;
           }
           
           .materials-section {
             margin-bottom: 15px;
           }
           
           .materials-section h3 {
             font-size: 18px;
             font-weight: bold;
             margin: 0 0 8px 0;
             text-align: center;
             background-color: #f0f0f0;
             padding: 6px;
             border-radius: 3px;
           }
           
           .comments-section {
             border: 2px solid #000;
             padding: 10px;
             border-radius: 5px;
             height: 100%;
             display: flex;
             flex-direction: column;
           }
           
           .comments-section h3 {
             font-size: 20px;
             font-weight: bold;
             margin: 0 0 8px 0;
             text-align: center;
             background-color: #f0f0f0;
             padding: 6px;
             border-radius: 3px;
           }
          
                     .materials-section {
             margin-bottom: 15px;
           }
           
           .materials-section h3 {
             font-size: 18px;
             font-weight: bold;
             margin: 0 0 8px 0;
             text-align: center;
             background-color: #f0f0f0;
             padding: 6px;
             border-radius: 3px;
           }
          
                     table {
             width: 100%;
             border-collapse: collapse;
             margin-bottom: 12px;
             font-size: 14px;
           }
           
           th, td {
             border: 1px solid #000;
             padding: 8px 6px;
             text-align: center;
           }
           
           th {
             background-color: #f0f0f0;
             font-weight: bold;
             font-size: 15px;
           }
          
                     .time-section {
             margin-bottom: 15px;
           }
           
           .time-section h3 {
             font-size: 20px;
             font-weight: bold;
             margin: 0 0 8px 0;
             text-align: center;
             background-color: #f0f0f0;
             padding: 6px;
             border-radius: 3px;
           }
           
           .time-writing-box {
             border: 2px solid #000;
             background-color: #f9f9f9;
             min-height: 200px;
             margin-top: 8px;
           }
          
                     .total-time {
             text-align: center;
             font-size: 16px;
             font-weight: bold;
             margin: 8px 0;
             padding: 12px;
             background-color: #f0f0f0;
             border-radius: 5px;
           }
          
                     .footer {
             margin-top: 20px;
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 15px;
           }
           
           .signature-box {
             border: 1px solid #000;
             padding: 8px;
             text-align: center;
             height: 70px;
           }
           
           .signature-label {
             font-size: 13px;
             font-weight: bold;
             margin-bottom: 4px;
           }
          
                     .signature-line {
             border-top: 1px solid #000;
             margin-top: 40px;
             padding-top: 4px;
             font-size: 11px;
           }
          
          .page-break {
            page-break-before: always;
          }
          
          @media print {
            .no-print {
              display: none;
            }
          }
        </style>
      </head>
      <body>
        <div class="header">
          <div class="title">生產工單</div>
          <div class="subtitle">${P.code}</div>
          <div>列印日期：${new Date().toLocaleDateString("zh-TW")}</div>
        </div>
        
                 <div class="top-info">
           <div class="top-info-item">
             <div class="top-info-label">產品系列</div>
             <div class="top-info-value">${P.productSnapshot.seriesName||"未指定"}</div>
           </div>
           <div class="top-info-item">
             <div class="top-info-label">產品名稱</div>
             <div class="top-info-value">${P.productSnapshot.name}</div>
           </div>
           <div class="top-info-item">
             <div class="top-info-label">香精代號</div>
             <div class="top-info-value">${P.productSnapshot.fragranceCode}</div>
           </div>
           <div class="top-info-item">
             <div class="top-info-label">尼古丁濃度</div>
             <div class="top-info-value">${P.productSnapshot.nicotineMg} mg</div>
           </div>
           <div class="top-info-item">
             <div class="top-info-label">目標產量</div>
             <div class="top-info-value">${P.targetQuantity} KG</div>
           </div>
         </div>
        
                 <div class="main-content">
           <div class="materials-section">
             <h3>核心配方物料清單</h3>
             <table>
               <thead>
                 <tr>
                   <th>物料名稱</th>
                   <th>料件代號</th>
                   <th>比例</th>
                   <th>需求數量</th>
                   <th>使用數量</th>
                   <th>單位</th>
                 </tr>
               </thead>
               <tbody>
                 ${t.map(t=>`
                   <tr>
                                        <td style="font-weight: bold; font-size: 15px;">${t.name}</td>
                   <td style="font-weight: bold; font-size: 15px;">${t.code}</td>
                   <td style="font-size: 15px;">${t.ratio?t.ratio+"%":"-"}</td>
                   <td style="font-weight: bold; font-size: 15px;">${e(t.quantity)}</td>
                   <td style="border: 2px solid #000; background-color: #f9f9f9; min-width: 60px; height: 30px;"></td>
                   <td style="font-size: 15px;">${t.unit}</td>
                   </tr>
                 `).join("")}
               </tbody>
             </table>
             
             ${s.length>0?`
             <h3>產品專屬物料</h3>
             <table>
               <thead>
                 <tr>
                   <th>物料名稱</th>
                   <th>料件代號</th>
                   <th>使用數量</th>
                   <th>單位</th>
                 </tr>
               </thead>
               <tbody>
                 ${s.map(e=>`
                   <tr>
                     <td style="font-weight: bold; font-size: 15px;">${e.name}</td>
                     <td style="font-weight: bold; font-size: 15px;">${e.code}</td>
                     <td style="border: 2px solid #000; background-color: #f9f9f9; min-width: 60px; height: 30px;"></td>
                     <td style="font-size: 15px;">${e.unit}</td>
                   </tr>
                 `).join("")}
               </tbody>
             </table>
             `:""}
             
             ${a.length>0?`
             <h3>系列通用物料</h3>
             <table>
               <thead>
                 <tr>
                   <th>物料名稱</th>
                   <th>料件代號</th>
                   <th>使用數量</th>
                   <th>單位</th>
                 </tr>
               </thead>
               <tbody>
                 ${a.map(e=>`
                   <tr>
                     <td style="font-weight: bold; font-size: 15px;">${e.name}</td>
                     <td style="font-weight: bold; font-size: 15px;">${e.code}</td>
                     <td style="border: 2px solid #000; background-color: #f9f9f9; min-width: 60px; height: 30px;"></td>
                     <td style="font-size: 15px;">${e.unit}</td>
                   </tr>
                 `).join("")}
               </tbody>
             </table>
             `:""}
           </div>
           
           <div class="comments-section">
             <h3>留言板</h3>
             <div style="flex: 1; border: 1px solid #ccc; background-color: #f9f9f9; padding: 8px; min-height: 400px;">
               <!-- 留言內容會在這裡顯示 -->
             </div>
           </div>
         </div>
        
                 <div class="time-section">
           <h3>工時申報表</h3>
           ${R&&R.length>0?`
             <table>
               <thead>
                 <tr>
                   <th>人員</th>
                   <th>工作日期</th>
                   <th>開始時間</th>
                   <th>結束時間</th>
                   <th>工時小計</th>
                 </tr>
               </thead>
               <tbody>
                 ${R.map(e=>`
                   <tr>
                     <td>${e.personnelName}</td>
                     <td>${e.startDate}</td>
                     <td>${e.startTime}</td>
                     <td>${e.endTime}</td>
                     <td>${Math.floor(e.duration)}小時${Math.round(e.duration%1*60)}分鐘</td>
                   </tr>
                 `).join("")}
               </tbody>
             </table>
             <div class="total-time">
               總人工小時：${Math.floor(eK/60)} 小時 ${Math.floor(eK%60)} 分鐘 (共 ${R.length} 筆紀錄)
             </div>
           `:`
             <div style="text-align: center; padding: 15px; color: #666; font-size: 16px;">
               尚無工時紀錄
             </div>
           `}
           <div class="time-writing-box">
             <!-- 工時申報書寫區域 -->
           </div>
         </div>
        
        <div class="footer">
          <div class="signature-box">
            <div class="signature-label">生產主管簽名</div>
            <div class="signature-line"></div>
          </div>
          
          <div class="signature-box">
            <div class="signature-label">倉庫管理簽名</div>
            <div class="signature-line"></div>
          </div>
        </div>
        
                 ${P.notes?`
         <div style="margin-top: 15px; border: 1px solid #000; padding: 8px;">
           <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: bold;">備註</h3>
           <div style="font-size: 13px; white-space: pre-wrap;">${P.notes}</div>
         </div>
         `:""}
      </body>
      </html>
         `};return V?a.jsx("div",{className:"container mx-auto py-10",children:a.jsx("div",{className:"flex justify-center items-center py-20",children:(0,a.jsxs)("div",{className:"text-center",children:[a.jsx(x.Z,{className:"w-8 h-8 animate-spin mx-auto mb-4 text-blue-600"}),a.jsx("p",{className:"text-gray-600",children:"載入工單資料中..."})]})})}):P?a.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50",children:(0,a.jsxs)("div",{className:"container mx-auto p-2 sm:p-4 py-4 sm:py-10",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4 sm:mb-8",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 sm:gap-4",children:[a.jsx(T.z,{variant:"outline",size:"icon",onClick:()=>t.back(),className:"hover:bg-white/80 backdrop-blur-sm",children:a.jsx(u.Z,{className:"h-4 w-4"})}),(0,a.jsxs)("div",{className:"flex-grow min-w-0",children:[a.jsx("h1",{className:"text-xl sm:text-3xl font-bold bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 bg-clip-text text-transparent truncate",children:"工單詳情"}),a.jsx("p",{className:"text-gray-600 font-mono text-sm sm:text-base truncate",children:P.code})]})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)(T.z,{variant:"outline",onClick:()=>{let e=window.open("","_blank");if(!e){d.Am.error("無法開啟列印視窗，請檢查彈出視窗設定");return}let t=eV();e.document.write(t),e.document.close(),e.focus(),setTimeout(()=>{e.print(),e.close()},500)},className:"bg-blue-600 hover:bg-blue-700 text-white border-blue-600",children:[a.jsx(g,{className:"mr-2 h-4 w-4"}),"列印工單"]}),!!P&&("預報"===P.status||"進行"===P.status||"完工"===P.status)&&(0,a.jsxs)(T.z,{variant:"outline",onClick:P?"預報"===P.status||"進行"===P.status?()=>{ev(!0)}:"完工"===P.status?()=>{eM(!0)}:()=>{}:()=>{},className:"bg-green-600 hover:bg-green-700 text-white border-green-600",children:[a.jsx(p.Z,{className:"mr-2 h-4 w-4"}),(()=>{if(!P)return"完工";if("預報"===P.status||"進行"===P.status);else if("完工"===P.status)return"入庫";return"完工"})()]}),(0,a.jsxs)(T.z,{variant:"destructive",onClick:()=>em(!0),className:"bg-red-500 hover:bg-red-600 flex-shrink-0",children:[a.jsx(f.Z,{className:"mr-2 h-4 w-4"}),"刪除工單"]})]})]}),(0,a.jsxs)(Z.Zb,{className:"mb-4 sm:mb-6 shadow-lg border-0 bg-white",children:[a.jsx(Z.Ol,{className:"pb-3 sm:pb-6 bg-gradient-to-r from-blue-200 to-blue-300 text-blue-800 rounded-t-xl",children:(0,a.jsxs)(Z.ll,{className:"flex items-center gap-2 text-lg sm:text-xl",children:[a.jsx(b.Z,{className:"h-5 w-5"}),"工單基本資料"]})}),a.jsx(Z.aY,{children:(0,a.jsxs)("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6",children:[(0,a.jsxs)("div",{className:"text-center p-3 sm:p-4 bg-white rounded-lg border",children:[a.jsx("div",{className:"text-xs sm:text-sm text-gray-600 mb-1",children:"生產產品名稱"}),a.jsx("div",{className:"font-semibold text-blue-800 text-sm sm:text-base truncate",children:P.productSnapshot.name}),a.jsx("div",{className:"text-xs text-gray-500 truncate",children:P.productSnapshot.seriesName||"未指定"})]}),(0,a.jsxs)("div",{className:"text-center p-3 sm:p-4 bg-white rounded-lg border",children:[a.jsx("div",{className:"text-xs sm:text-sm text-gray-600 mb-1",children:"使用香精"}),a.jsx("div",{className:"font-semibold text-pink-800 text-sm sm:text-base truncate",children:P.productSnapshot.fragranceCode}),a.jsx("div",{className:"text-xs text-gray-500 truncate",children:P.productSnapshot.fragranceName})]}),(0,a.jsxs)("div",{className:"text-center p-3 sm:p-4 bg-white rounded-lg border",children:[a.jsx("div",{className:"text-xs sm:text-sm text-gray-600 mb-1",children:"尼古丁濃度"}),(0,a.jsxs)("div",{className:"font-semibold text-orange-800 text-sm sm:text-base",children:[P.productSnapshot.nicotineMg," mg"]})]}),(0,a.jsxs)("div",{className:"text-center p-3 sm:p-4 bg-white rounded-lg border",children:[a.jsx("div",{className:"text-xs sm:text-sm text-gray-600 mb-1",children:"工單狀態"}),a.jsx(z.C,{className:`${U.find(e=>e.value===P.status)?.color} text-base sm:text-lg font-bold px-3 py-1`,children:P.status})]})]})})]}),(0,a.jsxs)(Z.Zb,{className:"mb-4 sm:mb-6 shadow-lg border-0 bg-white",children:[a.jsx(Z.Ol,{className:"pb-3 sm:pb-6 bg-gradient-to-r from-green-200 to-green-300 text-green-800 rounded-t-xl",children:(0,a.jsxs)(Z.ll,{className:"flex items-center gap-2 text-lg sm:text-xl",children:[a.jsx(j.Z,{className:"h-5 w-5"}),"工單詳細資料",P?.status==="入庫"&&a.jsx(z.C,{variant:"secondary",className:"ml-2 bg-purple-100 text-purple-800 border-purple-200",children:"已入庫 - 僅可查看"}),P?.status==="完工"&&a.jsx(z.C,{variant:"secondary",className:"ml-2 bg-green-100 text-green-800 border-green-200",children:"已完工 - 僅可編輯工時"})]})}),(0,a.jsxs)(Z.aY,{children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4",children:[(0,a.jsxs)("div",{children:[a.jsx(I._,{className:"text-sm text-gray-600",children:"目前工單狀態"}),L?(0,a.jsxs)(E.Ph,{value:es.status,onValueChange:e=>{P?.status==="預報"&&"進行"===e?ea(t=>({...t,status:e})):P?.status==="進行"&&"預報"===e?ea(t=>({...t,status:e})):d.Am.error("工單狀態只能在預報和進行之間切換")},children:[a.jsx(E.i4,{className:"mt-1",children:a.jsx(E.ki,{})}),a.jsx(E.Bw,{children:U.filter(e=>"預報"===e.value||"進行"===e.value).map(e=>a.jsx(E.Ql,{value:e.value,children:e.label},e.value))})]}):a.jsx("div",{className:"mt-1",children:a.jsx(z.C,{className:`${U.find(e=>e.value===P.status)?.color} text-base sm:text-lg font-bold px-3 py-1`,children:P.status})})]}),(0,a.jsxs)("div",{children:[a.jsx(I._,{className:"text-sm text-gray-600",children:"生產產品名稱"}),a.jsx("div",{className:"mt-1 font-medium text-gray-900",children:P.productSnapshot.name})]}),(0,a.jsxs)("div",{children:[a.jsx(I._,{className:"text-sm text-gray-600",children:"產品系列"}),a.jsx("div",{className:"mt-1 font-medium text-gray-900",children:P.productSnapshot.seriesName||"未指定"})]}),(0,a.jsxs)("div",{children:[a.jsx(I._,{className:"text-sm text-gray-600",children:"目標產量 (KG)"}),L?a.jsx(Q.I,{type:"number",min:"0.1",step:"0.1",value:es.targetQuantity,onChange:e=>eZ(parseFloat(e.target.value)||0),className:"mt-1"}):(0,a.jsxs)("div",{className:"mt-1 font-medium text-gray-900",children:[P.targetQuantity," KG"]})]})]}),a.jsx("div",{className:"mt-4 flex flex-col sm:flex-row justify-end gap-2",children:L?(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row gap-2",children:[a.jsx(T.z,{variant:"outline",onClick:()=>Y(!1),disabled:X,className:"w-full sm:w-auto",children:"取消"}),a.jsx(T.z,{onClick:eG,disabled:X,className:"bg-green-600 hover:bg-green-700 w-full sm:w-auto",children:X?(0,a.jsxs)(a.Fragment,{children:[a.jsx(x.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"儲存中..."]}):(0,a.jsxs)(a.Fragment,{children:[a.jsx(N.Z,{className:"mr-2 h-4 w-4"}),"儲存"]})})]}):(0,a.jsxs)(T.z,{onClick:()=>{P&&(ea({status:P.status,qcStatus:P.qcStatus,actualQuantity:P.actualQuantity,targetQuantity:P.targetQuantity,notes:P.notes||""}),Y(!0))},disabled:!(P&&("預報"===P.status||"進行"===P.status)),className:"bg-green-600 hover:bg-green-700 w-full sm:w-auto",title:P&&("預報"===P.status||"進行"===P.status)?"點擊編輯工單詳細資料":"完工或入庫狀態無法編輯",children:[a.jsx(v.Z,{className:"mr-2 h-4 w-4"}),"編輯"]})})]})]}),(0,a.jsxs)(Z.Zb,{className:"mb-4 sm:mb-6 shadow-lg border-0 bg-white",children:[a.jsx(Z.Ol,{className:"pb-3 sm:pb-6 bg-gradient-to-r from-purple-200 to-purple-300 text-purple-800 rounded-t-xl",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)(Z.ll,{className:"flex items-center gap-2 text-lg sm:text-xl",children:[a.jsx(y.Z,{className:"h-5 w-5"}),"香精物料清單 (BOM表)",P?.status==="入庫"&&a.jsx(z.C,{variant:"secondary",className:"ml-2 bg-purple-100 text-purple-800 border-purple-200",children:"已入庫 - 僅可查看"}),P?.status==="完工"&&a.jsx(z.C,{variant:"secondary",className:"ml-2 bg-green-100 text-green-800 border-green-200",children:"已完工 - 僅可編輯工時"})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)(T.z,{variant:"outline",size:"sm",onClick:eF,disabled:eh,className:"text-purple-700 border-purple-300 hover:bg-purple-50",children:[eh?a.jsx(x.Z,{className:"h-4 w-4 animate-spin"}):a.jsx(w.Z,{className:"h-4 w-4"}),"重新載入"]}),ep?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(T.z,{variant:"outline",size:"sm",onClick:()=>{ej({}),ef(!1)},className:"text-red-700 border-red-300 hover:bg-red-50",children:[a.jsx(k.Z,{className:"h-4 w-4 mr-1"}),"取消"]}),(0,a.jsxs)(T.z,{variant:"outline",size:"sm",onClick:eO,className:"text-purple-700 border-purple-300 hover:bg-purple-50",children:[a.jsx(N.Z,{className:"h-4 w-4 mr-1"}),"保存數量"]})]}):(0,a.jsxs)(T.z,{variant:"outline",size:"sm",onClick:()=>ef(!0),disabled:!(P&&("預報"===P.status||"進行"===P.status)),className:"text-purple-700 border-purple-300 hover:bg-purple-50",title:P&&("預報"===P.status||"進行"===P.status)?"點擊編輯物料使用數量":"完工或入庫狀態無法編輯數量",children:[a.jsx(v.Z,{className:"h-4 w-4 mr-1"}),"編輯數量"]})]})]})}),a.jsx(Z.aY,{children:(0,a.jsxs)("div",{className:"space-y-4 sm:space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h3",{className:"text-lg font-semibold text-purple-700 mb-3 flex items-center gap-2",children:[a.jsx(y.Z,{className:"h-4 w-4"}),"核心配方物料"]}),a.jsx("div",{className:"overflow-x-auto",children:(0,a.jsxs)($.iA,{children:[a.jsx($.xD,{children:(0,a.jsxs)($.SC,{className:"bg-gradient-to-r from-gray-50 to-gray-100",children:[a.jsx($.ss,{className:"text-gray-700 font-bold text-xs sm:text-sm",children:"物料名稱"}),a.jsx($.ss,{className:"text-gray-700 font-bold text-xs sm:text-sm",children:"料件代號"}),a.jsx($.ss,{className:"text-gray-700 font-bold text-xs sm:text-sm",children:"比例"}),a.jsx($.ss,{className:"text-gray-700 font-bold text-xs sm:text-sm",children:"需求數量"}),a.jsx($.ss,{className:"text-gray-700 font-bold text-xs sm:text-sm",children:"使用數量"}),a.jsx($.ss,{className:"text-gray-700 font-bold text-xs sm:text-sm",children:"單位"})]})}),a.jsx($.RM,{children:P.billOfMaterials.filter(e=>["fragrance","pg","vg","nicotine"].includes(e.category)).map((e,t)=>(0,a.jsxs)($.SC,{className:"hover:bg-gray-50/50 transition-all duration-200",children:[a.jsx($.pj,{className:"font-medium",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:["fragrance"===e.category&&a.jsx(y.Z,{className:"h-4 w-4 text-purple-600"}),"pg"===e.category&&a.jsx("div",{className:"w-4 h-4 bg-blue-500 rounded"}),"vg"===e.category&&a.jsx("div",{className:"w-4 h-4 bg-green-500 rounded"}),"nicotine"===e.category&&a.jsx("div",{className:"w-4 h-4 bg-orange-500 rounded"}),a.jsx("span",{className:"text-xs sm:text-sm truncate",children:e.name})]})}),a.jsx($.pj,{className:"font-mono text-xs sm:text-sm",children:e.code}),a.jsx($.pj,{children:e.ratio?`${e.ratio}%`:"-"}),a.jsx($.pj,{className:"font-medium",children:eS(e.quantity)}),a.jsx($.pj,{children:ep?a.jsx(Q.I,{type:"number",min:"0",step:"0.001",value:void 0!==eb[e.id]?eb[e.id]:e.usedQuantity||0,onChange:t=>{eA(e.id,t.target.value)},className:"w-20"}):a.jsx("span",{className:"font-medium",children:eS(e.usedQuantity||0)})}),a.jsx($.pj,{children:e.unit})]},t))})]})})]}),P.billOfMaterials.filter(e=>"specific"===e.category).length>0&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("h3",{className:"text-lg font-semibold text-blue-700 mb-3 flex items-center gap-2",children:[a.jsx(b.Z,{className:"h-4 w-4"}),"產品專屬物料"]}),a.jsx("div",{className:"overflow-x-auto",children:(0,a.jsxs)($.iA,{children:[a.jsx($.xD,{children:(0,a.jsxs)($.SC,{className:"bg-gradient-to-r from-gray-50 to-gray-100",children:[a.jsx($.ss,{className:"text-gray-700 font-bold",children:"物料名稱"}),a.jsx($.ss,{className:"text-gray-700 font-bold",children:"料件代號"}),a.jsx($.ss,{className:"text-gray-700 font-bold",children:"使用數量"}),a.jsx($.ss,{className:"text-gray-700 font-bold",children:"單位"})]})}),a.jsx($.RM,{children:P.billOfMaterials.filter(e=>"specific"===e.category).sort((e,t)=>e.name.localeCompare(t.name)).map((e,t)=>(0,a.jsxs)($.SC,{className:"hover:bg-gray-50/50 transition-all duration-200",children:[a.jsx($.pj,{className:"font-medium",children:e.name}),a.jsx($.pj,{className:"font-mono text-sm",children:e.code}),a.jsx($.pj,{children:ep?a.jsx(Q.I,{type:"number",min:"0",step:"1",value:void 0!==eb[e.id]?eb[e.id]:e.usedQuantity||0,onChange:t=>{eA(e.id,t.target.value)},className:"w-20"}):a.jsx("span",{className:"font-medium",children:eS(e.usedQuantity||0)})}),a.jsx($.pj,{children:e.unit})]},t))})]})})]}),P.billOfMaterials.filter(e=>"common"===e.category).length>0&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("h3",{className:"text-lg font-semibold text-green-700 mb-3 flex items-center gap-2",children:[a.jsx(b.Z,{className:"h-4 w-4"}),"系列通用物料"]}),a.jsx("div",{className:"overflow-x-auto",children:(0,a.jsxs)($.iA,{children:[a.jsx($.xD,{children:(0,a.jsxs)($.SC,{className:"bg-gradient-to-r from-green-600 to-emerald-700",children:[a.jsx($.ss,{className:"text-white font-bold",children:"物料名稱"}),a.jsx($.ss,{className:"text-white font-bold",children:"料件代號"}),a.jsx($.ss,{className:"text-white font-bold",children:"使用數量"}),a.jsx($.ss,{className:"text-white font-bold",children:"單位"})]})}),a.jsx($.RM,{children:P.billOfMaterials.filter(e=>"common"===e.category).sort((e,t)=>e.name.localeCompare(t.name)).map((e,t)=>(0,a.jsxs)($.SC,{className:"bg-gradient-to-r from-green-50 to-emerald-50",children:[a.jsx($.pj,{className:"font-medium",children:e.name}),a.jsx($.pj,{className:"font-mono text-sm",children:e.code}),a.jsx($.pj,{children:ep?a.jsx(Q.I,{type:"number",min:"0",step:"1",value:void 0!==eb[e.id]?eb[e.id]:e.usedQuantity||0,onChange:t=>{eA(e.id,t.target.value)},className:"w-20"}):a.jsx("span",{className:"font-medium",children:eS(e.usedQuantity||0)})}),a.jsx($.pj,{children:e.unit})]},t))})]})})]})]})})]}),(0,a.jsxs)(Z.Zb,{className:"mb-4 sm:mb-6 bg-gradient-to-r from-orange-50 to-amber-50 border-orange-200",children:[a.jsx(Z.Ol,{className:"pb-3 sm:pb-6",children:(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[(0,a.jsxs)(Z.ll,{className:"text-orange-800 flex items-center gap-2 text-lg sm:text-xl",children:[a.jsx(M.Z,{className:"h-5 w-5"}),"工時申報",P?.status==="入庫"&&a.jsx(z.C,{variant:"secondary",className:"ml-2 bg-purple-100 text-purple-800 border-purple-200",children:"已入庫 - 無法新增"}),P?.status==="完工"&&a.jsx(z.C,{variant:"secondary",className:"ml-2 bg-green-100 text-green-800 border-green-200",children:"已完工 - 仍可新增"})]}),(0,a.jsxs)(T.z,{onClick:()=>et(!0),className:"bg-orange-600 hover:bg-orange-700 w-full sm:w-auto",children:[a.jsx(M.Z,{className:"mr-2 h-4 w-4"}),"工時管理"]})]})}),(0,a.jsxs)(Z.aY,{children:[a.jsx("div",{className:"mb-4 sm:mb-6 p-3 sm:p-4 bg-white rounded-lg border",children:(0,a.jsxs)("div",{className:"text-center",children:[a.jsx("div",{className:"text-sm text-gray-600 mb-1",children:"總人工小時"}),(0,a.jsxs)("div",{className:"text-xl sm:text-2xl font-bold text-orange-600",children:[Math.floor(eK/60)," 小時 ",Math.floor(eK%60)," 分鐘"]}),(0,a.jsxs)("div",{className:"text-xs text-gray-500",children:["共 ",R.length," 筆紀錄"]})]})}),R&&R.length>0?a.jsx("div",{className:"overflow-x-auto",children:(0,a.jsxs)($.iA,{children:[a.jsx($.xD,{children:(0,a.jsxs)($.SC,{className:"bg-gradient-to-r from-orange-600 to-amber-700",children:[a.jsx($.ss,{className:"text-white font-bold text-xs sm:text-sm",children:"人員"}),a.jsx($.ss,{className:"text-white font-bold text-xs sm:text-sm",children:"工作日期"}),a.jsx($.ss,{className:"text-white font-bold text-xs sm:text-sm",children:"開始時間"}),a.jsx($.ss,{className:"text-white font-bold text-xs sm:text-sm",children:"結束時間"}),a.jsx($.ss,{className:"text-white font-bold text-xs sm:text-sm",children:"工時小計"})]})}),a.jsx($.RM,{children:R.map((e,t)=>(0,a.jsxs)($.SC,{children:[a.jsx($.pj,{className:"font-medium",children:e.personnelName}),a.jsx($.pj,{children:e.startDate}),a.jsx($.pj,{children:e.startTime}),a.jsx($.pj,{children:e.endTime}),(0,a.jsxs)($.pj,{className:"font-medium",children:[Math.floor(e.duration)," 小時 ",Math.round(e.duration%1*60)," 分鐘"]})]},t))})]})}):(0,a.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[a.jsx(M.Z,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),a.jsx("p",{children:"尚無工時紀錄"}),a.jsx("p",{className:"text-sm",children:"點擊上方按鈕新增工時紀錄"})]})]})]}),a.jsx(W,{isOpen:ee,onOpenChange:e=>{et(e),e||eE()},workOrderId:h,workOrderNumber:P?.code,isLocked:P?.status==="入庫"}),(0,a.jsxs)(Z.Zb,{className:"mb-6 bg-gradient-to-r from-yellow-50 to-orange-50 border-yellow-200",children:[a.jsx(Z.Ol,{children:(0,a.jsxs)(Z.ll,{className:"text-orange-800 flex items-center gap-2",children:[a.jsx(D.Z,{className:"h-5 w-5"}),"留言記錄",(0,a.jsxs)(z.C,{variant:"secondary",className:"ml-2",children:[er.length," 則留言"]}),P?.status==="入庫"&&a.jsx(z.C,{variant:"secondary",className:"ml-2 bg-purple-100 text-purple-800 border-purple-200",children:"僅可留言"})]})}),(0,a.jsxs)(Z.aY,{children:[(0,a.jsxs)("div",{className:"mb-6 p-4 bg-white rounded-lg border border-yellow-200",children:[(0,a.jsxs)("div",{className:"mb-4",children:[a.jsx(I._,{htmlFor:"comment",className:"text-sm font-medium text-gray-700",children:"新增留言"}),a.jsx(_.g,{id:"comment",value:ei,onChange:e=>en(e.target.value),placeholder:"輸入留言內容...",className:"mt-1 min-h-[100px] resize-none"})]}),(0,a.jsxs)("div",{className:"mb-4",children:[a.jsx(I._,{className:"text-sm font-medium text-gray-700 mb-2 block",children:"上傳圖片"}),(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2",children:[(0,a.jsxs)(T.z,{variant:"outline",onClick:()=>document.getElementById("image-upload")?.click(),className:"border-yellow-300 text-yellow-700 hover:bg-yellow-50 w-full sm:w-auto",children:[a.jsx(C.Z,{className:"mr-2 h-4 w-4"}),"選擇圖片"]}),a.jsx("input",{id:"image-upload",type:"file",multiple:!0,accept:"image/*",onChange:eI,className:"hidden"}),a.jsx("span",{className:"text-sm text-gray-500 text-center sm:text-left",children:"可選擇多張圖片 (每張最大 2MB)"})]}),ed.length>0&&(0,a.jsxs)("div",{className:"mt-3",children:[(0,a.jsxs)(I._,{className:"text-sm font-medium text-gray-700 mb-2 block",children:["已選擇的圖片 (",ed.length," 張)"]}),a.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:ed.map((e,t)=>(0,a.jsxs)("div",{className:"relative group",children:[a.jsx("img",{src:e,alt:`圖片 ${t+1}`,className:"w-full h-20 sm:h-24 object-cover rounded-lg border cursor-pointer",onClick:()=>{let t=document.createElement("div");t.className="fixed inset-0 z-50 flex items-center justify-center bg-black/80",t.onclick=()=>t.remove();let s=document.createElement("img");s.src=e,s.className="max-w-[90vw] max-h-[90vh] object-contain rounded-lg",s.onclick=e=>e.stopPropagation(),t.appendChild(s),document.body.appendChild(t)}}),a.jsx(T.z,{variant:"destructive",size:"sm",onClick:()=>e_(t),className:"absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity h-6 w-6 p-0",children:a.jsx(k.Z,{className:"h-3 w-3"})})]},t))})]})]}),(0,a.jsxs)(T.z,{onClick:eq,disabled:!ei.trim()&&0===ed.length,className:"bg-orange-600 hover:bg-orange-700 w-full sm:w-auto",children:[a.jsx(D.Z,{className:"mr-2 h-4 w-4"}),"新增留言"]})]}),a.jsx("div",{className:"space-y-4",children:0===er.length?(0,a.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[a.jsx(D.Z,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),a.jsx("p",{children:"尚無留言記錄"})]}):er.map(e=>(0,a.jsxs)("div",{className:"bg-white rounded-lg border border-yellow-200 p-3 sm:p-4",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 min-w-0 flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx(S.Z,{className:"h-4 w-4 text-gray-500 flex-shrink-0"}),a.jsx("span",{className:"font-medium text-gray-700 truncate",children:e.createdBy})]}),a.jsx("span",{className:"text-sm text-gray-500",children:new Date(e.createdAt).toLocaleString()})]}),a.jsx(T.z,{variant:"ghost",size:"sm",onClick:()=>eR(e.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50 flex-shrink-0 ml-2",children:a.jsx(f.Z,{className:"h-4 w-4"})})]}),e.text&&a.jsx("div",{className:"mb-3 text-gray-700 whitespace-pre-wrap break-words",children:e.text}),e.images.length>0&&a.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:e.images.map((e,t)=>a.jsx("div",{className:"relative group",children:a.jsx("img",{src:e,alt:`留言圖片 ${t+1}`,className:"w-full h-20 sm:h-24 object-cover rounded-lg border cursor-pointer",onClick:()=>{let t=document.createElement("div");t.className="fixed inset-0 z-50 flex items-center justify-center bg-black/80",t.onclick=()=>t.remove();let s=document.createElement("img");s.src=e,s.className="max-w-[90vw] max-h-[90vh] object-contain rounded-lg",s.onclick=e=>e.stopPropagation(),t.appendChild(s),document.body.appendChild(t)}})},t))})]},e.id))})]})]}),a.jsx(F.Vq,{open:eN,onOpenChange:ev,children:(0,a.jsxs)(F.cZ,{className:"w-[95vw] max-w-4xl sm:max-w-5xl max-h-[90vh] overflow-y-auto",children:[(0,a.jsxs)(F.fK,{children:[a.jsx(F.$N,{className:"text-green-600 text-lg sm:text-xl",children:"確認完工"}),a.jsx(F.Be,{children:"請確認以下資訊後點擊完工按鈕。完工後將無法再修改目標產量和使用數量，但仍可新增工時記錄。系統會顯示庫存扣除後的剩餘數量，並實際扣除相應的庫存。"}),a.jsx("div",{className:"flex justify-end",children:(0,a.jsxs)(T.z,{variant:"outline",size:"sm",onClick:eQ,className:"text-blue-600 border-blue-300 hover:bg-blue-50",children:[a.jsx(w.Z,{className:"h-4 w-4 mr-1"}),"重新載入庫存"]})})]}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-3",children:"已填寫使用數量的物料"}),(0,a.jsxs)("p",{className:"text-sm text-gray-600 mb-3",children:["顯示物料的現有庫存、使用數量和扣除後的剩餘數量。",a.jsx("span",{className:"text-blue-600",children:"藍色"}),"為現有數量，",a.jsx("span",{className:"text-red-600",children:"紅色"}),"為使用數量，",a.jsx("span",{className:"text-green-600",children:"綠色"}),"為剩餘數量，",a.jsx("span",{className:"text-red-600",children:"紅色"}),"表示庫存不足。",V&&(0,a.jsxs)("span",{className:"ml-2 text-blue-600",children:[a.jsx(x.Z,{className:"h-3 w-3 inline animate-spin mr-1"}),"載入庫存中..."]})]}),a.jsx("div",{className:"overflow-x-auto",children:(0,a.jsxs)($.iA,{children:[a.jsx($.xD,{children:(0,a.jsxs)($.SC,{className:"bg-gray-50",children:[a.jsx($.ss,{className:"text-gray-700 font-bold",children:"物料名稱"}),a.jsx($.ss,{className:"text-gray-700 font-bold",children:"料件代號"}),a.jsx($.ss,{className:"text-gray-700 font-bold",children:"現有數量"}),a.jsx($.ss,{className:"text-gray-700 font-bold",children:"使用數量"}),a.jsx($.ss,{className:"text-gray-700 font-bold",children:"扣完剩餘"})]})}),a.jsx($.RM,{children:P?.billOfMaterials.filter(e=>(e.usedQuantity||0)>0).map((e,t)=>{let s=e.currentStock||0,r=e.usedQuantity||0,l=s-r;return a.jsxs($.SC,{children:[a.jsx($.pj,{className:"font-medium",children:e.name}),a.jsx($.pj,{className:"font-mono",children:e.code}),a.jsxs($.pj,{className:"font-medium text-blue-600",children:[eS(s)," ",e.unit]}),a.jsxs($.pj,{className:"font-medium text-red-600",children:["-",eS(r)," ",e.unit]}),a.jsxs($.pj,{className:`font-medium ${l<0?"text-red-600":"text-green-600"}`,children:[eS(l)," ",e.unit,l<0&&a.jsx("span",{className:"ml-1 text-xs bg-red-100 text-red-800 px-1 py-0.5 rounded",children:"庫存不足"})]})]},t)})})]})}),(0,a.jsxs)("div",{className:"mt-3 flex flex-wrap gap-4 text-xs text-gray-600",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[a.jsx("div",{className:"w-3 h-3 bg-blue-100 border border-blue-300 rounded"}),a.jsx("span",{children:"現有數量"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[a.jsx("div",{className:"w-3 h-3 bg-red-100 border border-red-300 rounded"}),a.jsx("span",{children:"使用數量"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[a.jsx("div",{className:"w-3 h-3 bg-green-100 border border-green-300 rounded"}),a.jsx("span",{children:"剩餘數量"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[a.jsx("div",{className:"w-3 h-3 bg-red-100 border border-red-300 rounded"}),a.jsx("span",{children:"庫存不足"})]})]}),P?.billOfMaterials.some(e=>0===(e.currentStock||0)&&(e.usedQuantity||0)>0)&&a.jsx("div",{className:"mt-3 p-2 bg-yellow-50 rounded-lg border border-yellow-200",children:(0,a.jsxs)("div",{className:"text-xs text-yellow-700",children:[a.jsx(A.Z,{className:"h-3 w-3 inline mr-1"}),"部分物料的庫存資訊可能未正確載入，請點擊「重新載入庫存」按鈕更新"]})}),P?.billOfMaterials.filter(e=>{let t=e.currentStock||0,s=e.usedQuantity||0;return t-s>=0&&s>0}).length>0&&a.jsx("div",{className:"mt-3 p-3 bg-green-50 rounded-lg border border-green-200",children:(0,a.jsxs)("div",{className:"text-center",children:[a.jsx("div",{className:"text-sm text-green-700 font-medium",children:"庫存充足項目"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-green-600",children:[P?.billOfMaterials.filter(e=>{let t=e.currentStock||0,s=e.usedQuantity||0;return t-s>=0&&s>0}).length||0," 項"]})]})}),P?.billOfMaterials.every(e=>(e.currentStock||0)>0||0===(e.usedQuantity||0))&&a.jsx("div",{className:"mt-3 p-2 bg-blue-50 rounded-lg border border-blue-200",children:(0,a.jsxs)("div",{className:"text-xs text-blue-700",children:[a.jsx(p.Z,{className:"h-3 w-3 inline mr-1"}),"庫存資訊已正確載入"]})}),a.jsx("div",{className:"mt-3 p-3 bg-orange-50 rounded-lg border border-orange-200",children:(0,a.jsxs)("div",{className:"flex items-start gap-2",children:[a.jsx(O.Z,{className:"h-4 w-4 text-orange-600 mt-0.5 flex-shrink-0"}),(0,a.jsxs)("div",{children:[a.jsx("p",{className:"text-sm font-medium text-orange-800 mb-1",children:"庫存扣除提醒"}),a.jsx("p",{className:"text-xs text-orange-700",children:"確認完工後，系統將實際扣除上述物料的使用數量，此操作無法復原。"})]})]})}),P?.billOfMaterials.filter(e=>(e.usedQuantity||0)>0).length===0&&(0,a.jsxs)("div",{className:"text-center py-4 text-red-500 bg-red-50 rounded-lg border border-red-200",children:[a.jsx(A.Z,{className:"h-6 w-6 mx-auto mb-2"}),a.jsx("p",{className:"font-medium",children:"警告：尚無填寫使用數量的物料"}),a.jsx("p",{className:"text-sm",children:"請先填寫至少一個物料的使用數量才能完工"})]}),P?.billOfMaterials.some(e=>(e.currentStock||0)-(e.usedQuantity||0)<0)&&(0,a.jsxs)("div",{className:"text-center py-4 text-orange-500 bg-orange-50 rounded-lg border border-orange-200",children:[a.jsx(A.Z,{className:"h-6 w-6 mx-auto mb-2"}),a.jsx("p",{className:"font-medium",children:"注意：有庫存不足的物料"}),a.jsx("p",{className:"text-sm",children:"部分物料的庫存不足以滿足使用數量，但仍可完工"}),(0,a.jsxs)("div",{className:"mt-3 text-left",children:[a.jsx("p",{className:"text-sm font-medium text-orange-700 mb-2",children:"庫存不足項目："}),a.jsx("div",{className:"space-y-1",children:P?.billOfMaterials.filter(e=>(e.currentStock||0)-(e.usedQuantity||0)<0).map((e,t)=>{let s=e.currentStock||0,r=e.usedQuantity||0;return a.jsxs("div",{className:"text-xs bg-orange-100 p-2 rounded border border-orange-200",children:[a.jsxs("div",{className:"font-medium",children:[e.name," (",e.code,")"]}),a.jsxs("div",{className:"text-orange-600",children:["現有: ",eS(s)," ",e.unit," | 使用: ",eS(r)," ",e.unit," | 不足: ",eS(r-s)," ",e.unit]})]},t)})})]})]})]}),(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-3",children:"工時記錄"}),R&&R.length>0?(0,a.jsxs)("div",{className:"overflow-x-auto",children:[(0,a.jsxs)($.iA,{children:[a.jsx($.xD,{children:(0,a.jsxs)($.SC,{className:"bg-gray-50",children:[a.jsx($.ss,{className:"text-gray-700 font-bold",children:"人員"}),a.jsx($.ss,{className:"text-gray-700 font-bold",children:"工作日期"}),a.jsx($.ss,{className:"text-gray-700 font-bold",children:"開始時間"}),a.jsx($.ss,{className:"text-gray-700 font-bold",children:"結束時間"}),a.jsx($.ss,{className:"text-gray-700 font-bold",children:"工時小計"})]})}),a.jsx($.RM,{children:R.map((e,t)=>(0,a.jsxs)($.SC,{children:[a.jsx($.pj,{className:"font-medium",children:e.personnelName}),a.jsx($.pj,{children:e.workDate}),a.jsx($.pj,{children:e.startTime}),a.jsx($.pj,{children:e.endTime}),(0,a.jsxs)($.pj,{className:"font-medium",children:[e.duration," 小時"]})]},t))})]}),a.jsx("div",{className:"mt-3 p-3 bg-blue-50 rounded-lg",children:(0,a.jsxs)("div",{className:"text-center",children:[a.jsx("div",{className:"text-sm text-gray-600",children:"總人工小時"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-600",children:[Math.floor(eK/60)," 小時 ",eK%60," 分鐘"]}),(0,a.jsxs)("div",{className:"text-xs text-gray-500",children:["共 ",R.length," 筆紀錄"]})]})})]}):(0,a.jsxs)("div",{className:"text-center py-4 text-orange-500 bg-orange-50 rounded-lg border border-orange-200",children:[a.jsx(A.Z,{className:"h-6 w-6 mx-auto mb-2"}),a.jsx("p",{className:"font-medium",children:"注意：尚無工時記錄"}),a.jsx("p",{className:"text-sm",children:"建議先新增工時記錄再完工，但非必要"})]})]}),(0,a.jsxs)("div",{className:"p-4 bg-blue-50 rounded-lg border border-blue-200",children:[a.jsx("h3",{className:"text-lg font-semibold text-blue-800 mb-3",children:"完工總結"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[a.jsx("div",{className:"text-sm text-blue-600 mb-1",children:"已填寫使用數量的物料"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-800",children:[P?.billOfMaterials.filter(e=>(e.usedQuantity||0)>0).length||0," 項"]})]}),(0,a.jsxs)("div",{children:[a.jsx("div",{className:"text-sm text-blue-600 mb-1",children:"總工時記錄"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-800",children:[R?.length||0," 筆"]})]}),(0,a.jsxs)("div",{children:[a.jsx("div",{className:"text-sm text-blue-600 mb-1",children:"總人工小時"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-800",children:[Math.floor(eK/60)," 小時 ",eK%60," 分鐘"]})]}),(0,a.jsxs)("div",{children:[a.jsx("div",{className:"text-sm text-blue-600 mb-1",children:"目標產量"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-800",children:[P?.targetQuantity," KG"]})]}),(0,a.jsxs)("div",{children:[a.jsx("div",{className:"text-sm text-blue-600 mb-1",children:"庫存不足項目"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-red-600",children:[P?.billOfMaterials.filter(e=>(e.currentStock||0)-(e.usedQuantity||0)<0).length||0," 項"]}),(0,a.jsxs)("div",{className:"text-xs text-red-500",children:["不足: ",P?.billOfMaterials.reduce((e,t)=>{let s=t.currentStock||0;return e+Math.max(0,(t.usedQuantity||0)-s)},0).toFixed(3)," KG"]})]}),(0,a.jsxs)("div",{children:[a.jsx("div",{className:"text-sm text-blue-600 mb-1",children:"總使用數量"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-800",children:[P?.billOfMaterials.reduce((e,t)=>e+(t.usedQuantity||0),0).toFixed(3)," KG"]})]}),(0,a.jsxs)("div",{children:[a.jsx("div",{className:"text-sm text-blue-600 mb-1",children:"庫存充足項目"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-green-600",children:[P?.billOfMaterials.filter(e=>{let t=e.currentStock||0,s=e.usedQuantity||0;return t-s>=0&&s>0}).length||0," 項"]}),(0,a.jsxs)("div",{className:"text-xs text-green-500",children:["剩餘: ",P?.billOfMaterials.reduce((e,t)=>e+Math.max(0,(t.currentStock||0)-(t.usedQuantity||0)),0).toFixed(3)," KG"]})]})]}),(0,a.jsxs)("div",{className:"mt-4 p-3 bg-white rounded-lg border border-blue-200",children:[a.jsx("h4",{className:"text-sm font-semibold text-blue-800 mb-2",children:"庫存統計摘要"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3 text-xs",children:[(0,a.jsxs)("div",{className:"text-center",children:[a.jsx("div",{className:"text-gray-600",children:"總庫存數量"}),(0,a.jsxs)("div",{className:"font-bold text-blue-600",children:[P?.billOfMaterials.reduce((e,t)=>e+(t.currentStock||0),0).toFixed(3)," KG"]})]}),(0,a.jsxs)("div",{className:"text-center",children:[a.jsx("div",{className:"text-gray-600",children:"總使用數量"}),(0,a.jsxs)("div",{className:"font-bold text-red-600",children:[P?.billOfMaterials.reduce((e,t)=>e+(t.usedQuantity||0),0).toFixed(3)," KG"]})]}),(0,a.jsxs)("div",{className:"text-center",children:[a.jsx("div",{className:"text-gray-600",children:"預計剩餘"}),(0,a.jsxs)("div",{className:"font-bold text-green-600",children:[P?.billOfMaterials.reduce((e,t)=>e+((t.currentStock||0)-(t.usedQuantity||0)),0).toFixed(3)," KG"]})]})]}),a.jsx("div",{className:"mt-3 pt-3 border-t border-blue-200",children:(0,a.jsxs)("div",{className:"text-center",children:[a.jsx("div",{className:"text-gray-600 text-xs",children:"庫存使用率"}),a.jsx("div",{className:"font-bold text-blue-600",children:(()=>{let e=P?.billOfMaterials.reduce((e,t)=>e+(t.currentStock||0),0)||0,t=P?.billOfMaterials.reduce((e,t)=>e+(t.usedQuantity||0),0)||0;return 0===e?"0%":`${(t/e*100).toFixed(1)}%`})()})]})})]})]})]}),(0,a.jsxs)(F.cN,{className:"flex flex-col sm:flex-row gap-2",children:[a.jsx(T.z,{variant:"outline",onClick:()=>ev(!1),className:"w-full sm:w-auto",title:"取消完工操作",children:"取消"}),a.jsx(T.z,{onClick:ez,disabled:ey||P?.billOfMaterials.filter(e=>(e.usedQuantity||0)>0).length===0,className:"bg-green-600 hover:bg-green-700 w-full sm:w-auto",title:P?.billOfMaterials.filter(e=>(e.usedQuantity||0)>0).length===0?"請先填寫至少一個物料的使用數量":P?.billOfMaterials.some(e=>(e.currentStock||0)-(e.usedQuantity||0)<0)?"有庫存不足的物料，但仍可完工並扣除庫存":"確認將工單狀態設為完工並扣除庫存",children:ey?(0,a.jsxs)(a.Fragment,{children:[a.jsx(x.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"完工中..."]}):(0,a.jsxs)(a.Fragment,{children:[a.jsx(p.Z,{className:"mr-2 h-4 w-4"}),P?.billOfMaterials.some(e=>(e.currentStock||0)-(e.usedQuantity||0)<0)?"確認完工並扣除庫存 (有庫存不足)":"確認完工並扣除庫存"]})})]})]})}),a.jsx(F.Vq,{open:ek,onOpenChange:eM,children:(0,a.jsxs)(F.cZ,{className:"w-[95vw] max-w-md sm:max-w-lg",children:[(0,a.jsxs)(F.fK,{children:[a.jsx(F.$N,{className:"text-blue-600 text-lg sm:text-xl",children:"確認入庫"}),(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:[(0,a.jsxs)("p",{className:"mb-3",children:['即將將工單 "',P?.code,'" 設為入庫狀態。']}),a.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:(0,a.jsxs)("div",{className:"flex items-start gap-2",children:[a.jsx(O.Z,{className:"h-4 w-4 text-yellow-600 mt-0.5 flex-shrink-0"}),(0,a.jsxs)("div",{children:[a.jsx("p",{className:"font-medium text-yellow-800 mb-1",children:"重要提醒"}),a.jsx("p",{className:"text-yellow-700 text-sm",children:"入庫後將無法再修改任何資料，包括："}),(0,a.jsxs)("ul",{className:"list-disc list-inside mt-1 text-sm text-yellow-700 space-y-1",children:[a.jsx("li",{children:"目標產量和使用數量"}),a.jsx("li",{children:"工時申報記錄"}),a.jsx("li",{children:"工單狀態"})]}),a.jsx("p",{className:"text-yellow-700 text-sm mt-2",children:"僅可繼續新增留言和查看資料。"})]})]})})]})]}),(0,a.jsxs)(F.cN,{className:"flex flex-col sm:flex-row gap-2",children:[a.jsx(T.z,{variant:"outline",onClick:()=>eM(!1),className:"w-full sm:w-auto",title:"取消入庫操作",children:"取消"}),a.jsx(T.z,{onClick:e$,disabled:eD,className:"bg-blue-600 hover:bg-blue-700 w-full sm:w-auto",title:"確認將工單狀態設為入庫",children:eD?(0,a.jsxs)(a.Fragment,{children:[a.jsx(x.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"入庫中..."]}):(0,a.jsxs)(a.Fragment,{children:[a.jsx(p.Z,{className:"mr-2 h-4 w-4"}),"確認入庫"]})})]})]})}),a.jsx(F.Vq,{open:eo,onOpenChange:em,children:(0,a.jsxs)(F.cZ,{className:"w-[95vw] max-w-md sm:max-w-lg",children:[(0,a.jsxs)(F.fK,{children:[a.jsx(F.$N,{className:"text-red-600 text-lg sm:text-xl",children:"確認刪除工單"}),(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:['此操作將永久刪除工單 "',P.code,'" 及其所有相關資料，包括：',(0,a.jsxs)("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[a.jsx("li",{children:"工單基本資料"}),a.jsx("li",{children:"所有留言記錄"}),a.jsx("li",{children:"所有上傳的圖片"}),a.jsx("li",{children:"工時記錄"})]}),a.jsx("p",{className:"mt-3 font-medium text-red-600",children:"此操作無法復原，請確認是否繼續？"})]})]}),(0,a.jsxs)(F.cN,{className:"flex flex-col sm:flex-row gap-2",children:[a.jsx(T.z,{variant:"outline",onClick:()=>em(!1),className:"w-full sm:w-auto",children:"取消"}),a.jsx(T.z,{variant:"destructive",onClick:eB,disabled:ex,className:"bg-red-600 hover:bg-red-700 w-full sm:w-auto",children:ex?(0,a.jsxs)(a.Fragment,{children:[a.jsx(x.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"刪除中..."]}):(0,a.jsxs)(a.Fragment,{children:[a.jsx(f.Z,{className:"mr-2 h-4 w-4"}),"確認刪除"]})})]})]})})]})}):a.jsx("div",{className:"container mx-auto py-10",children:(0,a.jsxs)("div",{className:"text-center",children:[a.jsx("p",{className:"text-red-600 mb-4",children:"工單不存在"}),(0,a.jsxs)(T.z,{onClick:()=>t.push("/dashboard/work-orders"),children:[a.jsx(u.Z,{className:"mr-2 h-4 w-4"}),"返回工單列表"]})]})})}},29280:(e,t,s)=>{"use strict";s.d(t,{Bw:()=>g,Ph:()=>o,Ql:()=>p,i4:()=>x,ki:()=>m});var a=s(10326),r=s(17577),l=s(38785),i=s(941),n=s(96633),d=s(32933),c=s(51223);let o=l.fC;l.ZA;let m=l.B4,x=r.forwardRef(({className:e,children:t,...s},r)=>(0,a.jsxs)(l.xz,{ref:r,className:(0,c.cn)("flex h-10 w-full items-center justify-between rounded-md border border-slate-200 bg-white px-3 py-2 text-sm ring-offset-white placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-950 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1 dark:border-slate-800 dark:bg-slate-950 dark:ring-offset-slate-950 dark:placeholder:text-slate-400 dark:focus:ring-slate-300",e),...s,children:[t,a.jsx(l.JO,{asChild:!0,children:a.jsx(i.Z,{className:"h-4 w-4 opacity-50"})})]}));x.displayName=l.xz.displayName;let u=r.forwardRef(({className:e,...t},s)=>a.jsx(l.u_,{ref:s,className:(0,c.cn)("flex cursor-default items-center justify-center py-1",e),...t,children:a.jsx(n.Z,{className:"h-4 w-4"})}));u.displayName=l.u_.displayName;let h=r.forwardRef(({className:e,...t},s)=>a.jsx(l.$G,{ref:s,className:(0,c.cn)("flex cursor-default items-center justify-center py-1",e),...t,children:a.jsx(i.Z,{className:"h-4 w-4"})}));h.displayName=l.$G.displayName;let g=r.forwardRef(({className:e,children:t,position:s="popper",...r},i)=>a.jsx(l.h_,{children:(0,a.jsxs)(l.VY,{ref:i,className:(0,c.cn)("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border border-slate-200 bg-white text-slate-950 shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-50","popper"===s&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",e),position:s,...r,children:[a.jsx(u,{}),a.jsx(l.l_,{className:(0,c.cn)("p-1","popper"===s&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:t}),a.jsx(h,{})]})}));g.displayName=l.VY.displayName,r.forwardRef(({className:e,...t},s)=>a.jsx(l.__,{ref:s,className:(0,c.cn)("py-1.5 pl-8 pr-2 text-sm font-semibold",e),...t})).displayName=l.__.displayName;let p=r.forwardRef(({className:e,children:t,...s},r)=>(0,a.jsxs)(l.ck,{ref:r,className:(0,c.cn)("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-slate-100 focus:text-slate-900 data-[disabled]:pointer-events-none data-[disabled]:opacity-50 dark:focus:bg-slate-800 dark:focus:text-slate-50",e),...s,children:[a.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:a.jsx(l.wU,{children:a.jsx(d.Z,{className:"h-4 w-4"})})}),a.jsx(l.eT,{children:t})]}));p.displayName=l.ck.displayName,r.forwardRef(({className:e,...t},s)=>a.jsx(l.Z0,{ref:s,className:(0,c.cn)("-mx-1 my-1 h-px bg-slate-100 dark:bg-slate-800",e),...t})).displayName=l.Z0.displayName},49527:(e,t,s)=>{"use strict";s.d(t,{n:()=>r});let a={PG_MATERIAL_CODES:["UV3404503","PG"],VG_MATERIAL_CODES:["UV3400698","VG"],NICOTINE_MATERIAL_CODES:["UV3405520","NIC","丁鹽","尼古丁"],PG_MATERIAL_NAMES:["PG丙二醇","PG","丙二醇"],VG_MATERIAL_NAMES:["VG甘油","VG","甘油"],NICOTINE_MATERIAL_NAMES:["丁鹽","尼古丁","NicSalt"]},r=(e,t)=>e.find(e=>{let s=e.code?.toUpperCase()||"",r=e.name||"";switch(t){case"pg":return a.PG_MATERIAL_CODES.some(e=>s.includes(e))||a.PG_MATERIAL_NAMES.some(e=>r.includes(e));case"vg":return a.VG_MATERIAL_CODES.some(e=>s.includes(e))||a.VG_MATERIAL_NAMES.some(e=>r.includes(e));case"nicotine":return a.NICOTINE_MATERIAL_CODES.some(e=>s.includes(e))||a.NICOTINE_MATERIAL_NAMES.some(e=>r.includes(e));default:return!1}})},95521:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>a});let a=(0,s(68570).createProxy)(String.raw`D:\APP\deer-lab\src\app\dashboard\work-orders\[id]\page.tsx#default`)},98958:(e,t,s)=>{"use strict";s.d(t,{Dx:()=>ea,VY:()=>es,aV:()=>et,dk:()=>er,fC:()=>X,h_:()=>ee,jm:()=>L,p8:()=>v,x8:()=>el,xz:()=>J});var a=s(17577),r=s(82561),l=s(48051),i=s(93095),n=s(88957),d=s(52067),c=s(825),o=s(10441),m=s(83078),x=s(9815),u=s(45226),h=s(80699),g=s(58260),p=s(35664),f=s(34214),b=s(10326),j="Dialog",[N,v]=(0,i.b)(j),[y,w]=N(j),k=e=>{let{__scopeDialog:t,children:s,open:r,defaultOpen:l,onOpenChange:i,modal:c=!0}=e,o=a.useRef(null),m=a.useRef(null),[x,u]=(0,d.T)({prop:r,defaultProp:l??!1,onChange:i,caller:j});return(0,b.jsx)(y,{scope:t,triggerRef:o,contentRef:m,contentId:(0,n.M)(),titleId:(0,n.M)(),descriptionId:(0,n.M)(),open:x,onOpenChange:u,onOpenToggle:a.useCallback(()=>u(e=>!e),[u]),modal:c,children:s})};k.displayName=j;var M="DialogTrigger",D=a.forwardRef((e,t)=>{let{__scopeDialog:s,...a}=e,i=w(M,s),n=(0,l.e)(t,i.triggerRef);return(0,b.jsx)(u.WV.button,{type:"button","aria-haspopup":"dialog","aria-expanded":i.open,"aria-controls":i.contentId,"data-state":V(i.open),...a,ref:n,onClick:(0,r.Mj)(e.onClick,i.onOpenToggle)})});D.displayName=M;var C="DialogPortal",[S,A]=N(C,{forceMount:void 0}),O=e=>{let{__scopeDialog:t,forceMount:s,children:r,container:l}=e,i=w(C,t);return(0,b.jsx)(S,{scope:t,forceMount:s,children:a.Children.map(r,e=>(0,b.jsx)(x.z,{present:s||i.open,children:(0,b.jsx)(m.h,{asChild:!0,container:l,children:e})}))})};O.displayName=C;var T="DialogOverlay",Z=a.forwardRef((e,t)=>{let s=A(T,e.__scopeDialog),{forceMount:a=s.forceMount,...r}=e,l=w(T,e.__scopeDialog);return l.modal?(0,b.jsx)(x.z,{present:a||l.open,children:(0,b.jsx)($,{...r,ref:t})}):null});Z.displayName=T;var z=(0,f.Z8)("DialogOverlay.RemoveScroll"),$=a.forwardRef((e,t)=>{let{__scopeDialog:s,...a}=e,r=w(T,s);return(0,b.jsx)(g.Z,{as:z,allowPinchZoom:!0,shards:[r.contentRef],children:(0,b.jsx)(u.WV.div,{"data-state":V(r.open),...a,ref:t,style:{pointerEvents:"auto",...a.style}})})}),E="DialogContent",Q=a.forwardRef((e,t)=>{let s=A(E,e.__scopeDialog),{forceMount:a=s.forceMount,...r}=e,l=w(E,e.__scopeDialog);return(0,b.jsx)(x.z,{present:a||l.open,children:l.modal?(0,b.jsx)(I,{...r,ref:t}):(0,b.jsx)(_,{...r,ref:t})})});Q.displayName=E;var I=a.forwardRef((e,t)=>{let s=w(E,e.__scopeDialog),i=a.useRef(null),n=(0,l.e)(t,s.contentRef,i);return a.useEffect(()=>{let e=i.current;if(e)return(0,p.Ry)(e)},[]),(0,b.jsx)(F,{...e,ref:n,trapFocus:s.open,disableOutsidePointerEvents:!0,onCloseAutoFocus:(0,r.Mj)(e.onCloseAutoFocus,e=>{e.preventDefault(),s.triggerRef.current?.focus()}),onPointerDownOutside:(0,r.Mj)(e.onPointerDownOutside,e=>{let t=e.detail.originalEvent,s=0===t.button&&!0===t.ctrlKey;(2===t.button||s)&&e.preventDefault()}),onFocusOutside:(0,r.Mj)(e.onFocusOutside,e=>e.preventDefault())})}),_=a.forwardRef((e,t)=>{let s=w(E,e.__scopeDialog),r=a.useRef(!1),l=a.useRef(!1);return(0,b.jsx)(F,{...e,ref:t,trapFocus:!1,disableOutsidePointerEvents:!1,onCloseAutoFocus:t=>{e.onCloseAutoFocus?.(t),t.defaultPrevented||(r.current||s.triggerRef.current?.focus(),t.preventDefault()),r.current=!1,l.current=!1},onInteractOutside:t=>{e.onInteractOutside?.(t),t.defaultPrevented||(r.current=!0,"pointerdown"!==t.detail.originalEvent.type||(l.current=!0));let a=t.target;s.triggerRef.current?.contains(a)&&t.preventDefault(),"focusin"===t.detail.originalEvent.type&&l.current&&t.preventDefault()}})}),F=a.forwardRef((e,t)=>{let{__scopeDialog:s,trapFocus:r,onOpenAutoFocus:i,onCloseAutoFocus:n,...d}=e,m=w(E,s),x=a.useRef(null),u=(0,l.e)(t,x);return(0,h.EW)(),(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(o.M,{asChild:!0,loop:!0,trapped:r,onMountAutoFocus:i,onUnmountAutoFocus:n,children:(0,b.jsx)(c.XB,{role:"dialog",id:m.contentId,"aria-describedby":m.descriptionId,"aria-labelledby":m.titleId,"data-state":V(m.open),...d,ref:u,onDismiss:()=>m.onOpenChange(!1)})}),(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(U,{titleId:m.titleId}),(0,b.jsx)(Y,{contentRef:x,descriptionId:m.descriptionId})]})]})}),P="DialogTitle",q=a.forwardRef((e,t)=>{let{__scopeDialog:s,...a}=e,r=w(P,s);return(0,b.jsx)(u.WV.h2,{id:r.titleId,...a,ref:t})});q.displayName=P;var R="DialogDescription",B=a.forwardRef((e,t)=>{let{__scopeDialog:s,...a}=e,r=w(R,s);return(0,b.jsx)(u.WV.p,{id:r.descriptionId,...a,ref:t})});B.displayName=R;var G="DialogClose",K=a.forwardRef((e,t)=>{let{__scopeDialog:s,...a}=e,l=w(G,s);return(0,b.jsx)(u.WV.button,{type:"button",...a,ref:t,onClick:(0,r.Mj)(e.onClick,()=>l.onOpenChange(!1))})});function V(e){return e?"open":"closed"}K.displayName=G;var H="DialogTitleWarning",[L,W]=(0,i.k)(H,{contentName:E,titleName:P,docsSlug:"dialog"}),U=({titleId:e})=>{let t=W(H),s=`\`${t.contentName}\` requires a \`${t.titleName}\` for the component to be accessible for screen reader users.

If you want to hide the \`${t.titleName}\`, you can wrap it with our VisuallyHidden component.

For more information, see https://radix-ui.com/primitives/docs/components/${t.docsSlug}`;return a.useEffect(()=>{e&&!document.getElementById(e)&&console.error(s)},[s,e]),null},Y=({contentRef:e,descriptionId:t})=>{let s=W("DialogDescriptionWarning"),r=`Warning: Missing \`Description\` or \`aria-describedby={undefined}\` for {${s.contentName}}.`;return a.useEffect(()=>{let s=e.current?.getAttribute("aria-describedby");t&&s&&!document.getElementById(t)&&console.warn(r)},[r,e,t]),null},X=k,J=D,ee=O,et=Z,es=Q,ea=q,er=B,el=K},34478:(e,t,s)=>{"use strict";s.d(t,{f:()=>n});var a=s(17577),r=s(45226),l=s(10326),i=a.forwardRef((e,t)=>(0,l.jsx)(r.WV.label,{...e,ref:t,onMouseDown:t=>{t.target.closest("button, input, select, textarea")||(e.onMouseDown?.(t),!t.defaultPrevented&&t.detail>1&&t.preventDefault())}}));i.displayName="Label";var n=i}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[8948,9654,5540,8693,692,4108,4334,5182],()=>s(16437));module.exports=a})();