"use strict";exports.id=8012,exports.ids=[8012],exports.modules={98258:(e,s,r)=>{r.d(s,{Z:()=>a});let a=(0,r(62881).Z)("FlaskConical",[["path",{d:"M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2",key:"pzvekw"}],["path",{d:"M8.5 2h7",key:"csnxdl"}],["path",{d:"M7 16h10",key:"wp8him"}]])},88012:(e,s,r)=>{r.d(s,{u:()=>I});var a=r(10326),l=r(17577),t=r(74723),n=r(74064),o=r(770),d=r(78880),i=r(76),c=r(90445),x=r(85999),m=r(91664),u=r(24118),g=r(9969),h=r(41190),p=r(29280),f=r(25038),j=r(48705),b=r(40765),N=r(98258),v=r(941),y=r(88307),w=r(32933);let C=o.Ry({name:o.Z_().min(2,{message:"產品名稱至少需要 2 個字元"}),seriesId:o.Z_({required_error:"必須選擇一個產品系列"}),fragranceId:o.Z_({required_error:"必須選擇一個香精"}),nicotineMg:o.oQ.number().min(0,{message:"尼古丁濃度不能為負數"}).default(0),specificMaterialIds:o.IX(o.Z_()).optional().default([]),status:o.Km(["啟用","備用","棄用"]).default("啟用")});function I({isOpen:e,onOpenChange:s,onProductUpdate:r,productData:o}){let[I,k]=(0,l.useState)(!1),[S,L]=(0,l.useState)({series:[],fragrances:[],materials:[]}),[M,Z]=(0,l.useState)(null),[z,R]=(0,l.useState)({percentage:0,pgRatio:0,vgRatio:0}),[X,J]=(0,l.useState)(""),[D,G]=(0,l.useState)(!1),[T,V]=(0,l.useState)(""),[$,P]=(0,l.useState)(""),[A,W]=(0,l.useState)([]),F=!!o,Q=(0,t.cI)({resolver:(0,n.F)(C),defaultValues:{name:"",seriesId:void 0,fragranceId:void 0,nicotineMg:0,specificMaterialIds:[],status:"啟用"}}),_=async e=>{if(!e||!c.db){Z(null),R({percentage:0,pgRatio:0,vgRatio:0});return}try{let s=await (0,i.QT)((0,i.doc)(c.db,"fragrances",e));if(s.exists()){let e=s.data();Z(e),R({percentage:e.percentage||0,pgRatio:e.pgRatio||0,vgRatio:e.vgRatio||0})}}catch(e){console.error("獲取香精配方失敗:",e)}};async function B(e){k(!0);let a=x.Am.loading(F?"正在更新產品...":"正在新增產品...");try{let l=(0,d.$C)(),t={...e};if(F&&o){let s=(0,d.V1)(l,"updateProduct");await s({productId:o.id,...t}),x.Am.success(`產品 ${e.name} 已更新。`,{id:a})}else{let s=(0,d.V1)(l,"createProduct");await s(t),x.Am.success(`產品 ${e.name} 已建立。`,{id:a})}r(),s(!1)}catch(s){let e=s instanceof Error?s.message:"發生未知錯誤。";x.Am.error(e,{id:a})}finally{k(!1)}}return(0,l.useEffect)(()=>{let e=Q.watch("seriesId");if(console.log("系列選擇改變:",{seriesId:e,isEditMode:F,seriesInfoLength:A.length}),e&&!F&&A.length>0){let s=A.find(s=>s.id===e);if(console.log("找到的系列信息:",s),s&&s.productType&&s.code){let e=Math.floor(1e3+9e3*Math.random());V(String(e));let r=`${s.productType}-${s.code}-${e}`;P(r),console.log("成功生成產品代碼:",{productType:s.productType,code:s.code,randomNumber:e,fullCode:r})}else V(""),P(""),console.log("未找到系列信息或產品類型:",{hasSelectedSeriesInfo:!!s,productType:s?.productType,code:s?.code})}else V(""),P(""),e&&!F&&0===A.length&&console.log("系列資訊尚未載入完成")},[Q.watch("seriesId"),A,F]),a.jsx(u.Vq,{open:e,onOpenChange:s,children:(0,a.jsxs)(u.cZ,{className:"max-w-4xl max-h-[90vh] overflow-y-auto bg-white",children:[(0,a.jsxs)(u.fK,{className:"pb-4 border-b border-gray-200",children:[(0,a.jsxs)(u.$N,{className:"flex items-center gap-3 text-2xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent",children:[a.jsx("div",{className:"w-10 h-10 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center",children:a.jsx(j.Z,{className:"h-5 w-5 text-white"})}),F?"編輯產品":"新增產品"]}),a.jsx(u.Be,{className:"text-gray-600 mt-2",children:F?"修改產品詳細資訊":"建立新的產品資料"})]}),a.jsx(g.l0,{...Q,children:(0,a.jsxs)("form",{onSubmit:Q.handleSubmit(B),className:"space-y-6",children:[(0,a.jsxs)("div",{className:"space-y-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200 shadow-sm",children:[(0,a.jsxs)("h3",{className:"text-lg font-bold flex items-center gap-2 text-blue-800",children:[a.jsx("div",{className:"w-6 h-6 bg-blue-100 rounded-lg flex items-center justify-center",children:a.jsx(b.Z,{className:"h-3 w-3 text-blue-600"})}),"基本資料"]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[a.jsx(g.Wi,{control:Q.control,name:"name",render:({field:e})=>(0,a.jsxs)(g.xJ,{className:"space-y-2",children:[a.jsx(g.lX,{className:"text-sm font-semibold text-gray-700",children:"產品名稱 *"}),a.jsx(g.NI,{children:a.jsx(h.I,{placeholder:"例如：茉莉綠茶香精",className:"border-gray-300 focus:border-blue-500 focus:ring-blue-500",...e})}),a.jsx(g.zG,{})]})}),a.jsx(g.Wi,{control:Q.control,name:"seriesId",render:({field:e})=>(0,a.jsxs)(g.xJ,{className:"space-y-2",children:[a.jsx(g.lX,{className:"text-sm font-semibold text-gray-700",children:"所屬系列 *"}),(0,a.jsxs)(p.Ph,{onValueChange:e.onChange,value:e.value,children:[a.jsx(g.NI,{children:a.jsx(p.i4,{className:"border-gray-300 focus:border-blue-500 focus:ring-blue-500",children:a.jsx(p.ki,{placeholder:"選擇一個產品系列"})})}),a.jsx(p.Bw,{children:S.series.map(e=>a.jsx(p.Ql,{value:e.value,children:e.label},e.value))})]}),a.jsx(g.zG,{})]})}),a.jsx(g.Wi,{control:Q.control,name:"nicotineMg",render:({field:e})=>(0,a.jsxs)(g.xJ,{className:"space-y-2",children:[a.jsx(g.lX,{className:"text-sm font-semibold text-gray-700",children:"丁鹽濃度 (MG)"}),a.jsx(g.NI,{children:a.jsx(h.I,{type:"number",placeholder:"0",className:"border-gray-300 focus:border-blue-500 focus:ring-blue-500",...e})}),a.jsx(g.zG,{})]})}),a.jsx(g.Wi,{control:Q.control,name:"status",render:({field:e})=>(0,a.jsxs)(g.xJ,{className:"space-y-2",children:[a.jsx(g.lX,{className:"text-sm font-semibold text-gray-700",children:"產品狀態"}),(0,a.jsxs)(p.Ph,{onValueChange:e.onChange,defaultValue:e.value,children:[a.jsx(g.NI,{children:a.jsx(p.i4,{className:"border-gray-300 focus:border-blue-500 focus:ring-blue-500",children:a.jsx(p.ki,{placeholder:"選擇產品狀態"})})}),(0,a.jsxs)(p.Bw,{children:[a.jsx(p.Ql,{value:"啟用",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full"}),"啟用"]})}),a.jsx(p.Ql,{value:"備用",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:"w-3 h-3 bg-yellow-500 rounded-full"}),"備用"]})}),a.jsx(p.Ql,{value:"棄用",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:"w-3 h-3 bg-pink-500 rounded-full"}),"棄用"]})})]})]}),a.jsx(g.zG,{})]})}),!F&&Q.watch("seriesId")&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(g.xJ,{className:"space-y-2",children:[a.jsx(g.lX,{className:"text-sm font-semibold text-gray-700",children:"產品編號"}),a.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-300 rounded-md",children:a.jsx("span",{className:"text-sm font-mono text-gray-700",children:T||"載入中..."})}),a.jsx("p",{className:"text-xs text-gray-500",children:"4位數隨機編號，系統自動生成"}),!T&&a.jsx("p",{className:"text-xs text-red-500",children:"如果持續載入中，請重新選擇系列"})]}),(0,a.jsxs)(g.xJ,{className:"space-y-2",children:[a.jsx(g.lX,{className:"text-sm font-semibold text-gray-700",children:"產品代碼預覽"}),a.jsx("div",{className:"px-3 py-2 bg-blue-50 border border-blue-300 rounded-md",children:a.jsx("span",{className:"text-sm font-mono text-blue-700",children:$||"載入中..."})}),a.jsx("p",{className:"text-xs text-blue-500",children:"格式：[系列類型]-[系列代號]-[隨機編號]"})]})]}),F&&o&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(g.xJ,{className:"space-y-2",children:[a.jsx(g.lX,{className:"text-sm font-semibold text-gray-700",children:"產品編號"}),a.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-300 rounded-md",children:a.jsx("span",{className:"text-sm font-mono text-gray-700",children:o.productNumber||"N/A"})}),a.jsx("p",{className:"text-xs text-gray-500",children:"產品編號不可修改"})]}),(0,a.jsxs)(g.xJ,{className:"space-y-2",children:[a.jsx(g.lX,{className:"text-sm font-semibold text-gray-700",children:"產品代號"}),a.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-300 rounded-md",children:a.jsx("span",{className:"text-sm font-mono text-gray-700",children:o.code||"N/A"})}),a.jsx("p",{className:"text-xs text-gray-500",children:"產品代號不可修改"})]})]})]})]}),(0,a.jsxs)("div",{className:"space-y-6 p-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-200 shadow-sm",children:[(0,a.jsxs)("h3",{className:"text-xl font-bold flex items-center gap-3 text-green-800",children:[a.jsx("div",{className:"w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center",children:a.jsx(N.Z,{className:"h-4 w-4 text-green-600"})}),"使用香精"]}),a.jsx("div",{className:"grid grid-cols-1 gap-6",children:a.jsx(g.Wi,{control:Q.control,name:"fragranceId",render:({field:e})=>(0,a.jsxs)(g.xJ,{children:[a.jsx(g.lX,{className:"text-sm font-semibold text-gray-700",children:"選擇香精 *"}),(0,a.jsxs)("div",{className:"relative fragrance-dropdown",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between w-full px-3 py-2 border border-gray-300 rounded-md bg-white cursor-pointer hover:border-green-500 focus-within:border-green-500 focus-within:ring-2 focus-within:ring-green-500",onClick:()=>G(!D),children:[a.jsx("span",{className:e.value?"text-gray-900":"text-gray-500",children:e.value&&S.fragrances.find(s=>s.value===e.value)?.label||"選擇一個香精"}),a.jsx(v.Z,{className:`h-4 w-4 text-gray-400 transition-transform ${D?"rotate-180":""}`})]}),D&&(0,a.jsxs)("div",{className:"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-hidden",children:[a.jsx("div",{className:"p-2 border-b border-gray-200",children:(0,a.jsxs)("div",{className:"relative",children:[a.jsx(y.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),a.jsx(h.I,{type:"text",placeholder:"搜尋香精...",value:X,onChange:e=>J(e.target.value),className:"pl-10 border-0 focus:ring-0 focus:border-0",onClick:e=>e.stopPropagation()})]})}),(0,a.jsxs)("div",{className:"max-h-48 overflow-y-auto",children:[S.fragrances.filter(e=>e.label.toLowerCase().includes(X.toLowerCase())).map(s=>(0,a.jsxs)("div",{className:`flex items-center justify-between px-3 py-2 cursor-pointer hover:bg-green-50 ${e.value===s.value?"bg-green-100":""}`,onClick:()=>{e.onChange(s.value),_(s.value),G(!1),J("")},children:[a.jsx("span",{className:"text-sm",children:s.label}),e.value===s.value&&a.jsx(w.Z,{className:"h-4 w-4 text-green-600"})]},s.value)),0===S.fragrances.filter(e=>e.label.toLowerCase().includes(X.toLowerCase())).length&&a.jsx("div",{className:"px-3 py-2 text-sm text-gray-500 text-center",children:"沒有找到符合的香精"})]})]})]}),a.jsx(g.zG,{})]})})}),M&&(0,a.jsxs)("div",{className:"bg-white rounded-lg p-4 border border-green-200",children:[a.jsx("h4",{className:"font-semibold text-green-800 mb-3",children:"香精配方資訊"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 text-sm",children:[(0,a.jsxs)("div",{children:[a.jsx("span",{className:"text-gray-600",children:"香精名稱："}),a.jsx("span",{className:"font-medium",children:M.name})]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"text-gray-600",children:"香精代號："}),a.jsx("span",{className:"font-medium",children:M.code})]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"text-gray-600",children:"香精比例："}),(0,a.jsxs)("span",{className:"font-medium text-green-600",children:[z.percentage,"%"]})]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"text-gray-600",children:"PG比例："}),(0,a.jsxs)("span",{className:"font-medium text-blue-600",children:[z.pgRatio,"%"]})]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"text-gray-600",children:"VG比例："}),(0,a.jsxs)("span",{className:"font-medium text-purple-600",children:[z.vgRatio,"%"]})]})]})]})]}),(0,a.jsxs)("div",{className:"space-y-6 p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border border-purple-200 shadow-sm",children:[(0,a.jsxs)("h3",{className:"text-xl font-bold flex items-center gap-3 text-purple-800",children:[a.jsx("div",{className:"w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center",children:a.jsx(j.Z,{className:"h-4 w-4 text-purple-600"})}),"專屬材料"]}),a.jsx("div",{className:"grid grid-cols-1 gap-6",children:a.jsx(g.Wi,{control:Q.control,name:"specificMaterialIds",render:({field:e})=>(0,a.jsxs)(g.xJ,{children:[a.jsx(g.lX,{className:"text-sm font-semibold text-gray-700",children:"選擇專屬材料"}),a.jsx(f.N,{options:S.materials,selected:e.value||[],onChange:e.onChange,placeholder:"選擇該產品專屬使用的材料..."}),a.jsx(g.zG,{})]})})})]}),(0,a.jsxs)("div",{className:"flex justify-end gap-3 pt-6 border-t border-gray-200",children:[a.jsx(m.z,{type:"button",variant:"outline",onClick:()=>s(!1),className:"border-gray-300 text-gray-700 hover:bg-gray-50",children:"取消"}),a.jsx(m.z,{type:"submit",disabled:I,className:"bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white shadow-lg hover:shadow-xl transition-all duration-200",children:I?(0,a.jsxs)(a.Fragment,{children:[a.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"處理中..."]}):F?"儲存更新":"確認新增"})]})]})})]})})}},25038:(e,s,r)=>{r.d(s,{N:()=>o});var a=r(10326),l=r(17577),t=r(94019),n=r(38443);function o({options:e,selected:s,onChange:r,onAddNew:o,placeholder:d="Select options...",className:i,allowCreate:c=!1}){let[x,m]=l.useState(!1),[u,g]=l.useState(""),h=l.useRef(null),p=e=>{g(""),r([...s,e])},f=()=>{u.trim()&&o&&(o(u.trim()),g(""))},j=e=>{r(s.filter(s=>s!==e))},b=e.filter(e=>s.includes(e.value)),N=e.filter(e=>{if(s.includes(e.value))return!1;if(!u.trim())return!0;let r=u.trim().toLowerCase(),a=(e.materialName||e.label).toLowerCase(),l=(e.category||"").toLowerCase(),t=(e.subCategory||"").toLowerCase(),n=e.label.toLowerCase();return a.includes(r)||l.includes(r)||t.includes(r)||n.includes(r)}).sort((e,s)=>{let r=(e.materialName||e.label).toLowerCase(),a=(s.materialName||s.label).toLowerCase();return r.localeCompare(a,"zh-TW")});return(0,a.jsxs)("div",{className:"overflow-visible bg-transparent",children:[a.jsx("div",{className:"group border border-input px-3 py-2 text-sm ring-offset-background rounded-md focus-within:ring-2 focus-within:ring-ring focus-within:ring-offset-2",children:(0,a.jsxs)("div",{className:"flex gap-1 flex-wrap",children:[b.map(({value:e,label:s,category:r,subCategory:l,materialName:o})=>(0,a.jsxs)(n.C,{variant:"secondary",className:"flex items-center gap-1",children:[a.jsx("span",{className:"font-medium",children:o||s}),r&&a.jsx("span",{className:"px-1 py-0.5 text-xs rounded bg-blue-100 text-blue-800 font-medium",children:r}),l&&a.jsx("span",{className:"px-1 py-0.5 text-xs rounded bg-green-100 text-green-800 font-medium",children:l}),a.jsx("button",{className:"ml-1 ring-offset-background rounded-full outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",onKeyDown:s=>{"Enter"===s.key&&j(e)},onMouseDown:e=>e.preventDefault(),onClick:()=>j(e),children:a.jsx(t.Z,{className:"h-3 w-3 text-muted-foreground hover:text-foreground"})})]},e)),a.jsx("input",{ref:h,type:"text",value:u,onChange:e=>{let s=e.target.value;g(s),s.trim()?m(!0):m(!1)},onKeyDown:e=>{"Backspace"===e.key&&""===u&&s.length>0&&j(s[s.length-1]),"Enter"===e.key&&u.trim()&&c&&o&&(e.preventDefault(),f())},onBlur:()=>{setTimeout(()=>m(!1),200)},onFocus:()=>{u.trim()&&m(!0)},placeholder:d,className:"ml-2 bg-transparent outline-none placeholder:text-muted-foreground flex-1"})]})}),a.jsx("div",{className:"relative mt-2",children:x&&(N.length>0||c&&u.trim())?a.jsx("div",{className:"absolute w-full z-10 top-0 rounded-md border bg-popover text-popover-foreground shadow-md outline-none animate-in",children:(0,a.jsxs)("div",{className:"h-full overflow-auto",children:[N.map(({value:e,label:s,category:r,subCategory:l,materialName:t})=>a.jsx("div",{onMouseDown:e=>{e.preventDefault(),e.stopPropagation()},onClick:()=>p(e),className:"cursor-pointer px-2 py-3 hover:bg-accent hover:text-accent-foreground",children:(0,a.jsxs)("div",{className:"flex items-center gap-2 w-full",children:[a.jsx("span",{className:"flex-1 font-medium",children:t||s}),r&&a.jsx("span",{className:"px-2 py-1 text-xs rounded-md bg-blue-100 text-blue-800 font-medium",children:r}),l&&a.jsx("span",{className:"px-2 py-1 text-xs rounded-md bg-green-100 text-green-800 font-medium",children:l})]})},e)),c&&u.trim()&&!N.find(e=>e.label.toLowerCase()===u.toLowerCase())&&(0,a.jsxs)("div",{onMouseDown:e=>{e.preventDefault(),e.stopPropagation()},onClick:f,className:"cursor-pointer text-blue-600 px-2 py-3 hover:bg-accent hover:text-accent-foreground",children:['新增 "',u.trim(),'"']})]})}):null})]})}}};