(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3604],{64341:function(e,s,t){Promise.resolve().then(t.bind(t,5287))},60044:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});let a=(0,t(79205).Z)("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]])},41671:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});let a=(0,t(79205).Z)("CircleCheckBig",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]])},16275:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});let a=(0,t(79205).Z)("ShoppingCart",[["circle",{cx:"8",cy:"21",r:"1",key:"jimo8o"}],["circle",{cx:"19",cy:"21",r:"1",key:"13723u"}],["path",{d:"M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12",key:"9zh506"}]])},5287:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return R}});var a=t(57437),r=t(2265),l=t(99376),i=t(5978),c=t(46410),n=t(1850),d=t(14438),m=t(60713),o=t(51817),x=t(32660),h=t(41671);let u=(0,t(79205).Z)("Truck",[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]]);var g=t(18930),j=t(16275),p=t(60044),b=t(92369),f=t(31047),N=t(44794),y=t(99397),v=t(32489),w=t(53417),k=t(17689),C=t(79820),Z=t(33804),S=t(69174),A=t(12381),z=t(40279),q=t(23675),O=t(74291),I=t(29501),M=t(67119),E=t(13590),F=t(80670);let P=M.Ry({items:M.IX(M.Ry({id:M.Z_(),name:M.Z_(),code:M.Z_(),unit:M.Z_(),itemRef:M.Yj(),quantity:M.oQ.number().min(0,"數量不能為負數"),receivedQuantity:M.oQ.number().min(0,"數量不能為負數")}))});function B(e){let{isOpen:s,onOpenChange:t,onSuccess:r,purchaseOrder:l}=e,i=(0,I.cI)({resolver:(0,E.F)(P),defaultValues:{items:l.items.map(e=>({...e,receivedQuantity:e.quantity}))}}),{fields:c}=(0,I.Dq)({control:i.control,name:"items"}),m=async e=>{i.clearErrors();let s=d.Am.loading("正在處理入庫...");try{let a=(0,n.$C)(),i=(0,n.V1)(a,"receivePurchaseOrderItems"),c={purchaseOrderId:l.id,items:e.items.map(e=>{var s;return{itemRefPath:(null===(s=e.itemRef)||void 0===s?void 0:s.path)||e.itemRef,receivedQuantity:e.receivedQuantity}})};console.log("=== 採購單入庫除錯日誌 ==="),console.log("採購單 ID:",l.id),console.log("採購單狀態:",l.status),console.log("發送 payload:",JSON.stringify(c,null,2));let m=await i(c);console.log("Cloud Function 回應:",JSON.stringify(m,null,2)),m.data&&console.log("入庫成功，更新結果:",m.data),d.Am.success("收貨入庫成功，庫存已更新。",{id:s}),r(),t(!1)}catch(t){var a;console.error("=== 入庫操作失敗 ==="),console.error("錯誤類型:",null==t?void 0:null===(a=t.constructor)||void 0===a?void 0:a.name),console.error("錯誤訊息:",t instanceof Error?t.message:t),console.error("完整錯誤物件:",t);let e=t instanceof Error?t.message:"入庫操作失敗";d.Am.error(e,{id:s})}};return(0,a.jsx)(O.Vq,{open:s,onOpenChange:t,children:(0,a.jsxs)(O.cZ,{className:"max-w-3xl","aria-describedby":"receive-dialog-description",children:[(0,a.jsxs)(O.fK,{children:[(0,a.jsx)(O.$N,{children:"收貨與入庫確認"}),(0,a.jsx)(O.Be,{id:"receive-dialog-description",children:"請確認以下採購項目的實際到貨數量。系統將根據您填寫的數量更新庫存。"})]}),(0,a.jsx)(F.l0,{...i,children:(0,a.jsxs)("form",{onSubmit:i.handleSubmit(m),children:[(0,a.jsx)("div",{className:"max-h-[60vh] overflow-y-auto pr-4",children:(0,a.jsxs)(Z.iA,{children:[(0,a.jsx)(Z.xD,{children:(0,a.jsxs)(Z.SC,{children:[(0,a.jsx)(Z.ss,{children:"品項名稱"}),(0,a.jsx)(Z.ss,{className:"w-[120px]",children:"採購數量"}),(0,a.jsx)(Z.ss,{className:"w-[150px]",children:"實際收到數量"})]})}),(0,a.jsx)(Z.RM,{children:c.map((e,s)=>(0,a.jsxs)(Z.SC,{children:[(0,a.jsxs)(Z.pj,{className:"font-medium",children:[e.name," ",(0,a.jsx)("span",{className:"text-muted-foreground font-mono text-xs",children:e.code})]}),(0,a.jsxs)(Z.pj,{children:[e.quantity," ",e.unit]}),(0,a.jsx)(Z.pj,{children:(0,a.jsx)(I.Qr,{control:i.control,name:"items.".concat(s,".receivedQuantity"),render:e=>{let{field:s}=e;return(0,a.jsx)(z.I,{type:"number",min:"0",...s})}})})]},e.id))})]})}),(0,a.jsxs)(O.cN,{className:"mt-6",children:[(0,a.jsx)(A.z,{type:"button",variant:"ghost",onClick:()=>t(!1),children:"取消"}),(0,a.jsxs)(A.z,{type:"submit",disabled:i.formState.isSubmitting,children:[i.formState.isSubmitting&&(0,a.jsx)(o.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"確認入庫"]})]})]})})]})})}function R(){let e=(0,l.useRouter)(),{id:s}=(0,l.useParams)(),[I,M]=(0,r.useState)(null),[E,F]=(0,r.useState)(!0),[P,R]=(0,r.useState)(!1),[T,$]=(0,r.useState)(!1),[Q,_]=(0,r.useState)([]),[D,L]=(0,r.useState)([]),[V,K]=(0,r.useState)([]),[Y,H]=(0,r.useState)(""),[U,J]=(0,r.useState)([]),[G,W]=(0,r.useState)(!1),[X,ee]=(0,r.useState)(!1),[es,et]=(0,r.useState)(!1),[ea,er]=(0,r.useState)({name:"",amount:0,quantity:1,unit:"項",description:""}),el=(0,r.useCallback)(async s=>{F(!0);try{var t,a,r;if(!c.db)throw Error("Firebase 未初始化");let l=(0,i.doc)(c.db,"purchaseOrders",s),n=await (0,i.QT)(l);if(!n.exists()){d.Am.error("找不到指定的採購單。"),e.push("/dashboard/purchase-orders");return}let m=n.data(),o=m.supplierRef?await (0,i.QT)(m.supplierRef):null,x=m.createdByRef?await (0,i.QT)(m.createdByRef):null,h=(null===(t=m.createdAt)||void 0===t?void 0:t.toDate().toLocaleString("zh-TW",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}))||"N/A",u={id:n.id,code:m.code,supplierName:(null==o?void 0:null===(a=o.data())||void 0===a?void 0:a.name)||"未知供應商",status:m.status,createdByName:(null==x?void 0:null===(r=x.data())||void 0===r?void 0:r.name)||"未知人員",createdAt:h,items:m.items||[],additionalFees:m.additionalFees||[],comments:m.comments||[]};M(u),_([...m.items||[]]),L([...m.additionalFees||[]]),K([...m.comments||[]])}catch(e){console.error("讀取採購單詳情失敗:",e),d.Am.error("讀取採購單詳情失敗。")}finally{F(!1)}},[e]);(0,r.useEffect)(()=>{"string"==typeof s&&el(s)},[s,el]);let ei=(e,s)=>{s<1||_(t=>{let a=[...t];return a[e]={...a[e],quantity:s},a})},ec=(e,s)=>{s<0||_(t=>{let a=[...t];return a[e]={...a[e],costPerUnit:s},a})},en=e=>{L(s=>s.filter(s=>s.id!==e)),d.Am.success("已移除其他費用")},ed=async e=>{let t=e.target.files;if(!t||0===t.length)return;let a=Array.from(t),r=d.Am.loading("正在處理圖片...");try{if(a.reduce((e,s)=>e+s.size,0)>10485760){d.Am.error("總檔案大小不能超過 10MB，請選擇較小的圖片",{id:r});return}let e=await (0,m.OM)(a,{folder:"purchase-orders/".concat(s,"/comments"),maxSize:2,compress:!0,quality:.6}),t=e.filter(e=>e.success),l=e.filter(e=>!e.success);if(t.length>0){let e=t.map(e=>e.url);J(s=>[...s,...e]),d.Am.success("成功上傳 ".concat(t.length," 張圖片"),{id:r})}if(l.length>0){let e=l.map(e=>e.error).join(", ");d.Am.error("以下圖片上傳失敗: ".concat(e),{id:r})}}catch(e){console.error("圖片處理失敗:",e),d.Am.error("圖片處理失敗: ".concat(e instanceof Error?e.message:"未知錯誤"),{id:r})}e.target.value=""},em=e=>{J(s=>s.filter((s,t)=>t!==e))},eo=async()=>{if(!Y.trim()&&0===U.length){d.Am.error("請輸入留言內容或上傳圖片");return}if(I&&c.db)try{let e={id:Date.now().toString(),text:Y.trim(),images:U,createdAt:new Date().toISOString(),createdBy:I.createdByName||"當前用戶"},s=(0,i.doc)(c.db,"purchaseOrders",I.id),t=[...V,e];await (0,i.r7)(s,{comments:t,updatedAt:i.EK.now()}),K(t),M(e=>e?{...e,comments:t}:null),H(""),J([]),d.Am.success("留言已新增")}catch(e){console.error("新增留言失敗:",e),d.Am.error("新增留言失敗")}},ex=async e=>{try{let s=V.find(s=>s.id===e);if(!s)return;if(s.images.length>0){let{getStorage:e,ref:a,deleteObject:r}=await Promise.resolve().then(t.bind(t,96485)),l=e(),i=s.images.map(async e=>{try{let s=a(l,e);await r(s)}catch(e){console.error("刪除圖片失敗:",e)}});await Promise.all(i)}let a=V.filter(s=>s.id!==e);if(K(a),I&&c.db){let e=(0,i.doc)(c.db,"purchaseOrders",I.id);await (0,i.r7)(e,{comments:a,updatedAt:i.EK.now()}),M(e=>e?{...e,comments:a}:null)}d.Am.success("留言已刪除")}catch(e){console.error("刪除留言失敗:",e),d.Am.error("刪除留言失敗")}},eh=async()=>{if(!I||!c.db)return;et(!0);let s=d.Am.loading("正在刪除採購單...");try{let a=V.flatMap(e=>e.images);if(a.length>0){let{getStorage:e,ref:s,deleteObject:r}=await Promise.resolve().then(t.bind(t,96485)),l=e(),i=a.map(async e=>{try{let t=s(l,e);await r(t)}catch(e){console.error("刪除圖片失敗:",e)}});await Promise.all(i)}let{doc:r,deleteDoc:l}=await Promise.resolve().then(t.bind(t,5978)),i=r(c.db,"purchaseOrders",I.id);await l(i),d.Am.success("採購單已刪除",{id:s}),e.push("/dashboard/purchase-orders")}catch(e){console.error("刪除採購單失敗:",e),d.Am.error("刪除採購單失敗",{id:s})}finally{et(!1),ee(!1)}},eu=async()=>{if(!I||!c.db)return;R(!0);let e=d.Am.loading("正在儲存變更...");try{let s=(0,i.doc)(c.db,"purchaseOrders",I.id);await (0,i.r7)(s,{items:Q,additionalFees:D,updatedAt:i.EK.now()}),M(e=>e?{...e,items:Q,additionalFees:D}:null),d.Am.success("變更已儲存",{id:e})}catch(s){console.error("儲存變更失敗:",s),d.Am.error("儲存變更失敗",{id:e})}finally{R(!1)}},eg=async e=>{if(!I)return;R(!0);let s=d.Am.loading('正在將狀態更新為 "'.concat(e,'"...'));try{let t=(0,n.$C)(),a=(0,n.V1)(t,"updatePurchaseOrderStatus");await a({purchaseOrderId:I.id,newStatus:e}),d.Am.success("狀態更新成功。",{id:s}),el(I.id)}catch(t){let e=t instanceof Error?t.message:"狀態更新失敗";d.Am.error(e,{id:s})}finally{R(!1)}};return E?(0,a.jsx)("div",{className:"flex items-center justify-center h-64",children:(0,a.jsx)(o.Z,{className:"h-8 w-8 animate-spin"})}):I?(0,a.jsxs)("div",{className:"container mx-auto p-2 sm:p-4 py-4 sm:py-10",children:[(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-4 mb-4 sm:mb-8",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 sm:gap-4",children:[(0,a.jsx)(A.z,{variant:"outline",size:"icon",onClick:()=>e.back(),className:"hover:bg-amber-50 border-amber-200",children:(0,a.jsx)(x.Z,{className:"h-4 w-4"})}),(0,a.jsxs)("div",{className:"min-w-0",children:[(0,a.jsx)("h1",{className:"text-xl sm:text-3xl font-bold text-amber-600 truncate",children:"採購單詳情"}),(0,a.jsx)("p",{className:"text-muted-foreground mt-2 text-sm sm:text-base",children:"查看採購單的詳細資訊"})]})]}),(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:["預報單"===I.status&&(0,a.jsxs)(A.z,{onClick:()=>eg("已訂購"),disabled:P,className:"bg-amber-600 hover:bg-amber-700 w-full sm:w-auto",children:[P?(0,a.jsx)(o.Z,{className:"mr-2 h-4 w-4 animate-spin"}):(0,a.jsx)(h.Z,{className:"mr-2 h-4 w-4"}),"標示為已訂購"]}),"已訂購"===I.status&&(0,a.jsxs)(A.z,{onClick:()=>$(!0),disabled:P,className:"bg-green-600 hover:bg-green-700 w-full sm:w-auto",children:[(0,a.jsx)(u,{className:"mr-2 h-4 w-4"}),"收貨入庫"]}),(0,a.jsxs)(A.z,{onClick:()=>ee(!0),disabled:es,variant:"destructive",className:"bg-red-600 hover:bg-red-700 w-full sm:w-auto",children:[(0,a.jsx)(g.Z,{className:"mr-2 h-4 w-4"}),"刪除訂單"]})]})]}),(0,a.jsxs)(C.Zb,{className:"mb-4 sm:mb-6 border-0 shadow-lg bg-gradient-to-r from-background to-amber-10",children:[(0,a.jsx)(C.Ol,{className:"pb-3 sm:pb-6",children:(0,a.jsxs)(C.ll,{className:"flex items-center gap-2 text-amber-600 text-lg sm:text-xl",children:[(0,a.jsx)(j.Z,{className:"h-5 w-5"}),"採購單資訊"]})}),(0,a.jsxs)(C.aY,{children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6",children:[(0,a.jsx)("div",{className:"space-y-2",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center",children:(0,a.jsx)(j.Z,{className:"h-4 w-4 text-white"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-600",children:"採購單編號"}),(0,a.jsx)("p",{className:"text-lg font-bold text-gray-900",children:I.code})]})]})}),(0,a.jsx)("div",{className:"space-y-2",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-lg flex items-center justify-center",children:(0,a.jsx)(p.Z,{className:"h-4 w-4 text-white"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-600",children:"供應商"}),(0,a.jsx)("p",{className:"text-lg font-semibold text-gray-900",children:I.supplierName})]})]})}),(0,a.jsx)("div",{className:"space-y-2",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center",children:(0,a.jsx)(b.Z,{className:"h-4 w-4 text-white"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-600",children:"建立人員"}),(0,a.jsx)("p",{className:"text-lg font-semibold text-gray-900",children:I.createdByName})]})]})}),(0,a.jsx)("div",{className:"space-y-2",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center",children:(0,a.jsx)(f.Z,{className:"h-4 w-4 text-white"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-600",children:"建立時間"}),(0,a.jsx)("p",{className:"text-lg font-semibold text-gray-900",children:I.createdAt})]})]})})]}),(0,a.jsx)("div",{className:"mt-6 pt-6 border-t border-gray-200",children:(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("span",{className:"text-sm font-medium text-gray-600",children:"當前狀態："}),(0,a.jsx)(S.C,{variant:(e=>{switch(e){case"已收貨":return"default";case"已訂購":return"secondary";case"預報單":default:return"outline";case"已取消":return"destructive"}})(I.status),className:"text-sm font-medium px-3 py-1 ".concat("預報單"===I.status?"bg-purple-100 text-purple-800 border-purple-200":"已訂購"===I.status?"bg-green-100 text-green-800 border-green-200":"已收貨"===I.status?"bg-gray-600 text-white border-gray-600":"已取消"===I.status?"bg-red-100 text-red-800 border-red-200":"bg-gray-600 text-white border-gray-600"),children:I.status})]})})]})]}),(0,a.jsxs)(C.Zb,{className:"mb-4 sm:mb-6 border-0 shadow-lg",children:[(0,a.jsxs)(C.Ol,{className:"pb-3 sm:pb-6",children:[(0,a.jsxs)(C.ll,{className:"flex items-center gap-2 text-lg sm:text-xl",children:[(0,a.jsx)(N.Z,{className:"h-5 w-5 text-amber-600"}),"採購項目清單"]}),(0,a.jsx)(C.SZ,{children:"此採購單中包含的所有項目列表"})]}),(0,a.jsx)(C.aY,{children:I.items.length>0?(0,a.jsxs)("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[(0,a.jsxs)(Z.iA,{children:[(0,a.jsx)(Z.xD,{children:(0,a.jsxs)(Z.SC,{className:"bg-gray-50",children:[(0,a.jsx)(Z.ss,{className:"font-semibold text-gray-700",children:"品項代號"}),(0,a.jsx)(Z.ss,{className:"font-semibold text-gray-700",children:"品項名稱"}),(0,a.jsx)(Z.ss,{className:"text-right font-semibold text-gray-700",children:"採購數量"}),(0,a.jsx)(Z.ss,{className:"text-right font-semibold text-gray-700",children:"單價"}),(0,a.jsx)(Z.ss,{className:"text-right font-semibold text-gray-700",children:"小計"})]})}),(0,a.jsx)(Z.RM,{children:Q.map((e,s)=>{let t=e.costPerUnit||0,r=t*e.quantity;return(0,a.jsxs)(Z.SC,{className:"hover:bg-amber-50/30 transition-colors duration-200",children:[(0,a.jsx)(Z.pj,{children:(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center",children:(0,a.jsx)(N.Z,{className:"h-4 w-4 text-white"})}),(0,a.jsx)("span",{className:"font-mono font-medium text-gray-900",children:e.code})]})}),(0,a.jsx)(Z.pj,{className:"font-medium text-gray-900",children:e.name}),(0,a.jsx)(Z.pj,{className:"text-right",children:"已收貨"===I.status?(0,a.jsxs)("span",{className:"font-semibold text-amber-600",children:[e.quantity," ",e.unit]}):(0,a.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,a.jsx)(z.I,{type:"number",min:"1",value:e.quantity,onChange:e=>ei(s,parseInt(e.target.value)||1),className:"w-20 text-center border-amber-200 focus:border-amber-500"}),(0,a.jsx)("span",{className:"text-sm text-gray-500 whitespace-nowrap",children:e.unit})]})}),(0,a.jsx)(Z.pj,{className:"text-right",children:"已收貨"===I.status?(0,a.jsxs)("span",{className:"text-gray-600",children:["NT$ ",t.toLocaleString()]}):(0,a.jsxs)("div",{className:"flex items-center justify-end gap-1",children:[(0,a.jsx)("span",{className:"text-sm text-gray-500",children:"NT$"}),(0,a.jsx)(z.I,{type:"number",min:"0",step:"0.01",value:t,onChange:e=>ec(s,parseFloat(e.target.value)||0),className:"w-24 text-right border-amber-200 focus:border-amber-500"})]})}),(0,a.jsx)(Z.pj,{className:"text-right",children:(0,a.jsxs)("span",{className:"font-semibold text-amber-600",children:["NT$ ",r.toLocaleString()]})})]},s)})})]}),(0,a.jsx)("div",{className:"mt-4 pt-4 border-t border-gray-200",children:(0,a.jsxs)("div",{className:"flex justify-end items-center gap-4",children:[(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsxs)("div",{className:"text-sm text-gray-600 mb-1",children:["項目總額：NT$ ",Q.reduce((e,s)=>e+(s.costPerUnit||0)*s.quantity,0).toLocaleString()]}),(0,a.jsxs)("div",{className:"text-sm text-gray-600 mb-1",children:["其他費用：NT$ ",D.reduce((e,s)=>e+s.amount*s.quantity,0).toLocaleString()]}),(0,a.jsxs)("div",{className:"text-lg font-bold text-amber-600 border-t border-gray-200 pt-1",children:["總金額：NT$ ",(Q.reduce((e,s)=>e+(s.costPerUnit||0)*s.quantity,0)+D.reduce((e,s)=>e+s.amount*s.quantity,0)).toLocaleString()]})]}),"已收貨"!==I.status&&(0,a.jsx)(A.z,{onClick:eu,disabled:P,className:"bg-amber-600 hover:bg-amber-700 text-white",children:P?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(o.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"儲存中..."]}):"儲存變更"})]})})]}):(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center py-12 bg-gray-50 rounded-lg",children:[(0,a.jsx)("div",{className:"w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-3",children:(0,a.jsx)(N.Z,{className:"h-6 w-6 text-gray-400"})}),(0,a.jsx)("h3",{className:"text-base font-medium text-gray-900 mb-1",children:"沒有採購項目"}),(0,a.jsx)("p",{className:"text-sm text-gray-500 text-center",children:"此採購單目前沒有包含任何項目"})]})})]}),(0,a.jsxs)(C.Zb,{className:"mb-4 sm:mb-6 border-0 shadow-lg",children:[(0,a.jsxs)(C.Ol,{className:"pb-3 sm:pb-6",children:[(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[(0,a.jsxs)(C.ll,{className:"flex items-center gap-2 text-lg sm:text-xl",children:[(0,a.jsx)(N.Z,{className:"h-5 w-5 text-amber-600"}),"其他費用"]}),"已收貨"!==I.status&&(0,a.jsxs)(A.z,{onClick:()=>W(!0),className:"bg-amber-600 hover:bg-amber-700 text-white w-full sm:w-auto",children:[(0,a.jsx)(y.Z,{className:"mr-2 h-4 w-4"}),"增加其他費用"]})]}),(0,a.jsx)(C.SZ,{children:"運費、關稅或其他額外費用"})]}),(0,a.jsx)(C.aY,{children:D.length>0?(0,a.jsx)("div",{className:"space-y-3",children:D.map(e=>(0,a.jsxs)("div",{className:"flex items-center justify-between p-3 bg-amber-50 rounded-lg border border-amber-200",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("div",{className:"font-medium text-gray-900",children:e.name}),e.description&&(0,a.jsx)("div",{className:"text-sm text-gray-600 mt-1",children:e.description}),(0,a.jsxs)("div",{className:"text-sm text-gray-500 mt-1",children:[e.quantity," ",e.unit]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsxs)("span",{className:"font-semibold text-amber-600",children:["NT$ ",(e.amount*e.quantity).toLocaleString()]}),"已收貨"!==I.status&&(0,a.jsx)(A.z,{variant:"ghost",size:"sm",onClick:()=>en(e.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:(0,a.jsx)(v.Z,{className:"h-4 w-4"})})]})]},e.id))}):(0,a.jsx)("div",{className:"text-center py-8 text-gray-500",children:"目前沒有其他費用"})})]}),(0,a.jsxs)(C.Zb,{className:"mb-4 sm:mb-6 border-0 shadow-lg bg-gradient-to-r from-amber-50 to-orange-50 border-amber-200",children:[(0,a.jsxs)(C.Ol,{className:"pb-3 sm:pb-6",children:[(0,a.jsxs)(C.ll,{className:"flex items-center gap-2 text-lg sm:text-xl text-amber-800",children:[(0,a.jsx)(w.Z,{className:"h-5 w-5"}),"留言記錄",(0,a.jsxs)(S.C,{variant:"secondary",className:"ml-2",children:[V.length," 則留言"]})]}),(0,a.jsx)(C.SZ,{children:"採購單相關的留言和備註"})]}),(0,a.jsxs)(C.aY,{children:[(0,a.jsxs)("div",{className:"mb-4 sm:mb-6 p-3 sm:p-4 bg-white rounded-lg border border-amber-200",children:[(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700",children:"新增留言"}),(0,a.jsx)(q.g,{placeholder:"輸入留言內容...",value:Y,onChange:e=>H(e.target.value),className:"mt-1 min-h-[100px] resize-none"})]}),(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 mb-2 block",children:"上傳圖片"}),(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2",children:[(0,a.jsxs)(A.z,{variant:"outline",onClick:()=>{var e;return null===(e=document.getElementById("purchase-image-upload"))||void 0===e?void 0:e.click()},className:"border-amber-300 text-amber-700 hover:bg-amber-50 w-full sm:w-auto",children:[(0,a.jsx)(k.Z,{className:"mr-2 h-4 w-4"}),"選擇圖片"]}),(0,a.jsx)("input",{id:"purchase-image-upload",type:"file",multiple:!0,accept:"image/*",onChange:ed,className:"hidden"}),(0,a.jsx)("span",{className:"text-sm text-gray-500 text-center sm:text-left",children:"可選擇多張圖片 (每張最大 2MB)"})]}),U.length>0&&(0,a.jsxs)("div",{className:"mt-3",children:[(0,a.jsxs)("label",{className:"text-sm font-medium text-gray-700 mb-2 block",children:["已選擇的圖片 (",U.length," 張)"]}),(0,a.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:U.map((e,s)=>(0,a.jsxs)("div",{className:"relative group",children:[(0,a.jsx)("img",{src:e,alt:"圖片 ".concat(s+1),className:"w-full h-20 sm:h-24 object-cover rounded-lg border cursor-pointer",onClick:()=>{let s=document.createElement("div");s.className="fixed inset-0 z-50 flex items-center justify-center bg-black/80",s.onclick=()=>s.remove();let t=document.createElement("img");t.src=e,t.className="max-w-[90vw] max-h-[90vh] object-contain rounded-lg",t.onclick=e=>e.stopPropagation(),s.appendChild(t),document.body.appendChild(s)}}),(0,a.jsx)(A.z,{variant:"destructive",size:"sm",onClick:()=>em(s),className:"absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity h-6 w-6 p-0",children:(0,a.jsx)(v.Z,{className:"h-3 w-3"})})]},s))})]})]}),(0,a.jsxs)(A.z,{onClick:eo,disabled:!Y.trim()&&0===U.length,className:"bg-amber-600 hover:bg-amber-700 w-full sm:w-auto",children:[(0,a.jsx)(w.Z,{className:"mr-2 h-4 w-4"}),"新增留言"]})]}),(0,a.jsx)("div",{className:"space-y-4",children:0===V.length?(0,a.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,a.jsx)(w.Z,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,a.jsx)("p",{children:"尚無留言記錄"})]}):V.map(e=>(0,a.jsxs)("div",{className:"bg-white rounded-lg border border-amber-200 p-3 sm:p-4",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 min-w-0 flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(b.Z,{className:"h-4 w-4 text-gray-500 flex-shrink-0"}),(0,a.jsx)("span",{className:"font-medium text-gray-700 truncate",children:e.createdBy})]}),(0,a.jsx)("span",{className:"text-sm text-gray-500",children:new Date(e.createdAt).toLocaleString()})]}),(0,a.jsx)(A.z,{variant:"ghost",size:"sm",onClick:()=>ex(e.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50 flex-shrink-0 ml-2",children:(0,a.jsx)(g.Z,{className:"h-4 w-4"})})]}),e.text&&(0,a.jsx)("div",{className:"mb-3 text-gray-700 whitespace-pre-wrap break-words",children:e.text}),e.images.length>0&&(0,a.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:e.images.map((e,s)=>(0,a.jsx)("div",{className:"relative group",children:(0,a.jsx)("img",{src:e,alt:"留言圖片 ".concat(s+1),className:"w-full h-20 sm:h-24 object-cover rounded-lg border cursor-pointer",onClick:()=>{let s=document.createElement("div");s.className="fixed inset-0 z-50 flex items-center justify-center bg-black/80",s.onclick=()=>s.remove();let t=document.createElement("img");t.src=e,t.className="max-w-[90vw] max-h-[90vh] object-contain rounded-lg",t.onclick=e=>e.stopPropagation(),s.appendChild(t),document.body.appendChild(s)}})},s))})]},e.id))})]})]}),I&&(0,a.jsx)(B,{isOpen:T,onOpenChange:$,onSuccess:()=>el(I.id),purchaseOrder:I}),(0,a.jsx)(O.Vq,{open:G,onOpenChange:W,children:(0,a.jsxs)(O.cZ,{className:"w-[95vw] max-w-md sm:max-w-lg",children:[(0,a.jsxs)(O.fK,{children:[(0,a.jsx)(O.$N,{className:"text-lg sm:text-xl",children:"增加其他費用"}),(0,a.jsx)(O.Be,{children:"添加運費、關稅或其他額外費用項目"})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700",children:"費用名稱"}),(0,a.jsx)(z.I,{placeholder:"例如：運費、關稅、手續費",value:ea.name,onChange:e=>er(s=>({...s,name:e.target.value}))})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700",children:"單價 (NT$)"}),(0,a.jsx)(z.I,{type:"number",placeholder:"0",value:ea.amount,onChange:e=>er(s=>({...s,amount:parseFloat(e.target.value)||0}))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700",children:"數量"}),(0,a.jsx)(z.I,{type:"number",placeholder:"1",value:ea.quantity,onChange:e=>er(s=>({...s,quantity:parseInt(e.target.value)||1}))})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700",children:"單位"}),(0,a.jsx)(z.I,{placeholder:"例如：次、件、公斤",value:ea.unit,onChange:e=>er(s=>({...s,unit:e.target.value}))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700",children:"描述 (選填)"}),(0,a.jsx)(q.g,{placeholder:"費用的詳細說明...",value:ea.description||"",onChange:e=>er(s=>({...s,description:e.target.value})),rows:3})]})]}),(0,a.jsxs)(O.cN,{className:"flex flex-col sm:flex-row gap-2",children:[(0,a.jsx)(A.z,{variant:"outline",onClick:()=>W(!1),className:"w-full sm:w-auto",children:"取消"}),(0,a.jsx)(A.z,{onClick:()=>{if(!ea.name||ea.amount<=0){d.Am.error("請填寫費用名稱和金額");return}let e={id:Date.now().toString(),...ea};L(s=>[...s,e]),er({name:"",amount:0,quantity:1,unit:"項",description:""}),W(!1),d.Am.success("已添加其他費用")},className:"bg-amber-600 hover:bg-amber-700 text-white w-full sm:w-auto",children:"添加費用"})]})]})}),(0,a.jsx)(O.Vq,{open:X,onOpenChange:ee,children:(0,a.jsxs)(O.cZ,{className:"w-[95vw] max-w-md sm:max-w-lg",children:[(0,a.jsxs)(O.fK,{children:[(0,a.jsx)(O.$N,{className:"text-red-600 text-lg sm:text-xl",children:"刪除採購單"}),(0,a.jsx)(O.Be,{children:"此操作將永久刪除此採購單及其所有相關資料，包括："})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:(0,a.jsxs)("ul",{className:"text-sm text-red-700 space-y-1",children:[(0,a.jsx)("li",{children:"• 採購單基本資訊"}),(0,a.jsx)("li",{children:"• 所有採購項目"}),(0,a.jsx)("li",{children:"• 其他費用項目"}),(0,a.jsx)("li",{children:"• 所有留言記錄"}),(0,a.jsx)("li",{children:"• 所有相關圖片"})]})}),(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:[(0,a.jsx)("strong",{children:"採購單編號："})," ",null==I?void 0:I.code]}),(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:[(0,a.jsx)("strong",{children:"供應商："})," ",null==I?void 0:I.supplierName]}),(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:[(0,a.jsx)("strong",{children:"留言數量："})," ",V.length," 則"]}),(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:[(0,a.jsx)("strong",{children:"圖片數量："})," ",V.flatMap(e=>e.images).length," 張"]})]}),(0,a.jsxs)(O.cN,{className:"flex flex-col sm:flex-row gap-2",children:[(0,a.jsx)(A.z,{variant:"outline",onClick:()=>ee(!1),disabled:es,className:"w-full sm:w-auto",children:"取消"}),(0,a.jsx)(A.z,{onClick:eh,disabled:es,variant:"destructive",className:"bg-red-600 hover:bg-red-700 w-full sm:w-auto",children:es?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(o.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"刪除中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(g.Z,{className:"mr-2 h-4 w-4"}),"確認刪除"]})})]})]})})]}):(0,a.jsx)("div",{className:"text-center py-10",children:"無法載入採購單資料。"})}},80670:function(e,s,t){"use strict";t.d(s,{NI:function(){return j},Wi:function(){return o},l0:function(){return d},lX:function(){return g},xJ:function(){return u},zG:function(){return p}});var a=t(57437),r=t(2265),l=t(37053),i=t(29501),c=t(93448),n=t(75060);let d=i.RV,m=r.createContext({}),o=e=>{let{...s}=e;return(0,a.jsx)(m.Provider,{value:{name:s.name},children:(0,a.jsx)(i.Qr,{...s})})},x=()=>{let e=r.useContext(m),s=r.useContext(h),{getFieldState:t}=(0,i.Gc)(),a=(0,i.cl)({name:e.name}),l=t(e.name,a);if(!e)throw Error("useFormField should be used within <FormField>");let{id:c}=s;return{id:c,name:e.name,formItemId:"".concat(c,"-form-item"),formDescriptionId:"".concat(c,"-form-item-description"),formMessageId:"".concat(c,"-form-item-message"),...l}},h=r.createContext({});function u(e){let{className:s,...t}=e,l=r.useId();return(0,a.jsx)(h.Provider,{value:{id:l},children:(0,a.jsx)("div",{"data-slot":"form-item",className:(0,c.cn)("grid gap-2",s),...t})})}function g(e){let{className:s,...t}=e,{error:r,formItemId:l}=x();return(0,a.jsx)(n._,{"data-slot":"form-label","data-error":!!r,className:(0,c.cn)("data-[error=true]:text-destructive",s),htmlFor:l,...t})}function j(e){let{...s}=e,{error:t,formItemId:r,formDescriptionId:i,formMessageId:c}=x();return(0,a.jsx)(l.g7,{"data-slot":"form-control",id:r,"aria-describedby":t?"".concat(i," ").concat(c):"".concat(i),"aria-invalid":!!t,...s})}function p(e){var s;let{className:t,...r}=e,{error:l,formMessageId:i}=x(),n=l?String(null!==(s=null==l?void 0:l.message)&&void 0!==s?s:""):r.children;return n?(0,a.jsx)("p",{"data-slot":"form-message",id:i,className:(0,c.cn)("text-destructive text-sm",t),...r,children:n}):null}}},function(e){e.O(0,[3609,9015,3676,5569,4438,9436,4116,6818,2365,1348,2971,2117,1744],function(){return e(e.s=64341)}),_N_E=e.O()}]);