(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7682],{42056:function(e,s,t){Promise.resolve().then(t.bind(t,16913))},95805:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});let a=(0,t(79205).Z)("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]])},16913:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return _}});var a=t(57437),l=t(2265),r=t(71245),n=t(14438),i=t(71594),c=t(24525),d=t(12381),o=t(40279),m=t(33804),x=t(69174),u=t(79205);let h=(0,u.Z)("ChevronsLeft",[["path",{d:"m11 17-5-5 5-5",key:"13zhaf"}],["path",{d:"m18 17-5-5 5-5",key:"h8a8et"}]]);var g=t(92451),j=t(10407);let f=(0,u.Z)("ChevronsRight",[["path",{d:"m6 17 5-5-5-5",key:"xnjwq"}],["path",{d:"m13 17 5-5-5-5",key:"17xmmf"}]]);var v=t(80719);function p(e){var s,t,r,n,u,p,N,b,y,w,C;let{columns:k,data:S,onRowClick:F}=e,[R,Z]=l.useState([]),[P,A]=l.useState([]),[D,z]=l.useState({}),[M,V]=l.useState({}),_=(0,i.b7)({data:S,columns:k,getCoreRowModel:(0,c.sC)(),getFilteredRowModel:(0,c.vL)(),getPaginationRowModel:(0,c.G_)(),getSortedRowModel:(0,c.tj)(),onSortingChange:Z,onColumnFiltersChange:A,onColumnVisibilityChange:z,onRowSelectionChange:V,state:{sorting:R,columnFilters:P,columnVisibility:D,rowSelection:M},initialState:{pagination:{pageSize:10}}});return(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsxs)("div",{className:"flex items-center py-4 gap-4",children:[(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsx)(o.I,{placeholder:"搜尋備註、操作人員...",value:(null===(s=_.getColumn("remarks"))||void 0===s?void 0:s.getFilterValue())||"",onChange:e=>{var s;let t=e.target.value;null===(s=_.getColumn("remarks"))||void 0===s||s.setFilterValue(t)},className:"max-w-sm"})}),(0,a.jsx)("div",{className:"flex items-center gap-2",children:(0,a.jsxs)(x.C,{variant:"outline",className:"text-sm",children:["共 ",S.length," 筆紀錄"]})})]}),(0,a.jsx)("div",{className:"hidden lg:block",children:(0,a.jsx)("div",{className:"rounded-md border",children:(0,a.jsxs)(m.iA,{children:[(0,a.jsx)(m.xD,{children:_.getHeaderGroups().map(e=>(0,a.jsx)(m.SC,{children:e.headers.map(e=>(0,a.jsx)(m.ss,{className:"bg-gradient-to-r from-gray-50 to-gray-100",children:e.isPlaceholder?null:(0,i.ie)(e.column.columnDef.header,e.getContext())},e.id))},e.id))}),(0,a.jsx)(m.RM,{children:(null===(t=_.getRowModel().rows)||void 0===t?void 0:t.length)?_.getRowModel().rows.map(e=>(0,a.jsx)(m.SC,{"data-state":e.getIsSelected()&&"selected",className:"hover:bg-gray-50 transition-colors duration-200 ".concat(F?"cursor-pointer":""),onClick:()=>F&&F(e.original),children:e.getVisibleCells().map(e=>(0,a.jsx)(m.pj,{children:(0,i.ie)(e.column.columnDef.cell,e.getContext())},e.id))},e.id)):(0,a.jsx)(m.SC,{children:(0,a.jsx)(m.pj,{colSpan:k.length,className:"h-24 text-center",children:(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center space-y-2",children:[(0,a.jsx)("div",{className:"text-gray-400 text-lg",children:"\uD83D\uDCCA"}),(0,a.jsx)("div",{className:"text-gray-500 font-medium",children:"沒有找到庫存紀錄"}),(0,a.jsx)("div",{className:"text-gray-400 text-sm",children:"請嘗試調整搜尋條件"})]})})})})]})})}),(0,a.jsx)("div",{className:"lg:hidden space-y-4",children:(null===(r=_.getRowModel().rows)||void 0===r?void 0:r.length)?_.getRowModel().rows.map(e=>{var s;return(0,a.jsxs)("div",{className:"bg-white rounded-lg border border-gray-200 p-4 space-y-3 hover:shadow-md transition-shadow duration-200 ".concat(F?"cursor-pointer":""),onClick:()=>F&&F(e.original),children:[(0,a.jsxs)("div",{className:"flex items-start justify-between",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("div",{className:"flex items-center gap-2 mb-2",children:(0,a.jsx)(x.C,{variant:"outline",className:"text-xs",children:(0,v.bU)(e.getValue("changeReason"))})}),(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:["影響項目：",(null===(s=e.getValue("details"))||void 0===s?void 0:s.length)||0," 項"]})]}),(0,a.jsx)("div",{className:"text-right",children:(0,a.jsx)("div",{className:"text-sm text-gray-500",children:new Intl.DateTimeFormat("zh-TW",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(e.getValue("changeDate"))})})]}),(0,a.jsx)("div",{className:"flex items-center justify-between text-sm",children:(0,a.jsxs)("div",{className:"text-gray-600",children:["操作: ",e.getValue("operatorName")]})}),e.getValue("remarks")&&(0,a.jsxs)("div",{className:"text-sm text-gray-600 bg-gray-50 px-3 py-2 rounded-md",children:["備註: ",e.getValue("remarks")]})]},e.id)}):(0,a.jsxs)("div",{className:"text-center py-12",children:[(0,a.jsx)("div",{className:"text-gray-400 text-4xl mb-4",children:"\uD83D\uDCCA"}),(0,a.jsx)("div",{className:"text-gray-500 font-medium text-lg mb-2",children:"沒有找到庫存紀錄"}),(0,a.jsx)("div",{className:"text-gray-400",children:"請嘗試調整搜尋條件"})]})}),(0,a.jsxs)("div",{className:"flex items-center justify-between space-x-2 py-4",children:[(0,a.jsxs)("div",{className:"flex-1 text-sm text-muted-foreground",children:["顯示第 ",(null===(u=_.getState())||void 0===u?void 0:null===(n=u.pagination)||void 0===n?void 0:n.pageIndex)*(null===(N=_.getState())||void 0===N?void 0:null===(p=N.pagination)||void 0===p?void 0:p.pageSize)+1," 到"," ",Math.min(((null===(y=_.getState())||void 0===y?void 0:null===(b=y.pagination)||void 0===b?void 0:b.pageIndex)+1)*(null===(C=_.getState())||void 0===C?void 0:null===(w=C.pagination)||void 0===w?void 0:w.pageSize),_.getFilteredRowModel().rows.length)," ","筆，共 ",_.getFilteredRowModel().rows.length," 筆紀錄"]}),(0,a.jsxs)("div",{className:"space-x-2",children:[(0,a.jsx)(d.z,{variant:"outline",size:"sm",onClick:()=>_.setPageIndex(0),disabled:!_.getCanPreviousPage(),children:(0,a.jsx)(h,{className:"h-4 w-4"})}),(0,a.jsx)(d.z,{variant:"outline",size:"sm",onClick:()=>_.previousPage(),disabled:!_.getCanPreviousPage(),children:(0,a.jsx)(g.Z,{className:"h-4 w-4"})}),(0,a.jsx)(d.z,{variant:"outline",size:"sm",onClick:()=>_.nextPage(),disabled:!_.getCanNextPage(),children:(0,a.jsx)(j.Z,{className:"h-4 w-4"})}),(0,a.jsx)(d.z,{variant:"outline",size:"sm",onClick:()=>_.setPageIndex(_.getPageCount()-1),disabled:!_.getCanNextPage(),children:(0,a.jsx)(f,{className:"h-4 w-4"})})]})]})]})}var N=t(28842),b=t(44794),y=t(95805);let w=e=>[{accessorKey:"changeDate",header:e=>{let{column:s}=e;return(0,a.jsxs)(d.z,{variant:"ghost",onClick:()=>s.toggleSorting("asc"===s.getIsSorted()),className:"font-semibold text-gray-700 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200",children:["動作時間",(0,a.jsx)(N.Z,{className:"ml-2 h-4 w-4"})]})},cell:e=>{let{row:s}=e,t=s.getValue("changeDate");return(0,a.jsxs)("div",{className:"text-sm text-gray-700",children:[(0,a.jsx)("div",{className:"font-medium",children:new Intl.DateTimeFormat("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"}).format(t)}),(0,a.jsx)("div",{className:"text-xs text-gray-500",children:new Intl.DateTimeFormat("zh-TW",{hour:"2-digit",minute:"2-digit"}).format(t)})]})},enableSorting:!0,enableColumnFilter:!1},{accessorKey:"changeReason",header:()=>(0,a.jsx)("div",{className:"font-semibold text-gray-700",children:"動作類型"}),cell:e=>{let{row:s}=e,t=s.getValue("changeReason");return(0,a.jsx)(x.C,{variant:(e=>{switch(e){case"purchase":return"default";case"workorder":default:return"secondary";case"inventory_check":return"outline";case"manual_adjustment":return"destructive"}})(t),className:"text-xs",children:(0,v.bU)(t)})},enableColumnFilter:!0,enableSorting:!0,filterFn:"equals"},{accessorKey:"details",header:()=>(0,a.jsx)("div",{className:"font-semibold text-gray-700",children:"影響項目"}),cell:e=>{let{row:s}=e,t=s.getValue("details"),l=t.filter(e=>"material"===e.itemType).length,r=t.filter(e=>"fragrance"===e.itemType).length;return(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)(b.Z,{className:"h-3 w-3 text-blue-500"}),(0,a.jsx)("span",{className:"text-xs text-blue-600 font-medium",children:l})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)(y.Z,{className:"h-3 w-3 text-purple-500"}),(0,a.jsx)("span",{className:"text-xs text-purple-600 font-medium",children:r})]}),(0,a.jsxs)("div",{className:"text-xs text-gray-500",children:["共 ",t.length," 項"]})]})},enableColumnFilter:!1,enableSorting:!0},{accessorKey:"operatorName",header:()=>(0,a.jsx)("div",{className:"font-semibold text-gray-700",children:"操作人員"}),cell:e=>{let{row:s}=e;return(0,a.jsx)("div",{className:"text-gray-700 font-medium",children:s.getValue("operatorName")})},enableColumnFilter:!0,enableSorting:!0,filterFn:"includesString"},{accessorKey:"remarks",header:()=>(0,a.jsx)("div",{className:"font-semibold text-gray-700",children:"備註"}),cell:e=>{let{row:s}=e,t=s.getValue("remarks");return t?(0,a.jsx)("div",{className:"text-gray-600 text-sm max-w-xs truncate",title:t,children:t}):(0,a.jsx)("div",{className:"text-gray-400 text-sm",children:"-"})},enableColumnFilter:!0,enableSorting:!0,filterFn:"includesString"},{accessorKey:"relatedDocumentId",header:()=>(0,a.jsx)("div",{className:"font-semibold text-gray-700",children:"相關文件"}),cell:e=>{let{row:s}=e,t=s.original,l=t.relatedDocumentId,r=t.relatedDocumentType;return l?(0,a.jsxs)("div",{className:"text-gray-600 text-sm max-w-xs truncate",title:"".concat(r||"文件",": ").concat(l),children:[r||"文件",": ",l]}):(0,a.jsx)("div",{className:"text-gray-400 text-sm",children:"-"})},enableColumnFilter:!0,enableSorting:!0,filterFn:"includesString"}];w(()=>{console.warn("columns 未提供點擊處理函數，請使用 createColumns 函數並傳入處理函數")});var C=t(79820),k=t(15291),S=t(75060),F=t(82431),R=t(43044),Z=t(99397),P=t(21047),A=t(70525),D=t(38220),z=t(90740),M=t(4899);function V(){let{appUser:e}=(0,r.a)(),[s,t]=(0,l.useState)([]),[i,c]=(0,l.useState)([]),[m,x]=(0,l.useState)(!0),[u,h]=(0,l.useState)({pageSize:10}),[g,j]=(0,l.useState)(null),[f,N]=(0,l.useState)(!1),y=(0,l.useCallback)(()=>{let e=s.length,t=s.filter(e=>"purchase"===e.changeReason).length,a=s.filter(e=>"workorder"===e.changeReason).length,l=s.filter(e=>"inventory_check"===e.changeReason).length,r=s.filter(e=>"manual_adjustment"===e.changeReason).length,n=0,i=0;return s.forEach(e=>{e.details.forEach(e=>{"material"===e.itemType?n++:"fragrance"===e.itemType&&i++})}),{total:e,purchase:t,workorder:a,inventoryCheck:l,manualAdjustment:r,materials:n,fragrances:i}},[s]),V=(0,l.useCallback)(async()=>{x(!0);try{let e=await (0,v.zN)(u);t(e.records),c(e.records)}catch(e){console.error("載入庫存紀錄失敗:",e),n.Am.error("載入庫存紀錄失敗")}finally{x(!1)}},[u]);(0,l.useEffect)(()=>{V()},[V]);let _=(0,l.useCallback)(()=>{let e=s;u.remarks&&(e=e.filter(e=>e.remarks&&e.remarks.toLowerCase().includes(u.remarks.toLowerCase())||e.operatorName&&e.operatorName.toLowerCase().includes(u.remarks.toLowerCase()))),u.changeReason&&(e=e.filter(e=>e.changeReason===u.changeReason)),c(e)},[s,u]);(0,l.useEffect)(()=>{_()},[_]);let T=(e,s)=>{h(t=>({...t,[e]:s}))},U=e=>{j(e),N(!0)},E=w(U),I=y();return(0,a.jsxs)("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100",children:[(0,a.jsxs)("div",{className:"container mx-auto p-4 sm:p-6 lg:p-8",children:[(0,a.jsxs)("div",{className:"mb-8",children:[(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-3xl sm:text-4xl font-bold bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 bg-clip-text text-transparent",children:"庫存紀錄中心"}),(0,a.jsx)("p",{className:"text-gray-600 mt-2 text-lg font-medium",children:"完整的庫存變動追蹤與審計系統"})]}),(0,a.jsx)("div",{className:"flex items-center gap-2",children:(0,a.jsxs)(d.z,{variant:"outline",onClick:V,className:"hover:bg-white/80 backdrop-blur-sm transition-all duration-200",children:[(0,a.jsx)(F.Z,{className:"mr-2 h-4 w-4"}),"重新整理"]})})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6",children:[(0,a.jsxs)(C.Zb,{className:"bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200",children:[(0,a.jsx)(C.Ol,{className:"pb-2",children:(0,a.jsxs)(C.ll,{className:"text-sm font-medium text-blue-700 flex items-center gap-2",children:[(0,a.jsx)(R.Z,{className:"h-4 w-4"}),"總紀錄"]})}),(0,a.jsx)(C.aY,{children:(0,a.jsx)("div",{className:"text-2xl font-bold text-blue-900",children:I.total})})]}),(0,a.jsxs)(C.Zb,{className:"bg-gradient-to-br from-green-50 to-green-100 border-green-200",children:[(0,a.jsx)(C.Ol,{className:"pb-2",children:(0,a.jsxs)(C.ll,{className:"text-sm font-medium text-green-700 flex items-center gap-2",children:[(0,a.jsx)(Z.Z,{className:"h-4 w-4"}),"採購購入"]})}),(0,a.jsx)(C.aY,{children:(0,a.jsx)("div",{className:"text-2xl font-bold text-green-900",children:I.purchase})})]}),(0,a.jsxs)(C.Zb,{className:"bg-gradient-to-br from-orange-50 to-orange-100 border-orange-200",children:[(0,a.jsx)(C.Ol,{className:"pb-2",children:(0,a.jsxs)(C.ll,{className:"text-sm font-medium text-orange-700 flex items-center gap-2",children:[(0,a.jsx)(P.Z,{className:"h-4 w-4"}),"工單領料"]})}),(0,a.jsx)(C.aY,{children:(0,a.jsx)("div",{className:"text-2xl font-bold text-orange-900",children:I.workorder})})]}),(0,a.jsxs)(C.Zb,{className:"bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200",children:[(0,a.jsx)(C.Ol,{className:"pb-2",children:(0,a.jsxs)(C.ll,{className:"text-sm font-medium text-blue-700 flex items-center gap-2",children:[(0,a.jsx)(A.Z,{className:"h-4 w-4"}),"庫存盤點"]})}),(0,a.jsx)(C.aY,{children:(0,a.jsx)("div",{className:"text-2xl font-bold text-blue-900",children:I.inventoryCheck})})]}),(0,a.jsxs)(C.Zb,{className:"bg-gradient-to-br from-red-50 to-red-100 border-red-200",children:[(0,a.jsx)(C.Ol,{className:"pb-2",children:(0,a.jsxs)(C.ll,{className:"text-sm font-medium text-red-700 flex items-center gap-2",children:[(0,a.jsx)(A.Z,{className:"h-4 w-4"}),"直接修改"]})}),(0,a.jsx)(C.aY,{children:(0,a.jsx)("div",{className:"text-2xl font-bold text-red-900",children:I.manualAdjustment})})]}),(0,a.jsxs)(C.Zb,{className:"bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200",children:[(0,a.jsx)(C.Ol,{className:"pb-2",children:(0,a.jsxs)(C.ll,{className:"text-sm font-medium text-purple-700 flex items-center gap-2",children:[(0,a.jsx)(b.Z,{className:"h-4 w-4"}),"物料"]})}),(0,a.jsx)(C.aY,{children:(0,a.jsx)("div",{className:"text-2xl font-bold text-purple-900",children:I.materials})})]}),(0,a.jsxs)(C.Zb,{className:"bg-gradient-to-br from-pink-50 to-pink-100 border-pink-200",children:[(0,a.jsx)(C.Ol,{className:"pb-2",children:(0,a.jsxs)(C.ll,{className:"text-sm font-medium text-pink-700 flex items-center gap-2",children:[(0,a.jsx)(D.Z,{className:"h-4 w-4"}),"香精"]})}),(0,a.jsx)(C.aY,{children:(0,a.jsx)("div",{className:"text-2xl font-bold text-pink-900",children:I.fragrances})})]})]}),(0,a.jsxs)(C.Zb,{className:"bg-white/80 backdrop-blur-sm border-gray-200",children:[(0,a.jsx)(C.Ol,{className:"pb-3",children:(0,a.jsxs)(C.ll,{className:"text-lg text-gray-800 flex items-center gap-2",children:[(0,a.jsx)(z.Z,{className:"h-5 w-5 text-gray-600"}),"篩選條件"]})}),(0,a.jsx)(C.aY,{children:(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(S._,{htmlFor:"search",className:"text-sm font-medium text-gray-700",children:"搜尋"}),(0,a.jsx)(o.I,{id:"search",placeholder:"備註、操作人員...",value:u.remarks||"",onChange:e=>T("remarks",e.target.value),className:"mt-1"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(S._,{htmlFor:"changeReason",className:"text-sm font-medium text-gray-700",children:"變動原因"}),(0,a.jsxs)(k.Ph,{value:u.changeReason||"all",onValueChange:e=>T("changeReason","all"===e?void 0:e),children:[(0,a.jsx)(k.i4,{className:"mt-1",children:(0,a.jsx)(k.ki,{placeholder:"選擇原因"})}),(0,a.jsxs)(k.Bw,{children:[(0,a.jsx)(k.Ql,{value:"all",children:"全部原因"}),(0,a.jsx)(k.Ql,{value:"purchase",children:"採購購入"}),(0,a.jsx)(k.Ql,{value:"workorder",children:"工單領料"}),(0,a.jsx)(k.Ql,{value:"inventory_check",children:"庫存盤點"}),(0,a.jsx)(k.Ql,{value:"manual_adjustment",children:"直接修改"})]})]})]}),(0,a.jsx)("div",{className:"flex items-end",children:(0,a.jsx)(d.z,{variant:"outline",onClick:()=>{h({pageSize:10})},className:"w-full hover:bg-gray-50 transition-all duration-200",children:"清除篩選"})})]})})]})]}),m?(0,a.jsx)("div",{className:"flex items-center justify-center py-16",children:(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"w-16 h-16 border-4 border-gray-200 rounded-full animate-spin"}),(0,a.jsx)("div",{className:"absolute top-0 left-0 w-16 h-16 border-4 border-transparent border-t-blue-500 rounded-full animate-spin"})]}),(0,a.jsx)("span",{className:"mt-6 text-gray-600 font-medium text-lg",children:"載入庫存紀錄中..."}),(0,a.jsx)("p",{className:"text-gray-500 text-sm mt-2",children:"請稍候，正在從資料庫讀取資料"})]})}):(0,a.jsx)("div",{className:"overflow-hidden rounded-xl border border-gray-200 bg-white/80 backdrop-blur-sm",children:(0,a.jsx)(p,{columns:E,data:i,onRowClick:U})})]}),(0,a.jsx)(M.w,{record:g,isOpen:f,onClose:()=>{N(!1),j(null)}})]})}function _(){return(0,a.jsx)(V,{})}},71245:function(e,s,t){"use strict";t.d(s,{H:function(){return m},a:function(){return x}});var a=t(57437),l=t(2265),r=t(82148),n=t(46410),i=t(5978),c=t(14438),d=t(47903);let o=(0,l.createContext)({user:null,appUser:null,isLoading:!0,login:async()=>!1,logout:async()=>{},hasPermission:()=>!1,hasAnyPermission:()=>!1,hasAllPermissions:()=>!1}),m=e=>{let{children:s}=e,[t,m]=(0,l.useState)(null),[x,u]=(0,l.useState)(null),[h,g]=(0,l.useState)(!0),j=async e=>{(0,d.fF)("loadUserData 開始執行",{uid:e.uid});try{let s=(0,n.T)();if(!s){(0,d.vU)("Firestore 未初始化"),u(null);return}(0,d.fF)("獲取用戶文檔",{uid:e.uid});let t=await (0,i.QT)((0,i.doc)(s,"users",e.uid));if(t.exists()){(0,d.fF)("用戶文檔存在");let e=t.data();if((0,d.fF)("用戶資料",e),e.roleRef){(0,d.fF)("用戶有角色引用，獲取角色資料");try{let s=await (0,i.QT)(e.roleRef);if(s.exists()){let t=s.data();e.roleName=t.displayName||t.name,e.permissions=t.permissions||[],(0,d.fF)("角色資料載入成功",{role:e.roleName,permissions:e.permissions})}else(0,d.ZK)("角色文檔不存在")}catch(e){(0,d.vU)("載入角色資料失敗",e)}}else(0,d.ZK)("用戶沒有角色引用");(0,d.fF)("設置 appUser",e),u(e)}else(0,d.ZK)("用戶文檔不存在"),u(null)}catch(e){(0,d.vU)("載入用戶資料失敗",e),u(null)}},f=async(e,s)=>{try{let t=(0,n.E7)();if(!t)return c.Am.error("系統初始化失敗"),!1;let a=e.includes("@")?e:"".concat(e,"@deer-lab.local"),l=await (0,r.e5)(t,a,s);return await j(l.user),c.Am.success("登入成功！"),!0}catch(e){return(0,d.vU)("登入失敗",e),c.Am.error(e.message||"登入失敗"),!1}},v=async()=>{try{let e=(0,n.E7)();e&&(await (0,r.w7)(e),m(null),u(null),c.Am.success("已成功登出"),window.location.href="/")}catch(e){(0,d.vU)("登出失敗",e),c.Am.error("登出失敗")}};return(0,l.useEffect)(()=>{(0,d.fF)("AuthContext useEffect 開始執行");try{let e=(0,n.E7)();if(!e){(0,d.vU)("Auth 未初始化，設置 isLoading = false"),g(!1);return}(0,d.fF)("設置 onAuthStateChanged 監聽器");let s=(0,r.Aj)(e,async e=>{try{(0,d.fF)("onAuthStateChanged 觸發",{uid:(null==e?void 0:e.uid)||null}),e?(m(e),(0,d.fF)("開始載入用戶資料"),await j(e)):(m(null),u(null),(0,d.fF)("用戶已登出，清除狀態")),g(!1),(0,d.fF)("設置 isLoading = false")}catch(e){(0,d.vU)("onAuthStateChanged 回調執行失敗",e),g(!1)}});return()=>{(0,d.fF)("清理 onAuthStateChanged 監聽器"),"function"==typeof s&&s()}}catch(e){(0,d.vU)("AuthContext useEffect 執行失敗",e),g(!1)}},[]),(0,a.jsx)(o.Provider,{value:{user:t,appUser:x,isLoading:h,login:f,logout:v,hasPermission:e=>null!=x&&!!x.permissions&&x.permissions.includes(e),hasAnyPermission:e=>null!=x&&!!x.permissions&&e.some(e=>x.permissions.includes(e)),hasAllPermissions:e=>null!=x&&!!x.permissions&&e.every(e=>x.permissions.includes(e))},children:s})},x=()=>(0,l.useContext)(o)},6394:function(e,s,t){"use strict";t.d(s,{f:function(){return i}});var a=t(2265),l=t(66840),r=t(57437),n=a.forwardRef((e,s)=>(0,r.jsx)(l.WV.label,{...e,ref:s,onMouseDown:s=>{var t;s.target.closest("button, input, select, textarea")||(null===(t=e.onMouseDown)||void 0===t||t.call(e,s),!s.defaultPrevented&&s.detail>1&&s.preventDefault())}}));n.displayName="Label";var i=n}},function(e){e.O(0,[3609,9015,3676,5569,4438,9436,3909,2696,4116,4200,3003,2365,5753,4899,2971,2117,1744],function(){return e(e.s=42056)}),_N_E=e.O()}]);