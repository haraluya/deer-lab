(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1148],{18968:function(e,t,s){Promise.resolve().then(s.bind(s,5147))},73618:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(79205).Z)("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]])},49322:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(79205).Z)("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]])},43044:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(79205).Z)("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]])},91723:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(79205).Z)("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]])},66927:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(79205).Z)("Droplets",[["path",{d:"M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z",key:"1ptgy4"}],["path",{d:"M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97",key:"1sl1rz"}]])},82431:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(79205).Z)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]])},83229:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(79205).Z)("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]])},15868:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(79205).Z)("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]])},85954:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(79205).Z)("Timer",[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]])},76865:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(79205).Z)("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},95805:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(79205).Z)("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]])},11239:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(79205).Z)("Zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]])},5147:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return $}});var a=s(57437),n=s(2265),r=s(99376),l=s(5978),i=s(46410),d=s(14438),c=s(60713),o=s(47903),m=s(69958),x=s(51817),u=s(32660),h=s(79205);let g=(0,h.Z)("Printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]);var p=s(30401),f=s(18930),b=s(44794),j=s(73618),v=s(83229),N=s(15868),y=s(66927),w=s(82431),k=s(32489),M=s(91723),S=s(53417),C=s(17689),D=s(92369),T=s(49322),O=s(76865),A=s(12381),Z=s(79820),z=s(69174),Q=s(33804),E=s(15291),I=s(40279),F=s(75060),_=s(23675),B=s(74291),q=s(43044),K=s(95805),R=s(99397),G=s(31047);let P=(0,h.Z)("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);var V=s(11239),H=s(85954),L=s(22135),U=s(40875);function Y(e){let{isOpen:t,onOpenChange:s,workOrderId:r,workOrderNumber:c,isLocked:o=!1}=e,[m,u]=(0,n.useState)([]),[h,g]=(0,n.useState)([]),[p,b]=(0,n.useState)(!0),[j,N]=(0,n.useState)(!1),[y,w]=(0,n.useState)(null),[S,C]=(0,n.useState)(new Set),[T,_]=(0,n.useState)(!1),[Y,W]=(0,n.useState)([]),[$,J]=(0,n.useState)({personnelId:"",startDate:"",startTime:"",endDate:"",endTime:"",notes:""}),[X,ee]=(0,n.useState)(null);(0,n.useEffect)(()=>{t&&et()},[t,r]);let et=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;b(!0);try{if(!i.db)throw Error("Firebase 未初始化");if(!r)throw Error("工單ID未提供");console.log("開始載入工時申報資料，工單ID:",r),console.log("載入人員資料...");let e=(await (0,l.getDocs)((0,l.collection)(i.db,"users"))).docs.map(e=>{let t=e.data();return{id:e.id,name:t.name||"未命名",employeeId:t.employeeId||"",...t}}).filter(e=>e.name&&"未命名"!==e.name);console.log("人員資料載入成功，共",e.length,"人"),u(e),console.log("載入工時記錄...");try{let e=(0,l.query)((0,l.collection)(i.db,"timeEntries"),(0,l.where)("workOrderId","==",r),(0,l.Xo)("createdAt","desc")),t=(await (0,l.getDocs)(e)).docs.map(e=>({id:e.id,...e.data()}));console.log("工時記錄載入成功，共",t.length,"筆記錄"),g(t)}catch(s){console.warn("複合索引查詢失敗，改用簡單查詢:",s);let e=(0,l.query)((0,l.collection)(i.db,"timeEntries"),(0,l.where)("workOrderId","==",r)),t=(await (0,l.getDocs)(e)).docs.map(e=>({id:e.id,...e.data()})).sort((e,t)=>{var s,a,n,r;let l=(null===(a=e.createdAt)||void 0===a?void 0:null===(s=a.toDate)||void 0===s?void 0:s.call(a))||new Date(e.createdAt||0);return((null===(r=t.createdAt)||void 0===r?void 0:null===(n=r.toDate)||void 0===n?void 0:n.call(r))||new Date(t.createdAt||0)).getTime()-l.getTime()});console.log("簡化查詢成功，共",t.length,"筆記錄"),g(t)}d.Am.success("工時資料載入完成")}catch(n){var t,s;if(console.error("載入資料失敗:",n),e<2&&!(null===(t=n.message)||void 0===t?void 0:t.includes("權限"))){console.log("載入失敗，".concat(2-e," 秒後重試...")),d.Am.loading("載入失敗，正在重試..."),setTimeout(()=>et(e+1),2e3);return}let a="載入資料失敗";"permission-denied"===n.code?a="權限不足，請檢查登入狀態":"unavailable"===n.code?a="網路連線問題，請檢查網路連線":(null===(s=n.message)||void 0===s?void 0:s.includes("索引"))?a="資料庫索引問題，請聯絡系統管理員":n.message&&(a="載入失敗: ".concat(n.message)),d.Am.error(a)}finally{b(!1)}},es=(e,t,s,a)=>{if(!e||!t||!s||!a)return 0;let n=new Date("".concat(e,"T").concat(t));return(new Date("".concat(s,"T").concat(a)).getTime()-n.getTime())/36e5},ea=async()=>{if(o){d.Am.error("工單已入庫，無法新增工時記錄");return}if(T){if(0===Y.length||!$.startDate||!$.startTime||!$.endDate||!$.endTime){d.Am.error("請選擇人員並填寫完整時間資訊");return}let e=[];if(Y.forEach(t=>{let s=m.find(e=>e.id===t);s&&er(t,$.startDate,$.startTime,$.endDate,$.endTime)&&e.push(s.name)}),e.length>0){d.Am.error("以下人員時間有重疊，無法新增：".concat(e.join(", ")));return}let t=es($.startDate,$.startTime,$.endDate,$.endTime);if(t<=0){d.Am.error("結束時間必須晚於開始時間");return}N(!0);try{let e=Y.map(async e=>{let s=m.find(t=>t.id===e);if(!s)return;let a={workOrderId:r,workOrderNumber:c,personnelId:e,personnelName:s.name,startDate:$.startDate,startTime:$.startTime,endDate:$.endDate,endTime:$.endTime,startDateTime:l.EK.fromDate(new Date("".concat($.startDate,"T").concat($.startTime))),endDateTime:l.EK.fromDate(new Date("".concat($.endDate,"T").concat($.endTime))),duration:t,overtimeHours:en(t),notes:$.notes,status:"draft",createdAt:l.EK.now(),updatedAt:l.EK.now()};await (0,l.addDoc)((0,l.collection)(i.db,"timeEntries"),a)});await Promise.all(e),d.Am.success("已批量新增 ".concat(Y.length," 筆工時記錄")),W([])}catch(e){console.error("批量新增工時記錄失敗:",e),d.Am.error("批量新增工時記錄失敗")}finally{N(!1),et()}}else{if(!$.personnelId||!$.startDate||!$.startTime||!$.endDate||!$.endTime){d.Am.error("請填寫完整資訊");return}let e=es($.startDate,$.startTime,$.endDate,$.endTime);if(e<=0){d.Am.error("結束時間必須晚於開始時間");return}if(er($.personnelId,$.startDate,$.startTime,$.endDate,$.endTime)){d.Am.error("此時間段與該人員的其他工時記錄重疊，請調整時間");return}let t=m.find(e=>e.id===$.personnelId);if(!t){d.Am.error("找不到指定人員");return}N(!0);try{let s={workOrderId:r,workOrderNumber:c,personnelId:$.personnelId,personnelName:t.name,startDate:$.startDate,startTime:$.startTime,endDate:$.endDate,endTime:$.endTime,startDateTime:l.EK.fromDate(new Date("".concat($.startDate,"T").concat($.startTime))),endDateTime:l.EK.fromDate(new Date("".concat($.endDate,"T").concat($.endTime))),duration:e,overtimeHours:en(e),notes:$.notes,status:"draft",createdAt:l.EK.now(),updatedAt:l.EK.now()};await (0,l.addDoc)((0,l.collection)(i.db,"timeEntries"),s),d.Am.success("工時記錄已新增")}catch(e){console.error("新增工時記錄失敗:",e),d.Am.error("新增工時記錄失敗")}finally{N(!1),et()}}J({personnelId:"",startDate:"",startTime:"",endDate:"",endTime:"",notes:""})},en=e=>Math.max(0,e-8),er=(e,t,s,a,n,r)=>{let l=new Date("".concat(t,"T").concat(s)),i=new Date("".concat(a,"T").concat(n));return h.some(t=>{if(r&&t.id===r||t.personnelId!==e)return!1;let s=new Date("".concat(t.startDate,"T").concat(t.startTime));return l<new Date("".concat(t.endDate,"T").concat(t.endTime))&&i>s})},el=async e=>{if(o){d.Am.error("工單已入庫，無法編輯工時記錄");return}w(e.id),ee({...e,startDate:e.startDate,startTime:e.startTime,endDate:e.endDate,endTime:e.endTime})},ei=async()=>{if(!X||!y)return;let e=es(X.startDate,X.startTime,X.endDate,X.endTime);if(e<=0){d.Am.error("結束時間必須晚於開始時間");return}N(!0);try{await (0,l.r7)((0,l.doc)(i.db,"timeEntries",y),{startDate:X.startDate,startTime:X.startTime,endDate:X.endDate,endTime:X.endTime,startDateTime:l.EK.fromDate(new Date("".concat(X.startDate,"T").concat(X.startTime))),endDateTime:l.EK.fromDate(new Date("".concat(X.endDate,"T").concat(X.endTime))),duration:e,overtimeHours:en(e),notes:X.notes,updatedAt:l.EK.now()}),d.Am.success("工時記錄已更新"),w(null),ee(null),et()}catch(e){console.error("更新工時記錄失敗:",e),d.Am.error("更新工時記錄失敗")}finally{N(!1)}},ed=async e=>{if(o){d.Am.error("工單已入庫，無法刪除工時記錄");return}if(confirm("確定要刪除這筆工時記錄嗎？"))try{await (0,l.deleteDoc)((0,l.doc)(i.db,"timeEntries",e)),d.Am.success("工時記錄已刪除"),et()}catch(e){console.error("刪除工時記錄失敗:",e),d.Am.error("刪除工時記錄失敗")}},ec=e=>{let t=new Set(S);t.has(e)?t.delete(e):t.add(e),C(t)},eo=e=>e.substring(0,5),em=e=>{let t=Math.floor(e),s=Math.round((e-t)*60);return"".concat(t,"小時").concat(s>0?"".concat(s,"分鐘"):"")};return(0,a.jsx)(B.Vq,{open:t,onOpenChange:s,children:(0,a.jsxs)(B.cZ,{className:"max-w-4xl sm:max-w-4xl max-w-[calc(100vw-1rem)] max-h-[90vh] sm:max-h-[80vh] overflow-y-auto","aria-describedby":"time-tracking-dialog-description",children:[(0,a.jsxs)(B.fK,{children:[(0,a.jsxs)(B.$N,{className:"flex items-center gap-2",children:[(0,a.jsx)(M.Z,{className:"h-5 w-5"}),"工時追蹤"]}),(0,a.jsx)(B.Be,{id:"time-tracking-dialog-description",children:"記錄工單的工時資訊，包含人員、時間段和備註"})]}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[(0,a.jsxs)(Z.Zb,{className:"relative overflow-hidden bg-gradient-to-br from-blue-50 to-indigo-100 border-2 border-blue-200",children:[(0,a.jsx)(Z.Ol,{className:"pb-2",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)(Z.ll,{className:"text-sm font-bold text-blue-800",children:"總記錄數"}),(0,a.jsx)("div",{className:"p-2 bg-blue-500 rounded-lg",children:(0,a.jsx)(q.Z,{className:"h-4 w-4 text-white"})})]})}),(0,a.jsxs)(Z.aY,{children:[(0,a.jsx)("div",{className:"text-3xl font-bold text-blue-900 mb-1",children:h.length}),(0,a.jsx)("p",{className:"text-xs text-blue-600 font-medium",children:"筆工時記錄"})]}),(0,a.jsx)("div",{className:"absolute inset-0 bg-gradient-to-br from-transparent to-blue-600/10 pointer-events-none"})]}),(0,a.jsxs)(Z.Zb,{className:"relative overflow-hidden bg-gradient-to-br from-emerald-50 to-green-100 border-2 border-emerald-200",children:[(0,a.jsx)(Z.Ol,{className:"pb-2",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)(Z.ll,{className:"text-sm font-bold text-emerald-800",children:"總工時"}),(0,a.jsx)("div",{className:"p-2 bg-emerald-500 rounded-lg",children:(0,a.jsx)(M.Z,{className:"h-4 w-4 text-white"})})]})}),(0,a.jsxs)(Z.aY,{children:[(0,a.jsx)("div",{className:"text-3xl font-bold text-emerald-900 mb-1",children:em(h.reduce((e,t)=>e+t.duration,0))}),(0,a.jsx)("p",{className:"text-xs text-emerald-600 font-medium",children:"累計工作時間"})]}),(0,a.jsx)("div",{className:"absolute inset-0 bg-gradient-to-br from-transparent to-emerald-600/10 pointer-events-none"})]}),(0,a.jsxs)(Z.Zb,{className:"relative overflow-hidden bg-gradient-to-br from-purple-50 to-violet-100 border-2 border-purple-200",children:[(0,a.jsx)(Z.Ol,{className:"pb-2",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)(Z.ll,{className:"text-sm font-bold text-purple-800",children:"人工總時"}),(0,a.jsx)("div",{className:"p-2 bg-purple-500 rounded-lg",children:(0,a.jsx)(K.Z,{className:"h-4 w-4 text-white"})})]})}),(0,a.jsxs)(Z.aY,{children:[(0,a.jsx)("div",{className:"text-3xl font-bold text-purple-900 mb-1",children:em(h.reduce((e,t)=>e+t.duration,0))}),(0,a.jsx)("p",{className:"text-xs text-purple-600 font-medium",children:"總人工工時"})]}),(0,a.jsx)("div",{className:"absolute inset-0 bg-gradient-to-br from-transparent to-purple-600/10 pointer-events-none"})]})]}),!o&&(0,a.jsxs)(Z.Zb,{className:"border-2 border-blue-100 bg-gradient-to-br from-blue-50/50 to-indigo-50/50",children:[(0,a.jsx)(Z.Ol,{children:(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)(Z.ll,{className:"flex items-center gap-2 text-blue-900",children:[(0,a.jsx)(R.Z,{className:"h-4 w-4"}),"新增工時記錄"]}),(0,a.jsxs)(A.z,{variant:T?"default":"outline",size:"sm",onClick:()=>_(!T),className:"gap-2",children:[(0,a.jsx)(K.Z,{className:"h-4 w-4"}),T?"批量模式":"單一模式"]})]})}),(0,a.jsxs)(Z.aY,{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(F._,{className:"text-sm font-medium text-gray-700",children:T?"選擇多個人員":"選擇人員"}),T?(0,a.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2",children:m.map(e=>(0,a.jsxs)("label",{className:"flex items-center gap-2 p-2 rounded-lg border cursor-pointer hover:bg-blue-50 transition-colors",children:[(0,a.jsx)("input",{type:"checkbox",checked:Y.includes(e.id),onChange:t=>{t.target.checked?W([...Y,e.id]):W(Y.filter(t=>t!==e.id))},className:"w-4 h-4 text-blue-600 rounded focus:ring-blue-500"}),(0,a.jsxs)("span",{className:"text-sm",children:[e.name,(0,a.jsxs)("span",{className:"text-xs text-gray-500 ml-1",children:["(",e.employeeId,")"]})]})]},e.id))}):(0,a.jsxs)(E.Ph,{value:$.personnelId,onValueChange:e=>J({...$,personnelId:e}),children:[(0,a.jsx)(E.i4,{className:"bg-white",children:(0,a.jsx)(E.ki,{placeholder:"選擇人員"})}),(0,a.jsx)(E.Bw,{children:m.map(e=>(0,a.jsxs)(E.Ql,{value:e.id,children:[e.name," (",e.employeeId,")"]},e.id))})]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)(F._,{className:"text-sm font-semibold text-gray-800 flex items-center gap-2",children:[(0,a.jsx)(G.Z,{className:"h-4 w-4 text-blue-600"}),"工作日期"]}),(0,a.jsx)(I.I,{type:"date",value:$.startDate,onChange:e=>J({...$,startDate:e.target.value,endDate:e.target.value}),className:"bg-white border-2 border-blue-200 focus:border-blue-500 focus:ring-blue-200"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,a.jsxs)("div",{className:"space-y-4 p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border-2 border-green-200",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"p-2 bg-green-500 rounded-lg",children:(0,a.jsx)(M.Z,{className:"h-5 w-5 text-white"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-green-800",children:"上班時間"}),(0,a.jsx)("p",{className:"text-xs text-green-600",children:"設定開始工作時間"})]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)(F._,{className:"text-sm font-medium text-green-700",children:"時間 (24小時制)"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(I.I,{type:"time",value:$.startTime,onChange:e=>J({...$,startTime:e.target.value}),step:"60",className:"text-lg font-mono bg-white border-2 border-green-300 focus:border-green-500 focus:ring-green-200 pl-12 text-black [&::-webkit-calendar-picker-indicator]:opacity-100 [&::-webkit-calendar-picker-indicator]:cursor-pointer [&::-webkit-datetime-edit]:text-black [&::-webkit-datetime-edit-text]:text-black [&::-webkit-datetime-edit-hour-field]:text-black [&::-webkit-datetime-edit-minute-field]:text-black [&::-webkit-datetime-edit-ampm-field]:display-none",style:{colorScheme:"light",color:"#000000 !important",WebkitTextFillColor:"#000000 !important",opacity:1},placeholder:"09:00"}),(0,a.jsx)(M.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-green-500"})]}),(0,a.jsx)("p",{className:"text-xs text-green-600 bg-green-100 p-2 rounded",children:"格式：HH:MM (例如：09:30, 14:00)"})]})]}),(0,a.jsxs)("div",{className:"space-y-4 p-6 bg-gradient-to-br from-red-50 to-pink-50 rounded-xl border-2 border-red-200",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"p-2 bg-red-500 rounded-lg",children:(0,a.jsx)(M.Z,{className:"h-5 w-5 text-white"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-red-800",children:"下班時間"}),(0,a.jsx)("p",{className:"text-xs text-red-600",children:"設定結束工作時間"})]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)(F._,{className:"text-sm font-medium text-red-700",children:"時間 (24小時制)"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(I.I,{type:"time",value:$.endTime,onChange:e=>J({...$,endTime:e.target.value,endDate:$.startDate}),step:"60",className:"text-lg font-mono bg-white border-2 border-red-300 focus:border-red-500 focus:ring-red-200 pl-12 text-black [&::-webkit-calendar-picker-indicator]:opacity-100 [&::-webkit-calendar-picker-indicator]:cursor-pointer [&::-webkit-datetime-edit]:text-black [&::-webkit-datetime-edit-text]:text-black [&::-webkit-datetime-edit-hour-field]:text-black [&::-webkit-datetime-edit-minute-field]:text-black [&::-webkit-datetime-edit-ampm-field]:display-none",style:{colorScheme:"light",color:"#000000 !important",WebkitTextFillColor:"#000000 !important",opacity:1},placeholder:"18:00"}),(0,a.jsx)(M.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-red-500"})]}),(0,a.jsx)("p",{className:"text-xs text-red-600 bg-red-100 p-2 rounded",children:"格式：HH:MM (例如：17:30, 18:00)"})]})]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)(F._,{className:"text-sm font-semibold text-gray-800 flex items-center gap-2",children:[(0,a.jsx)(P,{className:"h-4 w-4 text-purple-600"}),"備註說明"]}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(I.I,{placeholder:"輸入工作內容或特殊註意事項...",value:$.notes,onChange:e=>J({...$,notes:e.target.value}),className:"bg-gradient-to-r from-white to-purple-50 border-2 border-purple-200 focus:border-purple-500 focus:ring-purple-200 pl-10"}),(0,a.jsx)(P,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-purple-500"})]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)(F._,{className:"text-sm font-semibold text-gray-800 flex items-center gap-2",children:[(0,a.jsx)(V.Z,{className:"h-4 w-4 text-yellow-600"}),"快速設定"]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[(0,a.jsxs)(A.z,{type:"button",variant:"outline",size:"sm",onClick:()=>J({...$,startTime:"09:00",endTime:"18:00"}),className:"gap-2 bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200 hover:from-blue-100 hover:to-indigo-100",children:[(0,a.jsx)(M.Z,{className:"h-3 w-3"}),"日班 9-6"]}),(0,a.jsxs)(A.z,{type:"button",variant:"outline",size:"sm",onClick:()=>J({...$,startTime:"08:00",endTime:"17:00"}),className:"gap-2 bg-gradient-to-r from-green-50 to-emerald-50 border-green-200 hover:from-green-100 hover:to-emerald-100",children:[(0,a.jsx)(M.Z,{className:"h-3 w-3"}),"早班 8-5"]}),(0,a.jsxs)(A.z,{type:"button",variant:"outline",size:"sm",onClick:()=>J({...$,startTime:"14:00",endTime:"22:00"}),className:"gap-2 bg-gradient-to-r from-purple-50 to-violet-50 border-purple-200 hover:from-purple-100 hover:to-violet-100",children:[(0,a.jsx)(M.Z,{className:"h-3 w-3"}),"晚班 2-10"]}),(0,a.jsxs)(A.z,{type:"button",variant:"outline",size:"sm",onClick:()=>J({...$,startTime:"09:00",endTime:"13:00"}),className:"gap-2 bg-gradient-to-r from-orange-50 to-amber-50 border-orange-200 hover:from-orange-100 hover:to-amber-100",children:[(0,a.jsx)(M.Z,{className:"h-3 w-3"}),"上半日"]})]})]}),$.startDate&&$.startTime&&$.endDate&&$.endTime&&(0,a.jsxs)("div",{className:"p-6 bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 rounded-xl border-2 border-orange-200",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"p-2 bg-orange-500 rounded-lg",children:(0,a.jsx)(H.Z,{className:"h-5 w-5 text-white"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-orange-900",children:"工時計算"}),(0,a.jsx)("p",{className:"text-xs text-orange-600",children:"自動計算工作時間"})]})]}),(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsx)("div",{className:"text-3xl font-bold text-orange-900",children:em(es($.startDate,$.startTime,$.endDate,$.endTime))}),(0,a.jsx)("p",{className:"text-xs text-orange-600",children:"總工時"})]})]}),en(es($.startDate,$.startTime,$.endDate,$.endTime))>0&&(0,a.jsxs)("div",{className:"flex items-center justify-between p-3 bg-red-100 rounded-lg border border-red-200",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(O.Z,{className:"h-4 w-4 text-red-600"}),(0,a.jsx)("span",{className:"text-sm font-medium text-red-800",children:"加班時数："})]}),(0,a.jsx)("div",{className:"text-lg font-bold text-red-800",children:em(en(es($.startDate,$.startTime,$.endDate,$.endTime)))})]})]}),(0,a.jsx)(A.z,{onClick:ea,disabled:j||(T?0===Y.length:!$.personnelId)||!$.startDate||!$.startTime||!$.endDate||!$.endTime,className:"w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700",size:"lg",children:j?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(x.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"新增中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(R.Z,{className:"mr-2 h-4 w-4"}),T?"批量新增 ".concat(Y.length," 筆記錄"):"新增工時記錄"]})})]})]}),(0,a.jsxs)(Z.Zb,{children:[(0,a.jsxs)(Z.Ol,{children:[(0,a.jsxs)(Z.ll,{className:"flex items-center gap-2",children:[(0,a.jsx)(q.Z,{className:"h-5 w-5"}),"工時記錄"]}),(0,a.jsxs)(Z.SZ,{children:["所有已記錄的工時資訊 ",o&&(0,a.jsx)(z.C,{variant:"destructive",className:"ml-2",children:"已鎖定"})]})]}),(0,a.jsx)(Z.aY,{children:p?(0,a.jsx)("div",{className:"flex justify-center items-center py-8",children:(0,a.jsx)(x.Z,{className:"h-6 w-6 animate-spin text-gray-400"})}):0===h.length?(0,a.jsxs)("div",{className:"text-center py-8 text-muted-foreground",children:[(0,a.jsx)(M.Z,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,a.jsx)("p",{children:"尚無工時記錄"})]}):(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("div",{className:"hidden md:block overflow-x-auto",children:(0,a.jsxs)(Q.iA,{children:[(0,a.jsx)(Q.xD,{children:(0,a.jsxs)(Q.SC,{children:[(0,a.jsx)(Q.ss,{className:"w-[150px]",children:"人員"}),(0,a.jsx)(Q.ss,{children:"開始時間"}),(0,a.jsx)(Q.ss,{children:"結束時間"}),(0,a.jsx)(Q.ss,{children:"工時"}),(0,a.jsx)(Q.ss,{children:"加班"}),(0,a.jsx)(Q.ss,{children:"備註"}),!o&&(0,a.jsx)(Q.ss,{className:"text-right",children:"操作"})]})}),(0,a.jsx)(Q.RM,{children:h.map(e=>(0,a.jsx)(Q.SC,{className:"hover:bg-gray-50",children:y===e.id?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(Q.pj,{children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(D.Z,{className:"h-4 w-4 text-muted-foreground"}),(0,a.jsx)("span",{className:"font-medium",children:e.personnelName})]})}),(0,a.jsx)(Q.pj,{children:(0,a.jsxs)("div",{className:"flex gap-1",children:[(0,a.jsx)(I.I,{type:"date",value:null==X?void 0:X.startDate,onChange:e=>ee({...X,startDate:e.target.value}),className:"h-8 text-xs"}),(0,a.jsx)(I.I,{type:"time",value:null==X?void 0:X.startTime,onChange:e=>ee({...X,startTime:e.target.value}),step:"60",className:"h-8 text-xs text-black [&::-webkit-calendar-picker-indicator]:opacity-100 [&::-webkit-datetime-edit]:text-black [&::-webkit-datetime-edit-text]:text-black [&::-webkit-datetime-edit-hour-field]:text-black [&::-webkit-datetime-edit-minute-field]:text-black [&::-webkit-datetime-edit-ampm-field]:display-none",style:{colorScheme:"light",color:"#000000 !important",WebkitTextFillColor:"#000000 !important",opacity:1}})]})}),(0,a.jsx)(Q.pj,{children:(0,a.jsxs)("div",{className:"flex gap-1",children:[(0,a.jsx)(I.I,{type:"date",value:null==X?void 0:X.endDate,onChange:e=>ee({...X,endDate:e.target.value}),className:"h-8 text-xs"}),(0,a.jsx)(I.I,{type:"time",value:null==X?void 0:X.endTime,onChange:e=>ee({...X,endTime:e.target.value}),step:"60",className:"h-8 text-xs text-black [&::-webkit-calendar-picker-indicator]:opacity-100 [&::-webkit-datetime-edit]:text-black [&::-webkit-datetime-edit-text]:text-black [&::-webkit-datetime-edit-hour-field]:text-black [&::-webkit-datetime-edit-minute-field]:text-black [&::-webkit-datetime-edit-ampm-field]:display-none",style:{colorScheme:"light",color:"#000000 !important",WebkitTextFillColor:"#000000 !important",opacity:1}})]})}),(0,a.jsx)(Q.pj,{colSpan:2,children:(0,a.jsx)(I.I,{value:(null==X?void 0:X.notes)||"",onChange:e=>ee({...X,notes:e.target.value}),placeholder:"備註",className:"h-8 text-xs"})}),(0,a.jsx)(Q.pj,{}),(0,a.jsx)(Q.pj,{className:"text-right",children:(0,a.jsxs)("div",{className:"flex gap-1 justify-end",children:[(0,a.jsx)(A.z,{size:"sm",variant:"ghost",onClick:ei,disabled:j,children:(0,a.jsx)(v.Z,{className:"h-4 w-4"})}),(0,a.jsx)(A.z,{size:"sm",variant:"ghost",onClick:()=>{w(null),ee(null)},children:(0,a.jsx)(k.Z,{className:"h-4 w-4"})})]})})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(Q.pj,{children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(D.Z,{className:"h-4 w-4 text-muted-foreground"}),(0,a.jsx)("span",{className:"font-medium",children:e.personnelName})]})}),(0,a.jsxs)(Q.pj,{className:"text-sm",children:[e.startDate," ",eo(e.startTime)]}),(0,a.jsxs)(Q.pj,{className:"text-sm",children:[e.endDate," ",eo(e.endTime)]}),(0,a.jsx)(Q.pj,{children:(0,a.jsx)(z.C,{variant:"outline",className:"bg-blue-50",children:em(e.duration)})}),(0,a.jsx)(Q.pj,{children:e.overtimeHours&&e.overtimeHours>0?(0,a.jsx)(z.C,{variant:"destructive",className:"bg-red-50 text-red-700",children:em(e.overtimeHours)}):(0,a.jsx)("span",{className:"text-gray-400",children:"-"})}),(0,a.jsx)(Q.pj,{className:"text-sm text-gray-600",children:e.notes||"-"}),!o&&(0,a.jsx)(Q.pj,{className:"text-right",children:(0,a.jsxs)("div",{className:"flex gap-1 justify-end",children:[(0,a.jsx)(A.z,{size:"sm",variant:"ghost",onClick:()=>el(e),children:(0,a.jsx)(P,{className:"h-4 w-4"})}),(0,a.jsx)(A.z,{size:"sm",variant:"ghost",onClick:()=>ed(e.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:(0,a.jsx)(f.Z,{className:"h-4 w-4"})})]})})]})},e.id))})]})}),(0,a.jsx)("div",{className:"md:hidden space-y-3",children:h.map(e=>(0,a.jsx)(Z.Zb,{className:"overflow-hidden",children:(0,a.jsxs)("div",{className:"p-4 cursor-pointer hover:bg-gray-50",onClick:()=>ec(e.id),children:[(0,a.jsxs)("div",{className:"flex justify-between items-start",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(D.Z,{className:"h-4 w-4 text-muted-foreground"}),(0,a.jsx)("span",{className:"font-medium",children:e.personnelName})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(z.C,{variant:"outline",className:"bg-blue-50",children:em(e.duration)}),S.has(e.id)?(0,a.jsx)(L.Z,{className:"h-4 w-4 text-gray-400"}):(0,a.jsx)(U.Z,{className:"h-4 w-4 text-gray-400"})]})]}),S.has(e.id)&&(0,a.jsxs)("div",{className:"mt-3 pt-3 border-t space-y-2",children:[(0,a.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"開始："}),(0,a.jsxs)("span",{children:[e.startDate," ",eo(e.startTime)]})]}),(0,a.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"結束："}),(0,a.jsxs)("span",{children:[e.endDate," ",eo(e.endTime)]})]}),e.overtimeHours&&e.overtimeHours>0&&(0,a.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"加班："}),(0,a.jsx)(z.C,{variant:"destructive",className:"bg-red-50 text-red-700",children:em(e.overtimeHours)})]}),e.notes&&(0,a.jsxs)("div",{className:"text-sm",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"備註："}),(0,a.jsx)("p",{className:"mt-1 text-gray-800",children:e.notes})]}),!o&&(0,a.jsxs)("div",{className:"flex gap-2 pt-2",children:[(0,a.jsxs)(A.z,{size:"sm",variant:"outline",onClick:t=>{t.stopPropagation(),el(e)},className:"flex-1",children:[(0,a.jsx)(P,{className:"h-4 w-4 mr-1"}),"編輯"]}),(0,a.jsxs)(A.z,{size:"sm",variant:"outline",onClick:t=>{t.stopPropagation(),ed(e.id)},className:"flex-1 text-red-600 hover:text-red-700 hover:bg-red-50",children:[(0,a.jsx)(f.Z,{className:"h-4 w-4 mr-1"}),"刪除"]})]})]})]})},e.id))})]})})]})]})]})})}let W=[{value:"預報",label:"預報",color:"bg-orange-100 text-orange-800 border-orange-200"},{value:"進行",label:"進行",color:"bg-blue-100 text-blue-800 border-blue-200"},{value:"完工",label:"完工",color:"bg-green-100 text-green-800 border-green-200"},{value:"入庫",label:"入庫",color:"bg-purple-100 text-purple-800 border-purple-200"}];function $(){var e,t;let h=(0,r.useParams)(),q=(0,r.useRouter)(),K=h.id,[R,G]=(0,n.useState)(null),[P,V]=(0,n.useState)([]),[H,L]=(0,n.useState)([]),[U,$]=(0,n.useState)(!0),[J,X]=(0,n.useState)(!1),[ee,et]=(0,n.useState)(!1),[es,ea]=(0,n.useState)(!1),[en,er]=(0,n.useState)({status:"",qcStatus:"",actualQuantity:0,targetQuantity:0,notes:""}),[el,ei]=(0,n.useState)([]),[ed,ec]=(0,n.useState)(""),[eo,em]=(0,n.useState)([]),[ex,eu]=(0,n.useState)(!1),[eh,eg]=(0,n.useState)(!1),[ep,ef]=(0,n.useState)(!1),[eb,ej]=(0,n.useState)(!1),[ev,eN]=(0,n.useState)({}),[ey,ew]=(0,n.useState)(!1),[ek,eM]=(0,n.useState)(!1),[eS,eC]=(0,n.useState)(!1),[eD,eT]=(0,n.useState)(!1),eO=e=>{if(0===e)return"0";let t=parseFloat(e.toFixed(6));return t%1==0?t.toString():parseFloat(t.toFixed(6)).toString()},eA=(e,t)=>{let s=parseFloat(parseFloat(t||"0").toFixed(6));eN(t=>({...t,[e]:s}))},eZ=async()=>{if(R&&i.db)try{let e=R.billOfMaterials.map(e=>({...e,usedQuantity:void 0!==ev[e.id]?parseFloat(ev[e.id].toFixed(6)):parseFloat((e.usedQuantity||0).toFixed(6))})),t=(0,l.doc)(i.db,"workOrders",K);await (0,l.r7)(t,{billOfMaterials:e,updatedAt:l.EK.now()}),G(t=>t?{...t,billOfMaterials:e}:null),eN({}),ej(!1),d.Am.success("使用數量已更新")}catch(e){(0,o.vU)("更新使用數量失敗",e),d.Am.error("更新使用數量失敗")}},ez=e=>R?R.billOfMaterials.map(t=>{if(["fragrance","pg","vg","nicotine"].includes(t.category)&&t.ratio){let s=parseFloat((t.ratio/100*e).toFixed(6));return{...t,quantity:s,usedQuantity:parseFloat((t.usedQuantity||s).toFixed(6))}}return t}):[],eQ=e=>{er(t=>({...t,targetQuantity:e}));let t=ez(e);G(e=>e?{...e,billOfMaterials:t}:null)},eE=async()=>{if(R&&i.db){eM(!0);try{let e=(0,l.doc)(i.db,"workOrders",K);for(let t of(await (0,l.r7)(e,{status:"完工",updatedAt:l.EK.now()}),R.billOfMaterials.filter(e=>(e.usedQuantity||0)>0))){let e=t.usedQuantity||0;if("fragrance"===t.category){let s=(0,l.doc)(i.db,"fragrances",t.id);try{let a=await (0,l.QT)(s);if(a.exists()){let n=a.data().currentStock||0,r=Math.max(0,parseFloat((n-e).toFixed(6)));await (0,l.r7)(s,{currentStock:r,updatedAt:l.EK.now()}),(0,o.fF)("香精庫存已扣除: ".concat(t.name),{currentStock:n,newStock:r,usedQuantity:e})}}catch(e){(0,o.vU)("更新香精庫存失敗: ".concat(t.name),e),d.Am.error("更新香精 ".concat(t.name," 庫存失敗"))}}else{let s=(0,l.doc)(i.db,"materials",t.id);try{let a=await (0,l.QT)(s);if(a.exists()){let n=a.data().currentStock||0,r=Math.max(0,parseFloat((n-e).toFixed(6)));await (0,l.r7)(s,{currentStock:r,updatedAt:l.EK.now()}),(0,o.fF)("物料庫存已扣除: ".concat(t.name),{currentStock:n,newStock:r,usedQuantity:e})}}catch(e){(0,o.vU)("更新物料庫存失敗: ".concat(t.name),e),d.Am.error("更新物料 ".concat(t.name," 庫存失敗"))}}}G(e=>e?{...e,status:"完工"}:null),ew(!1),X(!1),d.Am.success("工單已完工，庫存已扣除")}catch(e){(0,o.vU)("完工操作失敗",e),d.Am.error("完工操作失敗")}finally{eM(!1)}}},eI=async()=>{if(R&&i.db){eT(!0);try{let e=(0,l.doc)(i.db,"workOrders",K);await (0,l.r7)(e,{status:"入庫",updatedAt:l.EK.now()}),G(e=>e?{...e,status:"入庫"}:null),eC(!1),d.Am.success("工單已入庫")}catch(e){(0,o.vU)("入庫操作失敗",e),d.Am.error("入庫操作失敗")}finally{eT(!1)}}},eF=(0,n.useCallback)(async()=>{if(K&&i.db)try{let e=(0,l.query)((0,l.collection)(i.db,"timeEntries"),(0,l.where)("workOrderId","==",K),(0,l.Xo)("createdAt","desc")),t=(await (0,l.getDocs)(e)).docs.map(e=>({id:e.id,...e.data()}));V(t)}catch(e){(0,o.vU)("載入工時記錄失敗",e)}},[K]),e_=(0,n.useCallback)(async()=>{if(K&&i.db){$(!0);try{let c=await (0,l.QT)((0,l.doc)(i.db,"workOrders",K));if(c.exists()){var e,t,s,a,n,r;let d=c.data();(0,o.fF)("工單資料載入成功",{id:K,data:d}),(0,o.fF)("產品快照",d.productSnapshot);let m=await (0,l.getDocs)((0,l.collection)(i.db,"materials")),x=await (0,l.getDocs)((0,l.collection)(i.db,"fragrances")),u=m.docs.map(e=>({id:e.id,...e.data()})),h=x.docs.map(e=>({id:e.id,...e.data()}));[...u,...h],G({id:c.id,code:d.code,productSnapshot:{code:(null===(e=d.productSnapshot)||void 0===e?void 0:e.code)||"",name:(null===(t=d.productSnapshot)||void 0===t?void 0:t.name)||"",seriesName:(null===(s=d.productSnapshot)||void 0===s?void 0:s.seriesName)||"未指定",fragranceName:(null===(a=d.productSnapshot)||void 0===a?void 0:a.fragranceName)||"未指定",fragranceCode:(null===(n=d.productSnapshot)||void 0===n?void 0:n.fragranceCode)||"未指定",nicotineMg:(null===(r=d.productSnapshot)||void 0===r?void 0:r.nicotineMg)||0},billOfMaterials:(d.billOfMaterials||[]).map(e=>{let t=null;return"fragrance"===e.category&&(t=h.find(t=>t.id===e.id||t.code===e.code||t.name===e.name)),t||(t=u.find(t=>t.id===e.id||t.code===e.code||t.name===e.name)),{id:e.id||e.materialId||"",name:e.name||e.materialName||"",code:e.code||e.materialCode||"",type:e.type||("fragrance"===e.category?"fragrance":"material"),quantity:e.quantity||e.requiredQuantity||0,unit:e.unit||"個",ratio:e.ratio||0,isCalculated:void 0===e.isCalculated||e.isCalculated,category:e.category||"other",usedQuantity:e.usedQuantity||e.quantity||e.requiredQuantity||0,currentStock:t&&t.currentStock||0}}),targetQuantity:d.targetQuantity||0,actualQuantity:d.actualQuantity||0,status:d.status||"預報",qcStatus:d.qcStatus||"未檢驗",createdAt:d.createdAt,createdByRef:d.createdByRef,createdByName:d.createdByName||"",notes:d.notes||"",timeRecords:d.timeRecords||[],comments:d.comments||[]}),ei(d.comments||[])}else d.Am.error("找不到工單"),q.push("/dashboard/work-orders")}catch(e){console.error("載入工單失敗:",e),d.Am.error("載入工單失敗")}finally{$(!1)}}},[K,i.db,q]),eB=(0,n.useCallback)(async()=>{try{if(!i.db)return;let e=(await (0,l.getDocs)((0,l.collection)(i.db,"users"))).docs.map(e=>({id:e.id,...e.data()})).filter(e=>e.isActive).map(e=>({id:e.id,name:e.name,employeeId:e.employeeId}));L(e)}catch(e){console.error("載入人員資料失敗:",e)}},[]),eq=async e=>{let t=e.target.files;if(!t||0===t.length)return;let s=Array.from(t),a=d.Am.loading("正在處理圖片...");try{if(s.reduce((e,t)=>e+t.size,0)>10485760){d.Am.error("總檔案大小不能超過 10MB，請選擇較小的圖片",{id:a});return}let e=await (0,c.OM)(s,{folder:"work-orders/".concat(K,"/comments"),maxSize:2,compress:!0,quality:.6}),t=e.filter(e=>e.success),n=e.filter(e=>!e.success);if(t.length>0){let e=t.map(e=>e.url);em(t=>[...t,...e]),d.Am.success("成功上傳 ".concat(t.length," 張圖片"),{id:a})}if(n.length>0){let e=n.map(e=>e.error).join(", ");d.Am.error("以下圖片上傳失敗: ".concat(e),{id:a})}}catch(e){console.error("圖片處理失敗:",e),d.Am.error("圖片處理失敗: ".concat(e instanceof Error?e.message:"未知錯誤"),{id:a})}e.target.value=""},eK=e=>{em(t=>t.filter((t,s)=>s!==e))},eR=(0,n.useCallback)(async()=>{if(R&&i.db){ef(!0);try{let e=R.productSnapshot;console.log("重新載入BOM表 - 工單中的產品快照:",e);let t=null;if(e.fragranceCode&&"未指定"!==e.fragranceCode){console.log("重新載入BOM表 - 開始查詢香精:",e.fragranceCode);let s=(0,l.query)((0,l.collection)(i.db,"fragrances"),(0,l.where)("code","==",e.fragranceCode)),a=await (0,l.getDocs)(s);a.empty?console.log("重新載入BOM表 - 在香精集合中找不到對應的香精:",e.fragranceCode):(t=a.docs[0].data(),console.log("重新載入BOM表 - 成功獲取香精配方資料:",{code:t.code,name:t.name,percentage:t.percentage,pgRatio:t.pgRatio,vgRatio:t.vgRatio}))}else console.log("重新載入BOM表 - 香精代號未指定或為空");let s={name:e.name,fragranceName:e.fragranceName,fragranceCode:e.fragranceCode,nicotineMg:e.nicotineMg,fragranceFormula:t||null};console.log("重新載入BOM表 - 最終使用的產品資料:",s);let a=await eG(s,R.targetQuantity),n=R.billOfMaterials,r=a.map(e=>{let t=n.find(t=>t.id===e.id);return{...e,usedQuantity:(null==t?void 0:t.usedQuantity)||e.usedQuantity,currentStock:(null==t?void 0:t.currentStock)||e.currentStock||0}}),c=await (0,l.getDocs)((0,l.collection)(i.db,"materials")),o=await (0,l.getDocs)((0,l.collection)(i.db,"fragrances")),m=c.docs.map(e=>({id:e.id,...e.data()})),x=o.docs.map(e=>({id:e.id,...e.data()})),u=r.map(e=>{let t=null;return"fragrance"===e.category&&(t=x.find(t=>t.id===e.id||t.code===e.code||t.name===e.name)),t||(t=m.find(t=>t.id===e.id||t.code===e.code||t.name===e.name)),{...e,currentStock:t?t.currentStock||0:e.currentStock||0}}),h=(0,l.doc)(i.db,"workOrders",K);await (0,l.r7)(h,{billOfMaterials:u,updatedAt:l.EK.now()}),await e_(),d.Am.success("BOM表已重新載入")}catch(e){console.error("重新載入BOM表失敗:",e),d.Am.error("重新載入BOM表失敗")}finally{ef(!1)}}},[R,i.db,K,e_]),eG=async(e,t)=>{var s,a,n,r;if(!i.db)return[];console.log("重新載入BOM表 - 開始重新計算物料需求:",{productData:{name:e.name,fragranceName:e.fragranceName,fragranceCode:e.fragranceCode,nicotineMg:e.nicotineMg},targetQuantity:t});let c=(await (0,l.getDocs)((0,l.collection)(i.db,"materials"))).docs.map(e=>({id:e.id,...e.data()})),o=(await (0,l.getDocs)((0,l.collection)(i.db,"fragrances"))).docs.map(e=>({id:e.id,...e.data()})),x=[...c,...o];console.log("重新載入BOM表 - 載入的物料列表:",c.length,"個"),console.log("重新載入BOM表 - 載入的香精列表:",o.length,"個"),console.log("重新載入BOM表 - 合併後的總物料列表:",x.length,"個");let u=new Map;if(console.log("重新載入BOM表 - 檢查香精配方資料:",e.fragranceFormula),!e.fragranceFormula)return console.error("重新載入BOM表 - 錯誤：沒有香精配方資料"),d.Am.error("抓取錯誤：沒有香精配方資料"),[];let{percentage:h,pgRatio:g,vgRatio:p}=e.fragranceFormula;if(console.log("重新載入BOM表 - 香精配方資料:",{percentage:h,pgRatio:g,vgRatio:p}),!h||h<=0)return console.error("重新載入BOM表 - 錯誤：香精比例為0或無效"),d.Am.error("抓取錯誤：香精比例為0或無效"),[];let f={fragrance:h,pg:g,vg:p};if(console.log("重新載入BOM表 - 直接使用香精詳情中的配方比例（避免浮點數精度問題）:",{香精:h+"%",PG:g+"%",VG:p+"%",總計:h+g+p+"%"}),console.log("重新載入BOM表 - 最終使用香精比例:",f),e.fragranceName&&"未指定"!==e.fragranceName){let s=f.fragrance/100*t,a=o.find(t=>t.code===e.fragranceCode||t.name===e.fragranceName);console.log("重新載入BOM表 - 香精匹配結果:",{fragranceCode:e.fragranceCode,fragranceName:e.fragranceName,foundFragrance:a?{id:a.id,code:a.code,name:a.name,currentStock:a.currentStock}:null,allFragrances:o.map(e=>({code:e.code,name:e.name,currentStock:e.currentStock}))});let n=a&&a.currentStock||0,r=n>=s;u.set("fragrance",{id:a?a.id:e.fragranceCode||"fragrance",name:e.fragranceName,code:e.fragranceCode,type:"fragrance",quantity:s,unit:"KG",ratio:f.fragrance,isCalculated:!0,category:"fragrance",usedQuantity:s,currentStock:n}),console.log("重新載入BOM表 - 添加香精:",e.fragranceName,s,"比例:",f.fragrance,"庫存:",n,"充足:",r)}else console.log("重新載入BOM表 - 香精名稱未指定或為空，跳過香精添加");let b=(0,m.n)(x,"pg");if(b){let e=f.pg/100*t;u.set(b.id,{id:b.id,name:b.name,code:b.code,type:"material",quantity:e,unit:b.unit||"KG",ratio:f.pg,isCalculated:!0,category:"pg",usedQuantity:e,currentStock:b.currentStock||0}),console.log("重新載入BOM表 - 添加PG:",b.name,e,"比例:",f.pg,"庫存:",b.currentStock)}else console.warn("重新載入BOM表 - 找不到PG物料");let j=(0,m.n)(x,"vg");if(j){let e=f.vg/100*t;u.set(j.id,{id:j.id,name:j.name,code:j.code,type:"material",quantity:e,unit:j.unit||"KG",ratio:f.vg,isCalculated:!0,category:"vg",usedQuantity:e,currentStock:j.currentStock||0}),console.log("重新載入BOM表 - 添加VG:",j.name,e,"比例:",f.vg,"庫存:",j.currentStock)}else console.warn("重新載入BOM表 - 找不到VG物料");let v=(0,m.n)(x,"nicotine");if(v){let s=e.nicotineMg&&e.nicotineMg>0?t*e.nicotineMg/250:0;u.set(v.id,{id:v.id,name:v.name,code:v.code,type:"material",quantity:s,unit:v.unit||"KG",ratio:0,isCalculated:!0,category:"nicotine",usedQuantity:s,currentStock:v.currentStock||0}),console.log("重新載入BOM表 - 添加尼古丁:",v.name,s,"濃度:",e.nicotineMg,"庫存:",v.currentStock)}console.log("重新載入BOM表 - 專屬材料名稱:",null==R?void 0:null===(s=R.billOfMaterials)||void 0===s?void 0:s.filter(e=>"specific"===e.category).map(e=>e.name)),((null==R?void 0:null===(a=R.billOfMaterials)||void 0===a?void 0:a.filter(e=>"specific"===e.category))||[]).forEach(e=>{let t=c.find(t=>t.id===e.id||t.code===e.code||t.name===e.name);u.set(e.id,{...e,quantity:0,usedQuantity:e.usedQuantity||0,currentStock:t?t.currentStock||0:e.currentStock||0}),console.log("重新載入BOM表 - 保持專屬材料:",e.name,"需求量: 0",e.unit,"庫存:",t?t.currentStock:e.currentStock)}),console.log("重新載入BOM表 - 通用材料名稱:",null==R?void 0:null===(n=R.billOfMaterials)||void 0===n?void 0:n.filter(e=>"common"===e.category).map(e=>e.name)),((null==R?void 0:null===(r=R.billOfMaterials)||void 0===r?void 0:r.filter(e=>"common"===e.category))||[]).forEach(e=>{let t=c.find(t=>t.id===e.id||t.code===e.code||t.name===e.name);u.set(e.id,{...e,quantity:0,usedQuantity:e.usedQuantity||0,currentStock:t?t.currentStock||0:e.currentStock||0}),console.log("重新載入BOM表 - 保持通用材料:",e.name,"需求量: 0",e.unit,"庫存:",t?t.currentStock:e.currentStock)});let N=Array.from(u.values());return N.sort((e,t)=>{let s=["fragrance","pg","vg","nicotine","specific","common","other"],a=s.indexOf(e.category||"other"),n=s.indexOf(t.category||"other");return a!==n?a-n:(e.name||"").localeCompare(t.name||"")}),console.log("重新載入BOM表 - 最終物料需求:",N),N},eP=async()=>{if(!ed.trim()&&0===eo.length){d.Am.error("請輸入留言內容或上傳圖片");return}if(R&&i.db)try{let e={id:Date.now().toString(),text:ed.trim(),images:eo,createdAt:new Date().toISOString(),createdBy:"當前用戶"},t=(0,l.doc)(i.db,"workOrders",K),s=[...el,e];await (0,l.r7)(t,{comments:s,updatedAt:l.EK.now()}),ei(s),G(e=>e?{...e,comments:s}:null),ec(""),em([]),d.Am.success("留言已新增")}catch(e){console.error("新增留言失敗:",e),d.Am.error("新增留言失敗")}},eV=async e=>{try{let t=el.find(t=>t.id===e);if(!t)return;if(t.images.length>0){let{getStorage:e,ref:a,deleteObject:n}=await Promise.resolve().then(s.bind(s,96485)),r=e(),l=t.images.map(async e=>{try{let t=a(r,e);await n(t)}catch(e){console.error("刪除圖片失敗:",e)}});await Promise.all(l)}let a=el.filter(t=>t.id!==e);if(ei(a),R&&i.db){let e=(0,l.doc)(i.db,"workOrders",K);await (0,l.r7)(e,{comments:a,updatedAt:l.EK.now()}),G(e=>e?{...e,comments:a}:null)}d.Am.success("留言已刪除")}catch(e){console.error("刪除留言失敗:",e),d.Am.error("刪除留言失敗")}},eH=async()=>{if(!R||!i.db){console.error("缺少必要資料:",{workOrder:!!R,db:!!i.db}),d.Am.error("缺少必要資料，無法刪除工單");return}eg(!0);let e=d.Am.loading("正在刪除工單...");try{console.log("開始刪除工單:",R.id);let t=el.flatMap(e=>e.images);if(console.log("需要刪除的圖片數量:",t.length),t.length>0){let{getStorage:e,ref:a,deleteObject:n}=await Promise.resolve().then(s.bind(s,96485)),r=e(),l=t.map(async(e,s)=>{try{console.log("刪除圖片 ".concat(s+1,"/").concat(t.length,":"),e);let l=a(r,e);await n(l),console.log("圖片 ".concat(s+1," 刪除成功"))}catch(e){console.error("刪除圖片 ".concat(s+1," 失敗:"),e)}});await Promise.all(l),console.log("所有圖片刪除完成")}console.log("刪除工單文檔:",R.id);let{doc:a,deleteDoc:n}=await Promise.resolve().then(s.bind(s,5978)),r=a(i.db,"workOrders",R.id);await n(r),console.log("工單文檔刪除成功"),d.Am.success("工單已刪除",{id:e}),console.log("刪除完成，準備跳轉到工單列表"),q.push("/dashboard/work-orders")}catch(t){console.error("刪除工單失敗:",t),d.Am.error("刪除工單失敗: ".concat(t instanceof Error?t.message:"未知錯誤"),{id:e})}finally{console.log("清理狀態"),eg(!1),eu(!1)}};(0,n.useEffect)(()=>{e_(),eB(),eF()},[e_,eB,eF]);let eL=async()=>{if(R&&i.db){et(!0);try{let e=ez(en.targetQuantity),t=(0,l.doc)(i.db,"workOrders",K);await (0,l.r7)(t,{status:en.status,qcStatus:en.qcStatus,actualQuantity:en.actualQuantity,targetQuantity:en.targetQuantity,notes:en.notes,billOfMaterials:e,updatedAt:l.EK.now()}),G(t=>t?{...t,status:en.status,qcStatus:en.qcStatus,actualQuantity:en.actualQuantity,targetQuantity:en.targetQuantity,notes:en.notes,billOfMaterials:e}:null),X(!1),d.Am.success("工單資料已更新")}catch(e){console.error("更新工單失敗:",e),d.Am.error("更新工單失敗")}finally{et(!1)}}},eU=P.reduce((e,t)=>e+60*t.duration,0),eY=()=>{if(!R)return"";let e=e=>e%1==0?e.toString():parseFloat(e.toFixed(3)).toString(),t=R.billOfMaterials.filter(e=>["fragrance","pg","vg","nicotine"].includes(e.category)),s=R.billOfMaterials.filter(e=>"specific"===e.category),a=R.billOfMaterials.filter(e=>"common"===e.category);return'\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <meta charset="UTF-8">\n        <title>工單列印 - '.concat(R.code,'</title>\n        <style>\n          @media print {\n            @page {\n              size: A4;\n              margin: 1cm;\n            }\n          }\n          \n                     body {\n             font-family: \'Microsoft JhengHei\', Arial, sans-serif;\n             margin: 0;\n             padding: 15px;\n             font-size: 16px;\n             line-height: 1.3;\n             color: #000;\n           }\n          \n          .header {\n            text-align: center;\n            margin-bottom: 20px;\n            border-bottom: 3px solid #000;\n            padding-bottom: 10px;\n          }\n          \n                     .title {\n             font-size: 32px;\n             font-weight: bold;\n             margin-bottom: 8px;\n           }\n           \n           .subtitle {\n             font-size: 24px;\n             font-weight: bold;\n             margin-bottom: 12px;\n           }\n          \n                                .top-info {\n             display: grid;\n             grid-template-columns: 1fr 1fr 1fr 1fr 1fr;\n             gap: 8px;\n             margin-bottom: 15px;\n           }\n           \n           .top-info-item {\n             border: 3px solid #000;\n             padding: 8px;\n             text-align: center;\n             border-radius: 5px;\n             background-color: #f8f8f8;\n           }\n           \n           .top-info-label {\n             font-size: 16px;\n             font-weight: bold;\n             margin-bottom: 6px;\n             color: #333;\n           }\n           \n           .top-info-value {\n             font-size: 20px;\n             font-weight: bold;\n             color: #000;\n           }\n           \n           .main-content {\n             display: grid;\n             grid-template-columns: 2fr 1fr;\n             gap: 15px;\n             margin-bottom: 15px;\n           }\n           \n           .materials-section {\n             margin-bottom: 15px;\n           }\n           \n           .materials-section h3 {\n             font-size: 18px;\n             font-weight: bold;\n             margin: 0 0 8px 0;\n             text-align: center;\n             background-color: #f0f0f0;\n             padding: 6px;\n             border-radius: 3px;\n           }\n           \n           .comments-section {\n             border: 2px solid #000;\n             padding: 10px;\n             border-radius: 5px;\n             height: 100%;\n             display: flex;\n             flex-direction: column;\n           }\n           \n           .comments-section h3 {\n             font-size: 20px;\n             font-weight: bold;\n             margin: 0 0 8px 0;\n             text-align: center;\n             background-color: #f0f0f0;\n             padding: 6px;\n             border-radius: 3px;\n           }\n          \n                     .materials-section {\n             margin-bottom: 15px;\n           }\n           \n           .materials-section h3 {\n             font-size: 18px;\n             font-weight: bold;\n             margin: 0 0 8px 0;\n             text-align: center;\n             background-color: #f0f0f0;\n             padding: 6px;\n             border-radius: 3px;\n           }\n          \n                     table {\n             width: 100%;\n             border-collapse: collapse;\n             margin-bottom: 12px;\n             font-size: 14px;\n           }\n           \n           th, td {\n             border: 1px solid #000;\n             padding: 8px 6px;\n             text-align: center;\n           }\n           \n           th {\n             background-color: #f0f0f0;\n             font-weight: bold;\n             font-size: 15px;\n           }\n          \n                     .time-section {\n             margin-bottom: 15px;\n           }\n           \n           .time-section h3 {\n             font-size: 20px;\n             font-weight: bold;\n             margin: 0 0 8px 0;\n             text-align: center;\n             background-color: #f0f0f0;\n             padding: 6px;\n             border-radius: 3px;\n           }\n           \n           .time-writing-box {\n             border: 2px solid #000;\n             background-color: #f9f9f9;\n             min-height: 200px;\n             margin-top: 8px;\n           }\n          \n                     .total-time {\n             text-align: center;\n             font-size: 16px;\n             font-weight: bold;\n             margin: 8px 0;\n             padding: 12px;\n             background-color: #f0f0f0;\n             border-radius: 5px;\n           }\n          \n                     .footer {\n             margin-top: 20px;\n             display: grid;\n             grid-template-columns: 1fr 1fr;\n             gap: 15px;\n           }\n           \n           .signature-box {\n             border: 1px solid #000;\n             padding: 8px;\n             text-align: center;\n             height: 70px;\n           }\n           \n           .signature-label {\n             font-size: 13px;\n             font-weight: bold;\n             margin-bottom: 4px;\n           }\n          \n                     .signature-line {\n             border-top: 1px solid #000;\n             margin-top: 40px;\n             padding-top: 4px;\n             font-size: 11px;\n           }\n          \n          .page-break {\n            page-break-before: always;\n          }\n          \n          @media print {\n            .no-print {\n              display: none;\n            }\n          }\n        </style>\n      </head>\n      <body>\n        <div class="header">\n          <div class="title">生產工單</div>\n          <div class="subtitle">').concat(R.code,"</div>\n          <div>列印日期：").concat(new Date().toLocaleDateString("zh-TW"),'</div>\n        </div>\n        \n                 <div class="top-info">\n           <div class="top-info-item">\n             <div class="top-info-label">產品系列</div>\n             <div class="top-info-value">').concat(R.productSnapshot.seriesName||"未指定",'</div>\n           </div>\n           <div class="top-info-item">\n             <div class="top-info-label">產品名稱</div>\n             <div class="top-info-value">').concat(R.productSnapshot.name,'</div>\n           </div>\n           <div class="top-info-item">\n             <div class="top-info-label">香精代號</div>\n             <div class="top-info-value">').concat(R.productSnapshot.fragranceCode,'</div>\n           </div>\n           <div class="top-info-item">\n             <div class="top-info-label">尼古丁濃度</div>\n             <div class="top-info-value">').concat(R.productSnapshot.nicotineMg,' mg</div>\n           </div>\n           <div class="top-info-item">\n             <div class="top-info-label">目標產量</div>\n             <div class="top-info-value">').concat(R.targetQuantity,' KG</div>\n           </div>\n         </div>\n        \n                 <div class="main-content">\n           <div class="materials-section">\n             <h3>核心配方物料清單</h3>\n             <table>\n               <thead>\n                 <tr>\n                   <th>物料名稱</th>\n                   <th>料件代號</th>\n                   <th>比例</th>\n                   <th>需求數量</th>\n                   <th>使用數量</th>\n                   <th>單位</th>\n                 </tr>\n               </thead>\n               <tbody>\n                 ').concat(t.map(t=>'\n                   <tr>\n                                        <td style="font-weight: bold; font-size: 15px;">'.concat(t.name,'</td>\n                   <td style="font-weight: bold; font-size: 15px;">').concat(t.code,'</td>\n                   <td style="font-size: 15px;">').concat(t.ratio?t.ratio+"%":"-",'</td>\n                   <td style="font-weight: bold; font-size: 15px;">').concat(e(t.quantity),'</td>\n                   <td style="border: 2px solid #000; background-color: #f9f9f9; min-width: 60px; height: 30px;"></td>\n                   <td style="font-size: 15px;">').concat(t.unit,"</td>\n                   </tr>\n                 ")).join(""),"\n               </tbody>\n             </table>\n             \n             ").concat(s.length>0?"\n             <h3>產品專屬物料</h3>\n             <table>\n               <thead>\n                 <tr>\n                   <th>物料名稱</th>\n                   <th>料件代號</th>\n                   <th>使用數量</th>\n                   <th>單位</th>\n                 </tr>\n               </thead>\n               <tbody>\n                 ".concat(s.map(e=>'\n                   <tr>\n                     <td style="font-weight: bold; font-size: 15px;">'.concat(e.name,'</td>\n                     <td style="font-weight: bold; font-size: 15px;">').concat(e.code,'</td>\n                     <td style="border: 2px solid #000; background-color: #f9f9f9; min-width: 60px; height: 30px;"></td>\n                     <td style="font-size: 15px;">').concat(e.unit,"</td>\n                   </tr>\n                 ")).join(""),"\n               </tbody>\n             </table>\n             "):"","\n             \n             ").concat(a.length>0?"\n             <h3>系列通用物料</h3>\n             <table>\n               <thead>\n                 <tr>\n                   <th>物料名稱</th>\n                   <th>料件代號</th>\n                   <th>使用數量</th>\n                   <th>單位</th>\n                 </tr>\n               </thead>\n               <tbody>\n                 ".concat(a.map(e=>'\n                   <tr>\n                     <td style="font-weight: bold; font-size: 15px;">'.concat(e.name,'</td>\n                     <td style="font-weight: bold; font-size: 15px;">').concat(e.code,'</td>\n                     <td style="border: 2px solid #000; background-color: #f9f9f9; min-width: 60px; height: 30px;"></td>\n                     <td style="font-size: 15px;">').concat(e.unit,"</td>\n                   </tr>\n                 ")).join(""),"\n               </tbody>\n             </table>\n             "):"",'\n           </div>\n           \n           <div class="comments-section">\n             <h3>留言板</h3>\n             <div style="flex: 1; border: 1px solid #ccc; background-color: #f9f9f9; padding: 8px; min-height: 400px;">\n               <!-- 留言內容會在這裡顯示 -->\n             </div>\n           </div>\n         </div>\n        \n                 <div class="time-section">\n           <h3>工時申報表</h3>\n           ').concat(P&&P.length>0?"\n             <table>\n               <thead>\n                 <tr>\n                   <th>人員</th>\n                   <th>工作日期</th>\n                   <th>開始時間</th>\n                   <th>結束時間</th>\n                   <th>工時小計</th>\n                 </tr>\n               </thead>\n               <tbody>\n                 ".concat(P.map(e=>"\n                   <tr>\n                     <td>".concat(e.personnelName,"</td>\n                     <td>").concat(e.startDate,"</td>\n                     <td>").concat(e.startTime,"</td>\n                     <td>").concat(e.endTime,"</td>\n                     <td>").concat(Math.floor(e.duration),"小時").concat(Math.round(e.duration%1*60),"分鐘</td>\n                   </tr>\n                 ")).join(""),'\n               </tbody>\n             </table>\n             <div class="total-time">\n               總人工小時：').concat(Math.floor(eU/60)," 小時 ").concat(Math.floor(eU%60)," 分鐘 (共 ").concat(P.length," 筆紀錄)\n             </div>\n           "):'\n             <div style="text-align: center; padding: 15px; color: #666; font-size: 16px;">\n               尚無工時紀錄\n             </div>\n           ','\n           <div class="time-writing-box">\n             <!-- 工時申報書寫區域 -->\n           </div>\n         </div>\n        \n        <div class="footer">\n          <div class="signature-box">\n            <div class="signature-label">生產主管簽名</div>\n            <div class="signature-line"></div>\n          </div>\n          \n          <div class="signature-box">\n            <div class="signature-label">倉庫管理簽名</div>\n            <div class="signature-line"></div>\n          </div>\n        </div>\n        \n                 ').concat(R.notes?'\n         <div style="margin-top: 15px; border: 1px solid #000; padding: 8px;">\n           <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: bold;">備註</h3>\n           <div style="font-size: 13px; white-space: pre-wrap;">'.concat(R.notes,"</div>\n         </div>\n         "):"","\n      </body>\n      </html>\n         ")};return U?(0,a.jsx)("div",{className:"container mx-auto py-10",children:(0,a.jsx)("div",{className:"flex justify-center items-center py-20",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)(x.Z,{className:"w-8 h-8 animate-spin mx-auto mb-4 text-blue-600"}),(0,a.jsx)("p",{className:"text-gray-600",children:"載入工單資料中..."})]})})}):R?(0,a.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50",children:(0,a.jsxs)("div",{className:"container mx-auto p-2 sm:p-4 py-4 sm:py-10",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4 sm:mb-8",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 sm:gap-4",children:[(0,a.jsx)(A.z,{variant:"outline",size:"icon",onClick:()=>q.back(),className:"hover:bg-white/80 backdrop-blur-sm",children:(0,a.jsx)(u.Z,{className:"h-4 w-4"})}),(0,a.jsxs)("div",{className:"flex-grow min-w-0",children:[(0,a.jsx)("h1",{className:"text-xl sm:text-3xl font-bold bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 bg-clip-text text-transparent truncate",children:"工單詳情"}),(0,a.jsx)("p",{className:"text-gray-600 font-mono text-sm sm:text-base truncate",children:R.code})]})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)(A.z,{variant:"outline",onClick:()=>{let e=window.open("","_blank");if(!e){d.Am.error("無法開啟列印視窗，請檢查彈出視窗設定");return}let t=eY();e.document.write(t),e.document.close(),e.focus(),setTimeout(()=>{e.print(),e.close()},500)},className:"bg-blue-600 hover:bg-blue-700 text-white border-blue-600",children:[(0,a.jsx)(g,{className:"mr-2 h-4 w-4"}),"列印工單"]}),!!R&&("預報"===R.status||"進行"===R.status||"完工"===R.status)&&(0,a.jsxs)(A.z,{variant:"outline",onClick:R?"預報"===R.status||"進行"===R.status?()=>{ew(!0)}:"完工"===R.status?()=>{eC(!0)}:()=>{}:()=>{},className:"bg-green-600 hover:bg-green-700 text-white border-green-600",children:[(0,a.jsx)(p.Z,{className:"mr-2 h-4 w-4"}),(()=>{if(!R)return"完工";if("預報"===R.status||"進行"===R.status);else if("完工"===R.status)return"入庫";return"完工"})()]}),(0,a.jsxs)(A.z,{variant:"destructive",onClick:()=>eu(!0),className:"bg-red-500 hover:bg-red-600 flex-shrink-0",children:[(0,a.jsx)(f.Z,{className:"mr-2 h-4 w-4"}),"刪除工單"]})]})]}),(0,a.jsxs)(Z.Zb,{className:"mb-4 sm:mb-6 shadow-lg border-0 bg-white",children:[(0,a.jsx)(Z.Ol,{className:"pb-3 sm:pb-6 bg-gradient-to-r from-blue-200 to-blue-300 text-blue-800 rounded-t-xl",children:(0,a.jsxs)(Z.ll,{className:"flex items-center gap-2 text-lg sm:text-xl",children:[(0,a.jsx)(b.Z,{className:"h-5 w-5"}),"工單基本資料"]})}),(0,a.jsx)(Z.aY,{children:(0,a.jsxs)("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6",children:[(0,a.jsxs)("div",{className:"text-center p-3 sm:p-4 bg-white rounded-lg border",children:[(0,a.jsx)("div",{className:"text-xs sm:text-sm text-gray-600 mb-1",children:"生產產品名稱"}),(0,a.jsx)("div",{className:"font-semibold text-blue-800 text-sm sm:text-base truncate",children:R.productSnapshot.name}),(0,a.jsx)("div",{className:"text-xs text-gray-500 truncate",children:R.productSnapshot.seriesName||"未指定"})]}),(0,a.jsxs)("div",{className:"text-center p-3 sm:p-4 bg-white rounded-lg border",children:[(0,a.jsx)("div",{className:"text-xs sm:text-sm text-gray-600 mb-1",children:"使用香精"}),(0,a.jsx)("div",{className:"font-semibold text-pink-800 text-sm sm:text-base truncate",children:R.productSnapshot.fragranceCode}),(0,a.jsx)("div",{className:"text-xs text-gray-500 truncate",children:R.productSnapshot.fragranceName})]}),(0,a.jsxs)("div",{className:"text-center p-3 sm:p-4 bg-white rounded-lg border",children:[(0,a.jsx)("div",{className:"text-xs sm:text-sm text-gray-600 mb-1",children:"尼古丁濃度"}),(0,a.jsxs)("div",{className:"font-semibold text-orange-800 text-sm sm:text-base",children:[R.productSnapshot.nicotineMg," mg"]})]}),(0,a.jsxs)("div",{className:"text-center p-3 sm:p-4 bg-white rounded-lg border",children:[(0,a.jsx)("div",{className:"text-xs sm:text-sm text-gray-600 mb-1",children:"工單狀態"}),(0,a.jsx)(z.C,{className:"".concat(null===(e=W.find(e=>e.value===R.status))||void 0===e?void 0:e.color," text-base sm:text-lg font-bold px-3 py-1"),children:R.status})]})]})})]}),(0,a.jsxs)(Z.Zb,{className:"mb-4 sm:mb-6 shadow-lg border-0 bg-white",children:[(0,a.jsx)(Z.Ol,{className:"pb-3 sm:pb-6 bg-gradient-to-r from-green-200 to-green-300 text-green-800 rounded-t-xl",children:(0,a.jsxs)(Z.ll,{className:"flex items-center gap-2 text-lg sm:text-xl",children:[(0,a.jsx)(j.Z,{className:"h-5 w-5"}),"工單詳細資料",(null==R?void 0:R.status)==="入庫"&&(0,a.jsx)(z.C,{variant:"secondary",className:"ml-2 bg-purple-100 text-purple-800 border-purple-200",children:"已入庫 - 僅可查看"}),(null==R?void 0:R.status)==="完工"&&(0,a.jsx)(z.C,{variant:"secondary",className:"ml-2 bg-green-100 text-green-800 border-green-200",children:"已完工 - 僅可編輯工時"})]})}),(0,a.jsxs)(Z.aY,{children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(F._,{className:"text-sm text-gray-600",children:"目前工單狀態"}),J?(0,a.jsxs)(E.Ph,{value:en.status,onValueChange:e=>{(null==R?void 0:R.status)==="預報"&&"進行"===e?er(t=>({...t,status:e})):(null==R?void 0:R.status)==="進行"&&"預報"===e?er(t=>({...t,status:e})):d.Am.error("工單狀態只能在預報和進行之間切換")},children:[(0,a.jsx)(E.i4,{className:"mt-1",children:(0,a.jsx)(E.ki,{})}),(0,a.jsx)(E.Bw,{children:W.filter(e=>"預報"===e.value||"進行"===e.value).map(e=>(0,a.jsx)(E.Ql,{value:e.value,children:e.label},e.value))})]}):(0,a.jsx)("div",{className:"mt-1",children:(0,a.jsx)(z.C,{className:"".concat(null===(t=W.find(e=>e.value===R.status))||void 0===t?void 0:t.color," text-base sm:text-lg font-bold px-3 py-1"),children:R.status})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(F._,{className:"text-sm text-gray-600",children:"生產產品名稱"}),(0,a.jsx)("div",{className:"mt-1 font-medium text-gray-900",children:R.productSnapshot.name})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(F._,{className:"text-sm text-gray-600",children:"產品系列"}),(0,a.jsx)("div",{className:"mt-1 font-medium text-gray-900",children:R.productSnapshot.seriesName||"未指定"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(F._,{className:"text-sm text-gray-600",children:"目標產量 (KG)"}),J?(0,a.jsx)(I.I,{type:"number",min:"0.1",step:"0.1",value:en.targetQuantity,onChange:e=>eQ(parseFloat(e.target.value)||0),className:"mt-1"}):(0,a.jsxs)("div",{className:"mt-1 font-medium text-gray-900",children:[R.targetQuantity," KG"]})]})]}),(0,a.jsx)("div",{className:"mt-4 flex flex-col sm:flex-row justify-end gap-2",children:J?(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row gap-2",children:[(0,a.jsx)(A.z,{variant:"outline",onClick:()=>X(!1),disabled:ee,className:"w-full sm:w-auto",children:"取消"}),(0,a.jsx)(A.z,{onClick:eL,disabled:ee,className:"bg-green-600 hover:bg-green-700 w-full sm:w-auto",children:ee?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(x.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"儲存中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(v.Z,{className:"mr-2 h-4 w-4"}),"儲存"]})})]}):(0,a.jsxs)(A.z,{onClick:()=>{R&&(er({status:R.status,qcStatus:R.qcStatus,actualQuantity:R.actualQuantity,targetQuantity:R.targetQuantity,notes:R.notes||""}),X(!0))},disabled:!(R&&("預報"===R.status||"進行"===R.status)),className:"bg-green-600 hover:bg-green-700 w-full sm:w-auto",title:R&&("預報"===R.status||"進行"===R.status)?"點擊編輯工單詳細資料":"完工或入庫狀態無法編輯",children:[(0,a.jsx)(N.Z,{className:"mr-2 h-4 w-4"}),"編輯"]})})]})]}),(0,a.jsxs)(Z.Zb,{className:"mb-4 sm:mb-6 shadow-lg border-0 bg-white",children:[(0,a.jsx)(Z.Ol,{className:"pb-3 sm:pb-6 bg-gradient-to-r from-purple-200 to-purple-300 text-purple-800 rounded-t-xl",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)(Z.ll,{className:"flex items-center gap-2 text-lg sm:text-xl",children:[(0,a.jsx)(y.Z,{className:"h-5 w-5"}),"香精物料清單 (BOM表)",(null==R?void 0:R.status)==="入庫"&&(0,a.jsx)(z.C,{variant:"secondary",className:"ml-2 bg-purple-100 text-purple-800 border-purple-200",children:"已入庫 - 僅可查看"}),(null==R?void 0:R.status)==="完工"&&(0,a.jsx)(z.C,{variant:"secondary",className:"ml-2 bg-green-100 text-green-800 border-green-200",children:"已完工 - 僅可編輯工時"})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)(A.z,{variant:"outline",size:"sm",onClick:eR,disabled:ep,className:"text-purple-700 border-purple-300 hover:bg-purple-50",children:[ep?(0,a.jsx)(x.Z,{className:"h-4 w-4 animate-spin"}):(0,a.jsx)(w.Z,{className:"h-4 w-4"}),"重新載入"]}),eb?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(A.z,{variant:"outline",size:"sm",onClick:()=>{eN({}),ej(!1)},className:"text-red-700 border-red-300 hover:bg-red-50",children:[(0,a.jsx)(k.Z,{className:"h-4 w-4 mr-1"}),"取消"]}),(0,a.jsxs)(A.z,{variant:"outline",size:"sm",onClick:eZ,className:"text-purple-700 border-purple-300 hover:bg-purple-50",children:[(0,a.jsx)(v.Z,{className:"h-4 w-4 mr-1"}),"保存數量"]})]}):(0,a.jsxs)(A.z,{variant:"outline",size:"sm",onClick:()=>ej(!0),disabled:!(R&&("預報"===R.status||"進行"===R.status)),className:"text-purple-700 border-purple-300 hover:bg-purple-50",title:R&&("預報"===R.status||"進行"===R.status)?"點擊編輯物料使用數量":"完工或入庫狀態無法編輯數量",children:[(0,a.jsx)(N.Z,{className:"h-4 w-4 mr-1"}),"編輯數量"]})]})]})}),(0,a.jsx)(Z.aY,{children:(0,a.jsxs)("div",{className:"space-y-4 sm:space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h3",{className:"text-lg font-semibold text-purple-700 mb-3 flex items-center gap-2",children:[(0,a.jsx)(y.Z,{className:"h-4 w-4"}),"核心配方物料"]}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)(Q.iA,{children:[(0,a.jsx)(Q.xD,{children:(0,a.jsxs)(Q.SC,{className:"bg-gradient-to-r from-gray-50 to-gray-100",children:[(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold text-xs sm:text-sm",children:"物料名稱"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold text-xs sm:text-sm",children:"料件代號"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold text-xs sm:text-sm",children:"比例"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold text-xs sm:text-sm",children:"需求數量"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold text-xs sm:text-sm",children:"使用數量"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold text-xs sm:text-sm",children:"單位"})]})}),(0,a.jsx)(Q.RM,{children:R.billOfMaterials.filter(e=>["fragrance","pg","vg","nicotine"].includes(e.category)).map((e,t)=>(0,a.jsxs)(Q.SC,{className:"hover:bg-gray-50/50 transition-all duration-200",children:[(0,a.jsx)(Q.pj,{className:"font-medium",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:["fragrance"===e.category&&(0,a.jsx)(y.Z,{className:"h-4 w-4 text-purple-600"}),"pg"===e.category&&(0,a.jsx)("div",{className:"w-4 h-4 bg-blue-500 rounded"}),"vg"===e.category&&(0,a.jsx)("div",{className:"w-4 h-4 bg-green-500 rounded"}),"nicotine"===e.category&&(0,a.jsx)("div",{className:"w-4 h-4 bg-orange-500 rounded"}),(0,a.jsx)("span",{className:"text-xs sm:text-sm truncate",children:e.name})]})}),(0,a.jsx)(Q.pj,{className:"font-mono text-xs sm:text-sm",children:e.code}),(0,a.jsx)(Q.pj,{children:e.ratio?"".concat(e.ratio,"%"):"-"}),(0,a.jsx)(Q.pj,{className:"font-medium",children:eO(e.quantity)}),(0,a.jsx)(Q.pj,{children:eb?(0,a.jsx)(I.I,{type:"number",min:"0",step:"0.001",value:void 0!==ev[e.id]?ev[e.id]:e.usedQuantity||0,onChange:t=>{eA(e.id,t.target.value)},className:"w-20"}):(0,a.jsx)("span",{className:"font-medium",children:eO(e.usedQuantity||0)})}),(0,a.jsx)(Q.pj,{children:e.unit})]},t))})]})})]}),R.billOfMaterials.filter(e=>"specific"===e.category).length>0&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("h3",{className:"text-lg font-semibold text-blue-700 mb-3 flex items-center gap-2",children:[(0,a.jsx)(b.Z,{className:"h-4 w-4"}),"產品專屬物料"]}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)(Q.iA,{children:[(0,a.jsx)(Q.xD,{children:(0,a.jsxs)(Q.SC,{className:"bg-gradient-to-r from-gray-50 to-gray-100",children:[(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold",children:"物料名稱"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold",children:"料件代號"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold",children:"使用數量"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold",children:"單位"})]})}),(0,a.jsx)(Q.RM,{children:R.billOfMaterials.filter(e=>"specific"===e.category).sort((e,t)=>e.name.localeCompare(t.name)).map((e,t)=>(0,a.jsxs)(Q.SC,{className:"hover:bg-gray-50/50 transition-all duration-200",children:[(0,a.jsx)(Q.pj,{className:"font-medium",children:e.name}),(0,a.jsx)(Q.pj,{className:"font-mono text-sm",children:e.code}),(0,a.jsx)(Q.pj,{children:eb?(0,a.jsx)(I.I,{type:"number",min:"0",step:"1",value:void 0!==ev[e.id]?ev[e.id]:e.usedQuantity||0,onChange:t=>{eA(e.id,t.target.value)},className:"w-20"}):(0,a.jsx)("span",{className:"font-medium",children:eO(e.usedQuantity||0)})}),(0,a.jsx)(Q.pj,{children:e.unit})]},t))})]})})]}),R.billOfMaterials.filter(e=>"common"===e.category).length>0&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("h3",{className:"text-lg font-semibold text-green-700 mb-3 flex items-center gap-2",children:[(0,a.jsx)(b.Z,{className:"h-4 w-4"}),"系列通用物料"]}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)(Q.iA,{children:[(0,a.jsx)(Q.xD,{children:(0,a.jsxs)(Q.SC,{className:"bg-gradient-to-r from-green-600 to-emerald-700",children:[(0,a.jsx)(Q.ss,{className:"text-white font-bold",children:"物料名稱"}),(0,a.jsx)(Q.ss,{className:"text-white font-bold",children:"料件代號"}),(0,a.jsx)(Q.ss,{className:"text-white font-bold",children:"使用數量"}),(0,a.jsx)(Q.ss,{className:"text-white font-bold",children:"單位"})]})}),(0,a.jsx)(Q.RM,{children:R.billOfMaterials.filter(e=>"common"===e.category).sort((e,t)=>e.name.localeCompare(t.name)).map((e,t)=>(0,a.jsxs)(Q.SC,{className:"bg-gradient-to-r from-green-50 to-emerald-50",children:[(0,a.jsx)(Q.pj,{className:"font-medium",children:e.name}),(0,a.jsx)(Q.pj,{className:"font-mono text-sm",children:e.code}),(0,a.jsx)(Q.pj,{children:eb?(0,a.jsx)(I.I,{type:"number",min:"0",step:"1",value:void 0!==ev[e.id]?ev[e.id]:e.usedQuantity||0,onChange:t=>{eA(e.id,t.target.value)},className:"w-20"}):(0,a.jsx)("span",{className:"font-medium",children:eO(e.usedQuantity||0)})}),(0,a.jsx)(Q.pj,{children:e.unit})]},t))})]})})]})]})})]}),(0,a.jsxs)(Z.Zb,{className:"mb-4 sm:mb-6 bg-gradient-to-r from-orange-50 to-amber-50 border-orange-200",children:[(0,a.jsx)(Z.Ol,{className:"pb-3 sm:pb-6",children:(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[(0,a.jsxs)(Z.ll,{className:"text-orange-800 flex items-center gap-2 text-lg sm:text-xl",children:[(0,a.jsx)(M.Z,{className:"h-5 w-5"}),"工時申報",(null==R?void 0:R.status)==="入庫"&&(0,a.jsx)(z.C,{variant:"secondary",className:"ml-2 bg-purple-100 text-purple-800 border-purple-200",children:"已入庫 - 無法新增"}),(null==R?void 0:R.status)==="完工"&&(0,a.jsx)(z.C,{variant:"secondary",className:"ml-2 bg-green-100 text-green-800 border-green-200",children:"已完工 - 仍可新增"})]}),(0,a.jsxs)(A.z,{onClick:()=>ea(!0),className:"bg-orange-600 hover:bg-orange-700 w-full sm:w-auto",children:[(0,a.jsx)(M.Z,{className:"mr-2 h-4 w-4"}),"工時管理"]})]})}),(0,a.jsxs)(Z.aY,{children:[(0,a.jsx)("div",{className:"mb-4 sm:mb-6 p-3 sm:p-4 bg-white rounded-lg border",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-sm text-gray-600 mb-1",children:"總人工小時"}),(0,a.jsxs)("div",{className:"text-xl sm:text-2xl font-bold text-orange-600",children:[Math.floor(eU/60)," 小時 ",Math.floor(eU%60)," 分鐘"]}),(0,a.jsxs)("div",{className:"text-xs text-gray-500",children:["共 ",P.length," 筆紀錄"]})]})}),P&&P.length>0?(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)(Q.iA,{children:[(0,a.jsx)(Q.xD,{children:(0,a.jsxs)(Q.SC,{className:"bg-gradient-to-r from-orange-600 to-amber-700",children:[(0,a.jsx)(Q.ss,{className:"text-white font-bold text-xs sm:text-sm",children:"人員"}),(0,a.jsx)(Q.ss,{className:"text-white font-bold text-xs sm:text-sm",children:"工作日期"}),(0,a.jsx)(Q.ss,{className:"text-white font-bold text-xs sm:text-sm",children:"開始時間"}),(0,a.jsx)(Q.ss,{className:"text-white font-bold text-xs sm:text-sm",children:"結束時間"}),(0,a.jsx)(Q.ss,{className:"text-white font-bold text-xs sm:text-sm",children:"工時小計"})]})}),(0,a.jsx)(Q.RM,{children:P.map((e,t)=>(0,a.jsxs)(Q.SC,{children:[(0,a.jsx)(Q.pj,{className:"font-medium",children:e.personnelName}),(0,a.jsx)(Q.pj,{children:e.startDate}),(0,a.jsx)(Q.pj,{children:e.startTime}),(0,a.jsx)(Q.pj,{children:e.endTime}),(0,a.jsxs)(Q.pj,{className:"font-medium",children:[Math.floor(e.duration)," 小時 ",Math.round(e.duration%1*60)," 分鐘"]})]},t))})]})}):(0,a.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,a.jsx)(M.Z,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),(0,a.jsx)("p",{children:"尚無工時紀錄"}),(0,a.jsx)("p",{className:"text-sm",children:"點擊上方按鈕新增工時紀錄"})]})]})]}),(0,a.jsx)(Y,{isOpen:es,onOpenChange:e=>{ea(e),e||eF()},workOrderId:K,workOrderNumber:null==R?void 0:R.code,isLocked:(null==R?void 0:R.status)==="入庫"}),(0,a.jsxs)(Z.Zb,{className:"mb-6 bg-gradient-to-r from-yellow-50 to-orange-50 border-yellow-200",children:[(0,a.jsx)(Z.Ol,{children:(0,a.jsxs)(Z.ll,{className:"text-orange-800 flex items-center gap-2",children:[(0,a.jsx)(S.Z,{className:"h-5 w-5"}),"留言記錄",(0,a.jsxs)(z.C,{variant:"secondary",className:"ml-2",children:[el.length," 則留言"]}),(null==R?void 0:R.status)==="入庫"&&(0,a.jsx)(z.C,{variant:"secondary",className:"ml-2 bg-purple-100 text-purple-800 border-purple-200",children:"僅可留言"})]})}),(0,a.jsxs)(Z.aY,{children:[(0,a.jsxs)("div",{className:"mb-6 p-4 bg-white rounded-lg border border-yellow-200",children:[(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)(F._,{htmlFor:"comment",className:"text-sm font-medium text-gray-700",children:"新增留言"}),(0,a.jsx)(_.g,{id:"comment",value:ed,onChange:e=>ec(e.target.value),placeholder:"輸入留言內容...",className:"mt-1 min-h-[100px] resize-none"})]}),(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)(F._,{className:"text-sm font-medium text-gray-700 mb-2 block",children:"上傳圖片"}),(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2",children:[(0,a.jsxs)(A.z,{variant:"outline",onClick:()=>{var e;return null===(e=document.getElementById("image-upload"))||void 0===e?void 0:e.click()},className:"border-yellow-300 text-yellow-700 hover:bg-yellow-50 w-full sm:w-auto",children:[(0,a.jsx)(C.Z,{className:"mr-2 h-4 w-4"}),"選擇圖片"]}),(0,a.jsx)("input",{id:"image-upload",type:"file",multiple:!0,accept:"image/*",onChange:eq,className:"hidden"}),(0,a.jsx)("span",{className:"text-sm text-gray-500 text-center sm:text-left",children:"可選擇多張圖片 (每張最大 2MB)"})]}),eo.length>0&&(0,a.jsxs)("div",{className:"mt-3",children:[(0,a.jsxs)(F._,{className:"text-sm font-medium text-gray-700 mb-2 block",children:["已選擇的圖片 (",eo.length," 張)"]}),(0,a.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:eo.map((e,t)=>(0,a.jsxs)("div",{className:"relative group",children:[(0,a.jsx)("img",{src:e,alt:"圖片 ".concat(t+1),className:"w-full h-20 sm:h-24 object-cover rounded-lg border cursor-pointer",onClick:()=>{let t=document.createElement("div");t.className="fixed inset-0 z-50 flex items-center justify-center bg-black/80",t.onclick=()=>t.remove();let s=document.createElement("img");s.src=e,s.className="max-w-[90vw] max-h-[90vh] object-contain rounded-lg",s.onclick=e=>e.stopPropagation(),t.appendChild(s),document.body.appendChild(t)}}),(0,a.jsx)(A.z,{variant:"destructive",size:"sm",onClick:()=>eK(t),className:"absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity h-6 w-6 p-0",children:(0,a.jsx)(k.Z,{className:"h-3 w-3"})})]},t))})]})]}),(0,a.jsxs)(A.z,{onClick:eP,disabled:!ed.trim()&&0===eo.length,className:"bg-orange-600 hover:bg-orange-700 w-full sm:w-auto",children:[(0,a.jsx)(S.Z,{className:"mr-2 h-4 w-4"}),"新增留言"]})]}),(0,a.jsx)("div",{className:"space-y-4",children:0===el.length?(0,a.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,a.jsx)(S.Z,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,a.jsx)("p",{children:"尚無留言記錄"})]}):el.map(e=>(0,a.jsxs)("div",{className:"bg-white rounded-lg border border-yellow-200 p-3 sm:p-4",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 min-w-0 flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(D.Z,{className:"h-4 w-4 text-gray-500 flex-shrink-0"}),(0,a.jsx)("span",{className:"font-medium text-gray-700 truncate",children:e.createdBy})]}),(0,a.jsx)("span",{className:"text-sm text-gray-500",children:new Date(e.createdAt).toLocaleString()})]}),(0,a.jsx)(A.z,{variant:"ghost",size:"sm",onClick:()=>eV(e.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50 flex-shrink-0 ml-2",children:(0,a.jsx)(f.Z,{className:"h-4 w-4"})})]}),e.text&&(0,a.jsx)("div",{className:"mb-3 text-gray-700 whitespace-pre-wrap break-words",children:e.text}),e.images.length>0&&(0,a.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2",children:e.images.map((e,t)=>(0,a.jsx)("div",{className:"relative group",children:(0,a.jsx)("img",{src:e,alt:"留言圖片 ".concat(t+1),className:"w-full h-20 sm:h-24 object-cover rounded-lg border cursor-pointer",onClick:()=>{let t=document.createElement("div");t.className="fixed inset-0 z-50 flex items-center justify-center bg-black/80",t.onclick=()=>t.remove();let s=document.createElement("img");s.src=e,s.className="max-w-[90vw] max-h-[90vh] object-contain rounded-lg",s.onclick=e=>e.stopPropagation(),t.appendChild(s),document.body.appendChild(t)}})},t))})]},e.id))})]})]}),(0,a.jsx)(B.Vq,{open:ey,onOpenChange:ew,children:(0,a.jsxs)(B.cZ,{className:"w-[95vw] max-w-4xl sm:max-w-5xl max-h-[90vh] overflow-y-auto",children:[(0,a.jsxs)(B.fK,{children:[(0,a.jsx)(B.$N,{className:"text-green-600 text-lg sm:text-xl",children:"確認完工"}),(0,a.jsx)(B.Be,{children:"請確認以下資訊後點擊完工按鈕。完工後將無法再修改目標產量和使用數量，但仍可新增工時記錄。系統會顯示庫存扣除後的剩餘數量，並實際扣除相應的庫存。"}),(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsxs)(A.z,{variant:"outline",size:"sm",onClick:e_,className:"text-blue-600 border-blue-300 hover:bg-blue-50",children:[(0,a.jsx)(w.Z,{className:"h-4 w-4 mr-1"}),"重新載入庫存"]})})]}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-800 mb-3",children:"已填寫使用數量的物料"}),(0,a.jsxs)("p",{className:"text-sm text-gray-600 mb-3",children:["顯示物料的現有庫存、使用數量和扣除後的剩餘數量。",(0,a.jsx)("span",{className:"text-blue-600",children:"藍色"}),"為現有數量，",(0,a.jsx)("span",{className:"text-red-600",children:"紅色"}),"為使用數量，",(0,a.jsx)("span",{className:"text-green-600",children:"綠色"}),"為剩餘數量，",(0,a.jsx)("span",{className:"text-red-600",children:"紅色"}),"表示庫存不足。",U&&(0,a.jsxs)("span",{className:"ml-2 text-blue-600",children:[(0,a.jsx)(x.Z,{className:"h-3 w-3 inline animate-spin mr-1"}),"載入庫存中..."]})]}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)(Q.iA,{children:[(0,a.jsx)(Q.xD,{children:(0,a.jsxs)(Q.SC,{className:"bg-gray-50",children:[(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold",children:"物料名稱"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold",children:"料件代號"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold",children:"現有數量"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold",children:"使用數量"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold",children:"扣完剩餘"})]})}),(0,a.jsx)(Q.RM,{children:null==R?void 0:R.billOfMaterials.filter(e=>(e.usedQuantity||0)>0).map((e,t)=>{let s=e.currentStock||0,n=e.usedQuantity||0,r=s-n;return(0,a.jsxs)(Q.SC,{children:[(0,a.jsx)(Q.pj,{className:"font-medium",children:e.name}),(0,a.jsx)(Q.pj,{className:"font-mono",children:e.code}),(0,a.jsxs)(Q.pj,{className:"font-medium text-blue-600",children:[eO(s)," ",e.unit]}),(0,a.jsxs)(Q.pj,{className:"font-medium text-red-600",children:["-",eO(n)," ",e.unit]}),(0,a.jsxs)(Q.pj,{className:"font-medium ".concat(r<0?"text-red-600":"text-green-600"),children:[eO(r)," ",e.unit,r<0&&(0,a.jsx)("span",{className:"ml-1 text-xs bg-red-100 text-red-800 px-1 py-0.5 rounded",children:"庫存不足"})]})]},t)})})]})}),(0,a.jsxs)("div",{className:"mt-3 flex flex-wrap gap-4 text-xs text-gray-600",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)("div",{className:"w-3 h-3 bg-blue-100 border border-blue-300 rounded"}),(0,a.jsx)("span",{children:"現有數量"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)("div",{className:"w-3 h-3 bg-red-100 border border-red-300 rounded"}),(0,a.jsx)("span",{children:"使用數量"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)("div",{className:"w-3 h-3 bg-green-100 border border-green-300 rounded"}),(0,a.jsx)("span",{children:"剩餘數量"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)("div",{className:"w-3 h-3 bg-red-100 border border-red-300 rounded"}),(0,a.jsx)("span",{children:"庫存不足"})]})]}),(null==R?void 0:R.billOfMaterials.some(e=>0===(e.currentStock||0)&&(e.usedQuantity||0)>0))&&(0,a.jsx)("div",{className:"mt-3 p-2 bg-yellow-50 rounded-lg border border-yellow-200",children:(0,a.jsxs)("div",{className:"text-xs text-yellow-700",children:[(0,a.jsx)(T.Z,{className:"h-3 w-3 inline mr-1"}),"部分物料的庫存資訊可能未正確載入，請點擊「重新載入庫存」按鈕更新"]})}),(null==R?void 0:R.billOfMaterials.filter(e=>{let t=e.currentStock||0,s=e.usedQuantity||0;return t-s>=0&&s>0}).length)>0&&(0,a.jsx)("div",{className:"mt-3 p-3 bg-green-50 rounded-lg border border-green-200",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-sm text-green-700 font-medium",children:"庫存充足項目"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-green-600",children:[(null==R?void 0:R.billOfMaterials.filter(e=>{let t=e.currentStock||0,s=e.usedQuantity||0;return t-s>=0&&s>0}).length)||0," 項"]})]})}),(null==R?void 0:R.billOfMaterials.every(e=>(e.currentStock||0)>0||0===(e.usedQuantity||0)))&&(0,a.jsx)("div",{className:"mt-3 p-2 bg-blue-50 rounded-lg border border-blue-200",children:(0,a.jsxs)("div",{className:"text-xs text-blue-700",children:[(0,a.jsx)(p.Z,{className:"h-3 w-3 inline mr-1"}),"庫存資訊已正確載入"]})}),(0,a.jsx)("div",{className:"mt-3 p-3 bg-orange-50 rounded-lg border border-orange-200",children:(0,a.jsxs)("div",{className:"flex items-start gap-2",children:[(0,a.jsx)(O.Z,{className:"h-4 w-4 text-orange-600 mt-0.5 flex-shrink-0"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-orange-800 mb-1",children:"庫存扣除提醒"}),(0,a.jsx)("p",{className:"text-xs text-orange-700",children:"確認完工後，系統將實際扣除上述物料的使用數量，此操作無法復原。"})]})]})}),(null==R?void 0:R.billOfMaterials.filter(e=>(e.usedQuantity||0)>0).length)===0&&(0,a.jsxs)("div",{className:"text-center py-4 text-red-500 bg-red-50 rounded-lg border border-red-200",children:[(0,a.jsx)(T.Z,{className:"h-6 w-6 mx-auto mb-2"}),(0,a.jsx)("p",{className:"font-medium",children:"警告：尚無填寫使用數量的物料"}),(0,a.jsx)("p",{className:"text-sm",children:"請先填寫至少一個物料的使用數量才能完工"})]}),(null==R?void 0:R.billOfMaterials.some(e=>(e.currentStock||0)-(e.usedQuantity||0)<0))&&(0,a.jsxs)("div",{className:"text-center py-4 text-orange-500 bg-orange-50 rounded-lg border border-orange-200",children:[(0,a.jsx)(T.Z,{className:"h-6 w-6 mx-auto mb-2"}),(0,a.jsx)("p",{className:"font-medium",children:"注意：有庫存不足的物料"}),(0,a.jsx)("p",{className:"text-sm",children:"部分物料的庫存不足以滿足使用數量，但仍可完工"}),(0,a.jsxs)("div",{className:"mt-3 text-left",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-orange-700 mb-2",children:"庫存不足項目："}),(0,a.jsx)("div",{className:"space-y-1",children:null==R?void 0:R.billOfMaterials.filter(e=>(e.currentStock||0)-(e.usedQuantity||0)<0).map((e,t)=>{let s=e.currentStock||0,n=e.usedQuantity||0;return(0,a.jsxs)("div",{className:"text-xs bg-orange-100 p-2 rounded border border-orange-200",children:[(0,a.jsxs)("div",{className:"font-medium",children:[e.name," (",e.code,")"]}),(0,a.jsxs)("div",{className:"text-orange-600",children:["現有: ",eO(s)," ",e.unit," | 使用: ",eO(n)," ",e.unit," | 不足: ",eO(n-s)," ",e.unit]})]},t)})})]})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-800 mb-3",children:"工時記錄"}),P&&P.length>0?(0,a.jsxs)("div",{className:"overflow-x-auto",children:[(0,a.jsxs)(Q.iA,{children:[(0,a.jsx)(Q.xD,{children:(0,a.jsxs)(Q.SC,{className:"bg-gray-50",children:[(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold",children:"人員"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold",children:"工作日期"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold",children:"開始時間"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold",children:"結束時間"}),(0,a.jsx)(Q.ss,{className:"text-gray-700 font-bold",children:"工時小計"})]})}),(0,a.jsx)(Q.RM,{children:P.map((e,t)=>(0,a.jsxs)(Q.SC,{children:[(0,a.jsx)(Q.pj,{className:"font-medium",children:e.personnelName}),(0,a.jsx)(Q.pj,{children:e.workDate}),(0,a.jsx)(Q.pj,{children:e.startTime}),(0,a.jsx)(Q.pj,{children:e.endTime}),(0,a.jsxs)(Q.pj,{className:"font-medium",children:[e.duration," 小時"]})]},t))})]}),(0,a.jsx)("div",{className:"mt-3 p-3 bg-blue-50 rounded-lg",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-sm text-gray-600",children:"總人工小時"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-600",children:[Math.floor(eU/60)," 小時 ",eU%60," 分鐘"]}),(0,a.jsxs)("div",{className:"text-xs text-gray-500",children:["共 ",P.length," 筆紀錄"]})]})})]}):(0,a.jsxs)("div",{className:"text-center py-4 text-orange-500 bg-orange-50 rounded-lg border border-orange-200",children:[(0,a.jsx)(T.Z,{className:"h-6 w-6 mx-auto mb-2"}),(0,a.jsx)("p",{className:"font-medium",children:"注意：尚無工時記錄"}),(0,a.jsx)("p",{className:"text-sm",children:"建議先新增工時記錄再完工，但非必要"})]})]}),(0,a.jsxs)("div",{className:"p-4 bg-blue-50 rounded-lg border border-blue-200",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-blue-800 mb-3",children:"完工總結"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-sm text-blue-600 mb-1",children:"已填寫使用數量的物料"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-800",children:[(null==R?void 0:R.billOfMaterials.filter(e=>(e.usedQuantity||0)>0).length)||0," 項"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-sm text-blue-600 mb-1",children:"總工時記錄"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-800",children:[(null==P?void 0:P.length)||0," 筆"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-sm text-blue-600 mb-1",children:"總人工小時"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-800",children:[Math.floor(eU/60)," 小時 ",eU%60," 分鐘"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-sm text-blue-600 mb-1",children:"目標產量"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-800",children:[null==R?void 0:R.targetQuantity," KG"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-sm text-blue-600 mb-1",children:"庫存不足項目"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-red-600",children:[(null==R?void 0:R.billOfMaterials.filter(e=>(e.currentStock||0)-(e.usedQuantity||0)<0).length)||0," 項"]}),(0,a.jsxs)("div",{className:"text-xs text-red-500",children:["不足: ",null==R?void 0:R.billOfMaterials.reduce((e,t)=>{let s=t.currentStock||0;return e+Math.max(0,(t.usedQuantity||0)-s)},0).toFixed(3)," KG"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-sm text-blue-600 mb-1",children:"總使用數量"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-800",children:[null==R?void 0:R.billOfMaterials.reduce((e,t)=>e+(t.usedQuantity||0),0).toFixed(3)," KG"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-sm text-blue-600 mb-1",children:"庫存充足項目"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-green-600",children:[(null==R?void 0:R.billOfMaterials.filter(e=>{let t=e.currentStock||0,s=e.usedQuantity||0;return t-s>=0&&s>0}).length)||0," 項"]}),(0,a.jsxs)("div",{className:"text-xs text-green-500",children:["剩餘: ",null==R?void 0:R.billOfMaterials.reduce((e,t)=>e+Math.max(0,(t.currentStock||0)-(t.usedQuantity||0)),0).toFixed(3)," KG"]})]})]}),(0,a.jsxs)("div",{className:"mt-4 p-3 bg-white rounded-lg border border-blue-200",children:[(0,a.jsx)("h4",{className:"text-sm font-semibold text-blue-800 mb-2",children:"庫存統計摘要"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3 text-xs",children:[(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-gray-600",children:"總庫存數量"}),(0,a.jsxs)("div",{className:"font-bold text-blue-600",children:[null==R?void 0:R.billOfMaterials.reduce((e,t)=>e+(t.currentStock||0),0).toFixed(3)," KG"]})]}),(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-gray-600",children:"總使用數量"}),(0,a.jsxs)("div",{className:"font-bold text-red-600",children:[null==R?void 0:R.billOfMaterials.reduce((e,t)=>e+(t.usedQuantity||0),0).toFixed(3)," KG"]})]}),(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-gray-600",children:"預計剩餘"}),(0,a.jsxs)("div",{className:"font-bold text-green-600",children:[null==R?void 0:R.billOfMaterials.reduce((e,t)=>e+((t.currentStock||0)-(t.usedQuantity||0)),0).toFixed(3)," KG"]})]})]}),(0,a.jsx)("div",{className:"mt-3 pt-3 border-t border-blue-200",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-gray-600 text-xs",children:"庫存使用率"}),(0,a.jsx)("div",{className:"font-bold text-blue-600",children:(()=>{let e=(null==R?void 0:R.billOfMaterials.reduce((e,t)=>e+(t.currentStock||0),0))||0,t=(null==R?void 0:R.billOfMaterials.reduce((e,t)=>e+(t.usedQuantity||0),0))||0;return 0===e?"0%":"".concat((t/e*100).toFixed(1),"%")})()})]})})]})]})]}),(0,a.jsxs)(B.cN,{className:"flex flex-col sm:flex-row gap-2",children:[(0,a.jsx)(A.z,{variant:"outline",onClick:()=>ew(!1),className:"w-full sm:w-auto",title:"取消完工操作",children:"取消"}),(0,a.jsx)(A.z,{onClick:eE,disabled:ek||(null==R?void 0:R.billOfMaterials.filter(e=>(e.usedQuantity||0)>0).length)===0,className:"bg-green-600 hover:bg-green-700 w-full sm:w-auto",title:(null==R?void 0:R.billOfMaterials.filter(e=>(e.usedQuantity||0)>0).length)===0?"請先填寫至少一個物料的使用數量":(null==R?void 0:R.billOfMaterials.some(e=>(e.currentStock||0)-(e.usedQuantity||0)<0))?"有庫存不足的物料，但仍可完工並扣除庫存":"確認將工單狀態設為完工並扣除庫存",children:ek?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(x.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"完工中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(p.Z,{className:"mr-2 h-4 w-4"}),(null==R?void 0:R.billOfMaterials.some(e=>(e.currentStock||0)-(e.usedQuantity||0)<0))?"確認完工並扣除庫存 (有庫存不足)":"確認完工並扣除庫存"]})})]})]})}),(0,a.jsx)(B.Vq,{open:eS,onOpenChange:eC,children:(0,a.jsxs)(B.cZ,{className:"w-[95vw] max-w-md sm:max-w-lg",children:[(0,a.jsxs)(B.fK,{children:[(0,a.jsx)(B.$N,{className:"text-blue-600 text-lg sm:text-xl",children:"確認入庫"}),(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:[(0,a.jsxs)("p",{className:"mb-3",children:['即將將工單 "',null==R?void 0:R.code,'" 設為入庫狀態。']}),(0,a.jsx)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:(0,a.jsxs)("div",{className:"flex items-start gap-2",children:[(0,a.jsx)(O.Z,{className:"h-4 w-4 text-yellow-600 mt-0.5 flex-shrink-0"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium text-yellow-800 mb-1",children:"重要提醒"}),(0,a.jsx)("p",{className:"text-yellow-700 text-sm",children:"入庫後將無法再修改任何資料，包括："}),(0,a.jsxs)("ul",{className:"list-disc list-inside mt-1 text-sm text-yellow-700 space-y-1",children:[(0,a.jsx)("li",{children:"目標產量和使用數量"}),(0,a.jsx)("li",{children:"工時申報記錄"}),(0,a.jsx)("li",{children:"工單狀態"})]}),(0,a.jsx)("p",{className:"text-yellow-700 text-sm mt-2",children:"僅可繼續新增留言和查看資料。"})]})]})})]})]}),(0,a.jsxs)(B.cN,{className:"flex flex-col sm:flex-row gap-2",children:[(0,a.jsx)(A.z,{variant:"outline",onClick:()=>eC(!1),className:"w-full sm:w-auto",title:"取消入庫操作",children:"取消"}),(0,a.jsx)(A.z,{onClick:eI,disabled:eD,className:"bg-blue-600 hover:bg-blue-700 w-full sm:w-auto",title:"確認將工單狀態設為入庫",children:eD?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(x.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"入庫中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(p.Z,{className:"mr-2 h-4 w-4"}),"確認入庫"]})})]})]})}),(0,a.jsx)(B.Vq,{open:ex,onOpenChange:eu,children:(0,a.jsxs)(B.cZ,{className:"w-[95vw] max-w-md sm:max-w-lg",children:[(0,a.jsxs)(B.fK,{children:[(0,a.jsx)(B.$N,{className:"text-red-600 text-lg sm:text-xl",children:"確認刪除工單"}),(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:['此操作將永久刪除工單 "',R.code,'" 及其所有相關資料，包括：',(0,a.jsxs)("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[(0,a.jsx)("li",{children:"工單基本資料"}),(0,a.jsx)("li",{children:"所有留言記錄"}),(0,a.jsx)("li",{children:"所有上傳的圖片"}),(0,a.jsx)("li",{children:"工時記錄"})]}),(0,a.jsx)("p",{className:"mt-3 font-medium text-red-600",children:"此操作無法復原，請確認是否繼續？"})]})]}),(0,a.jsxs)(B.cN,{className:"flex flex-col sm:flex-row gap-2",children:[(0,a.jsx)(A.z,{variant:"outline",onClick:()=>eu(!1),className:"w-full sm:w-auto",children:"取消"}),(0,a.jsx)(A.z,{variant:"destructive",onClick:eH,disabled:eh,className:"bg-red-600 hover:bg-red-700 w-full sm:w-auto",children:eh?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(x.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"刪除中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(f.Z,{className:"mr-2 h-4 w-4"}),"確認刪除"]})})]})]})})]})}):(0,a.jsx)("div",{className:"container mx-auto py-10",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("p",{className:"text-red-600 mb-4",children:"工單不存在"}),(0,a.jsxs)(A.z,{onClick:()=>q.push("/dashboard/work-orders"),children:[(0,a.jsx)(u.Z,{className:"mr-2 h-4 w-4"}),"返回工單列表"]})]})})}},15291:function(e,t,s){"use strict";s.d(t,{Bw:function(){return g},Ph:function(){return o},Ql:function(){return p},i4:function(){return x},ki:function(){return m}});var a=s(57437),n=s(2265),r=s(33911),l=s(40875),i=s(22135),d=s(30401),c=s(93448);let o=r.fC;r.ZA;let m=r.B4,x=n.forwardRef((e,t)=>{let{className:s,children:n,...i}=e;return(0,a.jsxs)(r.xz,{ref:t,className:(0,c.cn)("flex h-10 w-full items-center justify-between rounded-md border border-slate-200 bg-white px-3 py-2 text-sm ring-offset-white placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-950 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1 dark:border-slate-800 dark:bg-slate-950 dark:ring-offset-slate-950 dark:placeholder:text-slate-400 dark:focus:ring-slate-300",s),...i,children:[n,(0,a.jsx)(r.JO,{asChild:!0,children:(0,a.jsx)(l.Z,{className:"h-4 w-4 opacity-50"})})]})});x.displayName=r.xz.displayName;let u=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)(r.u_,{ref:t,className:(0,c.cn)("flex cursor-default items-center justify-center py-1",s),...n,children:(0,a.jsx)(i.Z,{className:"h-4 w-4"})})});u.displayName=r.u_.displayName;let h=n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)(r.$G,{ref:t,className:(0,c.cn)("flex cursor-default items-center justify-center py-1",s),...n,children:(0,a.jsx)(l.Z,{className:"h-4 w-4"})})});h.displayName=r.$G.displayName;let g=n.forwardRef((e,t)=>{let{className:s,children:n,position:l="popper",...i}=e;return(0,a.jsx)(r.h_,{children:(0,a.jsxs)(r.VY,{ref:t,className:(0,c.cn)("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border border-slate-200 bg-white text-slate-950 shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-50","popper"===l&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",s),position:l,...i,children:[(0,a.jsx)(u,{}),(0,a.jsx)(r.l_,{className:(0,c.cn)("p-1","popper"===l&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:n}),(0,a.jsx)(h,{})]})})});g.displayName=r.VY.displayName,n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)(r.__,{ref:t,className:(0,c.cn)("py-1.5 pl-8 pr-2 text-sm font-semibold",s),...n})}).displayName=r.__.displayName;let p=n.forwardRef((e,t)=>{let{className:s,children:n,...l}=e;return(0,a.jsxs)(r.ck,{ref:t,className:(0,c.cn)("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-slate-100 focus:text-slate-900 data-[disabled]:pointer-events-none data-[disabled]:opacity-50 dark:focus:bg-slate-800 dark:focus:text-slate-50",s),...l,children:[(0,a.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,a.jsx)(r.wU,{children:(0,a.jsx)(d.Z,{className:"h-4 w-4"})})}),(0,a.jsx)(r.eT,{children:n})]})});p.displayName=r.ck.displayName,n.forwardRef((e,t)=>{let{className:s,...n}=e;return(0,a.jsx)(r.Z0,{ref:t,className:(0,c.cn)("-mx-1 my-1 h-px bg-slate-100 dark:bg-slate-800",s),...n})}).displayName=r.Z0.displayName},69958:function(e,t,s){"use strict";s.d(t,{n:function(){return n}});let a={PG_MATERIAL_CODES:["UV3404503","PG"],VG_MATERIAL_CODES:["UV3400698","VG"],NICOTINE_MATERIAL_CODES:["UV3405520","NIC","丁鹽","尼古丁"],PG_MATERIAL_NAMES:["PG丙二醇","PG","丙二醇"],VG_MATERIAL_NAMES:["VG甘油","VG","甘油"],NICOTINE_MATERIAL_NAMES:["丁鹽","尼古丁","NicSalt"]},n=(e,t)=>e.find(e=>{var s;let n=(null===(s=e.code)||void 0===s?void 0:s.toUpperCase())||"",r=e.name||"";switch(t){case"pg":return a.PG_MATERIAL_CODES.some(e=>n.includes(e))||a.PG_MATERIAL_NAMES.some(e=>r.includes(e));case"vg":return a.VG_MATERIAL_CODES.some(e=>n.includes(e))||a.VG_MATERIAL_NAMES.some(e=>r.includes(e));case"nicotine":return a.NICOTINE_MATERIAL_CODES.some(e=>n.includes(e))||a.NICOTINE_MATERIAL_NAMES.some(e=>r.includes(e));default:return!1}})},6394:function(e,t,s){"use strict";s.d(t,{f:function(){return i}});var a=s(2265),n=s(66840),r=s(57437),l=a.forwardRef((e,t)=>(0,r.jsx)(n.WV.label,{...e,ref:t,onMouseDown:t=>{var s;t.target.closest("button, input, select, textarea")||(null===(s=e.onMouseDown)||void 0===s||s.call(e,t),!t.defaultPrevented&&t.detail>1&&t.preventDefault())}}));l.displayName="Label";var i=l}},function(e){e.O(0,[3609,9015,3676,5569,4438,9436,3909,2696,4116,4200,2365,1348,2971,2117,1744],function(){return e(e.s=18968)}),_N_E=e.O()}]);