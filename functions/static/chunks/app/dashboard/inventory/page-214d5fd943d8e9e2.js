(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4439],{44742:function(e,t,s){Promise.resolve().then(s.bind(s,94006))},94006:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return eU}});var a=s(57437),r=s(2265),n=s(1850),i=s(14438),l=s(5978),c=s(46410);class o{set(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.defaultTTL;this.cache.set(e,{data:t,timestamp:Date.now(),ttl:s})}get(e){let t=this.cache.get(e);return t?Date.now()-t.timestamp>t.ttl?(this.cache.delete(e),null):t.data:null}has(e){let t=this.cache.get(e);return!!t&&(!(Date.now()-t.timestamp>t.ttl)||(this.cache.delete(e),!1))}delete(e){return this.cache.delete(e)}clear(){this.cache.clear()}cleanup(){let e=Date.now();for(let[t,s]of this.cache.entries())e-s.timestamp>s.ttl&&this.cache.delete(t)}getStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}constructor(){this.cache=new Map,this.defaultTTL=3e5}}let d=new o;setInterval(()=>{d.cleanup()},6e4);var m=s(47903);class u{async execute(e,t){if(this.pendingRequests.has(e))return m.kg.info("Request deduplication hit for key: ".concat(e)),this.pendingRequests.get(e);let s=t();this.pendingRequests.set(e,s);try{return await s}finally{this.pendingRequests.delete(e)}}cancel(e){this.pendingRequests.delete(e)}clear(){this.pendingRequests.clear()}getStats(){return{pendingCount:this.pendingRequests.size,pendingKeys:Array.from(this.pendingRequests.keys())}}constructor(){this.pendingRequests=new Map}}let x=new u;async function g(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{ttl:a=3e5,skipCache:r=!1,forceRefresh:n=!1}=s,i=JSON.stringify(t),o="firestore:".concat(e,":query:").concat(btoa(i));if(n&&d.delete(o),!r&&!n&&d.has(o)){let t=d.get(o);if(null!==t)return m.kg.info("Cache hit for collection: ".concat(e)),t}try{let s=await x.execute(o,async()=>{if(!c.db)throw Error("Firebase 未初始化");m.kg.info("Fetching collection: ".concat(e));let s=(0,l.collection)(c.db,e),a=(0,l.query)(s,...t);return(await (0,l.getDocs)(a)).docs.map(e=>({id:e.id,...e.data()}))});return d.set(o,s,a),s}catch(s){let t=s instanceof Error?s:Error(String(s));throw m.kg.error("Error fetching collection ".concat(e,":"),t),t}}let h={ttl:9e5},f=async e=>(await g("materials",[],{...h,...e})).map(e=>({...e,type:"material"})),p=async e=>(await g("fragrances",[],{...h,...e})).map(e=>({...e,type:"fragrance"}));function j(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{enabled:a=!0,...n}=s,[i,l]=(0,r.useState)(null),[c,o]=(0,r.useState)(a),[d,u]=(0,r.useState)(null),x=(0,r.useRef)(e),g=(0,r.useRef)(!0);(0,r.useEffect)(()=>{x.current=e},[e]),(0,r.useEffect)(()=>()=>{g.current=!1},[]);let h=(0,r.useCallback)(async()=>{if(a){o(!0),u(null);try{let e=await x.current();g.current&&l(e)}catch(s){let e=s instanceof Error?s:Error(String(s));m.kg.error("Firebase cache error for key ".concat(t,":"),e),g.current&&u(s instanceof Error?s:Error("Unknown error"))}finally{g.current&&o(!1)}}},[t,a]),f=(0,r.useCallback)(async()=>{await h()},[h]),p=(0,r.useCallback)(()=>{m.kg.info("清除快取: ".concat(t))},[t]);return(0,r.useEffect)(()=>{a&&h()},[h,a]),{data:i,loading:c,error:d,refetch:f,clearCache:p}}var b=s(82431),N=s(98728),v=s(76865),y=s(73618),w=s(44794),k=s(73247),C=s(38220),S=s(12381),A=s(79820),O=s(40279),I=s(17168),Z=s(95252),E=s(69140);function M(e){let{overview:t,loading:s}=e;if(s||!t)return(0,a.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[void 0,void 0,void 0,void 0].map((e,t)=>(0,a.jsxs)(A.Zb,{children:[(0,a.jsx)(A.Ol,{className:"pb-2",children:(0,a.jsx)(E.O,{className:"h-4 w-20"})}),(0,a.jsxs)(A.aY,{children:[(0,a.jsx)(E.O,{className:"h-8 w-16 mb-2"}),(0,a.jsx)(E.O,{className:"h-3 w-24"})]})]},t))});let r=[{title:"總物料數",value:t.totalMaterials,description:"".concat(t.lowStockMaterials," 項低庫存"),icon:w.Z,gradient:"from-blue-500 to-cyan-500",bgGradient:"from-blue-50 to-cyan-50",borderColor:"border-blue-200",iconColor:"text-blue-600"},{title:"總香精數",value:t.totalFragrances,description:"".concat(t.lowStockFragrances," 項低庫存"),icon:C.Z,gradient:"from-purple-500 to-pink-500",bgGradient:"from-purple-50 to-pink-50",borderColor:"border-purple-200",iconColor:"text-purple-600"},{title:"總物料成本",value:"NT$ ".concat(t.totalMaterialCost.toLocaleString()),description:"當前庫存價值",icon:Z.Z,gradient:"from-green-500 to-emerald-500",bgGradient:"from-green-50 to-emerald-50",borderColor:"border-green-200",iconColor:"text-green-600"},{title:"總香精成本",value:"NT$ ".concat(t.totalFragranceCost.toLocaleString()),description:"當前庫存價值",icon:Z.Z,gradient:"from-orange-500 to-red-500",bgGradient:"from-orange-50 to-red-50",borderColor:"border-orange-200",iconColor:"text-orange-600"}];return(0,a.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:r.map((e,t)=>(0,a.jsxs)(A.Zb,{className:"".concat(e.borderColor," bg-gradient-to-br ").concat(e.bgGradient," hover:shadow-lg transition-all duration-200 hover:scale-105"),children:[(0,a.jsxs)(A.Ol,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,a.jsx)(A.ll,{className:"text-sm font-medium text-gray-700",children:e.title}),(0,a.jsx)(e.icon,{className:"h-5 w-5 ".concat(e.iconColor)})]}),(0,a.jsxs)(A.aY,{children:[(0,a.jsx)("div",{className:"text-2xl font-bold bg-gradient-to-r ".concat(e.gradient," bg-clip-text text-transparent"),children:e.value}),(0,a.jsx)("p",{className:"text-xs ".concat(e.iconColor," mt-1 opacity-80"),children:e.description})]})]},t))})}var z=s(70525),F=s(3085),L=s(33804),R=s(69174),P=s(68245),T=s(3011),U=s(89134);let q={getItem:e=>{try{return window.localStorage.getItem(e)}catch(t){console.warn('Failed to get item "'.concat(e,'" from localStorage:'),t)}return null},setItem:(e,t)=>{try{window.localStorage.setItem(e,t)}catch(t){console.warn('Failed to set item "'.concat(e,'" to localStorage:'),t)}},removeItem:e=>{try{window.localStorage.removeItem(e)}catch(t){console.warn('Failed to remove item "'.concat(e,'" from localStorage:'),t)}}},_=(0,U.FL)(()=>q);function Q(e,t,s,a,r){return async function(){for(var n=arguments.length,i=Array(n),l=0;l<n;l++)i[l]=arguments[l];t(!0),s(null);try{let t=await e(...i);return a&&a(t),t}catch(t){let e=t instanceof Error?t.message:"Unknown error";return s(e),r&&r(t instanceof Error?t:Error(e)),null}finally{t(!1)}}}let V=(e,t)=>{let s=e.indexOf(t);return -1===s?[...e,t]:e.filter((e,t)=>t!==s)},D=(e,t,s)=>e.map(e=>e.id===t?{...e,...s}:e),G={materials:[],fragrances:[],loading:{materials:!1,fragrances:!1,updating:!1},selectedItems:{materials:[],fragrances:[]},filters:{searchTerm:"",category:"",lowStockOnly:!1,sortBy:"name",sortOrder:"asc"},batchOperations:{isEnabled:!1,pendingUpdates:{}}},Y=(e,t)=>{let s=e;if(t.searchTerm){let e=t.searchTerm.toLowerCase();s=s.filter(t=>{var s,a;return t.name.toLowerCase().includes(e)||t.code.toLowerCase().includes(e)||"category"in t&&(null===(s=t.category)||void 0===s?void 0:s.toLowerCase().includes(e))||"series"in t&&(null===(a=t.series)||void 0===a?void 0:a.toLowerCase().includes(e))})}return t.category&&"all"!==t.category&&(s=s.filter(e=>"category"in e&&e.category===t.category)),t.lowStockOnly&&(s=s.filter(e=>e.minStock>0&&e.currentStock<e.minStock)),s.sort((e,s)=>{let a,r;switch(t.sortBy){case"name":a=e.name.toLowerCase(),r=s.name.toLowerCase();break;case"code":a=e.code.toLowerCase(),r=s.code.toLowerCase();break;case"stock":a=e.currentStock,r=s.currentStock;break;case"cost":a=e.costPerUnit,r=s.costPerUnit;break;default:return 0}return a<r?"asc"===t.sortOrder?-1:1:a>r?"asc"===t.sortOrder?1:-1:0}),s},$=(0,T.U)()((0,U.tJ)((e,t)=>({...G,setMaterials:t=>e({materials:t}),setFragrances:t=>e({fragrances:t}),updateMaterial:(t,s)=>e(e=>({materials:D(e.materials,t,s)})),updateFragrance:(t,s)=>e(e=>({fragrances:D(e.fragrances,t,s)})),setLoading:(t,s)=>e(e=>({loading:{...e.loading,[t]:s}})),toggleSelection:(t,s)=>e(e=>({selectedItems:{...e.selectedItems,[t]:V(e.selectedItems[t],s)}})),clearSelections:()=>e(e=>({selectedItems:{materials:[],fragrances:[]}})),selectAll:t=>e(e=>{let s="materials"===t?e.materials:e.fragrances;return{selectedItems:{...e.selectedItems,[t]:s.map(e=>e.id)}}}),selectNone:t=>e(e=>({selectedItems:{...e.selectedItems,[t]:[]}})),updateFilters:t=>e(e=>({filters:{...e.filters,...t}})),setSearchTerm:t=>e(e=>({filters:{...e.filters,searchTerm:t}})),setCategory:t=>e(e=>({filters:{...e.filters,category:t}})),toggleLowStockFilter:()=>e(e=>({filters:{...e.filters,lowStockOnly:!e.filters.lowStockOnly}})),setSortBy:t=>e(e=>({filters:{...e.filters,sortBy:t}})),toggleSortOrder:()=>e(e=>({filters:{...e.filters,sortOrder:"asc"===e.filters.sortOrder?"desc":"asc"}})),enableBatchMode:()=>e(e=>({batchOperations:{...e.batchOperations,isEnabled:!0}})),disableBatchMode:()=>e(e=>({batchOperations:{isEnabled:!1,pendingUpdates:{}},selectedItems:{materials:[],fragrances:[]}})),addBatchUpdate:(t,s,a)=>e(e=>({batchOperations:{...e.batchOperations,pendingUpdates:{...e.batchOperations.pendingUpdates,[t]:{quantity:s,reason:a}}}})),removeBatchUpdate:t=>e(e=>{let s={...e.batchOperations.pendingUpdates};return delete s[t],{batchOperations:{...e.batchOperations,pendingUpdates:s}}}),clearBatchUpdates:()=>e(e=>({batchOperations:{...e.batchOperations,pendingUpdates:{}}})),loadMaterials:Q(async()=>{let e=await f();return t().setMaterials(e||[]),e},e=>t().setLoading("materials",e),e=>m.kg.error("載入物料失敗:",Error(e||"未知錯誤"))),loadFragrances:Q(async()=>{let e=await p();return t().setFragrances(e||[]),e},e=>t().setLoading("fragrances",e),e=>m.kg.error("載入香精失敗:",Error(e||"未知錯誤"))),refreshAll:async()=>{await Promise.all([t().loadMaterials(),t().loadFragrances()])},applyBatchUpdates:Q(async()=>{let{batchOperations:e}=t(),s=Object.entries(e.pendingUpdates);for(let[e,a]of s){let{quantity:s,reason:r}=a,n=t().materials.find(t=>t.id===e),i=t().fragrances.find(t=>t.id===e);n?t().updateMaterial(e,{currentStock:s}):i&&t().updateFragrance(e,{currentStock:s})}t().clearBatchUpdates(),m.kg.info("批量更新完成，共更新 ".concat(s.length," 個項目"))},e=>t().setLoading("updating",e),e=>m.kg.error("批量更新失敗:",Error(e||"未知錯誤"))),getFilteredMaterials:()=>{let{materials:e,filters:s}=t();return Y(e,s)},getFilteredFragrances:()=>{let{fragrances:e,filters:s}=t();return Y(e,s)},getLowStockItems:()=>{let{materials:e,fragrances:s}=t();return[...e,...s].filter(e=>e.minStock>0&&e.currentStock<e.minStock)},getSelectedItems:()=>{let{materials:e,fragrances:s,selectedItems:a}=t();return{materials:e.filter(e=>a.materials.includes(e.id)),fragrances:s.filter(e=>a.fragrances.includes(e.id))}},getTotalValue:()=>{let{materials:e,fragrances:s}=t();return{materials:e.reduce((e,t)=>e+t.currentStock*t.costPerUnit,0),fragrances:s.reduce((e,t)=>e+t.currentStock*t.costPerUnit,0)}}}),{name:"deer-lab-inventory-store",storage:_,partialize:e=>({filters:e.filters,selectedItems:e.selectedItems})}));function B(e){let{items:t,loading:s,onQuickUpdate:r,type:n}=e,{batchOperations:i,selectedItems:l,toggleSelection:c}=$();if(s)return(0,a.jsx)("div",{className:"space-y-3",children:[void 0,void 0,void 0,void 0,void 0].map((e,t)=>(0,a.jsxs)("div",{className:"flex items-center space-x-4 p-4 border rounded-lg",children:[(0,a.jsx)(E.O,{className:"h-4 w-16"}),(0,a.jsx)(E.O,{className:"h-4 w-32 flex-1"}),(0,a.jsx)(E.O,{className:"h-4 w-20"}),(0,a.jsx)(E.O,{className:"h-4 w-16"}),(0,a.jsx)(E.O,{className:"h-8 w-20"})]},t))});if(0===t.length)return(0,a.jsxs)("div",{className:"text-center py-12 text-gray-500",children:[(0,a.jsx)("div",{className:"mb-4",children:"material"===n?(0,a.jsx)(w.Z,{className:"h-12 w-12 mx-auto text-gray-300"}):(0,a.jsx)(C.Z,{className:"h-12 w-12 mx-auto text-gray-300"})}),(0,a.jsxs)("p",{className:"text-lg font-medium",children:["沒有找到","material"===n?"物料":"香精","項目"]}),(0,a.jsx)("p",{className:"text-sm",children:"嘗試調整搜尋條件或新增項目"})]});let o=e=>e.currentStock<=e.minStock?{status:"low",text:"低庫存",badgeColor:"bg-red-100 text-red-800 border-red-200",icon:(0,a.jsx)(v.Z,{className:"h-3 w-3"})}:e.currentStock>=e.maxStock?{status:"high",text:"高庫存",badgeColor:"bg-yellow-100 text-yellow-800 border-yellow-200",icon:(0,a.jsx)(z.Z,{className:"h-3 w-3"})}:{status:"normal",text:"正常",badgeColor:"bg-green-100 text-green-800 border-green-200",icon:(0,a.jsx)(F.Z,{className:"h-3 w-3"})};return(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"hidden md:block rounded-md border",children:(0,a.jsxs)(L.iA,{children:[(0,a.jsx)(L.xD,{children:(0,a.jsxs)(L.SC,{className:"bg-gray-50",children:[i.isEnabled&&(0,a.jsx)(L.ss,{className:"font-semibold w-12",children:(0,a.jsx)(P.X,{checked:t.every(e=>l["material"===n?"materials":"fragrances"].includes(e.id)),onCheckedChange:e=>{t.forEach(t=>{let s=l["material"===n?"materials":"fragrances"].includes(t.id);e&&!s?c("material"===n?"materials":"fragrances",t.id):!e&&s&&c("material"===n?"materials":"fragrances",t.id)})}})}),(0,a.jsx)(L.ss,{className:"font-semibold",children:"代碼"}),(0,a.jsx)(L.ss,{className:"font-semibold",children:"名稱"}),(0,a.jsx)(L.ss,{className:"font-semibold",children:"分類"}),(0,a.jsx)(L.ss,{className:"font-semibold text-right",children:"當前庫存"}),(0,a.jsx)(L.ss,{className:"font-semibold text-right",children:"安全庫存"}),(0,a.jsx)(L.ss,{className:"font-semibold text-right",children:"單價"}),(0,a.jsx)(L.ss,{className:"font-semibold text-right",children:"庫存價值"}),(0,a.jsx)(L.ss,{className:"font-semibold text-center",children:"狀態"}),(0,a.jsx)(L.ss,{className:"font-semibold text-center",children:"操作"})]})}),(0,a.jsx)(L.RM,{children:t.map(e=>{let t=o(e),s=e.currentStock*e.costPerUnit,d=l["material"===n?"materials":"fragrances"].includes(e.id);return(0,a.jsxs)(L.SC,{className:"hover:bg-gray-50 transition-colors ".concat(d&&i.isEnabled?"bg-blue-50 border-blue-200":""),children:[i.isEnabled&&(0,a.jsx)(L.pj,{children:(0,a.jsx)(P.X,{checked:d,onCheckedChange:()=>c("material"===n?"materials":"fragrances",e.id)})}),(0,a.jsx)(L.pj,{className:"font-mono text-sm font-medium",children:e.code}),(0,a.jsx)(L.pj,{children:(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium text-gray-900",children:e.name}),e.series&&(0,a.jsxs)("div",{className:"text-sm text-gray-500",children:["系列: ",e.series]})]})}),(0,a.jsx)(L.pj,{children:(0,a.jsx)("span",{className:"text-sm text-gray-600",children:e.category||"-"})}),(0,a.jsx)(L.pj,{className:"text-right",children:(0,a.jsx)(S.z,{variant:"ghost",className:"h-auto p-2 font-semibold hover:bg-blue-50",onClick:()=>r(e),children:(0,a.jsxs)("span",{className:"text-blue-600",children:[e.currentStock," ",e.unit]})})}),(0,a.jsxs)(L.pj,{className:"text-right text-sm text-gray-600",children:[e.minStock," ",e.unit]}),(0,a.jsxs)(L.pj,{className:"text-right text-sm text-gray-600",children:["NT$ ",e.costPerUnit.toLocaleString()]}),(0,a.jsxs)(L.pj,{className:"text-right font-medium text-gray-900",children:["NT$ ",s.toLocaleString()]}),(0,a.jsx)(L.pj,{className:"text-center",children:(0,a.jsxs)(R.C,{variant:"outline",className:"".concat(t.badgeColor," text-xs flex items-center gap-1 w-fit mx-auto"),children:[t.icon,t.text]})}),(0,a.jsx)(L.pj,{className:"text-center",children:(0,a.jsx)(S.z,{variant:"outline",size:"sm",onClick:()=>r(e),className:"text-xs",children:"快速調整"})})]},e.id)})})]})}),(0,a.jsx)("div",{className:"md:hidden space-y-4",children:t.map(e=>{let t=o(e),s=e.currentStock*e.costPerUnit,d=l["material"===n?"materials":"fragrances"].includes(e.id);return(0,a.jsxs)("div",{className:"bg-white border rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow ".concat(d&&i.isEnabled?"border-blue-300 bg-blue-50":"border-gray-200"),children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-3",children:[(0,a.jsxs)("div",{className:"flex items-start gap-3 flex-1",children:[i.isEnabled&&(0,a.jsx)(P.X,{checked:d,onCheckedChange:()=>c("material"===n?"materials":"fragrances",e.id),className:"mt-1"}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("div",{className:"font-medium text-gray-900 text-lg mb-1",children:e.name}),(0,a.jsxs)("div",{className:"font-mono text-sm text-gray-600 mb-1",children:["代碼: ",e.code]}),e.series&&(0,a.jsxs)("div",{className:"text-sm text-gray-500",children:["系列: ",e.series]})]})]}),(0,a.jsxs)(R.C,{variant:"outline",className:"".concat(t.badgeColor," text-xs flex items-center gap-1 shrink-0 ml-2"),children:[t.icon,t.text]})]}),e.category&&(0,a.jsx)("div",{className:"mb-3 py-1 px-2 bg-gray-100 rounded text-sm text-gray-700 inline-block",children:e.category}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[(0,a.jsxs)("div",{className:"bg-blue-50 rounded-lg p-3",children:[(0,a.jsx)("div",{className:"text-xs text-blue-600 font-medium mb-1",children:"當前庫存"}),(0,a.jsxs)("button",{onClick:()=>r(e),className:"text-lg font-bold text-blue-700 hover:text-blue-800 transition-colors",children:[e.currentStock," ",e.unit]})]}),(0,a.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3",children:[(0,a.jsx)("div",{className:"text-xs text-gray-600 font-medium mb-1",children:"安全庫存"}),(0,a.jsxs)("div",{className:"text-lg font-semibold text-gray-700",children:[e.minStock," ",e.unit]})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[(0,a.jsxs)("div",{className:"bg-green-50 rounded-lg p-3",children:[(0,a.jsx)("div",{className:"text-xs text-green-600 font-medium mb-1",children:"單價"}),(0,a.jsxs)("div",{className:"text-lg font-semibold text-green-700",children:["NT$ ",e.costPerUnit.toLocaleString()]})]}),(0,a.jsxs)("div",{className:"bg-purple-50 rounded-lg p-3",children:[(0,a.jsx)("div",{className:"text-xs text-purple-600 font-medium mb-1",children:"庫存價值"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-purple-700",children:["NT$ ",s.toLocaleString()]})]})]}),(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsx)(S.z,{onClick:()=>r(e),className:"bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-6 py-2 rounded-lg font-medium shadow-sm hover:shadow transition-all duration-200 min-h-[44px]",children:"快速調整"})})]},e.id)})})]})}var K=s(74291);function W(e){let{isOpen:t,onClose:s}=e,[l,c]=(0,r.useState)([]),[o,d]=(0,r.useState)(!0),m=async()=>{d(!0);try{let e=(0,n.$C)(),t=(0,n.V1)(e,"getLowStockItems"),s=(await t({})).data;s.success&&c(s.items)}catch(e){console.error("載入低庫存項目失敗:",e),i.Am.error("載入低庫存項目失敗")}finally{d(!1)}};return(0,r.useEffect)(()=>{t&&m()},[t]),(0,a.jsx)(K.Vq,{open:t,onOpenChange:s,children:(0,a.jsxs)(K.cZ,{className:"max-w-4xl max-h-[80vh] overflow-hidden flex flex-col",children:[(0,a.jsxs)(K.fK,{children:[(0,a.jsxs)(K.$N,{className:"flex items-center gap-2 text-red-600",children:[(0,a.jsx)(v.Z,{className:"h-5 w-5"}),"低庫存項目清單"]}),(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)(K.Be,{children:"以下項目的庫存已低於或等於安全庫存線，建議及時補貨"}),(0,a.jsxs)(S.z,{variant:"outline",size:"sm",onClick:m,disabled:o,className:"ml-4",children:[(0,a.jsx)(b.Z,{className:"h-4 w-4 mr-2 ".concat(o?"animate-spin":"")}),"重新整理"]})]})]}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto",children:o?(0,a.jsx)("div",{className:"space-y-3",children:[void 0,void 0,void 0,void 0,void 0].map((e,t)=>(0,a.jsxs)("div",{className:"flex items-center space-x-4 p-4 border rounded-lg",children:[(0,a.jsx)(E.O,{className:"h-4 w-16"}),(0,a.jsx)(E.O,{className:"h-4 w-32 flex-1"}),(0,a.jsx)(E.O,{className:"h-4 w-20"}),(0,a.jsx)(E.O,{className:"h-4 w-16"})]},t))}):0===l.length?(0,a.jsxs)("div",{className:"text-center py-12",children:[(0,a.jsx)("div",{className:"text-green-600 mb-4",children:(0,a.jsx)(w.Z,{className:"h-12 w-12 mx-auto"})}),(0,a.jsx)("h3",{className:"text-lg font-medium text-green-800 mb-2",children:"太棒了！"}),(0,a.jsx)("p",{className:"text-green-600",children:"目前沒有低庫存項目"}),(0,a.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:"所有物料和香精庫存都在安全範圍內"})]}):(0,a.jsxs)("div",{className:"rounded-md border",children:[(0,a.jsxs)(L.iA,{children:[(0,a.jsx)(L.xD,{children:(0,a.jsxs)(L.SC,{className:"bg-red-50",children:[(0,a.jsx)(L.ss,{className:"font-semibold",children:"類型"}),(0,a.jsx)(L.ss,{className:"font-semibold",children:"代碼"}),(0,a.jsx)(L.ss,{className:"font-semibold",children:"名稱"}),(0,a.jsx)(L.ss,{className:"font-semibold text-right",children:"當前庫存"}),(0,a.jsx)(L.ss,{className:"font-semibold text-right",children:"安全庫存"}),(0,a.jsx)(L.ss,{className:"font-semibold text-right",children:"短缺數量"}),(0,a.jsx)(L.ss,{className:"font-semibold text-right",children:"單價"}),(0,a.jsx)(L.ss,{className:"font-semibold text-right",children:"補貨成本"})]})}),(0,a.jsx)(L.RM,{children:l.map(e=>{let t=e.shortage*e.costPerUnit;return(0,a.jsxs)(L.SC,{className:"hover:bg-gray-50",children:[(0,a.jsx)(L.pj,{children:(0,a.jsx)(R.C,{variant:"outline",className:"".concat("material"===e.type?"text-blue-600 border-blue-200 bg-blue-50":"text-purple-600 border-purple-200 bg-purple-50"),children:"material"===e.type?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(w.Z,{className:"h-3 w-3 mr-1"}),"物料"]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(C.Z,{className:"h-3 w-3 mr-1"}),"香精"]})})}),(0,a.jsx)(L.pj,{className:"font-mono text-sm font-medium",children:e.code}),(0,a.jsx)(L.pj,{className:"font-medium",children:e.name}),(0,a.jsx)(L.pj,{className:"text-right",children:(0,a.jsxs)("span",{className:"text-red-600 font-medium",children:[e.currentStock," ",e.unit]})}),(0,a.jsxs)(L.pj,{className:"text-right text-gray-600",children:[e.minStock," ",e.unit]}),(0,a.jsx)(L.pj,{className:"text-right",children:(0,a.jsxs)(R.C,{variant:"destructive",className:"font-medium",children:[e.shortage," ",e.unit]})}),(0,a.jsxs)(L.pj,{className:"text-right text-sm text-gray-600",children:["NT$ ",e.costPerUnit.toLocaleString()]}),(0,a.jsxs)(L.pj,{className:"text-right font-medium text-red-600",children:["NT$ ",t.toLocaleString()]})]},"".concat(e.type,"-").concat(e.id))})})]}),(0,a.jsx)("div",{className:"border-t bg-gray-50 p-4",children:(0,a.jsxs)("div",{className:"flex justify-between items-center text-sm",children:[(0,a.jsxs)("span",{className:"font-medium text-gray-700",children:["共 ",l.length," 項低庫存項目"]}),(0,a.jsxs)("span",{className:"font-medium text-red-600",children:["總補貨成本: NT$ ",l.reduce((e,t)=>e+t.shortage*t.costPerUnit,0).toLocaleString()]})]})})]})})]})})}var X=s(99397),J=s(21047),H=s(41671),ee=s(99388),et=s(69958),es=s(75060),ea=s(46343),er=s(93448);function en(e){let{className:t,...s}=e;return(0,a.jsx)(ea.mY,{"data-slot":"command",className:(0,er.cn)("bg-popover text-popover-foreground flex h-full w-full flex-col overflow-hidden rounded-md",t),...s})}function ei(e){let{className:t,...s}=e;return(0,a.jsxs)("div",{"data-slot":"command-input-wrapper",className:"flex h-9 items-center gap-2 border-b px-3",children:[(0,a.jsx)(k.Z,{className:"size-4 shrink-0 opacity-50"}),(0,a.jsx)(ea.mY.Input,{"data-slot":"command-input",className:(0,er.cn)("placeholder:text-muted-foreground flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-hidden disabled:cursor-not-allowed disabled:opacity-50",t),...s})]})}function el(e){let{className:t,...s}=e;return(0,a.jsx)(ea.mY.List,{"data-slot":"command-list",className:(0,er.cn)("max-h-[300px] scroll-py-1 overflow-x-hidden overflow-y-auto",t),...s})}function ec(e){let{...t}=e;return(0,a.jsx)(ea.mY.Empty,{"data-slot":"command-empty",className:"py-6 text-center text-sm",...t})}function eo(e){let{className:t,...s}=e;return(0,a.jsx)(ea.mY.Group,{"data-slot":"command-group",className:(0,er.cn)("text-foreground [&_[cmdk-group-heading]]:text-muted-foreground overflow-hidden p-1 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium",t),...s})}function ed(e){let{className:t,...s}=e;return(0,a.jsx)(ea.mY.Item,{"data-slot":"command-item",className:(0,er.cn)("data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled=true]:pointer-events-none data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",t),...s})}var em=s(12749),eu=s(24156),ex=s(30401);function eg(e){let{isOpen:t,onClose:s}=e,[n,o]=(0,r.useState)([]),[d,m]=(0,r.useState)([]),[u,x]=(0,r.useState)([]),[g,h]=(0,r.useState)([]),[f,p]=(0,r.useState)([]),[j,b]=(0,r.useState)(!0),[N,k]=(0,r.useState)(!1),[A,I]=(0,r.useState)({}),[Z,E]=(0,r.useState)({});(0,r.useEffect)(()=>{t&&z()},[t]);let M=e=>e?n.filter(t=>t.name.toLowerCase().includes(e.toLowerCase())||t.code.toLowerCase().includes(e.toLowerCase())||t.seriesName&&t.seriesName.toLowerCase().includes(e.toLowerCase())).sort((e,t)=>{let s=e.seriesName||"未指定",a=t.seriesName||"未指定";return s!==a?s.localeCompare(a,"zh-TW"):e.name.localeCompare(t.name,"zh-TW")}):n,z=async()=>{b(!0);try{if(!c.db)throw Error("Firebase 未初始化");let[e,t,s]=await Promise.all([(0,l.getDocs)((0,l.query)((0,l.collection)(c.db,"products"),(0,l.Xo)("name"))),(0,l.getDocs)((0,l.query)((0,l.collection)(c.db,"materials"),(0,l.Xo)("name"))),(0,l.getDocs)((0,l.query)((0,l.collection)(c.db,"fragrances"),(0,l.Xo)("name")))]),a=await Promise.all(e.docs.map(async e=>{let t=e.data(),s="未指定";if(t.seriesRef)try{let e=await (0,l.QT)(t.seriesRef);e.exists()&&(s=e.data().name||"未指定")}catch(e){console.error("獲取產品系列失敗:",e)}let a="未指定",r="未指定",n={percentage:0,pgRatio:0,vgRatio:0};if(t.currentFragranceRef)try{let e=await (0,l.QT)(t.currentFragranceRef);if(e.exists()){let t=e.data();a=t.name||"未指定",r=t.code||"未指定",n={percentage:(null==t?void 0:t.percentage)||0,pgRatio:(null==t?void 0:t.pgRatio)||0,vgRatio:(null==t?void 0:t.vgRatio)||0}}}catch(e){console.error("獲取香精資訊失敗:",e)}let i=[];if(t.specificMaterials&&t.specificMaterials.length>0)try{i=(await Promise.all(t.specificMaterials.map(e=>(0,l.QT)(e)))).filter(e=>e.exists()).map(e=>{let t=e.data();return(null==t?void 0:t.name)||"未知材料"})}catch(e){console.error("獲取專屬材料失敗:",e)}let c=[],o=[];if(t.seriesRef)try{let e=await (0,l.QT)(t.seriesRef);if(e.exists()){let t=e.data();t.commonMaterials&&t.commonMaterials.length>0&&(o=t.commonMaterials,c=(await Promise.all(t.commonMaterials.map(e=>(0,l.QT)(e)))).filter(e=>e.exists()).map(e=>{let t=e.data();return(null==t?void 0:t.name)||"未知材料"}))}}catch(e){console.error("獲取通用材料失敗:",e)}return{id:e.id,name:t.name,code:t.code,seriesName:s,seriesRef:t.seriesRef,currentFragranceRef:t.currentFragranceRef,fragranceName:a,fragranceCode:r,fragranceFormula:n,nicotineMg:t.nicotineMg||0,specificMaterials:t.specificMaterials||[],specificMaterialNames:i,commonMaterials:o,commonMaterialNames:c}})),r=t.docs.map(e=>({id:e.id,...e.data()})),n=s.docs.map(e=>({id:e.id,...e.data()}));o(a),m(r),x(n)}catch(e){console.error("載入數據失敗:",e),i.Am.error("載入數據失敗")}finally{b(!1)}},F=(e,t,s)=>{h(a=>{let r=[...a];if("productId"===t&&"string"==typeof s){let t=n.find(e=>e.id===s);r[e]={...r[e],productId:s,productName:(null==t?void 0:t.name)||"",productCode:(null==t?void 0:t.code)||""}}else r[e]={...r[e],[t]:s};return r})},P=e=>{h(t=>t.filter((t,s)=>s!==e))},T=e=>e%1==0?e.toString():e.toFixed(3),U=f.length>0&&f.every(e=>e.canProduce);return f.filter(e=>!e.canProduce).reduce((e,t)=>e+t.shortage,0),(0,a.jsx)(K.Vq,{open:t,onOpenChange:s,children:(0,a.jsxs)(K.cZ,{className:"max-w-6xl max-h-[90vh] overflow-hidden flex flex-col",children:[(0,a.jsxs)(K.fK,{children:[(0,a.jsxs)(K.$N,{className:"flex items-center gap-2 text-green-600",children:[(0,a.jsx)(y.Z,{className:"h-5 w-5"}),"生產能力評估工具"]}),(0,a.jsx)(K.Be,{children:"選擇多個產品及其目標產量，系統會計算所需物料和香精，並評估是否有足夠庫存進行生產"})]}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto space-y-6",children:[(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold",children:"生產計畫設定"}),(0,a.jsxs)(S.z,{onClick:()=>{h(e=>[...e,{productId:"",productName:"",productCode:"",targetQuantity:0}])},size:"sm",children:[(0,a.jsx)(X.Z,{className:"h-4 w-4 mr-2"}),"新增產品"]})]}),0===g.length?(0,a.jsxs)("div",{className:"text-center py-8 text-gray-500 border-2 border-dashed border-gray-200 rounded-lg",children:[(0,a.jsx)(y.Z,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),(0,a.jsx)("p",{className:"text-lg font-medium",children:"尚未新增生產計畫"}),(0,a.jsx)("p",{className:"text-sm",children:"點擊「新增產品」開始設定生產目標"})]}):(0,a.jsx)("div",{className:"space-y-3",children:g.map((e,t)=>{var s;return(0,a.jsxs)("div",{className:"flex items-center gap-4 p-4 border rounded-lg bg-gray-50",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)(es._,{children:"產品選擇"}),(0,a.jsxs)(em.J2,{open:A[t]||!1,onOpenChange:e=>I(s=>({...s,[t]:e})),children:[(0,a.jsx)(em.xo,{asChild:!0,children:(0,a.jsxs)(S.z,{variant:"outline",role:"combobox","aria-expanded":A[t]||!1,className:"w-full justify-between",children:[e.productId?(null===(s=n.find(t=>t.id===e.productId))||void 0===s?void 0:s.name)||"產品未找到":"選擇產品...",(0,a.jsx)(eu.Z,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),(0,a.jsx)(em.yk,{className:"w-full p-0",children:(0,a.jsxs)(en,{children:[(0,a.jsx)(ei,{placeholder:"搜尋產品名稱或系列...",value:Z[t]||"",onValueChange:e=>E(s=>({...s,[t]:e}))}),(0,a.jsxs)(el,{children:[(0,a.jsx)(ec,{children:"找不到相符的產品。"}),(0,a.jsx)(eo,{children:M(Z[t]||"").map(s=>(0,a.jsxs)(ed,{value:s.id,onSelect:s=>{F(t,"productId",s===e.productId?"":s),I(e=>({...e,[t]:!1})),E(e=>({...e,[t]:""}))},children:[(0,a.jsx)(ex.Z,{className:(0,er.cn)("mr-2 h-4 w-4",e.productId===s.id?"opacity-100":"opacity-0")}),(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsxs)("span",{className:"font-medium",children:["[",s.seriesName||"未指定","] - ",s.name]}),(0,a.jsx)("span",{className:"text-xs text-muted-foreground",children:s.code})]})]},s.id))})]})]})})]})]}),(0,a.jsxs)("div",{className:"w-40",children:[(0,a.jsx)(es._,{children:"目標產量"}),(0,a.jsx)(O.I,{type:"number",placeholder:"數量",value:e.targetQuantity||"",onChange:e=>F(t,"targetQuantity",parseFloat(e.target.value)||0)})]}),(0,a.jsx)(S.z,{variant:"ghost",size:"sm",onClick:()=>P(t),className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:(0,a.jsx)(J.Z,{className:"h-4 w-4"})})]},t)})}),g.length>0&&(0,a.jsx)(S.z,{onClick:()=>{k(!0),setTimeout(()=>{try{if(!g.length||!d.length||!u.length){console.log("缺少必要資料:",{productionPlansCount:g.length,materialsCount:d.length,fragrancesCount:u.length}),k(!1);return}let e=new Map;g.forEach(t=>{if(!t.productId||!t.targetQuantity)return;let s=n.find(e=>e.id===t.productId);if(!s)return;if(console.log("計算產品物料需求:",{productName:s.name,targetQuantity:t.targetQuantity,fragranceFormula:s.fragranceFormula}),!s.fragranceFormula){console.error("錯誤：沒有香精配方資料");return}let{percentage:a,pgRatio:r,vgRatio:i}=s.fragranceFormula;if(!a||a<=0){console.error("錯誤：香精比例為0或無效");return}let l={fragrance:a,pg:r,vg:i};if(s.fragranceName&&"未指定"!==s.fragranceName){let a=t.targetQuantity*(l.fragrance/100),r=u.find(e=>e.code===s.fragranceCode||e.name===s.fragranceName||e.name.includes(s.fragranceName)||s.fragranceCode&&e.code.includes(s.fragranceCode)),n=r&&r.currentStock||0,i=r?"fragrance-".concat(r.id):"fragrance-".concat(s.fragranceCode);if(e.has(i)){let t=e.get(i);e.set(i,{...t,requiredQuantity:t.requiredQuantity+a})}else e.set(i,{id:r?r.id:"fragrance",type:"fragrance",code:s.fragranceCode,name:s.fragranceName,requiredQuantity:a,currentStock:n,unit:"KG",shortage:0,canProduce:n>=a})}let c=(0,et.n)(d,"pg");if(c){let s=t.targetQuantity*(l.pg/100),a="material-".concat(c.id);if(e.has(a)){let t=e.get(a);e.set(a,{...t,requiredQuantity:t.requiredQuantity+s})}else e.set(a,{id:c.id,type:"material",code:c.code,name:c.name,requiredQuantity:s,currentStock:c.currentStock||0,unit:c.unit||"KG",shortage:0,canProduce:(c.currentStock||0)>=s})}let o=(0,et.n)(d,"vg");if(o){let s=t.targetQuantity*(l.vg/100),a="material-".concat(o.id);if(e.has(a)){let t=e.get(a);e.set(a,{...t,requiredQuantity:t.requiredQuantity+s})}else e.set(a,{id:o.id,type:"material",code:o.code,name:o.name,requiredQuantity:s,currentStock:o.currentStock||0,unit:o.unit||"KG",shortage:0,canProduce:(o.currentStock||0)>=s})}let m=(0,et.n)(d,"nicotine");if(m&&s.nicotineMg&&s.nicotineMg>0){let a=t.targetQuantity*s.nicotineMg/250,r="material-".concat(m.id);if(e.has(r)){let t=e.get(r);e.set(r,{...t,requiredQuantity:t.requiredQuantity+a})}else e.set(r,{id:m.id,type:"material",code:m.code,name:m.name,requiredQuantity:a,currentStock:m.currentStock||0,unit:m.unit||"KG",shortage:0,canProduce:(m.currentStock||0)>=a})}s.specificMaterialNames&&s.specificMaterialNames.length>0&&s.specificMaterialNames.forEach(s=>{let a=d.find(e=>e.name===s);if(a){let s=t.targetQuantity,r="material-".concat(a.id);if(e.has(r)){let t=e.get(r);e.set(r,{...t,requiredQuantity:t.requiredQuantity+s})}else e.set(r,{id:a.id,type:"material",code:a.code,name:a.name,requiredQuantity:s,currentStock:a.currentStock||0,unit:a.unit||"個",shortage:0,canProduce:(a.currentStock||0)>=s})}}),s.commonMaterialNames&&s.commonMaterialNames.length>0&&s.commonMaterialNames.forEach(s=>{let a=d.find(e=>e.name===s);if(a){let s=t.targetQuantity,r="material-".concat(a.id);if(e.has(r)){let t=e.get(r);e.set(r,{...t,requiredQuantity:t.requiredQuantity+s})}else e.set(r,{id:a.id,type:"material",code:a.code,name:a.name,requiredQuantity:s,currentStock:a.currentStock||0,unit:a.unit||"個",shortage:0,canProduce:(a.currentStock||0)>=s})}})});let t=Array.from(e.values()).map(e=>({...e,shortage:Math.max(0,e.requiredQuantity-e.currentStock),canProduce:e.currentStock>=e.requiredQuantity}));t.sort((e,t)=>{let s=e=>"fragrance"===e.type?0:e.name.includes("PG")||e.name.includes("丙二醇")?1:e.name.includes("VG")||e.name.includes("甘油")?2:e.name.includes("尼古丁")||e.name.includes("丁鹽")?3:4,a=s(e),r=s(t);return a!==r?a-r:e.canProduce!==t.canProduce?e.canProduce?1:-1:e.name.localeCompare(t.name,"zh-TW")}),p(t),console.log("最終物料需求:",t)}catch(e){console.error("計算需求失敗:",e),i.Am.error("計算需求失敗")}finally{k(!1)}},500)},disabled:N,className:"w-full bg-green-600 hover:bg-green-700",children:N?(0,a.jsx)(a.Fragment,{children:"載入中..."}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(y.Z,{className:"mr-2 h-4 w-4"}),"計算物料需求"]})})]}),f.length>0&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold",children:"需求分析結果"}),(0,a.jsx)(R.C,{variant:U?"default":"destructive",className:"text-sm px-3 py-1",children:U?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(H.Z,{className:"h-4 w-4 mr-1"}),"可以生產"]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(ee.Z,{className:"h-4 w-4 mr-1"}),"庫存不足"]})})]}),(0,a.jsx)("div",{className:"rounded-md border",children:(0,a.jsxs)(L.iA,{children:[(0,a.jsx)(L.xD,{children:(0,a.jsxs)(L.SC,{className:U?"bg-green-50":"bg-red-50",children:[(0,a.jsx)(L.ss,{className:"font-semibold",children:"類型"}),(0,a.jsx)(L.ss,{className:"font-semibold",children:"代碼"}),(0,a.jsx)(L.ss,{className:"font-semibold",children:"名稱"}),(0,a.jsx)(L.ss,{className:"font-semibold text-right",children:"需要數量"}),(0,a.jsx)(L.ss,{className:"font-semibold text-right",children:"當前庫存"}),(0,a.jsx)(L.ss,{className:"font-semibold text-right",children:"短缺數量"}),(0,a.jsx)(L.ss,{className:"font-semibold text-center",children:"狀態"})]})}),(0,a.jsx)(L.RM,{children:f.map(e=>(0,a.jsxs)(L.SC,{className:"hover:bg-gray-50",children:[(0,a.jsx)(L.pj,{children:(0,a.jsx)(R.C,{variant:"outline",className:"".concat("material"===e.type?"text-blue-600 border-blue-200 bg-blue-50":"text-purple-600 border-purple-200 bg-purple-50"),children:"material"===e.type?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(w.Z,{className:"h-3 w-3 mr-1"}),"物料"]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(C.Z,{className:"h-3 w-3 mr-1"}),"香精"]})})}),(0,a.jsx)(L.pj,{className:"font-mono text-sm",children:e.code}),(0,a.jsx)(L.pj,{className:"font-medium",children:e.name}),(0,a.jsxs)(L.pj,{className:"text-right font-medium text-orange-600",children:[T(e.requiredQuantity)," ",e.unit]}),(0,a.jsxs)(L.pj,{className:"text-right",children:[e.currentStock," ",e.unit]}),(0,a.jsx)(L.pj,{className:"text-right",children:e.shortage>0?(0,a.jsxs)("span",{className:"text-red-600 font-medium",children:[e.shortage," ",e.unit]}):(0,a.jsx)("span",{className:"text-green-600",children:"-"})}),(0,a.jsx)(L.pj,{className:"text-center",children:e.canProduce?(0,a.jsxs)(R.C,{variant:"default",className:"bg-green-100 text-green-800",children:[(0,a.jsx)(H.Z,{className:"h-3 w-3 mr-1"}),"充足"]}):(0,a.jsxs)(R.C,{variant:"destructive",children:[(0,a.jsx)(ee.Z,{className:"h-3 w-3 mr-1"}),"不足"]})})]},"".concat(e.type,"-").concat(e.id)))})]})}),(0,a.jsxs)("div",{className:"p-4 rounded-lg border ".concat(U?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800"),children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[U?(0,a.jsx)(H.Z,{className:"h-5 w-5"}):(0,a.jsx)(v.Z,{className:"h-5 w-5"}),(0,a.jsx)("span",{className:"font-semibold",children:U?"生產評估：可以生產":"生產評估：庫存不足"})]}),(0,a.jsx)("p",{className:"text-sm",children:U?"所有必需的物料和香精庫存充足，可以按計畫進行生產。":"有 ".concat(f.filter(e=>!e.canProduce).length," 項物料/香精庫存不足，需要先補貨才能進行生產。")})]})]})]})]})})}var eh=s(51817),ef=s(23675);function ep(e){let{isOpen:t,onClose:s,item:l,onSuccess:c}=e,[o,d]=(0,r.useState)(l.currentStock.toString()),[m,u]=(0,r.useState)(""),[x,g]=(0,r.useState)(!1),h=async()=>{let e=parseFloat(o);if(isNaN(e)||e<0){i.Am.error("請輸入有效的庫存數量");return}if(e===l.currentStock){i.Am.error("新庫存數量與當前相同，無需更新");return}g(!0);try{let t=(0,n.$C)(),a=(0,n.V1)(t,"quickUpdateInventory");await a({itemId:l.id,itemType:l.type,newStock:e,remarks:m.trim()||"快速更新".concat("material"===l.type?"物料":"香精","庫存")}),i.Am.success("".concat(l.name," 庫存已更新為 ").concat(e," ").concat(l.unit)),c(),s()}catch(t){console.error("快速更新庫存失敗:",t);let e=t instanceof Error?t.message:"更新失敗";i.Am.error("更新失敗: ".concat(e))}finally{g(!1)}},f=parseFloat(o)-l.currentStock,p=(()=>{let e=parseFloat(o);return isNaN(e)?null:e<=l.minStock?{type:"warning",message:"警告：新庫存低於安全庫存！",color:"text-red-600 bg-red-50 border-red-200"}:e>=l.maxStock?{type:"info",message:"提示：新庫存高於最大庫存",color:"text-yellow-600 bg-yellow-50 border-yellow-200"}:null})();return(0,a.jsx)(K.Vq,{open:t,onOpenChange:s,children:(0,a.jsxs)(K.cZ,{className:"max-w-md",children:[(0,a.jsxs)(K.fK,{children:[(0,a.jsxs)(K.$N,{className:"flex items-center gap-2",children:["material"===l.type?(0,a.jsx)(w.Z,{className:"h-5 w-5 text-blue-600"}):(0,a.jsx)(C.Z,{className:"h-5 w-5 text-purple-600"}),"快速更新庫存"]}),(0,a.jsxs)(K.Be,{children:["快速調整 ",l.name," 的庫存數量，系統會自動記錄變更"]})]}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg space-y-2",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-sm text-gray-600",children:"項目代碼:"}),(0,a.jsx)("span",{className:"font-mono text-sm font-medium",children:l.code})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-sm text-gray-600",children:"項目名稱:"}),(0,a.jsx)("span",{className:"text-sm font-medium",children:l.name})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-sm text-gray-600",children:"當前庫存:"}),(0,a.jsxs)("span",{className:"text-sm font-medium",children:[l.currentStock," ",l.unit]})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-sm text-gray-600",children:"安全庫存:"}),(0,a.jsxs)("span",{className:"text-sm",children:[l.minStock," ",l.unit]})]})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(es._,{htmlFor:"newStock",children:"新庫存數量"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(O.I,{id:"newStock",type:"number",step:"0.01",min:"0",value:o,onChange:e=>d(e.target.value),className:"flex-1"}),(0,a.jsx)("div",{className:"flex items-center px-3 bg-gray-100 rounded-md text-sm text-gray-600",children:l.unit})]}),!isNaN(f)&&0!==f&&(0,a.jsxs)("div",{className:"text-sm font-medium ".concat(f>0?"text-green-600":f<0?"text-red-600":"text-gray-600"),children:["變化: ",f>0?"+":"",f," ",l.unit]})]}),p&&(0,a.jsxs)("div",{className:"p-3 rounded-lg border flex items-center gap-2 ".concat(p.color),children:[(0,a.jsx)(v.Z,{className:"h-4 w-4 flex-shrink-0"}),(0,a.jsx)("span",{className:"text-sm",children:p.message})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(es._,{htmlFor:"remarks",children:"備註 (選填)"}),(0,a.jsx)(ef.g,{id:"remarks",placeholder:"輸入更新原因或備註...",value:m,onChange:e=>u(e.target.value),rows:3})]})]}),(0,a.jsxs)(K.cN,{children:[(0,a.jsx)(S.z,{variant:"outline",onClick:s,disabled:x,children:"取消"}),(0,a.jsxs)(S.z,{onClick:h,disabled:x,children:[x&&(0,a.jsx)(eh.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"確認更新"]})]})]})})}let ej={globalLoading:{isLoading:!1,message:"",progress:void 0},notifications:[],sidebar:{isOpen:!0,isCollapsed:!1,activeSection:"dashboard"},modals:{},quickActions:{isOpen:!1,recentActions:[]},progressIndicators:{}},eb=()=>Math.random().toString(36).substr(2,9),eN=(0,T.U)()((0,U.tJ)((e,t)=>({...ej,setGlobalLoading:function(t){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",a=arguments.length>2?arguments[2]:void 0;return e(e=>({globalLoading:{isLoading:t,message:s,progress:a}}))},addNotification:t=>e(e=>({notifications:[{...t,id:eb(),timestamp:new Date,read:!1},...e.notifications].slice(0,50)})),markNotificationAsRead:t=>e(e=>({notifications:e.notifications.map(e=>e.id===t?{...e,read:!0}:e)})),clearNotifications:()=>e({notifications:[]}),setSidebarOpen:t=>e(e=>({sidebar:{...e.sidebar,isOpen:t}})),setSidebarCollapsed:t=>e(e=>({sidebar:{...e.sidebar,isCollapsed:t}})),setActiveSection:t=>e(e=>({sidebar:{...e.sidebar,activeSection:t}})),openModal:(t,s)=>e(e=>({modals:{...e.modals,[t]:{isOpen:!0,data:s}}})),closeModal:t=>e(e=>({modals:{...e.modals,[t]:{...e.modals[t],isOpen:!1}}})),toggleQuickActions:()=>e(e=>({quickActions:{...e.quickActions,isOpen:!e.quickActions.isOpen}})),addRecentAction:t=>e(e=>({quickActions:{...e.quickActions,recentActions:[{...t,timestamp:new Date},...e.quickActions.recentActions].slice(0,10)}})),setProgressIndicator:function(t,s,a){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"determinate";return e(e=>({progressIndicators:{...e.progressIndicators,[t]:{isVisible:!0,progress:s,message:a,type:r}}}))},addProgressIndicator:(t,s)=>e(e=>({progressIndicators:{...e.progressIndicators,[t]:s}})),updateProgressIndicator:(t,s)=>e(e=>({progressIndicators:{...e.progressIndicators,[t]:{...e.progressIndicators[t],...s}}})),removeProgressIndicator:t=>e(e=>{let s={...e.progressIndicators};return delete s[t],{progressIndicators:s}}),hideProgressIndicator:t=>e(e=>({progressIndicators:{...e.progressIndicators,[t]:{...e.progressIndicators[t],isVisible:!1}}})),showSuccessNotification:function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";t().addNotification({type:"success",title:e,message:s})},showErrorNotification:function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";t().addNotification({type:"error",title:e,message:s})},showWarningNotification:function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";t().addNotification({type:"warning",title:e,message:s})},showInfoNotification:function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";t().addNotification({type:"info",title:e,message:s})},toggleSidebar:()=>e(e=>({sidebar:{...e.sidebar,isOpen:!e.sidebar.isOpen}})),closeSidebar:()=>e(e=>({sidebar:{...e.sidebar,isOpen:!1}})),openSidebar:()=>e(e=>({sidebar:{...e.sidebar,isOpen:!0}})),closeAllModals:()=>e(e=>{let t={};return Object.keys(e.modals).forEach(s=>{t[s]={...e.modals[s],isOpen:!1}}),{modals:t}}),clearOldNotifications:t=>e(e=>{let s=new Date(Date.now()-t);return{notifications:e.notifications.filter(e=>e.timestamp>s)}})}),{name:"deer-lab-ui-store",storage:_,partialize:e=>({sidebar:e.sidebar,quickActions:{recentActions:e.quickActions.recentActions.slice(0,10)}})})),ev=()=>eN(e=>e.globalLoading),ey=()=>eN(e=>Object.entries(e.progressIndicators).filter(e=>{let[t,s]=e;return s.isVisible}).reduce((e,t)=>{let[s,a]=t;return e[s]=a,e},{}));var ew=s(55156);let ek=r.forwardRef((e,t)=>{let{className:s,orientation:r="horizontal",decorative:n=!0,...i}=e;return(0,a.jsx)(ew.f,{ref:t,decorative:n,orientation:r,className:(0,er.cn)("shrink-0 bg-border","horizontal"===r?"h-[1px] w-full":"h-full w-[1px]",s),...i})});ek.displayName=ew.f.displayName;var eC=s(60610);let eS=r.forwardRef((e,t)=>{let{className:s,value:r,showPercentage:n=!1,size:i="md",variant:l="default",...c}=e;return(0,a.jsxs)("div",{className:"relative w-full",children:[(0,a.jsx)(eC.fC,{ref:t,className:(0,er.cn)("relative overflow-hidden rounded-full bg-secondary","sm"===i&&"h-2","md"===i&&"h-3","lg"===i&&"h-4",s),...c,children:(0,a.jsx)(eC.z$,{className:(0,er.cn)("h-full w-full flex-1 transition-all duration-300 ease-in-out","default"===l&&"bg-gradient-to-r from-blue-500 to-blue-600","success"===l&&"bg-gradient-to-r from-green-500 to-green-600","warning"===l&&"bg-gradient-to-r from-yellow-500 to-orange-500","error"===l&&"bg-gradient-to-r from-red-500 to-red-600"),style:{transform:"translateX(-".concat(100-(r||0),"%)")}})}),n&&(0,a.jsxs)("div",{className:(0,er.cn)("absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xs font-medium text-white drop-shadow-sm","sm"===i&&"text-[10px]","lg"===i&&"text-sm"),children:[Math.round(r||0),"%"]})]})});eS.displayName=eC.fC.displayName;let eA=r.forwardRef((e,t)=>{let{className:s,value:r,size:n=40,strokeWidth:i=4,showPercentage:l=!0,variant:c="default",...o}=e,d=(n-i)/2,m=2*Math.PI*d;return(0,a.jsxs)("div",{ref:t,className:(0,er.cn)("relative inline-flex items-center justify-center",s),style:{width:n,height:n},...o,children:[(0,a.jsxs)("svg",{className:"transform -rotate-90",width:n,height:n,viewBox:"0 0 ".concat(n," ").concat(n),children:[(0,a.jsx)("circle",{className:"text-gray-200",strokeWidth:i,stroke:"currentColor",fill:"transparent",r:d,cx:n/2,cy:n/2}),(0,a.jsx)("circle",{className:(0,er.cn)("transition-all duration-300 ease-in-out",(()=>{switch(c){case"success":return"text-green-500";case"warning":return"text-yellow-500";case"error":return"text-red-500";default:return"text-blue-500"}})()),strokeWidth:i,strokeDasharray:m,strokeDashoffset:m-r/100*m,strokeLinecap:"round",stroke:"currentColor",fill:"transparent",r:d,cx:n/2,cy:n/2})]}),l&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,a.jsxs)("span",{className:"text-xs font-medium text-gray-700",children:[Math.round(r),"%"]})})]})});function eO(){let e=ev(),t=ey();return e.isLoading||0!==Object.keys(t).length?(0,a.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm",children:(0,a.jsx)(A.Zb,{className:"w-full max-w-md mx-4 shadow-xl",children:(0,a.jsx)(A.aY,{className:"p-6",children:e.isLoading&&(0,a.jsxs)("div",{className:"text-center space-y-4",children:[(0,a.jsx)("div",{className:"flex items-center justify-center",children:"number"==typeof e.progress?(0,a.jsx)(eA,{value:e.progress,size:60,strokeWidth:4,showPercentage:!0}):(0,a.jsx)(eh.Z,{className:"h-12 w-12 animate-spin text-blue-500"})}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"載入中..."}),e.message&&(0,a.jsx)("p",{className:"text-sm text-gray-600",children:e.message}),"number"==typeof e.progress&&(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)(eS,{value:e.progress,variant:"default",size:"md"}),(0,a.jsxs)("p",{className:"text-xs text-gray-500",children:[Math.round(e.progress),"% 完成"]})]})]})]})})})}):null}function eI(){let e=ey();return 0===Object.keys(e).length?null:(0,a.jsx)("div",{className:"fixed bottom-4 right-4 z-40 space-y-2 max-w-sm",children:Object.entries(e).map(e=>{let[t,s]=e;return(0,a.jsx)(eZ,{indicator:s,onClose:()=>{}},t)})})}function eZ(e){let{indicator:t,onClose:s}=e;return t.isVisible?(0,a.jsx)(A.Zb,{className:"shadow-lg border-l-4 border-l-blue-500 bg-white/95 backdrop-blur-sm",children:(0,a.jsxs)(A.aY,{className:"p-3 space-y-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[t.progress>=100?(0,a.jsx)(H.Z,{className:"h-4 w-4 text-green-500"}):t.progress<0?(0,a.jsx)(ee.Z,{className:"h-4 w-4 text-red-500"}):"indeterminate"===t.type?(0,a.jsx)(eh.Z,{className:"h-4 w-4 animate-spin text-blue-500"}):(0,a.jsx)(v.Z,{className:"h-4 w-4 text-orange-500"}),(0,a.jsx)("span",{className:"text-sm font-medium text-gray-900 flex-1",children:t.message}),s&&(0,a.jsx)("button",{onClick:s,className:"text-gray-400 hover:text-gray-600 text-xs",children:"\xd7"})]}),"determinate"===t.type&&(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)(eS,{value:Math.max(0,Math.min(100,t.progress)),variant:t.progress>=100?"success":t.progress<0?"error":"default",size:"sm"}),(0,a.jsxs)("div",{className:"flex justify-between text-xs text-gray-500",children:[(0,a.jsxs)("span",{children:[Math.round(t.progress),"%"]}),(0,a.jsx)("span",{children:t.progress>=100?"完成":t.progress<0?"失敗":"進行中"})]})]})]})}):null}function eE(e){let{total:t,completed:s,failed:r,currentOperation:n,onCancel:i}=e,l=s/(s+r)*100||0;return(0,a.jsx)(A.Zb,{className:"w-full max-w-md",children:(0,a.jsxs)(A.aY,{className:"p-4 space-y-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h3",{className:"font-semibold text-gray-900",children:"批量操作進度"}),i&&(0,a.jsx)("button",{onClick:i,className:"text-sm text-gray-500 hover:text-gray-700",children:"取消"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex justify-between text-sm text-gray-600",children:[(0,a.jsx)("span",{children:"整體進度"}),(0,a.jsxs)("span",{children:[s+r," / ",t]})]}),(0,a.jsx)(eS,{value:(s+r)/t*100,variant:"default",size:"md"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,a.jsxs)("div",{className:"text-green-600",children:[(0,a.jsx)("span",{className:"font-medium",children:"成功: "}),(0,a.jsx)("span",{children:s})]}),(0,a.jsxs)("div",{className:"text-red-600",children:[(0,a.jsx)("span",{className:"font-medium",children:"失敗: "}),(0,a.jsx)("span",{children:r})]})]}),s>0&&(0,a.jsxs)("div",{className:"text-xs text-gray-500",children:["成功率: ",Math.round(l),"%"]}),n&&(0,a.jsxs)("div",{className:"text-sm text-blue-600 flex items-center gap-2",children:[(0,a.jsx)(eh.Z,{className:"h-3 w-3 animate-spin"}),(0,a.jsx)("span",{children:n})]})]})})}eA.displayName="CircularProgress";var eM=s(70933),ez=s(32489),eF=s(33276),eL=s(61094),eR=s(69076);function eP(e){let{onClose:t}=e,{batchOperations:s,selectedItems:n,getSelectedItems:l,enableBatchMode:c,disableBatchMode:o,addBatchUpdate:d,removeBatchUpdate:m,clearBatchUpdates:u,applyBatchUpdates:x,selectAll:g,selectNone:h,clearSelections:f}=$(),{addProgressIndicator:p,updateProgressIndicator:j,removeProgressIndicator:b}=eN(),[N,v]=(0,r.useState)(""),[y,k]=(0,r.useState)(""),[I,Z]=(0,r.useState)(!1),E=l(),M=E.materials.length+E.fragrances.length,z=Object.keys(s.pendingUpdates).length,F=(0,r.useCallback)(()=>{c(),i.Am.success("已啟用批量操作模式")},[c]),L=(0,r.useCallback)(()=>{o(),t(),i.Am.info("已停用批量操作模式")},[o,t]),P=async()=>{if(0===z){i.Am.warning("沒有待應用的更新");return}Z(!0);let e="batch-operations";p(e,{isVisible:!0,progress:0,message:"準備批量更新 ".concat(z," 個項目..."),type:"determinate"});try{let t=Object.entries(s.pendingUpdates),a=0;for(let[s,r]of t)j(e,{progress:a/t.length*100,message:"更新項目 ".concat(a+1,"/").concat(t.length,"...")}),await new Promise(e=>setTimeout(e,200)),a++;await x(),j(e,{progress:100,message:"批量更新完成"}),setTimeout(()=>{b(e)},1e3),i.Am.success("成功更新 ".concat(z," 個項目")),f()}catch(t){j(e,{progress:-1,message:"批量更新失敗"}),setTimeout(()=>{b(e)},2e3),i.Am.error("批量更新失敗")}finally{Z(!1)}};return(0,a.jsxs)(A.Zb,{className:"w-full max-w-2xl mx-auto",children:[(0,a.jsx)(A.Ol,{children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)(A.ll,{className:"flex items-center gap-2 text-purple-700",children:[(0,a.jsx)(eM.Z,{className:"h-5 w-5"}),"批量操作面板"]}),(0,a.jsx)(S.z,{onClick:L,variant:"ghost",size:"sm",children:(0,a.jsx)(ez.Z,{className:"h-4 w-4"})})]})}),(0,a.jsx)(A.aY,{className:"space-y-6",children:s.isEnabled?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{className:"font-medium mb-3",children:"選擇控制"}),(0,a.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,a.jsxs)(S.z,{onClick:()=>{g("materials"),i.Am.success("已選擇所有物料")},variant:"outline",size:"sm",children:[(0,a.jsx)(w.Z,{className:"mr-2 h-3 w-3"}),"全選物料"]}),(0,a.jsxs)(S.z,{onClick:()=>{g("fragrances"),i.Am.success("已選擇所有香精")},variant:"outline",size:"sm",children:[(0,a.jsx)(C.Z,{className:"mr-2 h-3 w-3"}),"全選香精"]}),(0,a.jsxs)(S.z,{onClick:()=>{h("materials"),h("fragrances"),i.Am.info("已清空選擇")},variant:"outline",size:"sm",children:[(0,a.jsx)(eL.Z,{className:"mr-2 h-3 w-3"}),"清空選擇"]})]}),(0,a.jsxs)("div",{className:"mt-2 flex items-center gap-4 text-sm text-gray-600",children:[(0,a.jsxs)("span",{children:["已選擇: ",M," 個項目"]}),(0,a.jsxs)("span",{children:["待更新: ",z," 個項目"]})]})]}),(0,a.jsx)(ek,{}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{className:"font-medium mb-3",children:"批量更新設定"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-1",children:"新庫存量"}),(0,a.jsx)(O.I,{type:"number",placeholder:"輸入新的庫存數量",value:N,onChange:e=>v(e.target.value)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-1",children:"更新原因"}),(0,a.jsx)(O.I,{placeholder:"輸入更新原因",value:y,onChange:e=>k(e.target.value)})]})]}),(0,a.jsxs)("div",{className:"flex gap-2 mt-4",children:[(0,a.jsxs)(S.z,{onClick:()=>{if(!N||!y){i.Am.error("請輸入數量和原因");return}let e=parseFloat(N);if(isNaN(e)){i.Am.error("請輸入有效的數量");return}let t=[...E.materials,...E.fragrances];t.forEach(t=>{d(t.id,e,y)}),v(""),k(""),i.Am.success("已為 ".concat(t.length," 個項目添加批量更新"))},disabled:0===M,className:"flex-1",variant:"outline",children:[(0,a.jsx)(X.Z,{className:"mr-2 h-4 w-4"}),"為選中項目添加更新"]}),(0,a.jsx)(S.z,{onClick:u,disabled:0===z,variant:"ghost",size:"sm",children:(0,a.jsx)(eR.Z,{className:"h-4 w-4"})})]})]}),(0,a.jsx)(ek,{}),z>0&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("h4",{className:"font-medium mb-3",children:["待更新項目 (",z,")"]}),(0,a.jsx)("div",{className:"max-h-32 overflow-y-auto space-y-2",children:Object.entries(s.pendingUpdates).map(e=>{let[t,s]=e;return(0,a.jsxs)("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded",children:[(0,a.jsx)("span",{className:"text-sm font-mono",children:t}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(R.C,{variant:"secondary",children:s.quantity}),(0,a.jsx)("span",{className:"text-xs text-gray-500",children:s.reason}),(0,a.jsx)(S.z,{onClick:()=>m(t),variant:"ghost",size:"sm",children:(0,a.jsx)(ez.Z,{className:"h-3 w-3"})})]})]},t)})})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(S.z,{onClick:P,disabled:0===z||I,className:"flex-1 bg-green-600 hover:bg-green-700",children:I?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"mr-2 h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"}),"執行中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(eF.Z,{className:"mr-2 h-4 w-4"}),"應用批量更新"]})}),(0,a.jsx)(S.z,{onClick:L,variant:"outline",children:"取消"})]}),I&&z>0&&(0,a.jsx)(eE,{total:z,completed:0,failed:0,currentOperation:"正在更新庫存...",onCancel:()=>Z(!1)})]}):(0,a.jsxs)("div",{className:"text-center py-6",children:[(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)(eM.Z,{className:"h-12 w-12 text-gray-400 mx-auto mb-2"}),(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-700",children:"批量操作模式"}),(0,a.jsx)("p",{className:"text-gray-500",children:"啟用後可以批量選擇和修改庫存項目"})]}),(0,a.jsxs)(S.z,{onClick:F,className:"bg-purple-600 hover:bg-purple-700",children:[(0,a.jsx)(eF.Z,{className:"mr-2 h-4 w-4"}),"啟用批量操作"]})]})})]})}var eT=s(71245);function eU(){var e,t;let{appUser:s}=(0,eT.a)(),{setGlobalLoading:l,addProgressIndicator:c,updateProgressIndicator:o,removeProgressIndicator:d}=eN(),[m,u]=(0,r.useState)(null),[x,g]=(0,r.useState)(!0),[h,Z]=(0,r.useState)("materials"),[E,z]=(0,r.useState)(""),{data:F,loading:L,refetch:R}=j(()=>f(void 0),"materials-all",e),{data:P,loading:T,refetch:U}=j(()=>p(void 0),"fragrances-all",t),q=L||T,[_,Q]=(0,r.useState)(!1),[V,D]=(0,r.useState)(!1),[G,Y]=(0,r.useState)(!1),[$,K]=(0,r.useState)(!1),[X,J]=(0,r.useState)(null),[H,ee]=(0,r.useState)(!1),et=(0,r.useCallback)(async()=>{if(!x){g(!0),l(!0,"載入庫存統計中...");try{let e=(0,n.$C)(),t=(0,n.V1)(e,"getInventoryOverview"),s=(await t({})).data;s.success&&(u(s.overview),i.Am.success("庫存統計載入完成"))}catch(e){console.error("載入庫存總覽失敗:",e),i.Am.error("載入庫存總覽失敗")}finally{g(!1),l(!1)}}},[l]),es=(0,r.useCallback)(async()=>{let e="inventory-reload";c(e,{isVisible:!0,progress:0,message:"載入庫存資料...",type:"determinate"});try{o(e,{progress:30,message:"載入物料清單..."}),await R(),o(e,{progress:70,message:"載入香精清單..."}),await U(),o(e,{progress:100,message:"載入完成"}),setTimeout(()=>{d(e)},1e3),i.Am.success("庫存資料重新載入完成")}catch(t){o(e,{progress:-1,message:"載入失敗"}),setTimeout(()=>{d(e)},2e3),i.Am.error("重新載入失敗")}},[R,U,c,o,d]),ea=(0,r.useCallback)(async()=>{l(!0,"正在刷新所有資料...");try{await Promise.all([(async()=>{let e=(0,n.$C)(),t=(0,n.V1)(e,"getInventoryOverview"),s=(await t({})).data;s.success&&u(s.overview)})(),es()])}finally{l(!1)}},[es,l]),er=(0,r.useCallback)(e=>{J(e),Y(!0)},[]),en=(0,r.useCallback)(()=>{let e="materials"===h?F||[]:P||[];if(!E.trim())return e;let t=E.toLowerCase();return e.filter(e=>{var s,a;return e.name.toLowerCase().includes(t)||e.code.toLowerCase().includes(t)||(null===(s=e.category)||void 0===s?void 0:s.toLowerCase().includes(t))||(null===(a=e.series)||void 0===a?void 0:a.toLowerCase().includes(t))})},[h,F,P,E]);(0,r.useEffect)(()=>{H||(ee(!0),et())},[H,et]);let ei=en();return(0,a.jsxs)("div",{className:"container mx-auto py-8 space-y-8",children:[(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent",children:"庫存管理中心"}),(0,a.jsx)("p",{className:"text-gray-600 mt-2",children:"全方位庫存監控與管理系統"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)(S.z,{onClick:es,variant:"outline",className:"flex items-center gap-2",children:[(0,a.jsx)(b.Z,{className:"h-4 w-4"}),"重新載入資料"]}),(0,a.jsxs)(S.z,{onClick:ea,className:"flex items-center gap-2 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700",children:[(0,a.jsx)(b.Z,{className:"h-4 w-4"}),"完整刷新"]})]})]}),(0,a.jsx)(M,{overview:m,loading:x}),(0,a.jsxs)(A.Zb,{className:"border-orange-200 bg-gradient-to-r from-orange-50 to-amber-50",children:[(0,a.jsxs)(A.Ol,{children:[(0,a.jsxs)(A.ll,{className:"flex items-center gap-2 text-orange-800",children:[(0,a.jsx)(N.Z,{className:"h-5 w-5"}),"快速操作"]}),(0,a.jsx)(A.SZ,{children:"一鍵執行常用的庫存管理操作"})]}),(0,a.jsx)(A.aY,{children:(0,a.jsxs)("div",{className:"flex flex-wrap gap-3",children:[(0,a.jsxs)(S.z,{onClick:()=>Q(!0),className:"bg-red-600 hover:bg-red-700 text-white",children:[(0,a.jsx)(v.Z,{className:"mr-2 h-4 w-4"}),"查看低庫存項目"]}),(0,a.jsxs)(S.z,{onClick:()=>D(!0),className:"bg-green-600 hover:bg-green-700 text-white",children:[(0,a.jsx)(y.Z,{className:"mr-2 h-4 w-4"}),"生產能力評估"]}),(0,a.jsxs)(S.z,{onClick:()=>K(!0),className:"bg-purple-600 hover:bg-purple-700 text-white",children:[(0,a.jsx)(w.Z,{className:"mr-2 h-4 w-4"}),"批量操作"]})]})})]}),(0,a.jsxs)(A.Zb,{children:[(0,a.jsxs)(A.Ol,{children:[(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[(0,a.jsxs)(A.ll,{className:"flex items-center gap-2",children:[(0,a.jsx)(w.Z,{className:"h-5 w-5 text-blue-600"}),"庫存清單"]}),(0,a.jsxs)("div",{className:"relative w-full sm:w-80",children:[(0,a.jsx)(k.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),(0,a.jsx)(O.I,{placeholder:"搜尋".concat("materials"===h?"物料":"香精","名稱、代碼、分類..."),value:E,onChange:e=>z(e.target.value),className:"pl-10"})]})]}),(0,a.jsx)(A.SZ,{children:"點擊庫存數量可快速修改，系統會自動記錄變更"})]}),(0,a.jsx)(A.aY,{children:(0,a.jsxs)(I.mQ,{value:h,onValueChange:e=>Z(e),children:[(0,a.jsxs)(I.dr,{className:"grid w-full grid-cols-2 mb-6",children:[(0,a.jsxs)(I.SP,{value:"materials",className:"flex items-center gap-2",children:[(0,a.jsx)(w.Z,{className:"h-4 w-4"}),"物料 (",(null==F?void 0:F.length)||0,")"]}),(0,a.jsxs)(I.SP,{value:"fragrances",className:"flex items-center gap-2",children:[(0,a.jsx)(C.Z,{className:"h-4 w-4"}),"香精 (",(null==P?void 0:P.length)||0,")"]})]}),(0,a.jsx)(I.nU,{value:"materials",children:(0,a.jsx)(B,{items:ei,loading:q,onQuickUpdate:er,type:"material"})}),(0,a.jsx)(I.nU,{value:"fragrances",children:(0,a.jsx)(B,{items:ei,loading:q,onQuickUpdate:er,type:"fragrance"})})]})})]}),(0,a.jsx)(W,{isOpen:_,onClose:()=>Q(!1)}),(0,a.jsx)(eg,{isOpen:V,onClose:()=>D(!1)}),X&&(0,a.jsx)(ep,{isOpen:G,onClose:()=>{Y(!1),J(null)},item:X,onSuccess:async()=>{await es(),await et()}}),$&&(0,a.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4",children:(0,a.jsx)(eP,{onClose:()=>K(!1)})}),(0,a.jsx)(eO,{}),(0,a.jsx)(eI,{})]})}},69174:function(e,t,s){"use strict";s.d(t,{C:function(){return c}});var a=s(57437);s(2265);var r=s(37053),n=s(90535),i=s(93448);let l=(0,n.j)("inline-flex items-center justify-center rounded-full px-2 py-1 text-xs font-medium focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"bg-blue-100 text-blue-700",secondary:"bg-muted text-muted-foreground",destructive:"bg-red-100 text-red-700",outline:"text-foreground border border-border",success:"bg-green-100 text-green-700",warning:"bg-yellow-100 text-yellow-700",purple:"bg-purple-100 text-purple-700"}},defaultVariants:{variant:"default"}});function c(e){let{className:t,variant:s,asChild:n=!1,...c}=e,o=n?r.g7:"span";return(0,a.jsx)(o,{"data-slot":"badge",className:(0,i.cn)(l({variant:s}),t),...c})}},79820:function(e,t,s){"use strict";s.d(t,{Ol:function(){return i},SZ:function(){return c},Zb:function(){return n},aY:function(){return o},eW:function(){return d},ll:function(){return l}});var a=s(57437);s(2265);var r=s(93448);function n(e){let{className:t,...s}=e;return(0,a.jsx)("div",{"data-slot":"card",className:(0,r.cn)("bg-card text-card-foreground flex flex-col gap-6 rounded-lg border-2 p-6 shadow-md",t),...s})}function i(e){let{className:t,...s}=e;return(0,a.jsx)("div",{"data-slot":"card-header",className:(0,r.cn)("@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 has-data-[slot=card-action]:grid-cols-[1fr_auto]",t),...s})}function l(e){let{className:t,...s}=e;return(0,a.jsx)("div",{"data-slot":"card-title",className:(0,r.cn)("leading-none font-semibold",t),...s})}function c(e){let{className:t,...s}=e;return(0,a.jsx)("div",{"data-slot":"card-description",className:(0,r.cn)("text-muted-foreground text-sm",t),...s})}function o(e){let{className:t,...s}=e;return(0,a.jsx)("div",{"data-slot":"card-content",className:(0,r.cn)("",t),...s})}function d(e){let{className:t,...s}=e;return(0,a.jsx)("div",{"data-slot":"card-footer",className:(0,r.cn)("flex items-center",t),...s})}},68245:function(e,t,s){"use strict";s.d(t,{X:function(){return l}});var a=s(57437);s(2265);var r=s(9270),n=s(30401),i=s(93448);function l(e){let{className:t,...s}=e;return(0,a.jsx)(r.fC,{"data-slot":"checkbox",className:(0,i.cn)("peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",t),...s,children:(0,a.jsx)(r.z$,{"data-slot":"checkbox-indicator",className:"flex items-center justify-center text-current transition-none",children:(0,a.jsx)(n.Z,{className:"size-3.5"})})})}},74291:function(e,t,s){"use strict";s.d(t,{$N:function(){return g},Be:function(){return h},Vq:function(){return c},cN:function(){return x},cZ:function(){return m},fK:function(){return u}});var a=s(57437),r=s(2265),n=s(49027),i=s(32489),l=s(93448);let c=n.fC;n.xz;let o=n.h_;n.x8;let d=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,a.jsx)(n.aV,{ref:t,className:(0,l.cn)("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...r})});d.displayName=n.aV.displayName;let m=r.forwardRef((e,t)=>{let{className:s,children:r,...c}=e;return(0,a.jsxs)(o,{children:[(0,a.jsx)(d,{}),(0,a.jsxs)(n.VY,{ref:t,className:(0,l.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-2xl translate-x-[-50%] translate-y-[-50%] gap-4 border-2 border-border bg-background shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] rounded-lg max-h-[90vh] overflow-y-auto","p-4 sm:p-6 mx-2 sm:mx-0","max-w-[calc(100vw-1rem)] sm:max-w-lg md:max-w-xl lg:max-w-2xl","max-h-[95vh] sm:max-h-[90vh]",s),...c,children:[r,(0,a.jsxs)(n.x8,{className:"absolute right-3 top-3 sm:right-4 sm:top-4 z-10 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground p-1",children:[(0,a.jsx)(i.Z,{className:"h-5 w-5 sm:h-4 sm:w-4"}),(0,a.jsx)("span",{className:"sr-only",children:"關閉"})]})]})]})});m.displayName=n.VY.displayName;let u=e=>{let{className:t,...s}=e;return(0,a.jsx)("div",{className:(0,l.cn)("flex flex-col space-y-1.5 text-center sm:text-left pb-4 border-b border-border",t),...s})};u.displayName="DialogHeader";let x=e=>{let{className:t,...s}=e;return(0,a.jsx)("div",{className:(0,l.cn)("flex flex-col-reverse sm:flex-row sm:justify-end gap-2 sm:gap-0 sm:space-x-2 pt-4 border-t border-border","[&>*]:w-full sm:[&>*]:w-auto",t),...s})};x.displayName="DialogFooter";let g=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,a.jsx)(n.Dx,{ref:t,className:(0,l.cn)("text-xl sm:text-2xl font-bold flex items-center gap-2 sm:gap-3 leading-tight",s),...r})});g.displayName=n.Dx.displayName;let h=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,a.jsx)(n.dk,{ref:t,className:(0,l.cn)("text-sm text-muted-foreground",s),...r})});h.displayName=n.dk.displayName},40279:function(e,t,s){"use strict";s.d(t,{I:function(){return i}});var a=s(57437),r=s(2265),n=s(93448);let i=r.forwardRef((e,t)=>{let{className:s,type:r,...i}=e;return(0,a.jsx)("input",{type:r,className:(0,n.cn)("flex w-full rounded-md border border-slate-200 bg-white px-3 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-800 dark:bg-slate-950 dark:ring-offset-slate-950 dark:placeholder:text-slate-400 dark:focus-visible:ring-slate-300","h-11 sm:h-10 py-3 sm:py-2","text-base sm:text-sm","min-h-[44px]",s),ref:t,...i})});i.displayName="Input"},75060:function(e,t,s){"use strict";s.d(t,{_:function(){return i}});var a=s(57437);s(2265);var r=s(6394),n=s(93448);function i(e){let{className:t,...s}=e;return(0,a.jsx)(r.f,{"data-slot":"label",className:(0,n.cn)("flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",t),...s})}},12749:function(e,t,s){"use strict";s.d(t,{J2:function(){return l},xo:function(){return c},yk:function(){return o}});var a=s(57437),r=s(2265),n=s(27312),i=s(93448);let l=n.fC,c=n.xz,o=r.forwardRef((e,t)=>{let{className:s,align:r="center",sideOffset:l=4,...c}=e;return(0,a.jsx)(n.h_,{children:(0,a.jsx)(n.VY,{ref:t,align:r,sideOffset:l,className:(0,i.cn)("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2","max-w-[calc(100vw-2rem)] sm:w-72",s),...c})})});o.displayName=n.VY.displayName},69140:function(e,t,s){"use strict";s.d(t,{O:function(){return n}});var a=s(57437);s(2265);var r=s(93448);function n(e){let{className:t,...s}=e;return(0,a.jsx)("div",{className:(0,r.cn)("animate-pulse rounded-md bg-muted",t),...s})}},33804:function(e,t,s){"use strict";s.d(t,{RM:function(){return l},SC:function(){return c},iA:function(){return n},pj:function(){return d},ss:function(){return o},xD:function(){return i}});var a=s(57437);s(2265);var r=s(93448);function n(e){let{className:t,...s}=e;return(0,a.jsx)("div",{"data-slot":"table-container",className:"relative w-full overflow-x-auto",children:(0,a.jsx)("table",{"data-slot":"table",className:(0,r.cn)("w-full caption-bottom text-sm",t),...s})})}function i(e){let{className:t,...s}=e;return(0,a.jsx)("thead",{"data-slot":"table-header",className:(0,r.cn)("",t),...s})}function l(e){let{className:t,...s}=e;return(0,a.jsx)("tbody",{"data-slot":"table-body",className:(0,r.cn)("[&_tr:last-child]:border-0",t),...s})}function c(e){let{className:t,...s}=e;return(0,a.jsx)("tr",{"data-slot":"table-row",className:(0,r.cn)("hover:bg-muted/50 data-[state=selected]:bg-muted border-b border-border transition-colors",t),...s})}function o(e){let{className:t,...s}=e;return(0,a.jsx)("th",{"data-slot":"table-head",className:(0,r.cn)("bg-muted text-foreground font-semibold border-b border-border p-3 text-left align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",t),...s})}function d(e){let{className:t,...s}=e;return(0,a.jsx)("td",{"data-slot":"table-cell",className:(0,r.cn)("p-3 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",t),...s})}},17168:function(e,t,s){"use strict";s.d(t,{SP:function(){return o},dr:function(){return c},mQ:function(){return l},nU:function(){return d}});var a=s(57437),r=s(2265),n=s(20271),i=s(93448);let l=n.fC,c=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,a.jsx)(n.aV,{ref:t,className:(0,i.cn)("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",s),...r})});c.displayName=n.aV.displayName;let o=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,a.jsx)(n.xz,{ref:t,className:(0,i.cn)("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",s),...r})});o.displayName=n.xz.displayName;let d=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,a.jsx)(n.VY,{ref:t,className:(0,i.cn)("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",s),...r})});d.displayName=n.VY.displayName},23675:function(e,t,s){"use strict";s.d(t,{g:function(){return i}});var a=s(57437),r=s(2265),n=s(93448);let i=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,a.jsx)("textarea",{className:(0,n.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),ref:t,...r})});i.displayName="Textarea"},71245:function(e,t,s){"use strict";s.d(t,{H:function(){return m},a:function(){return u}});var a=s(57437),r=s(2265),n=s(82148),i=s(46410),l=s(5978),c=s(14438),o=s(47903);let d=(0,r.createContext)({user:null,appUser:null,isLoading:!0,login:async()=>!1,logout:async()=>{},hasPermission:()=>!1,hasAnyPermission:()=>!1,hasAllPermissions:()=>!1}),m=e=>{let{children:t}=e,[s,m]=(0,r.useState)(null),[u,x]=(0,r.useState)(null),[g,h]=(0,r.useState)(!0),f=async e=>{(0,o.fF)("loadUserData 開始執行",{uid:e.uid});try{let t=(0,i.T)();if(!t){(0,o.vU)("Firestore 未初始化"),x(null);return}(0,o.fF)("獲取用戶文檔",{uid:e.uid});let s=await (0,l.QT)((0,l.doc)(t,"users",e.uid));if(s.exists()){(0,o.fF)("用戶文檔存在");let e=s.data();if((0,o.fF)("用戶資料",e),e.roleRef){(0,o.fF)("用戶有角色引用，獲取角色資料");try{let t=await (0,l.QT)(e.roleRef);if(t.exists()){let s=t.data();e.roleName=s.displayName||s.name,e.permissions=s.permissions||[],(0,o.fF)("角色資料載入成功",{role:e.roleName,permissions:e.permissions})}else(0,o.ZK)("角色文檔不存在")}catch(e){(0,o.vU)("載入角色資料失敗",e)}}else(0,o.ZK)("用戶沒有角色引用");(0,o.fF)("設置 appUser",e),x(e)}else(0,o.ZK)("用戶文檔不存在"),x(null)}catch(e){(0,o.vU)("載入用戶資料失敗",e),x(null)}},p=async(e,t)=>{try{let s=(0,i.E7)();if(!s)return c.Am.error("系統初始化失敗"),!1;let a=e.includes("@")?e:"".concat(e,"@deer-lab.local"),r=await (0,n.e5)(s,a,t);return await f(r.user),c.Am.success("登入成功！"),!0}catch(e){return(0,o.vU)("登入失敗",e),c.Am.error(e.message||"登入失敗"),!1}},j=async()=>{try{let e=(0,i.E7)();e&&(await (0,n.w7)(e),m(null),x(null),c.Am.success("已成功登出"),window.location.href="/")}catch(e){(0,o.vU)("登出失敗",e),c.Am.error("登出失敗")}};return(0,r.useEffect)(()=>{(0,o.fF)("AuthContext useEffect 開始執行");try{let e=(0,i.E7)();if(!e){(0,o.vU)("Auth 未初始化，設置 isLoading = false"),h(!1);return}(0,o.fF)("設置 onAuthStateChanged 監聽器");let t=(0,n.Aj)(e,async e=>{try{(0,o.fF)("onAuthStateChanged 觸發",{uid:(null==e?void 0:e.uid)||null}),e?(m(e),(0,o.fF)("開始載入用戶資料"),await f(e)):(m(null),x(null),(0,o.fF)("用戶已登出，清除狀態")),h(!1),(0,o.fF)("設置 isLoading = false")}catch(e){(0,o.vU)("onAuthStateChanged 回調執行失敗",e),h(!1)}});return()=>{(0,o.fF)("清理 onAuthStateChanged 監聽器"),"function"==typeof t&&t()}}catch(e){(0,o.vU)("AuthContext useEffect 執行失敗",e),h(!1)}},[]),(0,a.jsx)(d.Provider,{value:{user:s,appUser:u,isLoading:g,login:p,logout:j,hasPermission:e=>null!=u&&!!u.permissions&&u.permissions.includes(e),hasAnyPermission:e=>null!=u&&!!u.permissions&&e.some(e=>u.permissions.includes(e)),hasAllPermissions:e=>null!=u&&!!u.permissions&&e.every(e=>u.permissions.includes(e))},children:t})},u=()=>(0,r.useContext)(d)},69958:function(e,t,s){"use strict";s.d(t,{n:function(){return r}});let a={PG_MATERIAL_CODES:["UV3404503","PG"],VG_MATERIAL_CODES:["UV3400698","VG"],NICOTINE_MATERIAL_CODES:["UV3405520","NIC","丁鹽","尼古丁"],PG_MATERIAL_NAMES:["PG丙二醇","PG","丙二醇"],VG_MATERIAL_NAMES:["VG甘油","VG","甘油"],NICOTINE_MATERIAL_NAMES:["丁鹽","尼古丁","NicSalt"]},r=(e,t)=>e.find(e=>{var s;let r=(null===(s=e.code)||void 0===s?void 0:s.toUpperCase())||"",n=e.name||"";switch(t){case"pg":return a.PG_MATERIAL_CODES.some(e=>r.includes(e))||a.PG_MATERIAL_NAMES.some(e=>n.includes(e));case"vg":return a.VG_MATERIAL_CODES.some(e=>r.includes(e))||a.VG_MATERIAL_NAMES.some(e=>n.includes(e));case"nicotine":return a.NICOTINE_MATERIAL_CODES.some(e=>r.includes(e))||a.NICOTINE_MATERIAL_NAMES.some(e=>n.includes(e));default:return!1}})}},function(e){e.O(0,[3609,9015,3676,5569,4438,9436,3909,2696,4116,2980,196,2365,2971,2117,1744],function(){return e(e.s=44742)}),_N_E=e.O()}]);