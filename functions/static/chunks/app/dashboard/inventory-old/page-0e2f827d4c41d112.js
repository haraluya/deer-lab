(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4746],{59801:function(e,s,t){Promise.resolve().then(t.bind(t,39730))},44794:function(e,s,t){"use strict";t.d(s,{Z:function(){return r}});let r=(0,t(79205).Z)("Package",[["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}],["path",{d:"M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z",key:"hh9hay"}],["path",{d:"m3.3 7 8.7 5 8.7-5",key:"g66t2b"}],["path",{d:"M12 22V12",key:"d0xqtd"}]])},99397:function(e,s,t){"use strict";t.d(s,{Z:function(){return r}});let r=(0,t(79205).Z)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},73247:function(e,s,t){"use strict";t.d(s,{Z:function(){return r}});let r=(0,t(79205).Z)("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]])},3085:function(e,s,t){"use strict";t.d(s,{Z:function(){return r}});let r=(0,t(79205).Z)("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]])},76865:function(e,s,t){"use strict";t.d(s,{Z:function(){return r}});let r=(0,t(79205).Z)("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},37683:function(e,s,t){"use strict";t.d(s,{Z:function(){return r}});let r=(0,t(79205).Z)("Warehouse",[["path",{d:"M22 8.35V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8.35A2 2 0 0 1 3.26 6.5l8-3.2a2 2 0 0 1 1.48 0l8 3.2A2 2 0 0 1 22 8.35Z",key:"gksnxg"}],["path",{d:"M6 18h12",key:"9pbo8z"}],["path",{d:"M6 14h12",key:"4cwo0f"}],["rect",{width:"12",height:"12",x:"6",y:"10",key:"apd30q"}]])},39730:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return P}});var r=t(57437),l=t(2265),a=t(5978),n=t(46410),c=t(14438),i=t(82431),d=t(44794),o=t(76865),m=t(37683),x=t(73247),u=t(99397),h=t(31047),j=t(70525),f=t(3085),g=t(21047),p=t(12381),N=t(79820),v=t(40279),b=t(33804),y=t(69174),w=t(74291),k=t(75060),S=t(15291),C=t(23675),Z=t(38220),A=t(1850),F=t(71245);function _(e){let{itemId:s,itemType:t,itemCode:a,itemName:n,currentStock:i,onAdjustmentComplete:m,onCancel:x}=e,{appUser:u}=(0,F.a)(),[h,g]=(0,l.useState)("increase"),[b,w]=(0,l.useState)(""),[_,L]=(0,l.useState)(""),[z,P]=(0,l.useState)(!1),q=async e=>{if(e.preventDefault(),!b||0>=parseFloat(b)){c.Am.error("請輸入有效的數量");return}if(!u){c.Am.error("用戶未認證");return}P(!0);try{let e=parseFloat(b),r="increase"===h?e:-e,l=i+r;if(l<0){c.Am.error("調整後庫存不能為負數");return}let a=(0,A.$C)(),n=(0,A.V1)(a,"adjustInventory"),d={itemId:s,itemType:t,quantityChange:r,remarks:_||"手動庫存調整"};console.log("呼叫 adjustInventory 函數，資料:",d),await n(d),c.Am.success("庫存調整成功"),m(l,_)}catch(e){console.error("庫存調整失敗:",e),c.Am.error("庫存調整失敗")}finally{P(!1)}},E=()=>{if(!b||0>=parseFloat(b))return i;let e=parseFloat(b);return i+("increase"===h?e:-e)},M=0>E();return(0,r.jsxs)(N.Zb,{className:"border-l-4 border-l-orange-500",children:[(0,r.jsx)(N.Ol,{children:(0,r.jsxs)(N.ll,{className:"text-lg text-gray-800 flex items-center gap-2",children:["material"===t?(0,r.jsx)(d.Z,{className:"h-5 w-5 text-blue-500"}):(0,r.jsx)(Z.Z,{className:"h-5 w-5 text-purple-500"}),"手動調整庫存"]})}),(0,r.jsx)(N.aY,{children:(0,r.jsxs)("form",{onSubmit:q,className:"space-y-6",children:[(0,r.jsx)("div",{className:"bg-gray-50 rounded-lg p-4 border border-gray-200",children:(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{className:"text-sm font-medium text-gray-600",children:"物料類型"}),(0,r.jsx)("div",{className:"mt-1",children:(0,r.jsx)(y.C,{variant:"outline",className:"text-sm",children:"material"===t?"物料":"香精"})})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{className:"text-sm font-medium text-gray-600",children:"物料編號"}),(0,r.jsx)("div",{className:"mt-1 font-mono text-sm bg-white px-3 py-2 rounded-md border",children:a})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{className:"text-sm font-medium text-gray-600",children:"物料名稱"}),(0,r.jsx)("div",{className:"mt-1 text-sm bg-white px-3 py-2 rounded-md border",children:n})]})]})}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{htmlFor:"adjustmentType",className:"text-sm font-medium text-gray-700",children:"調整類型"}),(0,r.jsxs)(S.Ph,{value:h,onValueChange:e=>g(e),children:[(0,r.jsx)(S.i4,{className:"mt-1",children:(0,r.jsx)(S.ki,{})}),(0,r.jsxs)(S.Bw,{children:[(0,r.jsx)(S.Ql,{value:"increase",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(j.Z,{className:"h-4 w-4 text-green-600"}),"增加庫存"]})}),(0,r.jsx)(S.Ql,{value:"decrease",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(f.Z,{className:"h-4 w-4 text-red-600"}),"減少庫存"]})})]})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{htmlFor:"quantity",className:"text-sm font-medium text-gray-700",children:"調整數量"}),(0,r.jsx)(v.I,{id:"quantity",type:"number",step:"0.01",min:"0.01",value:b,onChange:e=>w(e.target.value),placeholder:"輸入數量",className:"mt-1",required:!0})]})]}),(0,r.jsxs)("div",{className:"bg-blue-50 rounded-lg p-4 border border-blue-200",children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{className:"text-sm font-medium text-blue-700",children:"當前庫存"}),(0,r.jsx)("div",{className:"mt-1 text-2xl font-bold text-blue-900",children:i})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{className:"text-sm font-medium text-blue-700",children:"調整變化"}),(0,r.jsxs)("div",{className:"mt-1 flex items-center gap-2",children:["increase"===h?(0,r.jsx)(j.Z,{className:"h-5 w-5 text-green-600"}):(0,r.jsx)(f.Z,{className:"h-5 w-5 text-red-600"}),(0,r.jsxs)("span",{className:"text-lg font-bold ".concat("increase"===h?"text-green-600":"text-red-600"),children:["increase"===h?"+":"-",b||"0"]})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{className:"text-sm font-medium text-blue-700",children:"調整後庫存"}),(0,r.jsx)("div",{className:"mt-1 text-2xl font-bold ".concat(M?"text-red-600":"text-blue-900"),children:E()})]})]}),M&&(0,r.jsxs)("div",{className:"mt-3 flex items-center gap-2 text-red-600 bg-red-50 px-3 py-2 rounded-md border border-red-200",children:[(0,r.jsx)(o.Z,{className:"h-4 w-4"}),(0,r.jsx)("span",{className:"text-sm font-medium",children:"警告：調整後庫存將為負數"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{htmlFor:"remarks",className:"text-sm font-medium text-gray-700",children:"備註（可選）"}),(0,r.jsx)(C.g,{id:"remarks",value:_,onChange:e=>L(e.target.value),placeholder:"請說明調整原因...",className:"mt-1",rows:3})]}),(0,r.jsxs)("div",{className:"flex justify-end gap-3",children:[(0,r.jsx)(p.z,{type:"button",variant:"outline",onClick:x,disabled:z,children:"取消"}),(0,r.jsx)(p.z,{type:"submit",disabled:z||M,className:"bg-orange-600 hover:bg-orange-700 text-white",children:z?"調整中...":"確認調整"})]})]})})]})}var L=t(80719);function z(){let{appUser:e}=(0,F.a)(),[s,t]=(0,l.useState)([]),[C,Z]=(0,l.useState)([]),[z,P]=(0,l.useState)([]),[q,E]=(0,l.useState)([]),[M,U]=(0,l.useState)(!0),[D,O]=(0,l.useState)(""),[V,Q]=(0,l.useState)("all"),[I,T]=(0,l.useState)("all"),[R,Y]=(0,l.useState)(!1),[K,B]=(0,l.useState)(!1),[$,H]=(0,l.useState)(null),[W,X]=(0,l.useState)("material"),[G,J]=(0,l.useState)(null),ee=(0,l.useCallback)(async()=>{U(!0);try{if(!n.db)throw Error("Firebase 未初始化");let e=(0,a.query)((0,a.collection)(n.db,"materials"),(0,a.Xo)("name")),s=(await (0,a.getDocs)(e)).docs.map(e=>({id:e.id,...e.data()})),r=(0,a.query)((0,a.collection)(n.db,"fragrances"),(0,a.Xo)("name")),l=(await (0,a.getDocs)(r)).docs.map(e=>({id:e.id,...e.data()}));t(s),Z(l),P(s),E(l)}catch(e){console.error("讀取庫存資料失敗:",e),c.Am.error("讀取庫存資料失敗")}finally{U(!1)}},[]);(0,l.useEffect)(()=>{ee()},[ee]),(0,l.useEffect)(()=>{let e=s,t=C;D&&(e=e.filter(e=>e.name.toLowerCase().includes(D.toLowerCase())||e.code.toLowerCase().includes(D.toLowerCase())),t=t.filter(e=>e.name.toLowerCase().includes(D.toLowerCase())||e.code.toLowerCase().includes(D.toLowerCase()))),"all"!==V&&(e=e.filter(e=>e.status===V),t=t.filter(e=>e.status===V)),P(e),E(t)},[s,C,D,V]);let es=async(t,r,l,i)=>{try{if(!e){c.Am.error("用戶未認證");return}let d="material"===r?s.find(e=>e.id===t):C.find(e=>e.id===t);if(!d){c.Am.error("找不到指定項目");return}let o=l-d.currentStock;await (0,L.jK)("manual_adjustment",{operatorId:e.uid,operatorName:e.name||"未知用戶",remarks:i||void 0,details:[{itemId:d.id,itemType:r,itemCode:d.code,itemName:d.name,quantityChange:o,quantityAfter:l}]});let m=(0,a.doc)(n.db,"material"===r?"materials":"fragrances",t);await (0,a.r7)(m,{currentStock:l,lastUpdated:new Date}),c.Am.success("庫存調整成功"),Y(!1),H(null),ee()}catch(e){console.error("庫存調整失敗:",e),c.Am.error("庫存調整失敗")}},et=async()=>{if(!G||!e){c.Am.error("用戶未認證或資料不完整");return}try{let{itemId:e,itemType:s,itemCode:t,itemName:r,oldStock:l,newStock:a,remarks:n}=G,i=a-l;console.log("開始盤點，資料:",{itemId:e,itemType:s,itemCode:t,itemName:r,oldStock:l,newStock:a,quantityChange:i,remarks:n});let d=(0,A.$C)(),o=(0,A.V1)(d,"performStocktake"),m={items:[{itemRefPath:"".concat("material"===s?"materials":"fragrances","/").concat(e),currentStock:l,newStock:a}]};console.log("呼叫 performStocktake 函數，資料:",m);let x=await o(m);console.log("performStocktake 結果:",x),c.Am.success("庫存盤點完成"),B(!1),J(null),ee()}catch(s){console.error("庫存盤點失敗:",s);let e=s instanceof Error?s.message:"未知錯誤";c.Am.error("庫存盤點失敗: ".concat(e))}},er=(e,s)=>{H(e),X(s),Y(!0)},el=(e,s)=>{J({itemId:e.id,itemType:s,itemCode:e.code,itemName:e.name,oldStock:e.currentStock,newStock:e.currentStock,remarks:""}),B(!0)},ea=e=>e.currentStock<=e.minStock?{status:"low",text:"低庫存",color:"text-red-600 bg-red-50"}:e.currentStock>=e.maxStock?{status:"high",text:"高庫存",color:"text-yellow-600 bg-yellow-50"}:{status:"normal",text:"正常",color:"text-green-600 bg-green-50"},en=s.length+C.length,ec=s.filter(e=>e.currentStock<=e.minStock).length+C.filter(e=>e.currentStock<=e.minStock).length,ei=s.reduce((e,s)=>e+s.currentStock,0)+C.reduce((e,s)=>e+s.currentStock,0);return(0,r.jsxs)("div",{className:"container mx-auto py-10",children:[(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-3xl font-bold bg-gradient-to-r from-emerald-600 to-green-600 bg-clip-text text-transparent",children:"庫存管理"}),(0,r.jsx)("p",{className:"text-gray-600 mt-2",children:"監控物料和香精庫存與調整"})]}),(0,r.jsxs)(p.z,{onClick:ee,variant:"outline",className:"flex items-center gap-2",children:[(0,r.jsx)(i.Z,{className:"h-4 w-4"}),"重新整理"]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8",children:[(0,r.jsxs)(N.Zb,{className:"bg-gradient-to-br from-emerald-50 to-green-50 border-emerald-200",children:[(0,r.jsxs)(N.Ol,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,r.jsx)(N.ll,{className:"text-sm font-medium text-emerald-700",children:"總項目數"}),(0,r.jsx)(d.Z,{className:"h-4 w-4 text-emerald-600"})]}),(0,r.jsxs)(N.aY,{children:[(0,r.jsx)("div",{className:"text-2xl font-bold text-emerald-900",children:en}),(0,r.jsxs)("p",{className:"text-xs text-emerald-600 mt-1",children:["物料: ",s.length," | 香精: ",C.length]})]})]}),(0,r.jsxs)(N.Zb,{className:"bg-gradient-to-br from-red-50 to-pink-50 border-red-200",children:[(0,r.jsxs)(N.Ol,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,r.jsx)(N.ll,{className:"text-sm font-medium text-red-700",children:"低庫存項目"}),(0,r.jsx)(o.Z,{className:"h-4 w-4 text-red-600"})]}),(0,r.jsxs)(N.aY,{children:[(0,r.jsx)("div",{className:"text-2xl font-bold text-red-900",children:ec}),(0,r.jsx)("p",{className:"text-xs text-red-600 mt-1",children:"需要補貨"})]})]}),(0,r.jsxs)(N.Zb,{className:"bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-200",children:[(0,r.jsxs)(N.Ol,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,r.jsx)(N.ll,{className:"text-sm font-medium text-blue-700",children:"總庫存數量"}),(0,r.jsx)(m.Z,{className:"h-4 w-4 text-blue-600"})]}),(0,r.jsxs)(N.aY,{children:[(0,r.jsx)("div",{className:"text-2xl font-bold text-blue-900",children:ei.toLocaleString()}),(0,r.jsx)("p",{className:"text-xs text-blue-600 mt-1",children:"當前庫存總量"})]})]})]}),(0,r.jsxs)(N.Zb,{className:"mb-6",children:[(0,r.jsx)(N.Ol,{children:(0,r.jsx)(N.ll,{className:"text-lg",children:"篩選與搜尋"})}),(0,r.jsx)(N.aY,{children:(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{htmlFor:"search",children:"搜尋項目"}),(0,r.jsxs)("div",{className:"relative mt-1",children:[(0,r.jsx)(x.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),(0,r.jsx)(v.I,{id:"search",placeholder:"搜尋編號或名稱...",value:D,onChange:e=>O(e.target.value),className:"pl-10"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{htmlFor:"status",children:"狀態篩選"}),(0,r.jsxs)(S.Ph,{value:V,onValueChange:Q,children:[(0,r.jsx)(S.i4,{className:"mt-1",children:(0,r.jsx)(S.ki,{placeholder:"選擇狀態"})}),(0,r.jsxs)(S.Bw,{children:[(0,r.jsx)(S.Ql,{value:"all",children:"全部狀態"}),(0,r.jsx)(S.Ql,{value:"active",children:"啟用"}),(0,r.jsx)(S.Ql,{value:"inactive",children:"停用"})]})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{htmlFor:"type",children:"類型篩選"}),(0,r.jsxs)(S.Ph,{value:I,onValueChange:e=>T(e),children:[(0,r.jsx)(S.i4,{className:"mt-1",children:(0,r.jsx)(S.ki,{placeholder:"選擇類型"})}),(0,r.jsxs)(S.Bw,{children:[(0,r.jsx)(S.Ql,{value:"all",children:"全部類型"}),(0,r.jsx)(S.Ql,{value:"materials",children:"物料"}),(0,r.jsx)(S.Ql,{value:"fragrances",children:"香精"})]})]})]})]})})]}),("all"===I||"materials"===I)&&(0,r.jsxs)(N.Zb,{className:"mb-6",children:[(0,r.jsxs)(N.Ol,{children:[(0,r.jsxs)(N.ll,{className:"text-lg flex items-center gap-2",children:[(0,r.jsx)(d.Z,{className:"h-5 w-5 text-blue-500"}),"物料庫存"]}),(0,r.jsx)(N.SZ,{children:"管理物料庫存和調整"})]}),(0,r.jsx)(N.aY,{children:M?(0,r.jsxs)("div",{className:"text-center py-8",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600 mx-auto"}),(0,r.jsx)("p",{className:"text-gray-500 mt-2",children:"載入中..."})]}):0===z.length?(0,r.jsx)("div",{className:"text-center py-8 text-gray-500",children:"沒有找到符合條件的物料"}):(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)(b.iA,{children:[(0,r.jsx)(b.xD,{children:(0,r.jsxs)(b.SC,{children:[(0,r.jsx)(b.ss,{children:"編號"}),(0,r.jsx)(b.ss,{children:"名稱"}),(0,r.jsx)(b.ss,{children:"當前庫存"}),(0,r.jsx)(b.ss,{children:"單位"}),(0,r.jsx)(b.ss,{children:"最低庫存"}),(0,r.jsx)(b.ss,{children:"最高庫存"}),(0,r.jsx)(b.ss,{children:"狀態"}),(0,r.jsx)(b.ss,{children:"操作"})]})}),(0,r.jsx)(b.RM,{children:z.map(e=>{let s=ea(e);return(0,r.jsxs)(b.SC,{children:[(0,r.jsx)(b.pj,{className:"font-mono text-sm",children:e.code}),(0,r.jsx)(b.pj,{className:"font-medium",children:e.name}),(0,r.jsx)(b.pj,{children:(0,r.jsx)("span",{className:"font-semibold ".concat(s.color," px-2 py-1 rounded-full text-xs"),children:e.currentStock.toLocaleString()})}),(0,r.jsx)(b.pj,{children:e.unit}),(0,r.jsx)(b.pj,{children:e.minStock.toLocaleString()}),(0,r.jsx)(b.pj,{children:e.maxStock.toLocaleString()}),(0,r.jsx)(b.pj,{children:(0,r.jsx)(y.C,{variant:"active"===e.status?"default":"secondary",children:"active"===e.status?"啟用":"停用"})}),(0,r.jsx)(b.pj,{children:(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsxs)(p.z,{size:"sm",variant:"outline",onClick:()=>er(e,"material"),className:"text-blue-600 hover:text-blue-700",children:[(0,r.jsx)(u.Z,{className:"h-4 w-4 mr-1"}),"調整"]}),(0,r.jsxs)(p.z,{size:"sm",variant:"outline",onClick:()=>el(e,"material"),className:"text-green-600 hover:text-green-700",children:[(0,r.jsx)(h.Z,{className:"h-4 w-4 mr-1"}),"盤點"]})]})})]},e.id)})})]})})})]}),("all"===I||"fragrances"===I)&&(0,r.jsxs)(N.Zb,{className:"mb-6",children:[(0,r.jsxs)(N.Ol,{children:[(0,r.jsxs)(N.ll,{className:"text-lg flex items-center gap-2",children:[(0,r.jsx)(j.Z,{className:"h-5 w-5 text-purple-500"}),"香精庫存"]}),(0,r.jsx)(N.SZ,{children:"管理香精庫存和調整"})]}),(0,r.jsx)(N.aY,{children:M?(0,r.jsxs)("div",{className:"text-center py-8",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto"}),(0,r.jsx)("p",{className:"text-gray-500 mt-2",children:"載入中..."})]}):0===q.length?(0,r.jsx)("div",{className:"text-center py-8 text-gray-500",children:"沒有找到符合條件的香精"}):(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)(b.iA,{children:[(0,r.jsx)(b.xD,{children:(0,r.jsxs)(b.SC,{children:[(0,r.jsx)(b.ss,{children:"編號"}),(0,r.jsx)(b.ss,{children:"名稱"}),(0,r.jsx)(b.ss,{children:"當前庫存"}),(0,r.jsx)(b.ss,{children:"單位"}),(0,r.jsx)(b.ss,{children:"最低庫存"}),(0,r.jsx)(b.ss,{children:"最高庫存"}),(0,r.jsx)(b.ss,{children:"狀態"}),(0,r.jsx)(b.ss,{children:"操作"})]})}),(0,r.jsx)(b.RM,{children:q.map(e=>{let s=ea(e);return(0,r.jsxs)(b.SC,{children:[(0,r.jsx)(b.pj,{className:"font-mono text-sm",children:e.code}),(0,r.jsx)(b.pj,{className:"font-medium",children:e.name}),(0,r.jsx)(b.pj,{children:(0,r.jsx)("span",{className:"font-semibold ".concat(s.color," px-2 py-1 rounded-full text-xs"),children:e.currentStock.toLocaleString()})}),(0,r.jsx)(b.pj,{children:e.unit}),(0,r.jsx)(b.pj,{children:e.minStock.toLocaleString()}),(0,r.jsx)(b.pj,{children:e.maxStock.toLocaleString()}),(0,r.jsx)(b.pj,{children:(0,r.jsx)(y.C,{variant:"active"===e.status?"default":"secondary",children:"active"===e.status?"啟用":"停用"})}),(0,r.jsx)(b.pj,{children:(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsxs)(p.z,{size:"sm",variant:"outline",onClick:()=>er(e,"fragrance"),className:"text-purple-600 hover:text-purple-700",children:[(0,r.jsx)(u.Z,{className:"h-4 w-4 mr-1"}),"調整"]}),(0,r.jsxs)(p.z,{size:"sm",variant:"outline",onClick:()=>el(e,"fragrance"),className:"text-green-600 hover:text-green-700",children:[(0,r.jsx)(h.Z,{className:"h-4 w-4 mr-1"}),"盤點"]})]})})]},e.id)})})]})})})]}),(0,r.jsx)(w.Vq,{open:R,onOpenChange:Y,children:(0,r.jsxs)(w.cZ,{className:"max-w-2xl",children:[(0,r.jsxs)(w.fK,{children:[(0,r.jsx)(w.$N,{children:"調整庫存"}),(0,r.jsxs)(w.Be,{children:["調整 ",null==$?void 0:$.name," 的庫存數量"]})]}),$&&(0,r.jsx)(_,{itemId:$.id,itemType:W,itemCode:$.code,itemName:$.name,currentStock:$.currentStock,onAdjustmentComplete:(e,s)=>{es($.id,W,e,s)},onCancel:()=>{Y(!1),H(null)}})]})}),(0,r.jsx)(w.Vq,{open:K,onOpenChange:B,children:(0,r.jsxs)(w.cZ,{className:"max-w-2xl",children:[(0,r.jsxs)(w.fK,{children:[(0,r.jsx)(w.$N,{children:"庫存盤點"}),(0,r.jsxs)(w.Be,{children:["盤點 ",null==G?void 0:G.itemName," 的實際庫存數量"]})]}),G&&(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)("div",{className:"bg-gray-50 rounded-lg p-4 border border-gray-200",children:(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{className:"text-sm font-medium text-gray-600",children:"物料編號"}),(0,r.jsx)("div",{className:"mt-1 font-mono text-sm bg-white px-3 py-2 rounded-md border",children:G.itemCode})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{className:"text-sm font-medium text-gray-600",children:"物料名稱"}),(0,r.jsx)("div",{className:"mt-1 text-sm bg-white px-3 py-2 rounded-md border",children:G.itemName})]})]})}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{htmlFor:"newStock",className:"text-sm font-medium text-gray-700",children:"盤點後數量"}),(0,r.jsx)(v.I,{id:"newStock",type:"number",step:"0.01",min:"0",value:G.newStock,onChange:e=>J(s=>s?{...s,newStock:parseFloat(e.target.value)||0}:null),placeholder:"輸入盤點後的實際數量",className:"mt-1",required:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{htmlFor:"remarks",className:"text-sm font-medium text-gray-700",children:"盤點備註（可選）"}),(0,r.jsx)("textarea",{id:"remarks",value:G.remarks,onChange:e=>J(s=>s?{...s,remarks:e.target.value}:null),placeholder:"請說明盤點情況...",className:"mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent",rows:3})]})]}),(0,r.jsx)("div",{className:"bg-green-50 rounded-lg p-4 border border-green-200",children:(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{className:"text-sm font-medium text-green-700",children:"系統庫存"}),(0,r.jsx)("div",{className:"mt-1 text-2xl font-bold text-green-900",children:G.oldStock})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{className:"text-sm font-medium text-green-700",children:"盤點變化"}),(0,r.jsxs)("div",{className:"mt-1 flex items-center gap-2",children:[G.newStock>G.oldStock?(0,r.jsx)(j.Z,{className:"h-5 w-5 text-green-600"}):G.newStock<G.oldStock?(0,r.jsx)(f.Z,{className:"h-5 w-5 text-red-600"}):(0,r.jsx)(g.Z,{className:"h-5 w-5 text-gray-600"}),(0,r.jsxs)("span",{className:"text-lg font-bold ".concat(G.newStock>G.oldStock?"text-green-600":G.newStock<G.oldStock?"text-red-600":"text-gray-600"),children:[G.newStock>G.oldStock?"+":"",G.newStock-G.oldStock]})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)(k._,{className:"text-sm font-medium text-green-700",children:"盤點後庫存"}),(0,r.jsx)("div",{className:"mt-1 text-2xl font-bold text-green-900",children:G.newStock})]})]})}),(0,r.jsxs)("div",{className:"flex justify-end gap-3",children:[(0,r.jsx)(p.z,{type:"button",variant:"outline",onClick:()=>{B(!1),J(null)},children:"取消"}),(0,r.jsx)(p.z,{type:"button",onClick:et,className:"bg-green-600 hover:bg-green-700 text-white",children:"確認盤點"})]})]})]})})]})}function P(){return(0,r.jsx)(z,{})}},23675:function(e,s,t){"use strict";t.d(s,{g:function(){return n}});var r=t(57437),l=t(2265),a=t(93448);let n=l.forwardRef((e,s)=>{let{className:t,...l}=e;return(0,r.jsx)("textarea",{className:(0,a.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),ref:s,...l})});n.displayName="Textarea"},71245:function(e,s,t){"use strict";t.d(s,{H:function(){return m},a:function(){return x}});var r=t(57437),l=t(2265),a=t(82148),n=t(46410),c=t(5978),i=t(14438),d=t(47903);let o=(0,l.createContext)({user:null,appUser:null,isLoading:!0,login:async()=>!1,logout:async()=>{},hasPermission:()=>!1,hasAnyPermission:()=>!1,hasAllPermissions:()=>!1}),m=e=>{let{children:s}=e,[t,m]=(0,l.useState)(null),[x,u]=(0,l.useState)(null),[h,j]=(0,l.useState)(!0),f=async e=>{(0,d.fF)("loadUserData 開始執行",{uid:e.uid});try{let s=(0,n.T)();if(!s){(0,d.vU)("Firestore 未初始化"),u(null);return}(0,d.fF)("獲取用戶文檔",{uid:e.uid});let t=await (0,c.QT)((0,c.doc)(s,"users",e.uid));if(t.exists()){(0,d.fF)("用戶文檔存在");let e=t.data();if((0,d.fF)("用戶資料",e),e.roleRef){(0,d.fF)("用戶有角色引用，獲取角色資料");try{let s=await (0,c.QT)(e.roleRef);if(s.exists()){let t=s.data();e.roleName=t.displayName||t.name,e.permissions=t.permissions||[],(0,d.fF)("角色資料載入成功",{role:e.roleName,permissions:e.permissions})}else(0,d.ZK)("角色文檔不存在")}catch(e){(0,d.vU)("載入角色資料失敗",e)}}else(0,d.ZK)("用戶沒有角色引用");(0,d.fF)("設置 appUser",e),u(e)}else(0,d.ZK)("用戶文檔不存在"),u(null)}catch(e){(0,d.vU)("載入用戶資料失敗",e),u(null)}},g=async(e,s)=>{try{let t=(0,n.E7)();if(!t)return i.Am.error("系統初始化失敗"),!1;let r=e.includes("@")?e:"".concat(e,"@deer-lab.local"),l=await (0,a.e5)(t,r,s);return await f(l.user),i.Am.success("登入成功！"),!0}catch(e){return(0,d.vU)("登入失敗",e),i.Am.error(e.message||"登入失敗"),!1}},p=async()=>{try{let e=(0,n.E7)();e&&(await (0,a.w7)(e),m(null),u(null),i.Am.success("已成功登出"),window.location.href="/")}catch(e){(0,d.vU)("登出失敗",e),i.Am.error("登出失敗")}};return(0,l.useEffect)(()=>{(0,d.fF)("AuthContext useEffect 開始執行");try{let e=(0,n.E7)();if(!e){(0,d.vU)("Auth 未初始化，設置 isLoading = false"),j(!1);return}(0,d.fF)("設置 onAuthStateChanged 監聽器");let s=(0,a.Aj)(e,async e=>{try{(0,d.fF)("onAuthStateChanged 觸發",{uid:(null==e?void 0:e.uid)||null}),e?(m(e),(0,d.fF)("開始載入用戶資料"),await f(e)):(m(null),u(null),(0,d.fF)("用戶已登出，清除狀態")),j(!1),(0,d.fF)("設置 isLoading = false")}catch(e){(0,d.vU)("onAuthStateChanged 回調執行失敗",e),j(!1)}});return()=>{(0,d.fF)("清理 onAuthStateChanged 監聽器"),"function"==typeof s&&s()}}catch(e){(0,d.vU)("AuthContext useEffect 執行失敗",e),j(!1)}},[]),(0,r.jsx)(o.Provider,{value:{user:t,appUser:x,isLoading:h,login:g,logout:p,hasPermission:e=>null!=x&&!!x.permissions&&x.permissions.includes(e),hasAnyPermission:e=>null!=x&&!!x.permissions&&e.some(e=>x.permissions.includes(e)),hasAllPermissions:e=>null!=x&&!!x.permissions&&e.every(e=>x.permissions.includes(e))},children:s})},x=()=>(0,l.useContext)(o)},6394:function(e,s,t){"use strict";t.d(s,{f:function(){return c}});var r=t(2265),l=t(66840),a=t(57437),n=r.forwardRef((e,s)=>(0,a.jsx)(l.WV.label,{...e,ref:s,onMouseDown:s=>{var t;s.target.closest("button, input, select, textarea")||(null===(t=e.onMouseDown)||void 0===t||t.call(e,s),!s.defaultPrevented&&s.detail>1&&s.preventDefault())}}));n.displayName="Label";var c=n}},function(e){e.O(0,[3609,9015,3676,5569,4438,9436,3909,2696,4116,4200,2365,5753,2971,2117,1744],function(){return e(e.s=59801)}),_N_E=e.O()}]);