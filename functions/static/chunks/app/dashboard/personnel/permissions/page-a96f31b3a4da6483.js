(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3186],{24663:function(e,s,r){Promise.resolve().then(r.bind(r,89416))},89416:function(e,s,r){"use strict";r.r(s),r.d(s,{default:function(){return I}});var t=r(57437),a=r(2265),n=r(1850),i=r(1077);let l=e=>{let{children:s,roles:r,fallback:a=null}=e,{userRole:n}=(0,i.g)();return r.includes(n)?(0,t.jsx)(t.Fragment,{children:s}):(0,t.jsx)(t.Fragment,{children:a})},c=e=>{let{children:s,fallback:r=null}=e;return(0,t.jsx)(l,{roles:["系統管理員"],fallback:r,children:s})};var d=r(79820),o=r(12381),u=r(69174),m=r(17168),x=r(98617),f=r(49663),N=r(92369),E=r(88906),h=r(99397),g=r(41671),v=r(95805),A=r(98728),p=r(66337),j=r(42208),b=r(2207),R=r(18930),_=r(76865),S=r(14438);function w(){let[e,s]=(0,a.useState)([]),[r,l]=(0,a.useState)([]),[c,_]=(0,a.useState)(!0),[w,I]=(0,a.useState)("roles"),{isAdmin:y}=(0,i.g)(),O=(0,a.useCallback)(async()=>{try{let e=(0,n.$C)(),r=(0,n.V1)(e,"getRoles"),t=(await r()).data;"success"===t.status?s(t.roles||[]):S.Am.error("載入角色列表失敗")}catch(e){console.error("載入角色列表錯誤:",e),S.Am.error("載入角色列表失敗")}},[]),M=(0,a.useCallback)(async()=>{l([])},[]),V=async()=>{try{let s=(0,n.$C)(),r=(0,n.V1)(s,"initializeDefaultRoles"),t=(await r()).data;if("success"===t.status){var e;S.Am.success("成功初始化 ".concat((null===(e=t.roles)||void 0===e?void 0:e.length)||0," 個預設角色")),await O()}else"skipped"===t.status&&S.Am.info("系統已有角色，跳過初始化")}catch(e){console.error("初始化角色錯誤:",e),S.Am.error("初始化角色失敗")}};(0,a.useEffect)(()=>{(async()=>{_(!0),await Promise.all([O(),M()]),_(!1)})()},[O,M]);let P=e=>{switch(e){case"#dc2626":return"bg-red-500";case"#2563eb":return"bg-blue-500";case"#059669":return"bg-green-500";default:return"bg-gray-500"}},T=e=>{switch(e){case"admin":return x.Z;case"foreman":return f.Z;case"timekeeper":return N.Z;default:return E.Z}};return(0,t.jsxs)("div",{className:"p-6 space-y-6",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-2xl font-bold text-foreground",children:"權限管理"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"管理系統角色和使用者權限分配"})]}),0===e.length&&(0,t.jsxs)(o.z,{onClick:V,className:"bg-gradient-to-r from-blue-500 to-blue-600",children:[(0,t.jsx)(h.Z,{className:"mr-2 h-4 w-4"}),"初始化預設角色"]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[(0,t.jsx)(d.Zb,{className:"bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200",children:(0,t.jsx)(d.aY,{className:"p-4",children:(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(E.Z,{className:"h-8 w-8 text-blue-600"}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm text-blue-600 font-medium",children:"總角色數"}),(0,t.jsx)("p",{className:"text-2xl font-bold text-blue-800",children:e.length})]})]})})}),(0,t.jsx)(d.Zb,{className:"bg-gradient-to-br from-green-50 to-green-100 border-green-200",children:(0,t.jsx)(d.aY,{className:"p-4",children:(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(g.Z,{className:"h-8 w-8 text-green-600"}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm text-green-600 font-medium",children:"預設角色"}),(0,t.jsx)("p",{className:"text-2xl font-bold text-green-800",children:e.filter(e=>e.isDefault).length})]})]})})}),(0,t.jsx)(d.Zb,{className:"bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200",children:(0,t.jsx)(d.aY,{className:"p-4",children:(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(v.Z,{className:"h-8 w-8 text-purple-600"}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm text-purple-600 font-medium",children:"已分配用戶"}),(0,t.jsx)("p",{className:"text-2xl font-bold text-purple-800",children:r.length})]})]})})}),(0,t.jsx)(d.Zb,{className:"bg-gradient-to-br from-orange-50 to-orange-100 border-orange-200",children:(0,t.jsx)(d.aY,{className:"p-4",children:(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(A.Z,{className:"h-8 w-8 text-orange-600"}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm text-orange-600 font-medium",children:"自訂角色"}),(0,t.jsx)("p",{className:"text-2xl font-bold text-orange-800",children:e.filter(e=>!e.isDefault).length})]})]})})})]}),(0,t.jsxs)(m.mQ,{value:w,onValueChange:I,children:[(0,t.jsxs)(m.dr,{className:"grid w-full grid-cols-2",children:[(0,t.jsxs)(m.SP,{value:"roles",className:"flex items-center gap-2",children:[(0,t.jsx)(E.Z,{className:"h-4 w-4"}),"角色管理"]}),(0,t.jsxs)(m.SP,{value:"assignments",className:"flex items-center gap-2",children:[(0,t.jsx)(v.Z,{className:"h-4 w-4"}),"權限分配"]})]}),(0,t.jsx)(m.nU,{value:"roles",className:"space-y-4",children:c?(0,t.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,t.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):(0,t.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:e.map(e=>{var s;let r=T(e.name);return(0,t.jsxs)(d.Zb,{className:"hover:shadow-md transition-shadow",children:[(0,t.jsx)(d.Ol,{className:"pb-3",children:(0,t.jsxs)("div",{className:"flex items-start justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,t.jsx)("div",{className:"p-2 rounded-lg ".concat(P(e.color)),children:(0,t.jsx)(r,{className:"h-4 w-4 text-white"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)(d.ll,{className:"text-lg",children:e.displayName}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:e.name})]})]}),e.isDefault&&(0,t.jsxs)(u.C,{variant:"outline",className:"text-xs",children:[(0,t.jsx)(p.Z,{className:"mr-1 h-3 w-3"}),"預設"]})]})}),(0,t.jsxs)(d.aY,{className:"space-y-3",children:[(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:e.description}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm font-medium mb-2",children:"權限數量"}),(0,t.jsxs)(u.C,{variant:"secondary",children:[(null===(s=e.permissions)||void 0===s?void 0:s.length)||0," 項權限"]})]}),(0,t.jsxs)("div",{className:"flex space-x-2",children:[(0,t.jsxs)(o.z,{size:"sm",variant:"outline",className:"flex-1",children:[(0,t.jsx)(j.Z,{className:"mr-2 h-4 w-4"}),"檢視"]}),!e.isDefault&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(o.z,{size:"sm",variant:"outline",children:(0,t.jsx)(b.Z,{className:"h-4 w-4"})}),(0,t.jsx)(o.z,{size:"sm",variant:"destructive",children:(0,t.jsx)(R.Z,{className:"h-4 w-4"})})]})]})]})]},e.id)})})}),(0,t.jsx)(m.nU,{value:"assignments",children:(0,t.jsxs)(d.Zb,{children:[(0,t.jsxs)(d.Ol,{children:[(0,t.jsx)(d.ll,{children:"用戶角色分配"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"為用戶指派角色和權限"})]}),(0,t.jsx)(d.aY,{children:(0,t.jsxs)("div",{className:"text-center py-8",children:[(0,t.jsx)(v.Z,{className:"mx-auto h-12 w-12 text-muted-foreground mb-4"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"用戶角色分配功能開發中..."})]})})]})})]})]})}function I(){return(0,t.jsx)(c,{fallback:(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[400px] space-y-4",children:[(0,t.jsx)(_.Z,{className:"h-16 w-16 text-orange-500"}),(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("h2",{className:"text-xl font-semibold text-foreground",children:"權限不足"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"只有系統管理員可以訪問權限管理頁面"})]})]}),children:(0,t.jsx)(w,{})})}},69174:function(e,s,r){"use strict";r.d(s,{C:function(){return c}});var t=r(57437);r(2265);var a=r(37053),n=r(90535),i=r(93448);let l=(0,n.j)("inline-flex items-center justify-center rounded-full px-2 py-1 text-xs font-medium focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"bg-blue-100 text-blue-700",secondary:"bg-muted text-muted-foreground",destructive:"bg-red-100 text-red-700",outline:"text-foreground border border-border",success:"bg-green-100 text-green-700",warning:"bg-yellow-100 text-yellow-700",purple:"bg-purple-100 text-purple-700"}},defaultVariants:{variant:"default"}});function c(e){let{className:s,variant:r,asChild:n=!1,...c}=e,d=n?a.g7:"span";return(0,t.jsx)(d,{"data-slot":"badge",className:(0,i.cn)(l({variant:r}),s),...c})}},79820:function(e,s,r){"use strict";r.d(s,{Ol:function(){return i},SZ:function(){return c},Zb:function(){return n},aY:function(){return d},eW:function(){return o},ll:function(){return l}});var t=r(57437);r(2265);var a=r(93448);function n(e){let{className:s,...r}=e;return(0,t.jsx)("div",{"data-slot":"card",className:(0,a.cn)("bg-card text-card-foreground flex flex-col gap-6 rounded-lg border-2 p-6 shadow-md",s),...r})}function i(e){let{className:s,...r}=e;return(0,t.jsx)("div",{"data-slot":"card-header",className:(0,a.cn)("@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 has-data-[slot=card-action]:grid-cols-[1fr_auto]",s),...r})}function l(e){let{className:s,...r}=e;return(0,t.jsx)("div",{"data-slot":"card-title",className:(0,a.cn)("leading-none font-semibold",s),...r})}function c(e){let{className:s,...r}=e;return(0,t.jsx)("div",{"data-slot":"card-description",className:(0,a.cn)("text-muted-foreground text-sm",s),...r})}function d(e){let{className:s,...r}=e;return(0,t.jsx)("div",{"data-slot":"card-content",className:(0,a.cn)("",s),...r})}function o(e){let{className:s,...r}=e;return(0,t.jsx)("div",{"data-slot":"card-footer",className:(0,a.cn)("flex items-center",s),...r})}},17168:function(e,s,r){"use strict";r.d(s,{SP:function(){return d},dr:function(){return c},mQ:function(){return l},nU:function(){return o}});var t=r(57437),a=r(2265),n=r(20271),i=r(93448);let l=n.fC,c=a.forwardRef((e,s)=>{let{className:r,...a}=e;return(0,t.jsx)(n.aV,{ref:s,className:(0,i.cn)("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",r),...a})});c.displayName=n.aV.displayName;let d=a.forwardRef((e,s)=>{let{className:r,...a}=e;return(0,t.jsx)(n.xz,{ref:s,className:(0,i.cn)("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",r),...a})});d.displayName=n.xz.displayName;let o=a.forwardRef((e,s)=>{let{className:r,...a}=e;return(0,t.jsx)(n.VY,{ref:s,className:(0,i.cn)("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",r),...a})});o.displayName=n.VY.displayName},71245:function(e,s,r){"use strict";r.d(s,{H:function(){return u},a:function(){return m}});var t=r(57437),a=r(2265),n=r(82148),i=r(46410),l=r(5978),c=r(14438),d=r(47903);let o=(0,a.createContext)({user:null,appUser:null,isLoading:!0,login:async()=>!1,logout:async()=>{},hasPermission:()=>!1,hasAnyPermission:()=>!1,hasAllPermissions:()=>!1}),u=e=>{let{children:s}=e,[r,u]=(0,a.useState)(null),[m,x]=(0,a.useState)(null),[f,N]=(0,a.useState)(!0),E=async e=>{(0,d.fF)("loadUserData 開始執行",{uid:e.uid});try{let s=(0,i.T)();if(!s){(0,d.vU)("Firestore 未初始化"),x(null);return}(0,d.fF)("獲取用戶文檔",{uid:e.uid});let r=await (0,l.QT)((0,l.doc)(s,"users",e.uid));if(r.exists()){(0,d.fF)("用戶文檔存在");let e=r.data();if((0,d.fF)("用戶資料",e),e.roleRef){(0,d.fF)("用戶有角色引用，獲取角色資料");try{let s=await (0,l.QT)(e.roleRef);if(s.exists()){let r=s.data();e.roleName=r.displayName||r.name,e.permissions=r.permissions||[],(0,d.fF)("角色資料載入成功",{role:e.roleName,permissions:e.permissions})}else(0,d.ZK)("角色文檔不存在")}catch(e){(0,d.vU)("載入角色資料失敗",e)}}else(0,d.ZK)("用戶沒有角色引用");(0,d.fF)("設置 appUser",e),x(e)}else(0,d.ZK)("用戶文檔不存在"),x(null)}catch(e){(0,d.vU)("載入用戶資料失敗",e),x(null)}},h=async(e,s)=>{try{let r=(0,i.E7)();if(!r)return c.Am.error("系統初始化失敗"),!1;let t=e.includes("@")?e:"".concat(e,"@deer-lab.local"),a=await (0,n.e5)(r,t,s);return await E(a.user),c.Am.success("登入成功！"),!0}catch(e){return(0,d.vU)("登入失敗",e),c.Am.error(e.message||"登入失敗"),!1}},g=async()=>{try{let e=(0,i.E7)();e&&(await (0,n.w7)(e),u(null),x(null),c.Am.success("已成功登出"),window.location.href="/")}catch(e){(0,d.vU)("登出失敗",e),c.Am.error("登出失敗")}};return(0,a.useEffect)(()=>{(0,d.fF)("AuthContext useEffect 開始執行");try{let e=(0,i.E7)();if(!e){(0,d.vU)("Auth 未初始化，設置 isLoading = false"),N(!1);return}(0,d.fF)("設置 onAuthStateChanged 監聽器");let s=(0,n.Aj)(e,async e=>{try{(0,d.fF)("onAuthStateChanged 觸發",{uid:(null==e?void 0:e.uid)||null}),e?(u(e),(0,d.fF)("開始載入用戶資料"),await E(e)):(u(null),x(null),(0,d.fF)("用戶已登出，清除狀態")),N(!1),(0,d.fF)("設置 isLoading = false")}catch(e){(0,d.vU)("onAuthStateChanged 回調執行失敗",e),N(!1)}});return()=>{(0,d.fF)("清理 onAuthStateChanged 監聽器"),"function"==typeof s&&s()}}catch(e){(0,d.vU)("AuthContext useEffect 執行失敗",e),N(!1)}},[]),(0,t.jsx)(o.Provider,{value:{user:r,appUser:m,isLoading:f,login:h,logout:g,hasPermission:e=>null!=m&&!!m.permissions&&m.permissions.includes(e),hasAnyPermission:e=>null!=m&&!!m.permissions&&e.some(e=>m.permissions.includes(e)),hasAllPermissions:e=>null!=m&&!!m.permissions&&e.every(e=>m.permissions.includes(e))},children:s})},m=()=>(0,a.useContext)(o)},1077:function(e,s,r){"use strict";r.d(s,{g:function(){return i}});var t=r(71245);let a={PERSONNEL_VIEW:"personnel.view",PERSONNEL_MANAGE:"personnel.manage",TIME_VIEW:"time.view",TIME_MANAGE:"time.manage",SUPPLIERS_VIEW:"suppliers.view",SUPPLIERS_MANAGE:"suppliers.manage",PURCHASE_VIEW:"purchase.view",PURCHASE_MANAGE:"purchase.manage",MATERIALS_VIEW:"materials.view",MATERIALS_MANAGE:"materials.manage",FRAGRANCES_VIEW:"fragrances.view",FRAGRANCES_MANAGE:"fragrances.manage",PRODUCTS_VIEW:"products.view",PRODUCTS_MANAGE:"products.manage",WORK_ORDERS_VIEW:"workOrders.view",WORK_ORDERS_MANAGE:"workOrders.manage",INVENTORY_VIEW:"inventory.view",INVENTORY_MANAGE:"inventory.manage",INVENTORY_RECORDS_VIEW:"inventoryRecords.view",COST_VIEW:"cost.view",TIME_REPORTS_VIEW:"timeReports.view",ROLES_MANAGE:"roles.manage",SYSTEM_SETTINGS:"system.settings"};Object.values(a);let n={"/dashboard":{view:[]},"/dashboard/personnel":{view:[a.PERSONNEL_VIEW,a.PERSONNEL_MANAGE],manage:[a.PERSONNEL_MANAGE]},"/dashboard/time-records":{view:[a.TIME_VIEW,a.TIME_MANAGE]},"/dashboard/suppliers":{view:[a.SUPPLIERS_VIEW,a.SUPPLIERS_MANAGE],manage:[a.SUPPLIERS_MANAGE]},"/dashboard/purchase-orders":{view:[a.PURCHASE_VIEW,a.PURCHASE_MANAGE],manage:[a.PURCHASE_MANAGE]},"/dashboard/materials":{view:[a.MATERIALS_VIEW,a.MATERIALS_MANAGE],manage:[a.MATERIALS_MANAGE]},"/dashboard/fragrances":{view:[a.FRAGRANCES_VIEW,a.FRAGRANCES_MANAGE],manage:[a.FRAGRANCES_MANAGE]},"/dashboard/products":{view:[a.PRODUCTS_VIEW,a.PRODUCTS_MANAGE],manage:[a.PRODUCTS_MANAGE]},"/dashboard/work-orders":{view:[a.WORK_ORDERS_VIEW,a.WORK_ORDERS_MANAGE],manage:[a.WORK_ORDERS_MANAGE]},"/dashboard/inventory":{view:[a.INVENTORY_VIEW,a.INVENTORY_MANAGE],manage:[a.INVENTORY_MANAGE]},"/dashboard/inventory-records":{view:[a.INVENTORY_RECORDS_VIEW]},"/dashboard/cost-management":{view:[a.COST_VIEW]},"/dashboard/time-reports":{view:[a.TIME_REPORTS_VIEW]}};function i(){let{appUser:e,hasPermission:s,hasAnyPermission:r,hasAllPermissions:a}=(0,t.a)();return{hasPermission:s,hasAnyPermission:r,hasAllPermissions:a,canAccess:s=>null!=e&&!!e.permissions&&function(e,s){let r=n[e];return!r||0===r.view.length||r.view.some(e=>s.includes(e))}(s,e.permissions),canManage:s=>null!=e&&!!e.permissions&&function(e,s){let r=n[e];return null!=r&&!!r.manage&&r.manage.some(e=>s.includes(e))}(s,e.permissions),isAdmin:()=>(null==e?void 0:e.roleName)==="系統管理員",isForeman:()=>(null==e?void 0:e.roleName)==="生產領班",isTimekeeper:()=>(null==e?void 0:e.roleName)==="計時人員",userRole:(null==e?void 0:e.roleName)||"未設定",userPermissions:(null==e?void 0:e.permissions)||[]}}a.PERSONNEL_VIEW,a.PERSONNEL_MANAGE,a.TIME_VIEW,a.TIME_MANAGE,a.SUPPLIERS_VIEW,a.SUPPLIERS_MANAGE,a.PURCHASE_VIEW,a.PURCHASE_MANAGE,a.MATERIALS_VIEW,a.MATERIALS_MANAGE,a.FRAGRANCES_VIEW,a.FRAGRANCES_MANAGE,a.PRODUCTS_VIEW,a.PRODUCTS_MANAGE,a.WORK_ORDERS_VIEW,a.WORK_ORDERS_MANAGE,a.INVENTORY_VIEW,a.INVENTORY_MANAGE,a.INVENTORY_RECORDS_VIEW,a.COST_VIEW,a.TIME_REPORTS_VIEW,a.ROLES_MANAGE,a.SYSTEM_SETTINGS}},function(e){e.O(0,[3609,9015,3676,5569,4438,3909,1858,2365,2971,2117,1744],function(){return e(e.s=24663)}),_N_E=e.O()}]);