(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7020],{30337:function(e,t,s){Promise.resolve().then(s.bind(s,77989))},73618:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(79205).Z)("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]])},16275:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(79205).Z)("ShoppingCart",[["circle",{cx:"8",cy:"21",r:"1",key:"jimo8o"}],["circle",{cx:"19",cy:"21",r:"1",key:"13723u"}],["path",{d:"M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12",key:"9zh506"}]])},77989:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return O}});var a=s(57437),r=s(2265),l=s(99376),n=s(5978),c=s(1850),i=s(46410),o=s(5960),d=s(85452),u=s(25751),m=s(44794),h=s(56475),x=s(61649),g=s(73618),p=s(99397),j=s(73247),f=s(16275),b=s(32489),y=s(67782),v=s(42208),N=s(15868),k=s(76865),C=s(14438),w=s(33804),S=s(12381),z=s(32060),Z=s(68245),L=s(40279),P=s(79820),E=s(69174),M=s(64853),A=s(83112);function U(){let e=(0,l.useRouter)(),t=(0,l.useSearchParams)(),[s,U]=(0,r.useState)([]),[O,I]=(0,r.useState)([]),[q,F]=(0,r.useState)(!0),[D,R]=(0,r.useState)(!1),[X,$]=(0,r.useState)(!1),[T,V]=(0,r.useState)(!1),[W,_]=(0,r.useState)(null),[J,Q]=(0,r.useState)(new Set),[B,Y]=(0,r.useState)(""),[H,G]=(0,r.useState)(""),[K,ee]=(0,r.useState)(""),[et,es]=(0,r.useState)(!1),[ea,er]=(0,r.useState)(!1),[el,en]=(0,r.useState)({}),[ec,ei]=(0,r.useState)(!1),[eo,ed]=(0,r.useState)(!1),[eu,em]=(0,r.useState)(!1),[eh,ex]=(0,r.useState)(null),[eg,ep]=(0,r.useState)(!1),[ej,ef]=(0,r.useState)(!1),eb=(0,r.useCallback)(async()=>{let e=new Map;try{if(!i.db)throw Error("Firebase 未初始化");(await (0,n.getDocs)((0,n.collection)(i.db,"suppliers"))).forEach(t=>{e.set(t.id,t.data().name)})}catch(e){console.error("Failed to fetch suppliers for mapping:",e)}return e},[]),ey=(0,r.useCallback)(async e=>{F(!0);try{if(!i.db)throw Error("Firebase 未初始化");let t=(0,n.collection)(i.db,"materials"),s=(await (0,n.getDocs)(t)).docs.map(t=>{let s=t.data(),a=s.supplierRef,r=a?e.get(a.id)||"讀取失敗":"未指定";return{id:t.id,refPath:t.ref.path,code:s.code,name:s.name,category:s.category,subCategory:s.subCategory,supplierRef:s.supplierRef,supplierName:r,safetyStockLevel:s.safetyStockLevel||0,costPerUnit:s.costPerUnit||0,unit:s.unit,currentStock:s.currentStock||0,notes:s.notes}});s.sort((e,t)=>{let s=e.category||"",a=t.category||"";if(s!==a)return s.localeCompare(a,"zh-TW");let r=e.subCategory||"",l=t.subCategory||"";return r!==l?r.localeCompare(l,"zh-TW"):e.name.localeCompare(t.name,"zh-TW")}),U(s)}catch(e){console.error("Failed to fetch materials:",e),C.Am.error("讀取物料資料失敗。")}finally{F(!1)}},[]),ev=e=>(e.currentStock||0)<(e.safetyStockLevel||0),eN=(0,r.useCallback)(()=>{let e=new Map,t=new Map;s.forEach(s=>{s.category&&s.subCategory&&(e.has(s.category)||e.set(s.category,new Set),e.get(s.category).add(s.subCategory),t.has(s.subCategory)||t.set(s.subCategory,new Set),t.get(s.subCategory).add(s.category))});let a=s;if(B.trim()){let e=B.toLowerCase().trim();a=s.filter(t=>{var s,a;return t.name.toLowerCase().includes(e)||t.code.toLowerCase().includes(e)||(null===(s=t.category)||void 0===s?void 0:s.toLowerCase().includes(e))||(null===(a=t.subCategory)||void 0===a?void 0:a.toLowerCase().includes(e))||t.supplierName.toLowerCase().includes(e)})}let r=new Set,l=new Set;a.forEach(e=>{e.category&&r.add(e.category),e.subCategory&&l.add(e.subCategory)});let n=new Set,c=new Set;if(H&&K){let s=e.get(H),a=t.get(K);if((null==s?void 0:s.has(K))&&(null==a?void 0:a.has(H)))n.add(H),c.add(K);else{if(H){n.add(H);let t=e.get(H);t&&t.forEach(e=>{l.has(e)&&c.add(e)})}if(K){c.add(K);let e=t.get(K);e&&e.forEach(e=>{r.has(e)&&n.add(e)})}}}else if(H){n.add(H);let t=e.get(H);t&&t.forEach(e=>{l.has(e)&&c.add(e)})}else if(K){c.add(K);let e=t.get(K);e&&e.forEach(e=>{r.has(e)&&n.add(e)})}else n=r,c=l;return{categories:Array.from(n).sort(),subCategories:Array.from(c).sort()}},[s,B,H,K,et]),ek=e=>{ex(e),ep(!0)},eC=e=>{_(e),R(!0)},ew=e=>{_(e),$(!0)},eS=async()=>{if(W)try{let e=(0,c.$C)(),t=(0,c.V1)(e,"deleteMaterial");await t({materialId:W.id}),C.Am.success("物料 ".concat(W.name," 已成功刪除。"));let s=await eb();await ey(s)}catch(e){console.error("Error deleting material:",e),C.Am.error("刪除物料時發生錯誤。")}finally{$(!1),_(null)}},ez=async()=>{if(0===J.size){C.Am.info("請至少選擇一個物料進行刪除。");return}try{let e=(0,c.$C)(),t=(0,c.V1)(e,"deleteMaterial"),a=s.filter(e=>J.has(e.id)),r=C.Am.loading("正在刪除 ".concat(a.length," 個物料..."));for(let e of a)await t({materialId:e.id});C.Am.success("成功刪除 ".concat(a.length," 個物料。"),{id:r}),Q(new Set);let l=await eb();await ey(l)}catch(e){console.error("Error batch deleting materials:",e),C.Am.error("批量刪除物料時發生錯誤。")}finally{V(!1)}},eZ=(0,r.useCallback)(()=>{let e=s;if(B.trim()){let t=B.toLowerCase().trim();console.log("搜尋條件:",t),e=e.filter(e=>{var s,a;let r=e.name.toLowerCase().includes(t),l=e.code.toLowerCase().includes(t),n=null===(s=e.category)||void 0===s?void 0:s.toLowerCase().includes(t),c=null===(a=e.subCategory)||void 0===a?void 0:a.toLowerCase().includes(t),i=e.supplierName.toLowerCase().includes(t),o=r||l||n||c||i;return o&&console.log("找到匹配:",e.name,{nameMatch:r,codeMatch:l,categoryMatch:n,subCategoryMatch:c,supplierMatch:i}),o})}H&&(e=e.filter(e=>e.category===H)),K&&(e=e.filter(e=>e.subCategory===K)),et&&(e=e.filter(e=>ev(e))),e.sort((e,t)=>{let s=e.category||"",a=t.category||"";if(s!==a)return s.localeCompare(a,"zh-TW");let r=e.subCategory||"",l=t.subCategory||"";return r!==l?r.localeCompare(l,"zh-TW"):e.name.localeCompare(t.name,"zh-TW")}),console.log("篩選結果:",{searchTerm:B.trim(),totalMaterials:s.length,filteredCount:e.length,selectedCategory:H,selectedSubCategory:K}),I(e)},[s,B,H,K,et]),eL=e=>{Y(e),eZ()},eP=e=>{G(H===e?"":e)},eE=e=>{ee(K===e?"":e)},eM=()=>{_(null),R(!0)},eA=async()=>{let e=await eb();await ey(e)},eU=e=>{Q(t=>{let s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})},eO=e=>{try{var t;let s={id:e.id,name:e.name,code:e.code,type:"material",supplierId:(null===(t=e.supplierRef)||void 0===t?void 0:t.id)||"",supplierName:e.supplierName||"未指定",unit:e.unit||"",quantity:1,costPerUnit:e.costPerUnit||0,currentStock:e.currentStock||0},a=localStorage.getItem("purchaseCart"),r=[];if(a)try{r=JSON.parse(a)}catch(e){console.error("解析採購車資料失敗:",e)}let l=r.findIndex(t=>t.id===e.id&&"material"===t.type);l>=0?(r[l].quantity+=1,C.Am.success("已增加 ".concat(e.name," 的數量"))):(r.push(s),C.Am.success("已將 ".concat(e.name," 加入採購車"))),localStorage.setItem("purchaseCart",JSON.stringify(r))}catch(e){console.error("添加到採購車失敗:",e),C.Am.error("添加到採購車失敗")}},eI=(e,t)=>{en(s=>({...s,[e]:t}))},eq=async()=>{if(0===s.filter(e=>void 0!==el[e.id]&&el[e.id]!==e.currentStock).map(e=>({itemRefPath:"materials/".concat(e.id),currentStock:e.currentStock,newStock:el[e.id]})).length){C.Am.info("庫存數量沒有變更，無需儲存。"),er(!1),en({});return}ed(!0)},eF=async()=>{let e=s.filter(e=>void 0!==el[e.id]&&el[e.id]!==e.currentStock).map(e=>({itemRefPath:"materials/".concat(e.id),currentStock:e.currentStock,newStock:el[e.id]})),t=C.Am.loading("正在儲存盤點結果...");try{let s=(0,c.$C)(),a=(0,c.V1)(s,"performStocktake");await a({items:e}),C.Am.success("盤點結果儲存成功，庫存已更新。",{id:t}),en({}),er(!1),ed(!1);let r=await eb();await ey(r)}catch(s){let e=s instanceof Error?s.message:"儲存盤點失敗";C.Am.error(e,{id:t})}},eD=()=>{en({}),er(!1)};(0,r.useEffect)(()=>{(async()=>{let e=await eb();await ey(e)})()},[ey,eb]),(0,r.useEffect)(()=>{let a=t.get("edit");if(a&&s.length>0){let t=s.find(e=>e.id===a);t&&(_(t),R(!0),e.replace("/dashboard/materials"))}},[t,s,e]),(0,r.useEffect)(()=>{s.length>0&&eZ()},[s,eZ]);let{categories:eR,subCategories:eX}=(0,r.useMemo)(()=>eN(),[eN]);return(0,a.jsxs)("div",{className:"container mx-auto py-10 materials-page",children:[(0,a.jsx)("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8",children:(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-3xl font-bold text-orange-600",children:ea?"盤點模式中":"物料管理"}),(0,a.jsx)("p",{className:"text-muted-foreground mt-2",children:ea?"進行庫存盤點作業":"管理系統中的所有物料資料"})]})}),(0,a.jsx)("div",{className:"lg:hidden mb-6",children:(0,a.jsx)("div",{className:"grid grid-cols-2 gap-3 mb-3",children:ea?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(S.z,{onClick:eq,className:"w-full",children:[(0,a.jsx)(m.Z,{className:"mr-2 h-4 w-4"}),"儲存盤點"]}),(0,a.jsx)(S.z,{variant:"outline",onClick:eD,className:"w-full",children:"取消"})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(S.z,{variant:"outline",onClick:()=>ef(!0),className:"w-full",children:[(0,a.jsx)(h.Z,{className:"mr-2 h-4 w-4"}),"物料分類"]}),(0,a.jsxs)(S.z,{variant:"outline",onClick:()=>em(!0),className:"w-full",children:[(0,a.jsx)(x.Z,{className:"mr-2 h-4 w-4"}),"匯入/匯出"]}),(0,a.jsxs)(S.z,{variant:"outline",onClick:()=>er(!0),className:"w-full",children:[(0,a.jsx)(g.Z,{className:"mr-2 h-4 w-4"}),"盤點模式"]}),(0,a.jsxs)(S.z,{onClick:eM,className:"w-full bg-orange-600 hover:bg-orange-700",children:[(0,a.jsx)(p.Z,{className:"mr-2 h-4 w-4"}),"新增物料"]})]})})}),(0,a.jsx)("div",{className:"hidden lg:block mb-6",children:(0,a.jsx)("div",{className:"flex flex-wrap items-center gap-2 justify-end",children:ea?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(S.z,{onClick:eq,children:[(0,a.jsx)(m.Z,{className:"mr-2 h-4 w-4"}),"儲存盤點"]}),(0,a.jsx)(S.z,{variant:"outline",onClick:eD,children:"取消"})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(S.z,{variant:"outline",onClick:()=>ef(!0),children:[(0,a.jsx)(h.Z,{className:"mr-2 h-4 w-4"}),"物料分類"]}),(0,a.jsxs)(S.z,{variant:"outline",onClick:()=>em(!0),children:[(0,a.jsx)(x.Z,{className:"mr-2 h-4 w-4"}),"匯入/匯出"]}),(0,a.jsxs)(S.z,{variant:"outline",onClick:()=>er(!0),children:[(0,a.jsx)(g.Z,{className:"mr-2 h-4 w-4"}),"盤點模式"]}),(0,a.jsxs)(S.z,{onClick:eM,className:"bg-orange-600 hover:bg-orange-700",children:[(0,a.jsx)(p.Z,{className:"mr-2 h-4 w-4"}),"新增物料"]})]})})}),(0,a.jsx)(P.Zb,{className:"mb-6 border-0 shadow-lg bg-gradient-to-r from-orange-50 to-orange-100",children:(0,a.jsx)(P.aY,{className:"pt-6",children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(j.Z,{className:"absolute left-3 top-3 h-4 w-4 text-orange-600"}),(0,a.jsx)(L.I,{placeholder:"搜尋物料名稱、代號、分類或供應商...",value:B,onChange:e=>eL(e.target.value),className:"pl-10 border-input focus:border-orange-500 focus:ring-orange-500"})]})})}),(0,a.jsx)("div",{className:"mb-6",children:(0,a.jsxs)("div",{className:"flex flex-wrap gap-2",children:[s.filter(e=>ev(e)).length>0&&(0,a.jsxs)(E.C,{variant:et?"default":"secondary",className:"cursor-pointer transition-colors ".concat(et?"bg-red-600 hover:bg-red-700 text-white":"bg-red-100 hover:bg-red-200 text-red-800 border-red-300"),onClick:()=>{es(!et)},children:["安全庫存 (",s.filter(e=>ev(e)).length,")"]}),eR.map(e=>(0,a.jsx)(E.C,{variant:H===e?"default":"secondary",className:"cursor-pointer transition-colors ".concat(H===e?"bg-blue-600 hover:bg-blue-700 text-white":"bg-blue-100 hover:bg-blue-200 text-blue-800 border-blue-300"),onClick:()=>eP(e),children:e},e)),eX.map(e=>(0,a.jsx)(E.C,{variant:K===e?"default":"secondary",className:"cursor-pointer transition-colors ".concat(K===e?"bg-green-600 hover:bg-green-700 text-white":"bg-green-100 hover:bg-green-200 text-green-800 border-green-300"),onClick:()=>eE(e),children:e},e))]})}),J.size>0&&!ea&&(0,a.jsx)("div",{className:"mb-6",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)(S.z,{variant:"outline",size:"sm",onClick:()=>{if(0===J.size){C.Am.info("請至少選擇一個物料加入採購車。");return}try{let e=localStorage.getItem("purchaseCart"),t=e?JSON.parse(e):[],a=s.filter(e=>J.has(e.id));a.forEach(e=>{let s=t.find(t=>t.id===e.id&&"material"===t.type);if(s)s.quantity+=1;else{var a;t.push({id:e.id,name:e.name,code:e.code,type:"material",supplierId:(null===(a=e.supplierRef)||void 0===a?void 0:a.id)||"",supplierName:e.supplierName,unit:e.unit||"個",quantity:1,costPerUnit:e.costPerUnit||0,currentStock:e.currentStock||0})}}),localStorage.setItem("purchaseCart",JSON.stringify(t)),window.dispatchEvent(new CustomEvent("purchaseCartUpdated")),C.Am.success("已將 ".concat(a.length," 個物料加入採購車")),Q(new Set)}catch(e){console.error("加入採購車失敗:",e),C.Am.error("加入採購車失敗")}},className:"flex items-center gap-2",children:[(0,a.jsx)(f.Z,{className:"h-4 w-4"}),"加入採購車 (",J.size,")"]}),(0,a.jsxs)(S.z,{variant:"destructive",size:"sm",onClick:()=>V(!0),className:"flex items-center gap-2",children:[(0,a.jsx)(b.Z,{className:"h-4 w-4"}),"批量刪除 (",J.size,")"]})]})}),q&&(0,a.jsx)("div",{className:"flex justify-center items-center py-20",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"w-10 h-10 border-4 border-border rounded-full animate-spin border-t-primary mx-auto mb-4"}),(0,a.jsx)("p",{className:"text-muted-foreground",children:"載入中..."})]})}),!q&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"lg:hidden space-y-4",children:O.map(t=>{var s,r,l,n,c,i,o,d;return(0,a.jsx)(P.Zb,{className:"relative transition-colors duration-200 ".concat(ev(t)?"bg-pink-50":""),children:(0,a.jsxs)(P.aY,{className:"p-4",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between",children:[(0,a.jsxs)("div",{className:"flex-1 ".concat(ea?"":"cursor-pointer"),onClick:ea?void 0:()=>e.push("/dashboard/materials/".concat(t.id)),children:[(0,a.jsx)("div",{className:"font-medium text-foreground text-sm",children:t.name}),(0,a.jsxs)("div",{className:"text-xs text-muted-foreground",children:["代號: ",t.code]})]}),(0,a.jsxs)(z.h_,{children:[(0,a.jsx)(z.$F,{asChild:!0,children:(0,a.jsx)(S.z,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",children:(0,a.jsx)(y.Z,{className:"h-4 w-4"})})}),(0,a.jsxs)(z.AW,{align:"end",children:[(0,a.jsx)(z.Ju,{children:"操作"}),(0,a.jsxs)(z.Xi,{onClick:()=>ek(t),children:[(0,a.jsx)(v.Z,{className:"mr-2 h-4 w-4"}),"查看詳情"]}),(0,a.jsxs)(z.Xi,{onClick:()=>eC(t),children:[(0,a.jsx)(N.Z,{className:"mr-2 h-4 w-4"}),"編輯"]}),(0,a.jsx)(z.VD,{}),(0,a.jsxs)(z.Xi,{onClick:()=>ew(t),className:"text-red-600",children:[(0,a.jsx)(b.Z,{className:"mr-2 h-4 w-4"}),"刪除"]})]})]})]}),(0,a.jsxs)("div",{className:"mt-3 space-y-2",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:"分類:"}),(0,a.jsxs)("div",{className:"flex flex-wrap gap-1",children:[t.category&&(0,a.jsx)(E.C,{variant:"outline",className:"text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 border-blue-300",children:t.category}),t.subCategory&&(0,a.jsx)(E.C,{variant:"outline",className:"text-xs bg-green-100 hover:bg-green-200 text-green-800 border-green-300",children:t.subCategory})]})]}),!ea&&(0,a.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:"供應商:"}),(0,a.jsx)("span",{children:t.supplierName})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:ea?"應有庫存:":"目前庫存:"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("span",{className:ev(t)?"text-red-600 font-medium":"",children:[t.currentStock||0," ",t.unit]}),ev(t)&&(0,a.jsx)(k.Z,{className:"h-3 w-3 text-red-600"})]})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:"安全庫存:"}),(0,a.jsxs)("span",{children:[t.safetyStockLevel||0," ",t.unit]})]}),!ea&&(0,a.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:"成本:"}),(0,a.jsxs)("span",{children:["$",t.costPerUnit||0]})]})]}),ea&&(0,a.jsx)("div",{className:"mt-3 pt-3 border-t ".concat((null!==(r=null!==(s=el[t.id])&&void 0!==s?s:t.currentStock)&&void 0!==r?r:0)>(null!==(l=t.currentStock)&&void 0!==l?l:0)?"bg-green-50 -mx-4 -mb-4 px-4 pb-4":(null!==(c=null!==(n=el[t.id])&&void 0!==n?n:t.currentStock)&&void 0!==c?c:0)<(null!==(i=t.currentStock)&&void 0!==i?i:0)?"bg-pink-50 -mx-4 -mb-4 px-4 pb-4":""),children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-sm font-medium",children:"現有庫存:"}),(0,a.jsx)(L.I,{type:"number",inputMode:"numeric",value:null!==(d=null!==(o=el[t.id])&&void 0!==o?o:t.currentStock)&&void 0!==d?d:0,onChange:e=>eI(t.id,Number(e.target.value)),className:"w-20 h-8 text-sm"}),(0,a.jsx)("span",{className:"text-sm text-muted-foreground",children:t.unit})]})}),!ea&&(0,a.jsx)("div",{className:"mt-3 pt-3 border-t",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(Z.X,{checked:J.has(t.id),onCheckedChange:()=>eU(t.id)}),(0,a.jsxs)(S.z,{variant:"outline",size:"sm",onClick:()=>eO(t),className:"h-8 px-2 text-xs border-amber-200 text-amber-600 hover:bg-amber-50",children:[(0,a.jsx)(f.Z,{className:"h-3 w-3 mr-1"}),"加入採購車"]})]}),(0,a.jsxs)("div",{className:"text-sm text-muted-foreground",children:["$",t.costPerUnit||0]})]})})]})},t.id)})}),(0,a.jsx)("div",{className:"hidden lg:block",children:(0,a.jsx)(P.Zb,{children:(0,a.jsxs)(w.iA,{children:[(0,a.jsx)(w.xD,{children:(0,a.jsxs)(w.SC,{children:[(0,a.jsx)(w.ss,{className:"w-12",children:!ea&&(0,a.jsxs)("div",{className:"flex items-center gap-2",title:"全選所有物料",children:[(0,a.jsx)(Z.X,{checked:J.size===O.length&&O.length>0,onCheckedChange:e=>{e?Q(new Set(O.map(e=>e.id))):Q(new Set)}}),(0,a.jsx)("span",{className:"text-xs text-muted-foreground",children:"全選"})]})}),(0,a.jsx)(w.ss,{children:"物料資訊"}),(0,a.jsx)(w.ss,{children:"分類"}),!ea&&(0,a.jsx)(w.ss,{children:"供應商"}),(0,a.jsx)(w.ss,{children:ea?"應有庫存":"庫存"}),ea&&(0,a.jsx)(w.ss,{children:"現有庫存"}),!ea&&(0,a.jsx)(w.ss,{children:"成本"}),(0,a.jsx)(w.ss,{className:"w-12",children:"操作"})]})}),(0,a.jsx)(w.RM,{children:O.map(t=>{var s,r,l,n,c,i,o,d;return(0,a.jsxs)(w.SC,{className:"hover:bg-orange-50 transition-colors duration-200 ".concat(ev(t)?"bg-pink-50":""),children:[(0,a.jsx)(w.pj,{onClick:e=>e.stopPropagation(),children:!ea&&(0,a.jsx)(Z.X,{checked:J.has(t.id),onCheckedChange:()=>eU(t.id)})}),(0,a.jsxs)(w.pj,{className:ea?"":"cursor-pointer",onClick:ea?void 0:()=>e.push("/dashboard/materials/".concat(t.id)),children:[(0,a.jsx)("div",{className:"font-medium text-foreground",children:t.name}),(0,a.jsxs)("div",{className:"text-xs text-muted-foreground",children:["代號: ",t.code]})]}),(0,a.jsx)(w.pj,{className:ea?"":"cursor-pointer",onClick:ea?void 0:()=>e.push("/dashboard/materials/".concat(t.id)),children:(0,a.jsxs)("div",{className:"flex flex-wrap gap-1",children:[t.category&&(0,a.jsx)(E.C,{variant:"outline",className:"text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 border-blue-300",children:t.category}),t.subCategory&&(0,a.jsx)(E.C,{variant:"outline",className:"text-xs bg-green-100 hover:bg-green-200 text-green-800 border-green-300",children:t.subCategory})]})}),!ea&&(0,a.jsx)(w.pj,{className:ea?"":"cursor-pointer",onClick:ea?void 0:()=>e.push("/dashboard/materials/".concat(t.id)),children:t.supplierName}),(0,a.jsxs)(w.pj,{className:ea?"":"cursor-pointer",onClick:ea?void 0:()=>e.push("/dashboard/materials/".concat(t.id)),children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("span",{className:ev(t)?"text-red-600 font-medium":"",children:[t.currentStock||0," ",t.unit]}),ev(t)&&(0,a.jsx)(k.Z,{className:"h-3 w-3 text-red-600"})]}),(0,a.jsxs)("div",{className:"text-xs text-muted-foreground",children:["安全庫存: ",t.safetyStockLevel||0," ",t.unit]})]}),ea&&(0,a.jsx)(w.pj,{className:(null!==(r=null!==(s=el[t.id])&&void 0!==s?s:t.currentStock)&&void 0!==r?r:0)>(null!==(l=t.currentStock)&&void 0!==l?l:0)?"bg-green-50":(null!==(c=null!==(n=el[t.id])&&void 0!==n?n:t.currentStock)&&void 0!==c?c:0)<(null!==(i=t.currentStock)&&void 0!==i?i:0)?"bg-pink-50":"",children:(0,a.jsx)(L.I,{type:"number",inputMode:"numeric",value:null!==(d=null!==(o=el[t.id])&&void 0!==o?o:t.currentStock)&&void 0!==d?d:0,onChange:e=>eI(t.id,Number(e.target.value)),className:"w-20 h-8 text-sm"})}),!ea&&(0,a.jsxs)(w.pj,{className:ea?"":"cursor-pointer",onClick:ea?void 0:()=>e.push("/dashboard/materials/".concat(t.id)),children:["$",t.costPerUnit||0]}),(0,a.jsx)(w.pj,{children:(0,a.jsxs)(z.h_,{children:[(0,a.jsx)(z.$F,{asChild:!0,children:(0,a.jsx)(S.z,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:e=>e.stopPropagation(),children:(0,a.jsx)(y.Z,{className:"h-4 w-4"})})}),(0,a.jsxs)(z.AW,{align:"end",children:[(0,a.jsx)(z.Ju,{children:"操作"}),(0,a.jsxs)(z.Xi,{onClick:()=>eO(t),children:[(0,a.jsx)(f.Z,{className:"mr-2 h-4 w-4"}),"加入採購車"]}),(0,a.jsxs)(z.Xi,{onClick:()=>ek(t),children:[(0,a.jsx)(v.Z,{className:"mr-2 h-4 w-4"}),"查看詳情"]}),(0,a.jsxs)(z.Xi,{onClick:()=>eC(t),children:[(0,a.jsx)(N.Z,{className:"mr-2 h-4 w-4"}),"編輯"]}),(0,a.jsx)(z.VD,{}),(0,a.jsxs)(z.Xi,{onClick:()=>ew(t),className:"text-red-600",children:[(0,a.jsx)(b.Z,{className:"mr-2 h-4 w-4"}),"刪除"]})]})]})})]},t.id)})})]})})}),0===O.length&&!q&&(0,a.jsxs)("div",{className:"text-center py-20",children:[(0,a.jsx)("div",{className:"w-12 h-12 border-4 border-border rounded-full animate-spin border-t-primary mx-auto mb-4"}),(0,a.jsx)("p",{className:"text-muted-foreground",children:"沒有找到符合條件的物料"})]})]}),(0,a.jsx)(o.Z,{isOpen:D,onOpenChange:R,materialData:W,onMaterialUpdate:eA}),eh&&(0,a.jsx)(A.O,{isOpen:eg,onOpenChange:ep,title:eh.name,subtitle:"物料代號: ".concat(eh.code),sections:[{title:"基本資訊",color:"blue",fields:[{label:"物料代號",value:eh.code},{label:"物料名稱",value:eh.name},{label:"主分類",value:eh.category||"未分類"},{label:"細分分類",value:eh.subCategory||"未分類"},{label:"供應商",value:eh.supplierName},{label:"單位",value:eh.unit||"未指定"}]},{title:"庫存資訊",color:"green",fields:[{label:"目前庫存",value:"".concat(eh.currentStock||0," ").concat(eh.unit||"")},{label:"安全庫存",value:"".concat(eh.safetyStockLevel||0," ").concat(eh.unit||"")},{label:"單位成本",value:"$".concat(eh.costPerUnit||0)}]},...eh.notes?[{title:"備註",color:"yellow",fields:[{label:"備註",value:eh.notes}]}]:[]],actions:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(S.z,{variant:"outline",onClick:()=>ep(!1),children:"關閉"}),(0,a.jsxs)(S.z,{onClick:()=>{ep(!1),eC(eh)},children:[(0,a.jsx)(N.Z,{className:"mr-2 h-4 w-4"}),"編輯"]})]})}),(0,a.jsx)(u.Q,{isOpen:X,onOpenChange:$,onConfirm:eS,title:"確認刪除",description:"您確定要刪除物料「".concat(null==W?void 0:W.name,"」嗎？此操作無法復原。")}),(0,a.jsx)(u.Q,{isOpen:T,onOpenChange:V,onConfirm:ez,title:"確認批量刪除",description:"您確定要刪除選取的 ".concat(J.size," 個物料嗎？此操作無法復原。")}),(0,a.jsx)(u.Q,{isOpen:eo,onOpenChange:ed,onConfirm:eF,title:"確認盤點結果",description:"您確定要更新 ".concat(s.filter(e=>void 0!==el[e.id]&&el[e.id]!==e.currentStock).length," 個物料的庫存嗎？此操作將直接修改庫存資料。")}),(0,a.jsx)(d.J,{isOpen:ej,onOpenChange:ef}),(0,a.jsx)(M.Z,{isOpen:eu,onOpenChange:em,onImport:async(e,t,s)=>{let a=(0,c.$C)();try{console.log("開始匯入物料資料:",{totalRecords:e.length,sampleData:e.slice(0,3).map(e=>({name:e.name,code:e.code,supplierName:e.supplierName,hasSupplierName:!!e.supplierName}))});let t=new Map;if(!i.db)throw Error("Firebase 未初始化");(await (0,n.getDocs)((0,n.collection)(i.db,"suppliers"))).forEach(e=>{let s=e.data();t.set(s.name,e.id),console.log("供應商映射: ".concat(s.name," -> ").concat(e.id))});let r=new Map;(await (0,n.getDocs)((0,n.collection)(i.db,"materials"))).forEach(e=>{let t=e.data();t.code&&r.set(t.code,e.id)});let l=Math.ceil(e.length/20),o=0,d=0,u=0;for(let n=0;n<l;n++){let i=20*n,m=Math.min(i+20,e.length),h=e.slice(i,m);for(let e of h)try{let s;if(e.supplierName&&""!==e.supplierName.trim()){let a=e.supplierName.trim();s=t.get(a),console.log('尋找供應商: "'.concat(a,'" -> ').concat(s||"未找到")),s||console.warn('找不到供應商: "'.concat(a,'"'))}let l=void 0!==e.currentStock&&null!==e.currentStock&&""!==String(e.currentStock)?Number(e.currentStock):0,n=void 0!==e.safetyStockLevel&&null!==e.safetyStockLevel&&""!==String(e.safetyStockLevel)?Number(e.safetyStockLevel):0,i=void 0!==e.costPerUnit&&null!==e.costPerUnit&&""!==String(e.costPerUnit)?Number(e.costPerUnit):0,o={code:e.code,name:e.name,category:e.category||"",subCategory:e.subCategory||"",supplierId:s,currentStock:l,safetyStockLevel:n,costPerUnit:i,unit:e.unit||"個",notes:e.notes||""};if(console.log("處理物料 ".concat(e.name," 的完整資料:"),{code:o.code,name:o.name,category:o.category,subCategory:o.subCategory,supplierId:o.supplierId,currentStock:o.currentStock,safetyStockLevel:o.safetyStockLevel,costPerUnit:o.costPerUnit,unit:o.unit,notes:o.notes}),r.get(e.code)){console.log("物料代號 ".concat(e.code," 已存在，執行更新操作"));let t=(0,c.V1)(a,"updateMaterialByCode");await t(o),u++}else{console.log("物料代號 ".concat(e.code," 不存在，執行新增操作"));let t=(0,c.V1)(a,"createMaterial");await t(o),d++}}catch(e){throw console.error("處理物料資料失敗:",e),e}o+=h.length,null==s||s(o,e.length),n<l-1&&await new Promise(e=>setTimeout(e,500))}console.log("物料匯入結果:","成功處理 ".concat(o," 筆資料 (新增: ").concat(d,", 更新: ").concat(u,")")),eA()}catch(e){throw console.error("匯入物料失敗:",e),e}},onExport:async()=>s.map(e=>({code:e.code,name:e.name,category:e.category,subCategory:e.subCategory,supplierName:e.supplierName,safetyStockLevel:e.safetyStockLevel,costPerUnit:e.costPerUnit,unit:e.unit,currentStock:e.currentStock,notes:e.notes})),title:"物料資料",description:"匯入或匯出物料資料，支援 Excel 和 CSV 格式。匯入時會智能匹配物料代號：如果代號不存在則新增，如果代號已存在則更新覆蓋有填入的欄位。",color:"yellow",showUpdateOption:!0,maxBatchSize:500,sampleData:[{code:"MAT001",name:"示例物料",category:"原料",subCategory:"基礎原料",supplierName:"示例供應商",safetyStockLevel:100,costPerUnit:10.5,unit:"kg",currentStock:50,notes:"示例備註"}],fields:[{key:"code",label:"物料代號",required:!1,type:"string"},{key:"name",label:"物料名稱",required:!0,type:"string"},{key:"category",label:"主分類",required:!1,type:"string"},{key:"subCategory",label:"細分分類",required:!1,type:"string"},{key:"supplierName",label:"供應商",required:!1,type:"string"},{key:"safetyStockLevel",label:"安全庫存",required:!1,type:"number"},{key:"costPerUnit",label:"單位成本",required:!1,type:"number"},{key:"unit",label:"單位",required:!1,type:"string"},{key:"currentStock",label:"目前庫存",required:!1,type:"number"},{key:"notes",label:"備註",required:!1,type:"string"}]})]})}function O(){return(0,a.jsx)(r.Suspense,{fallback:(0,a.jsx)("div",{children:"Loading..."}),children:(0,a.jsx)(U,{})})}}},function(e){e.O(0,[3609,9015,1425,3676,5569,4438,9436,3909,2696,4116,4200,6818,5184,5711,2365,2313,7613,5452,195,2971,2117,1744],function(){return e(e.s=30337)}),_N_E=e.O()}]);