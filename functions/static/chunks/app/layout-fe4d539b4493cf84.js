(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3185],{81097:function(e,n,r){Promise.resolve().then(r.t.bind(r,14811,23)),Promise.resolve().then(r.bind(r,35129)),Promise.resolve().then(r.t.bind(r,2778,23))},35129:function(e,n,r){"use strict";r.d(n,{ClientProvider:function(){return d}});var t=r(57437),s=r(71245),o=r(2265),a=o.createContext(void 0),i={setTheme:e=>{},themes:[]},u=()=>{var e;return null!=(e=o.useContext(a))?e:i},l=r(14438);let c=e=>{let{...n}=e,{theme:r="system"}=u();return(0,t.jsx)(l.x7,{theme:r,className:"toaster group",style:{"--normal-bg":"var(--popover)","--normal-text":"var(--popover-foreground)","--normal-border":"var(--border)"},toastOptions:{style:{background:"rgb(var(--toast-bg, 255 255 255))",color:"rgb(var(--toast-text, 15 23 42))",border:"1px solid rgb(var(--toast-border, 226 232 240))",borderRadius:"var(--radius)",boxShadow:"0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)"}},...n})};function d(e){let{children:n}=e;return(0,t.jsxs)(s.H,{children:[n,(0,t.jsx)(c,{})]})}},71245:function(e,n,r){"use strict";r.d(n,{H:function(){return d},a:function(){return f}});var t=r(57437),s=r(2265),o=r(82148),a=r(46410),i=r(5978),u=r(14438),l=r(47903);let c=(0,s.createContext)({user:null,appUser:null,isLoading:!0,login:async()=>!1,logout:async()=>{},hasPermission:()=>!1,hasAnyPermission:()=>!1,hasAllPermissions:()=>!1}),d=e=>{let{children:n}=e,[r,d]=(0,s.useState)(null),[f,b]=(0,s.useState)(null),[m,g]=(0,s.useState)(!0),h=async e=>{(0,l.fF)("loadUserData 開始執行",{uid:e.uid});try{let n=(0,a.T)();if(!n){(0,l.vU)("Firestore 未初始化"),b(null);return}(0,l.fF)("獲取用戶文檔",{uid:e.uid});let r=await (0,i.QT)((0,i.doc)(n,"users",e.uid));if(r.exists()){(0,l.fF)("用戶文檔存在");let e=r.data();if((0,l.fF)("用戶資料",e),e.roleRef){(0,l.fF)("用戶有角色引用，獲取角色資料");try{let n=await (0,i.QT)(e.roleRef);if(n.exists()){let r=n.data();e.roleName=r.displayName||r.name,e.permissions=r.permissions||[],(0,l.fF)("角色資料載入成功",{role:e.roleName,permissions:e.permissions})}else(0,l.ZK)("角色文檔不存在")}catch(e){(0,l.vU)("載入角色資料失敗",e)}}else(0,l.ZK)("用戶沒有角色引用");(0,l.fF)("設置 appUser",e),b(e)}else(0,l.ZK)("用戶文檔不存在"),b(null)}catch(e){(0,l.vU)("載入用戶資料失敗",e),b(null)}},p=async(e,n)=>{try{let r=(0,a.E7)();if(!r)return u.Am.error("系統初始化失敗"),!1;let t=e.includes("@")?e:"".concat(e,"@deer-lab.local"),s=await (0,o.e5)(r,t,n);return await h(s.user),u.Am.success("登入成功！"),!0}catch(e){return(0,l.vU)("登入失敗",e),u.Am.error(e.message||"登入失敗"),!1}},v=async()=>{try{let e=(0,a.E7)();e&&(await (0,o.w7)(e),d(null),b(null),u.Am.success("已成功登出"),window.location.href="/")}catch(e){(0,l.vU)("登出失敗",e),u.Am.error("登出失敗")}};return(0,s.useEffect)(()=>{(0,l.fF)("AuthContext useEffect 開始執行");try{let e=(0,a.E7)();if(!e){(0,l.vU)("Auth 未初始化，設置 isLoading = false"),g(!1);return}(0,l.fF)("設置 onAuthStateChanged 監聽器");let n=(0,o.Aj)(e,async e=>{try{(0,l.fF)("onAuthStateChanged 觸發",{uid:(null==e?void 0:e.uid)||null}),e?(d(e),(0,l.fF)("開始載入用戶資料"),await h(e)):(d(null),b(null),(0,l.fF)("用戶已登出，清除狀態")),g(!1),(0,l.fF)("設置 isLoading = false")}catch(e){(0,l.vU)("onAuthStateChanged 回調執行失敗",e),g(!1)}});return()=>{(0,l.fF)("清理 onAuthStateChanged 監聽器"),"function"==typeof n&&n()}}catch(e){(0,l.vU)("AuthContext useEffect 執行失敗",e),g(!1)}},[]),(0,t.jsx)(c.Provider,{value:{user:r,appUser:f,isLoading:m,login:p,logout:v,hasPermission:e=>null!=f&&!!f.permissions&&f.permissions.includes(e),hasAnyPermission:e=>null!=f&&!!f.permissions&&e.some(e=>f.permissions.includes(e)),hasAllPermissions:e=>null!=f&&!!f.permissions&&e.every(e=>f.permissions.includes(e))},children:n})},f=()=>(0,s.useContext)(c)},46410:function(e,n,r){"use strict";r.d(n,{E7:function(){return h},KT:function(){return v},T:function(){return p},db:function(){return C}});var t=r(738),s=r(82148),o=r(5978),a=r(1850),i=r(96485),u=r(47903);(0,u.wC)("Firebase 模組載入...");let l=null,c=null,d=null,f=null,b=null,m=!1;function g(){return m?{app:l,auth:c,db:d,functions:f,storage:b}:function(){if(m)return(0,u.wC)("Firebase 已經初始化"),{app:l,auth:c,db:d,functions:f,storage:b};try{(0,u.wC)("開始初始化 Firebase...");let e=function(){let e={apiKey:"AIzaSyCMIAqNPsIyl3fJNllqNCuUJE2Rvcdf6fk",authDomain:"deer-lab.firebaseapp.com",projectId:"deer-lab",storageBucket:"deer-lab.firebasestorage.app",messagingSenderId:"554942047858",appId:"1:554942047858:web:607d3e27bb438c898644eb"};return(0,u.wC)("Firebase 配置檢查:"),(0,u.wC)("  API Key: ".concat(e.apiKey?"✅ 已設置":"❌ 未設置")),(0,u.wC)("  Auth Domain: ".concat(e.authDomain?"✅ 已設置":"❌ 未設置")),(0,u.wC)("  Project ID: ".concat(e.projectId?"✅ 已設置":"❌ 未設置")),(0,u.wC)("  Storage Bucket: ".concat(e.storageBucket?"✅ 已設置":"❌ 未設置")),(0,u.wC)("  Messaging Sender ID: ".concat(e.messagingSenderId?"✅ 已設置":"❌ 未設置")),(0,u.wC)("  App ID: ".concat(e.appId?"✅ 已設置":"❌ 未設置")),e}();if(!e.apiKey)throw Error("Missing NEXT_PUBLIC_FIREBASE_API_KEY environment variable");if(!e.authDomain)throw Error("Missing NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN environment variable");if(!e.projectId)throw Error("Missing NEXT_PUBLIC_FIREBASE_PROJECT_ID environment variable");return(0,u.wC)("正在初始化 Firebase App..."),l=(0,t.ZF)(e),(0,u.wC)("Firebase App 初始化成功"),(0,u.wC)("正在初始化 Firebase Auth..."),c=(0,s.v0)(l),(0,u.wC)("Firebase Auth 初始化成功"),(0,u.wC)("正在初始化 Firestore..."),d=(0,o.ad)(l),(0,u.wC)("Firestore 初始化成功"),(0,u.wC)("正在初始化 Firebase Functions..."),f=(0,a.$C)(l),(0,u.wC)("Firebase Functions 初始化成功"),(0,u.wC)("正在初始化 Firebase Storage..."),b=(0,i.getStorage)(l),(0,u.wC)("Firebase Storage 初始化成功"),m=!0,(0,u.wC)("Firebase 所有服務初始化完成！"),{app:l,auth:c,db:d,functions:f,storage:b}}catch(e){return console.error("❌ Firebase 初始化失敗:",e),{app:null,auth:null,db:null,functions:null,storage:null}}}()}function h(){return g().auth}function p(){return g().db}function v(){return g().storage}h();let C=p();g().functions,v()},47903:function(e,n,r){"use strict";r.d(n,{ZK:function(){return o},fF:function(){return i},kg:function(){return s},vU:function(){return a},wC:function(){return u}});class t{getColorCode(e){return({blue:"\x1b[34m",green:"\x1b[32m",yellow:"\x1b[33m",red:"\x1b[31m",purple:"\x1b[35m",cyan:"\x1b[36m"})[e]||""}formatMessage(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{prefix:r,color:t}=n,s=t?this.getColorCode(t):"";return"".concat(s).concat(r?"[".concat(r,"] "):"").concat(e).concat(t?"\x1b[0m":"")}log(e){for(var n=arguments.length,r=Array(n>1?n-1:0),t=1;t<n;t++)r[t-1]=arguments[t]}info(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]}success(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]}warn(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]}error(e,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.formatMessage("❌ ".concat(e),{...r,color:"red"}),console.error("系統錯誤",(null==n?void 0:n.message)||e)}debug(e,n){arguments.length>2&&void 0!==arguments[2]&&arguments[2]}firebase(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]}api(e,n,r){}performance(e,n){}}let s=new t;s.log.bind(s),s.info.bind(s),s.success.bind(s);let o=s.warn.bind(s),a=s.error.bind(s),i=s.debug.bind(s),u=s.firebase.bind(s);s.api.bind(s),s.performance.bind(s)},2778:function(){},14811:function(e){e.exports={style:{fontFamily:"'__Inter_e8ce0c', '__Inter_Fallback_e8ce0c'",fontStyle:"normal"},className:"__className_e8ce0c"}}},function(e){e.O(0,[9429,2461,3609,9015,3676,4438,2971,2117,1744],function(){return e(e.s=81097)}),_N_E=e.O()}]);