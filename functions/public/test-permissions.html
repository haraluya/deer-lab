<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¬Šé™æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æ¬Šé™ç³»çµ±æ¸¬è©¦</h1>
        
        <div id="status" class="status info">æ­£åœ¨åˆå§‹åŒ–...</div>
        
        <div>
            <button onclick="testLogin()">ğŸ” æ¸¬è©¦ç™»å…¥</button>
            <button onclick="testPermissions()">ğŸ” æ¸¬è©¦æ¬Šé™</button>
            <button onclick="testPersonnelFunctions()">ğŸ‘¥ æ¸¬è©¦äººå“¡ç®¡ç†</button>
            <button onclick="clearLog()">ğŸ§¹ æ¸…é™¤æ—¥èªŒ</button>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script type="module">
        // Firebase é…ç½® - ä½¿ç”¨æ¨¡æ“¬é…ç½®é¿å…é‡‘é‘°å¤–æµ
        const firebaseConfig = {
            apiKey: "mock-api-key-for-testing",
            authDomain: "deer-lab.firebaseapp.com",
            projectId: "deer-lab",
            storageBucket: "deer-lab.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmnop"
        };

        // æ¨¡æ“¬ Firebase åŠŸèƒ½
        const mockFirebase = {
            auth: {
                signInWithEmailAndPassword: async (email, password) => {
                    console.log('æ¨¡æ“¬ç™»å…¥:', email, password);
                    return { user: { uid: 'mock-user-id' } };
                }
            },
            firestore: {
                doc: () => ({ get: async () => ({ exists: () => true, data: () => ({ name: 'æ¸¬è©¦ç”¨æˆ¶', roleRef: { path: 'roles/test-role' } }) }) }),
                getDoc: async () => ({ exists: () => true, data: () => ({ name: 'æ¸¬è©¦è§’è‰²', permissions: ['personnel:create', 'personnel:edit'] }) })
            },
            functions: {
                httpsCallable: (name) => async (data) => {
                    console.log('æ¨¡æ“¬å‡½æ•¸èª¿ç”¨:', name, data);
                    return { data: { success: true, message: 'æ¨¡æ“¬æˆåŠŸ' } };
                }
            }
        };

        let currentUser = null;
        let appUser = null;

        // æ—¥èªŒå‡½æ•¸
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // æ›´æ–°ç‹€æ…‹
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // æ¸¬è©¦ç™»å…¥
        window.testLogin = async function() {
            try {
                log('ğŸ” é–‹å§‹æ¸¬è©¦ç™»å…¥...');
                updateStatus('æ­£åœ¨ç™»å…¥...', 'info');

                const email = '001@deer-lab.local';
                const password = 'password123';

                const userCredential = await mockFirebase.auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                log(`âœ… ç™»å…¥æˆåŠŸ: ${currentUser.uid}`);
                updateStatus('ç™»å…¥æˆåŠŸ', 'success');

                // è¼‰å…¥ç”¨æˆ¶è³‡æ–™
                await loadUserData();
                
            } catch (error) {
                log(`âŒ ç™»å…¥å¤±æ•—: ${error.message}`, 'error');
                updateStatus('ç™»å…¥å¤±æ•—', 'error');
            }
        };

        // è¼‰å…¥ç”¨æˆ¶è³‡æ–™
        async function loadUserData() {
            try {
                log('ğŸ” è¼‰å…¥ç”¨æˆ¶è³‡æ–™...');
                
                const userDoc = await mockFirebase.firestore.getDoc();
                const userData = userDoc.data();
                log(`ğŸ“‹ ç”¨æˆ¶è³‡æ–™: ${userData.name} (${userData.employeeId})`);
                
                // è¼‰å…¥è§’è‰²è³‡æ–™
                if (userData.roleRef) {
                    const roleDoc = await mockFirebase.firestore.getDoc();
                    const roleData = roleDoc.data();
                    appUser = {
                        ...userData,
                        roleName: roleData.name,
                        permissions: roleData.permissions || []
                    };
                    
                    log(`ğŸ­ è§’è‰²: ${appUser.roleName}`);
                    log(`ğŸ“‹ æ¬Šé™æ•¸é‡: ${appUser.permissions.length}`);
                    log(`âœ… ç”¨æˆ¶è³‡æ–™è¼‰å…¥å®Œæˆ`);
                }
                
            } catch (error) {
                log(`âŒ è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—: ${error.message}`);
            }
        }

        // æ¸¬è©¦æ¬Šé™
        window.testPermissions = function() {
            if (!appUser) {
                log('âŒ è«‹å…ˆç™»å…¥ä¸¦è¼‰å…¥ç”¨æˆ¶è³‡æ–™');
                return;
            }

            log('ğŸ” é–‹å§‹æ¬Šé™æ¸¬è©¦...');
            
            const personnelPermissions = [
                'personnel:create', 'personnel:edit', 'personnel:delete', 'personnel:view',
                'æ–°å¢äººå“¡', 'ç·¨è¼¯äººå“¡', 'åˆªé™¤äººå“¡', 'æŸ¥çœ‹äººå“¡ç®¡ç†'
            ];
            
            const hasPersonnelPermission = personnelPermissions.some(permission => 
                appUser.permissions.includes(permission)
            );
            
            log(`âœ… äººå“¡ç®¡ç†æ¬Šé™æª¢æŸ¥: ${hasPersonnelPermission ? 'é€šé' : 'å¤±æ•—'}`);
            
            if (hasPersonnelPermission) {
                const foundPermissions = personnelPermissions.filter(permission => 
                    appUser.permissions.includes(permission)
                );
                log(`âœ… æ‰¾åˆ°çš„æ¬Šé™: ${foundPermissions.join(', ')}`);
            }
            
            // æª¢æŸ¥å…·é«”æ¬Šé™
            ['personnel:create', 'personnel:edit', 'personnel:delete', 'personnel:view'].forEach(permission => {
                const hasPermission = appUser.permissions.includes(permission);
                log(`${hasPermission ? 'âœ…' : 'âŒ'} ${permission}: ${hasPermission ? 'æœ‰æ¬Šé™' : 'ç„¡æ¬Šé™'}`);
            });
        };

        // æ¸¬è©¦äººå“¡ç®¡ç†åŠŸèƒ½
        window.testPersonnelFunctions = async function() {
            if (!currentUser) {
                log('âŒ è«‹å…ˆç™»å…¥');
                return;
            }

            log('ğŸ‘¥ é–‹å§‹æ¸¬è©¦äººå“¡ç®¡ç†åŠŸèƒ½...');
            
            try {
                // æ¸¬è©¦ createPersonnel
                log('ğŸ“¡ æ¸¬è©¦ createPersonnel...');
                const createPersonnel = mockFirebase.functions.httpsCallable('createPersonnel');
                
                const testData = {
                    name: 'æ¸¬è©¦ç”¨æˆ¶',
                    employeeId: 'TEST001',
                    phone: '0900000000',
                    roleId: 'test-role-id',
                    password: '123456',
                    status: 'active'
                };
                
                const result = await createPersonnel(testData);
                log('âœ… createPersonnel èª¿ç”¨æˆåŠŸ');
                log(`ğŸ“‹ çµæœ: ${JSON.stringify(result.data)}`);
                
            } catch (error) {
                log(`âŒ createPersonnel å¤±æ•—: ${error.message}`);
                if (error.code) {
                    log(`ğŸ” éŒ¯èª¤ä»£ç¢¼: ${error.code}`);
                }
                if (error.details) {
                    log(`ğŸ” éŒ¯èª¤è©³æƒ…: ${JSON.stringify(error.details)}`);
                }
            }
        };

        // æ¸…é™¤æ—¥èªŒ
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };

        // åˆå§‹åŒ–
        log('ğŸš€ æ¬Šé™æ¸¬è©¦é é¢å·²è¼‰å…¥');
        updateStatus('æº–å‚™å°±ç·’', 'info');
    </script>
</body>
</html>
