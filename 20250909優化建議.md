# é¹¿é¹¿å°ä½œåŠç³»çµ±å„ªåŒ–å»ºè­°å ±å‘Š
**ç”Ÿæˆæ™‚é–“**: 2025-09-09  
**åˆ†æç¯„åœ**: å®Œæ•´å°ˆæ¡ˆä»£ç¢¼åº«  
**åˆ†ææ·±åº¦**: æ¶æ§‹ã€é‚è¼¯ã€ç¶­è­·æ€§ã€æ¨™æº–åŒ–  

## ğŸ¯ åŸ·è¡Œæ‘˜è¦

é¹¿é¹¿å°ä½œåŠæ˜¯ä¸€å€‹åŠŸèƒ½å®Œæ•´ä¸”å¯¦ç”¨çš„ç”Ÿç”¢ç®¡ç†ç³»çµ±ï¼Œå…·æœ‰è‰¯å¥½çš„åŸºç¤æ¶æ§‹ã€‚ç¶“éæ·±åº¦åˆ†æï¼Œç™¼ç¾åœ¨ä»£ç¢¼é‡ç”¨æ€§ã€æ¨™æº–åŒ–å’Œç¶­è­·æ•ˆç‡æ–¹é¢æœ‰é¡¯è‘—çš„æ”¹é€²ç©ºé–“ã€‚æœ¬å ±å‘Šæä¾›å…·é«”å¯æ“ä½œçš„å„ªåŒ–å»ºè­°ã€‚

---

## ğŸ“Š 1. æˆç†Ÿåº¦åˆ†æèˆ‡æ¨™æº–åŒ–æ©Ÿæœƒ

### 1.1 é‡è¤‡é‚è¼¯è­˜åˆ¥èˆ‡æ”¹é€²

#### ğŸ” æœå°‹å’Œéæ¿¾é‚è¼¯æ¨™æº–åŒ– âœ… **å·²å®Œæˆ**
**ç¾æ³å•é¡Œ**ï¼š
- åœ¨ 7+ å€‹ä¸»è¦é é¢ï¼ˆmaterials, fragrances, products, suppliers ç­‰ï¼‰ç™¼ç¾ç›¸åŒçš„æœå°‹éæ¿¾é‚è¼¯
- æ¯å€‹é é¢é‡è¤‡å¯¦ç¾ `handleSearchAndFilter`ã€ç¯©é¸æ¨™ç±¤ã€æœå°‹æ¡†ç­‰åŠŸèƒ½
- ä¼°è¨ˆé‡è¤‡ä»£ç¢¼é” 300+ è¡Œ

**æ¨™æº–åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// å»ºè­°æ–°å¢: src/hooks/useDataSearch.ts
export function useDataSearch<T>(
  data: T[], 
  searchFields: (keyof T)[], 
  filterConfig?: FilterConfig<T>
) {
  const [searchTerm, setSearchTerm] = useState('');
  const [activeFilters, setActiveFilters] = useState<string[]>([]);
  
  const filteredData = useMemo(() => {
    // çµ±ä¸€çš„æœå°‹ã€éæ¿¾ã€æ’åºé‚è¼¯
    return filterAndSortData(data, searchTerm, activeFilters, searchFields);
  }, [data, searchTerm, activeFilters, searchFields]);
  
  return {
    searchTerm,
    setSearchTerm,
    activeFilters,
    setActiveFilters,
    filteredData,
    clearFilters: () => setActiveFilters([])
  };
}
```

**é æœŸæ•ˆç›Š**ï¼š
- æ¸›å°‘ 60% çš„é‡è¤‡ä»£ç¢¼
- æå‡æœå°‹é‚è¼¯ä¸€è‡´æ€§
- ä¾¿æ–¼åŠŸèƒ½æ“´å±•å’Œç¶­è­·

#### ğŸ›’ è³¼ç‰©è»Šæ“ä½œçµ±ä¸€åŒ–
**ç¾æ³å•é¡Œ**ï¼š
- è³¼ç‰©è»Šå‹¾é¸ã€æ‰¹é‡æ“ä½œé‚è¼¯åœ¨å¤šå€‹åˆ—è¡¨é é‡è¤‡
- `handleCartToggle`ã€`handleAddToPurchaseCart` ç­‰å‡½æ•¸é‡è¤‡å¯¦ç¾

**æ¨™æº–åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// å»ºè­°æ–°å¢: src/hooks/useCartOperations.ts
export function useCartOperations<T extends { id: string }>(
  items: T[],
  cartType: 'purchase' | 'production'
) {
  const [selectedItems, setSelectedItems] = useState<Set<string>>(new Set());
  
  const handleToggleItem = useCallback((itemId: string) => {
    // çµ±ä¸€çš„å‹¾é¸é‚è¼¯
  }, []);
  
  const handleBatchAdd = useCallback(async () => {
    // çµ±ä¸€çš„æ‰¹é‡åŠ å…¥è³¼ç‰©è»Šé‚è¼¯
  }, [selectedItems]);
  
  return {
    selectedItems,
    handleToggleItem,
    handleBatchAdd,
    isAllSelected: selectedItems.size === items.length,
    clearSelection: () => setSelectedItems(new Set())
  };
}
```

#### ğŸ§ª é¦™ç²¾æ¯”ä¾‹è¨ˆç®—æ¨™æº–åŒ– âœ… **å·²å®Œæˆ**
**ç¾æ³å•é¡Œ**ï¼š
- `calculatePGRatios` å‡½æ•¸åƒ…åœ¨ `fragrances/page.tsx` å­˜åœ¨
- æ­¤é¡è¨ˆç®—é‚è¼¯æ‡‰è©²å…¨åŸŸå¯ç”¨ä½†ç¼ºä¹çµ±ä¸€ç®¡ç†

**æ¨™æº–åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// å»ºè­°æ–°å¢: src/utils/fragranceCalculations.ts
export const FragranceCalculations = {
  calculatePGRatios: (fragrancePercentage: number) => {
    const remainingPercentage = 100 - fragrancePercentage;
    return {
      pgPercentage: remainingPercentage * 0.6,
      vgPercentage: remainingPercentage * 0.4,
      fragrancePercentage
    };
  },
  
  validateRatios: (ratios: FragranceRatios) => {
    // æ¯”ä¾‹é©—è­‰é‚è¼¯
  },
  
  formatRatioDisplay: (ratio: number) => {
    // æ ¼å¼åŒ–é¡¯ç¤ºé‚è¼¯
  }
};
```

### 1.2 CRUD é é¢æ¶æ§‹çµ±ä¸€åŒ–

**ç¾æ³å•é¡Œ**ï¼š
- æ‰€æœ‰ä¸»è¦å¯¦é«”åˆ—è¡¨é é¢éƒ½ä½¿ç”¨ç›¸ä¼¼ä½†ç•¥æœ‰å·®ç•°çš„æ¶æ§‹
- åŒ…å«æœå°‹ã€ç¯©é¸ã€è¡¨æ ¼/å¡ç‰‡åˆ‡æ›ã€CRUD æ“ä½œç­‰é‡è¤‡åŠŸèƒ½

**çµ±ä¸€æ¶æ§‹æ–¹æ¡ˆ**ï¼š
```typescript
// å»ºè­°æ–°å¢: src/components/StandardDataListPage.tsx
interface DataListPageProps<T> {
  entityName: string;
  data: T[];
  isLoading: boolean;
  searchFields: (keyof T)[];
  filterConfig?: FilterConfig<T>;
  columns: ColumnDef<T>[];
  permissions: {
    view: string;
    manage?: string;
  };
  onAdd?: () => void;
  onEdit?: (item: T) => void;
  onDelete?: (item: T) => void;
}

export function StandardDataListPage<T extends { id: string }>(
  props: DataListPageProps<T>
) {
  // çµ±ä¸€çš„åˆ—è¡¨é é¢é‚è¼¯
  const searchHook = useDataSearch(props.data, props.searchFields);
  const cartHook = useCartOperations(searchHook.filteredData);
  
  return (
    <div className="space-y-6">
      <PageHeader title={props.entityName} />
      <SearchAndFilterBar {...searchHook} />
      <DataTableWithMobile 
        data={searchHook.filteredData}
        columns={props.columns}
        selectable
        onSelectionChange={cartHook.handleToggleItem}
      />
      <BatchOperations {...cartHook} />
    </div>
  );
}
```

---

## ğŸš€ 2. åŠŸèƒ½æ¨è–¦èˆ‡ç³»çµ±å¢å¼·

### 2.1 é«˜åƒ¹å€¼åŠŸèƒ½å»ºè­°

#### ğŸ“Š æ™ºèƒ½åº«å­˜é è­¦ç³»çµ±
**åŸºæ–¼**: ç¾æœ‰ä½åº«å­˜æª¢æ¸¬åŠŸèƒ½  
**å»ºè­°åŠŸèƒ½**:
```typescript
// æ–°åŠŸèƒ½æ¨¡çµ„: æ™ºèƒ½è£œè²¨å»ºè­°ç³»çµ±
interface SmartInventorySystem {
  // åŸºæ–¼æ­·å²æ¶ˆè€—çš„å‹•æ…‹å®‰å…¨åº«å­˜è¨ˆç®—
  calculateDynamicMinStock(itemId: string, historicalData: ConsumptionRecord[]): number;
  
  // å­£ç¯€æ€§èª¿æ•´æ©Ÿåˆ¶
  applySeasionalAdjustment(baseAmount: number, season: Season): number;
  
  // è‡ªå‹•è£œè²¨å»ºè­°
  generateReplenishmentSuggestions(): ReplenishmentSuggestion[];
  
  // ç¼ºè²¨é¢¨éšªé æ¸¬
  predictStockoutRisk(itemId: string, daysAhead: number): RiskLevel;
}
```

**å¯¦æ–½é‡é»**:
- æ•´åˆåˆ°ç¾æœ‰åº«å­˜ç›£æ§é é¢
- æä¾›è¦–è¦ºåŒ–é¢¨éšªå„€è¡¨æ¿
- è‡ªå‹•åŒ–è£œè²¨è¨‚å–®å»ºè­°

#### ğŸ’° é…æ–¹æˆæœ¬åˆ†æèˆ‡å„ªåŒ–
**åŸºæ–¼**: ç¾æœ‰é¦™ç²¾è©¦ç®—åŠŸèƒ½  
**å»ºè­°åŠŸèƒ½**:
```typescript
// æ–°åŠŸèƒ½æ¨¡çµ„: é…æ–¹ç›ˆåˆ©èƒ½åŠ›åˆ†æ
interface RecipeProfitabilityAnalyzer {
  // å³æ™‚æˆæœ¬åˆ†æ
  calculateRealTimeCosts(recipe: Recipe): CostAnalysis;
  
  // æ›¿ä»£æ–¹æ¡ˆå»ºè­°
  suggestCostOptimizedAlternatives(recipe: Recipe): AlternativeRecipe[];
  
  // æ¯›åˆ©åˆ†æ
  analyzeProfitMargins(recipe: Recipe, sellingPrice: number): ProfitAnalysis;
  
  // åƒ¹æ ¼æ•æ„Ÿåº¦åˆ†æ
  performSensitivityAnalysis(recipe: Recipe): SensitivityReport;
}
```

#### ğŸ“ˆ ä¾›æ‡‰å•†ç¸¾æ•ˆç®¡ç†ç³»çµ±
**åŸºæ–¼**: ç¾æœ‰ä¾›æ‡‰å•†ç®¡ç†  
**å»ºè­°åŠŸèƒ½**:
- äº¤è²¨åŠæ™‚ç‡è¿½è¹¤èˆ‡åˆ†æ
- åƒ¹æ ¼è¶¨å‹¢æ­·å²åˆ†æ
- ä¾›æ‡‰å•†è©•ç´šèˆ‡æ¨è–¦ç³»çµ±
- æ¡è³¼ç¸¾æ•ˆå ±è¡¨

#### âš¡ ç”Ÿç”¢æ•ˆç‡å„ªåŒ–å·¥å…·
**åŸºæ–¼**: ç¾æœ‰å·¥æ™‚ç®¡ç†ç³»çµ±  
**å»ºè­°åŠŸèƒ½**:
- ç”Ÿç”¢ç“¶é ¸è­˜åˆ¥ç®—æ³•
- äººå“¡æ•ˆç‡åˆ†æèˆ‡å»ºè­°
- æœ€ä½³ç”Ÿç”¢æ’ç¨‹æ¨è–¦
- ç”¢èƒ½è¦åŠƒå·¥å…·

### 2.2 ç”¨æˆ¶é«”é©—å¢å¼·

#### ğŸ¨ ä¸»é¡Œèˆ‡å€‹äººåŒ–
- æ·±è‰²æ¨¡å¼å®Œæ•´æ”¯æ´
- å€‹äººåŒ–å„€è¡¨æ¿é…ç½®
- å¸¸ç”¨åŠŸèƒ½å¿«é€Ÿå­˜å–é¢æ¿

#### ğŸ“± è¡Œå‹•ç«¯é«”é©—å„ªåŒ–
- PWA (Progressive Web App) åŠŸèƒ½
- é›¢ç·šè³‡æ–™åŒæ­¥
- æ¨æ’­é€šçŸ¥ç³»çµ±

---

## ğŸ§¹ 3. ä»£ç¢¼æ¸…ç†èˆ‡å„ªåŒ–

### 3.1 éœ€è¦ç«‹å³æ¸…ç†çš„æ–‡ä»¶

#### ğŸ—‘ï¸ éæ™‚å’Œæ¸¬è©¦æ–‡ä»¶æ¸…å–®
```bash
# å¯ä»¥å®‰å…¨åˆªé™¤çš„æ–‡ä»¶
src/app/dashboard/inventory-old/page.tsx          # èˆŠç‰ˆåº«å­˜é é¢
src/app/emergency-fix/page.tsx                    # ç·Šæ€¥ä¿®å¾©é é¢
src/app/fragrance-fix/page.tsx                    # é¦™ç²¾ä¿®å¾©é é¢
check-products.js                                 # æ ¹ç›®éŒ„æª¢æŸ¥è…³æœ¬
src/app/test-inventory/page.tsx                   # æ¸¬è©¦é é¢ï¼ˆå¦‚å­˜åœ¨ï¼‰

# éœ€è¦ç§»å‹•åˆ°é©ç•¶ä½ç½®çš„æ–‡ä»¶
check-products.js â†’ scripts/check-products.js    # ç§»è‡³ scripts ç›®éŒ„
```

#### ğŸ“ èª¿è©¦ä»£ç¢¼æ¸…ç†
**ç™¼ç¾çš„å•é¡Œ**:
- 330+ å€‹ toast æ¶ˆæ¯ï¼ˆå¯èƒ½éæ–¼é »ç¹ï¼‰
- 121+ å€‹ console.log èªå¥åˆ†æ•£åœ¨ 20+ å€‹æ–‡ä»¶ä¸­
- `fragrances/page.tsx` ä¸­å¤§é‡èª¿è©¦è¼¸å‡ºï¼ˆ85-100è¡Œï¼‰

**å»ºè­°æ”¹é€²**:
```typescript
// å»ºç«‹çµ±ä¸€çš„ Logger ç³»çµ±
// src/utils/logger.ts (å·²å­˜åœ¨ï¼Œéœ€è¦æ“´å±•)
export const logger = {
  debug: (message: string, data?: any) => {
    if (process.env.NODE_ENV === 'development') {
      console.log(`[DEBUG] ${message}`, data);
    }
  },
  info: (message: string, data?: any) => {
    console.info(`[INFO] ${message}`, data);
  },
  warn: (message: string, data?: any) => {
    console.warn(`[WARN] ${message}`, data);
  },
  error: (message: string, error?: any) => {
    console.error(`[ERROR] ${message}`, error);
    // å¯é¸ï¼šç™¼é€åˆ°éŒ¯èª¤è¿½è¹¤æœå‹™
  }
};
```

### 3.2 é¡å‹å®šç¾©çµ±ä¸€åŒ–

#### ğŸ—ï¸ é‡è¤‡é¡å‹å®šç¾©æ•´åˆ
**ç™¼ç¾çš„å•é¡Œ**:
- `Material`ã€`Fragrance`ã€`CartItem` ç­‰ä»‹é¢åœ¨å¤šè™•é‡è¤‡å®šç¾©
- é¡å‹å®šç¾©ä¸ä¸€è‡´å°è‡´æ½›åœ¨éŒ¯èª¤

**æ¨™æº–åŒ–æ–¹æ¡ˆ**:
```typescript
// src/types/entities.ts (æ•´åˆæ‰€æœ‰å¯¦é«”é¡å‹)
interface BaseEntity {
  id: string;
  createdAt: Timestamp;
  updatedAt: Timestamp;
  createdBy?: string;
  updatedBy?: string;
  isActive: boolean;
}

interface InventoryItem extends BaseEntity {
  code: string;
  name: string;
  currentStock: number;
  unit: string;
  costPerUnit: number;
  minStock: number;
  maxStock: number;
  category?: string;
  supplierId?: string;
  supplierName?: string;
}

interface Material extends InventoryItem {
  // åŸæ–™ç‰¹æœ‰å±¬æ€§
}

interface Fragrance extends InventoryItem {
  series?: string;
  // é¦™ç²¾ç‰¹æœ‰å±¬æ€§
}
```

---

## ğŸ› ï¸ 4. ç¶­è­·æ€§èˆ‡æ¨™æº–åŒ–æ”¹é€²

### 4.1 UI è¨­è¨ˆç³»çµ±çµ±ä¸€åŒ–

#### ğŸ¨ çµ„ä»¶æ¨™æº–åŒ–
```typescript
// å»ºè­°å»ºç«‹: src/components/StandardDataTable.tsx
interface StandardDataTableProps<T> {
  data: T[];
  columns: ColumnDef<T>[];
  searchable?: boolean;
  filterable?: boolean;
  responsive?: boolean;
  selectable?: boolean;
  actions?: ('view' | 'edit' | 'delete')[];
  permissions?: string[];
}

export function StandardDataTable<T>(props: StandardDataTableProps<T>) {
  // çµ±ä¸€çš„è³‡æ–™è¡¨æ ¼é‚è¼¯
  return (
    <>
      {/* æ¡Œé¢ç‰ˆè¡¨æ ¼ */}
      <div className="hidden lg:block">
        <DataTable {...props} />
      </div>
      
      {/* è¡Œå‹•ç‰ˆå¡ç‰‡ */}
      <div className="lg:hidden">
        <MobileCardList {...props} />
      </div>
    </>
  );
}
```

#### ğŸ“Š çµ±ä¸€çš„è¼‰å…¥ç‹€æ…‹ç®¡ç†
```typescript
// src/hooks/useAsyncData.ts
export function useAsyncData<T>(
  fetcher: () => Promise<T>,
  dependencies: any[] = []
) {
  const [data, setData] = useState<T | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  useEffect(() => {
    let cancelled = false;
    
    const loadData = async () => {
      try {
        setIsLoading(true);
        setError(null);
        const result = await fetcher();
        
        if (!cancelled) {
          setData(result);
        }
      } catch (err) {
        if (!cancelled) {
          setError(err instanceof Error ? err : new Error('Unknown error'));
        }
      } finally {
        if (!cancelled) {
          setIsLoading(false);
        }
      }
    };

    loadData();

    return () => {
      cancelled = true;
    };
  }, dependencies);

  return { data, isLoading, error, refetch: () => fetcher() };
}
```

### 4.2 é…ç½®åƒæ•¸é›†ä¸­ç®¡ç†

#### âš™ï¸ æ¥­å‹™é…ç½®çµ±ä¸€åŒ–
```typescript
// å»ºè­°æ–°å¢: src/config/business.ts
export const BUSINESS_CONFIG = {
  inventory: {
    lowStockThresholdRatio: 0.2,      // 20% è­¦æˆ’ç·š
    defaultReorderQuantity: 100,       // é è¨­è£œè²¨é‡
    maxStockMultiplier: 5,             // æœ€å¤§åº«å­˜å€æ•¸
  },
  
  fragrance: {
    defaultPGRatio: 60,                // é è¨­ PG æ¯”ä¾‹
    defaultVGRatio: 40,                // é è¨­ VG æ¯”ä¾‹
    maxConcentration: 100,             // æœ€å¤§æ¿ƒåº¦
    minConcentration: 0.1,             // æœ€å°æ¿ƒåº¦
  },
  
  production: {
    standardWorkingHours: 8,           // æ¨™æº–å·¥ä½œæ™‚æ•¸
    overtimeThreshold: 8,              // åŠ ç­é–€æª»
    maxDailyWorkingHours: 12,          // æ¯æ—¥æœ€å¤§å·¥æ™‚
  },
  
  ui: {
    itemsPerPage: 10,                  // æ¯é é¡¯ç¤ºç­†æ•¸
    searchDebounceMs: 300,             // æœå°‹é˜²æŠ–å»¶é²
    toastDurationMs: 3000,             // Toast é¡¯ç¤ºæ™‚é–“
  },
  
  features: {
    enableAdvancedAnalytics: false,    // é€²éšåˆ†æåŠŸèƒ½
    enableNotifications: true,         // é€šçŸ¥åŠŸèƒ½
    enableOfflineMode: false,          // é›¢ç·šæ¨¡å¼
  }
} as const;
```

### 4.3 éŒ¯èª¤è™•ç†æ¨™æº–åŒ–

#### ğŸš¨ çµ±ä¸€éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
```typescript
// å»ºè­°å¢å¼·: src/utils/errorHandler.ts
export class BusinessError extends Error {
  constructor(
    message: string,
    public code: string,
    public details?: any
  ) {
    super(message);
    this.name = 'BusinessError';
  }
}

export const errorHandler = {
  handleApiError: (error: any): never => {
    if (error.code === 'permission-denied') {
      throw new BusinessError('æ¬Šé™ä¸è¶³', 'PERMISSION_DENIED');
    }
    
    if (error.code === 'not-found') {
      throw new BusinessError('è³‡æ–™ä¸å­˜åœ¨', 'DATA_NOT_FOUND');
    }
    
    throw new BusinessError('ç³»çµ±éŒ¯èª¤', 'SYSTEM_ERROR', error);
  },
  
  handleFormError: (error: any): string => {
    if (error instanceof BusinessError) {
      return error.message;
    }
    return 'è¡¨å–®é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¼¸å…¥è³‡æ–™';
  }
};
```

---

## ğŸ“ˆ 5. æ¶æ§‹èˆ‡è³‡æ–™åº«æ¨™æº–åŒ–

### 5.1 è³‡æ–™æ¨¡å‹æ­£è¦åŒ–

#### ğŸ—„ï¸ Firestore é›†åˆæ¶æ§‹å„ªåŒ–
```typescript
// æ¨™æº–åŒ–çš„è³‡æ–™æ¨¡å‹æ¶æ§‹
interface DatabaseSchema {
  // æ ¸å¿ƒæ¥­å‹™å¯¦é«”
  materials: Material[];
  fragrances: Fragrance[];
  products: Product[];
  suppliers: Supplier[];
  
  // æ¥­å‹™æµç¨‹
  purchaseOrders: PurchaseOrder[];
  workOrders: WorkOrder[];
  
  // å¯©è¨ˆè»Œè·¡
  inventoryRecords: InventoryRecord[];
  timeEntries: TimeEntry[];
  
  // ç³»çµ±é…ç½®
  systemConfig: SystemConfig[];
  userPreferences: UserPreference[];
  
  // æ¬Šé™ç®¡ç†
  users: AppUser[];
  roles: Role[];
  permissions: Permission[];
}
```

#### ğŸ” ç´¢å¼•ç­–ç•¥æœ€ä½³åŒ–
```typescript
// å»ºè­°çš„ Firestore ç´¢å¼•é…ç½®
const FIRESTORE_INDEXES = {
  materials: [
    ['isActive', 'name'],
    ['supplierId', 'isActive'],
    ['currentStock', 'minStock'],
    ['category', 'isActive', 'name']
  ],
  
  workOrders: [
    ['status', 'createdAt'],
    ['assignedTo', 'status'],
    ['productId', 'status']
  ],
  
  timeEntries: [
    ['personnelId', 'date'],
    ['workOrderId', 'date'],
    ['date', 'personnelId']
  ]
};
```

### 5.2 API æ¨™æº–åŒ–

#### ğŸ”Œ Firebase Functions çµ±ä¸€æ ¼å¼
```typescript
// æ¨™æº–åŒ–çš„ API å›æ‡‰æ ¼å¼
interface ApiResponse<T = any> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
    details?: any;
  };
  meta?: {
    timestamp: number;
    version: string;
    requestId: string;
  };
}

// çµ±ä¸€çš„ API è™•ç†å‡½æ•¸
export const createApiHandler = <TInput, TOutput>(
  handler: (data: TInput, context: CallableContext) => Promise<TOutput>
) => {
  return onCall(async (request): Promise<ApiResponse<TOutput>> => {
    const requestId = generateRequestId();
    
    try {
      const result = await handler(request.data, request);
      
      return {
        success: true,
        data: result,
        meta: {
          timestamp: Date.now(),
          version: '1.0.0',
          requestId
        }
      };
      
    } catch (error) {
      console.error(`API Error [${requestId}]:`, error);
      
      return {
        success: false,
        error: {
          code: error.code || 'INTERNAL_ERROR',
          message: error.message || 'ç³»çµ±éŒ¯èª¤',
          details: process.env.NODE_ENV === 'development' ? error : undefined
        },
        meta: {
          timestamp: Date.now(),
          version: '1.0.0',
          requestId
        }
      };
    }
  });
};
```

---

## âš¡ 6. æ•ˆèƒ½å„ªåŒ–æ–¹æ¡ˆ

### 6.1 å‰ç«¯æ•ˆèƒ½å„ªåŒ–

#### ğŸš€ ä»£ç¢¼åˆ†å‰²ç­–ç•¥
```typescript
// å¯¦æ–½å‹•æ…‹åŒ¯å…¥
const MaterialsPage = lazy(() => import('@/app/dashboard/materials/page'));
const FragrancesPage = lazy(() => import('@/app/dashboard/fragrances/page'));
const WorkOrdersPage = lazy(() => import('@/app/dashboard/work-orders/page'));

// è·¯ç”±å±¤ç´šåˆ†å‰²
const routes = [
  {
    path: '/dashboard/materials',
    component: MaterialsPage,
    preload: () => import('@/app/dashboard/materials/page')
  }
];
```

#### ğŸ’¾ å¿«å–ç­–ç•¥å„ªåŒ–
```typescript
// å¯¦æ–½æ›´æ™ºèƒ½çš„å¿«å–æ©Ÿåˆ¶
export const useSmartCache = <T>(
  key: string,
  fetcher: () => Promise<T>,
  options: {
    staleTime?: number;
    cacheTime?: number;
    refetchOnWindowFocus?: boolean;
  } = {}
) => {
  // ä½¿ç”¨ React Query æˆ–é¡ä¼¼çš„è§£æ±ºæ–¹æ¡ˆ
  return useQuery({
    queryKey: [key],
    queryFn: fetcher,
    staleTime: options.staleTime ?? 5 * 60 * 1000, // 5 åˆ†é˜
    cacheTime: options.cacheTime ?? 10 * 60 * 1000, // 10 åˆ†é˜
    refetchOnWindowFocus: options.refetchOnWindowFocus ?? false
  });
};
```

### 6.2 è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–

#### ğŸ” æ‰¹é‡æŸ¥è©¢æœ€ä½³åŒ–
```typescript
// å¯¦æ–½æ‰¹é‡æŸ¥è©¢ç­–ç•¥
export const useBatchQuery = <T>(
  collection: string,
  ids: string[],
  options?: { batchSize?: number }
) => {
  const batchSize = options?.batchSize ?? 10;
  
  return useQuery({
    queryKey: [collection, 'batch', ids.sort().join(',')],
    queryFn: async () => {
      // åˆ†æ‰¹æŸ¥è©¢é‚è¼¯
      const batches = chunk(ids, batchSize);
      const results = await Promise.all(
        batches.map(batch => 
          getDocs(query(
            collectionGroup(db, collection),
            where(documentId(), 'in', batch)
          ))
        )
      );
      
      return results.flatMap(snapshot => 
        snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
      );
    },
    enabled: ids.length > 0
  });
};
```

---

## ğŸ“‹ 7. å¯¦æ–½è¨ˆåŠƒèˆ‡å„ªå…ˆç´š

### 7.1 å„ªå…ˆç´šçŸ©é™£

| å„ªå…ˆç´š | é …ç›® | é ä¼°å·¥æ™‚ | å½±éŸ¿ç¯„åœ | å¯¦æ–½é›£åº¦ |
|--------|------|----------|----------|----------|
| ğŸ”´ é«˜ | æ¸…ç†èª¿è©¦ä»£ç¢¼ | 4 å°æ™‚ | å…¨å°ˆæ¡ˆ | ä½ |
| ğŸ”´ é«˜ | åˆªé™¤éæ™‚æ–‡ä»¶ | 2 å°æ™‚ | ä»£ç¢¼æ•´æ½” | ä½ |
| ğŸ”´ é«˜ | çµ±ä¸€æœå°‹é‚è¼¯ Hook | 8 å°æ™‚ | 7+ é é¢ | ä¸­ |
| ğŸŸ¡ ä¸­ | CRUD çµ„ä»¶æ¨™æº–åŒ– | 16 å°æ™‚ | å…¨å°ˆæ¡ˆ | ä¸­ |
| ğŸŸ¡ ä¸­ | é…ç½®åƒæ•¸é›†ä¸­åŒ– | 6 å°æ™‚ | å…¨å°ˆæ¡ˆ | ä½ |
| ğŸŸ¡ ä¸­ | é¡å‹å®šç¾©çµ±ä¸€åŒ– | 8 å°æ™‚ | å…¨å°ˆæ¡ˆ | ä½ |
| ğŸŸ¢ ä½ | æ™ºèƒ½åº«å­˜é è­¦ | 24 å°æ™‚ | åº«å­˜ç³»çµ± | é«˜ |
| ğŸŸ¢ ä½ | é…æ–¹æˆæœ¬åˆ†æ | 20 å°æ™‚ | é…æ–¹ç³»çµ± | é«˜ |

### 7.2 å¯¦æ–½éšæ®µè¦åŠƒ

#### ç¬¬ä¸€éšæ®µ (ç«‹å³åŸ·è¡Œ - 1é€±)
1. **ä»£ç¢¼æ¸…ç†**
   - ç§»é™¤éé‡çš„ console.log å’Œèª¿è©¦ä»£ç¢¼
   - åˆªé™¤éæ™‚æ–‡ä»¶å’Œæ¸¬è©¦é é¢
   - æ•´ç†é‡è¤‡çš„é¡å‹å®šç¾©

2. **åŸºç¤æ¨™æº–åŒ–**
   - å»ºç«‹çµ±ä¸€çš„ `useDataSearch` Hook
   - å¯¦æ–½é…ç½®åƒæ•¸é›†ä¸­ç®¡ç†
   - å»ºç«‹çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶

#### ç¬¬äºŒéšæ®µ (çŸ­æœŸåŸ·è¡Œ - 2-3é€±)
1. **çµ„ä»¶æ¨™æº–åŒ–**
   - å»ºç«‹ `StandardDataTable` çµ„ä»¶
   - çµ±ä¸€è³¼ç‰©è»Šæ“ä½œé‚è¼¯
   - å¯¦æ–½ `StandardDataListPage` æ¶æ§‹

2. **æ•ˆèƒ½åŸºç¤å„ªåŒ–**
   - å¯¦æ–½åŸºç¤çš„ä»£ç¢¼åˆ†å‰²
   - å„ªåŒ– Firestore æŸ¥è©¢
   - å»ºç«‹å¿«å–ç­–ç•¥

#### ç¬¬ä¸‰éšæ®µ (ä¸­æœŸåŸ·è¡Œ - 1-2å€‹æœˆ)
1. **åŠŸèƒ½å¢å¼·**
   - æ™ºèƒ½åº«å­˜é è­¦ç³»çµ±
   - é…æ–¹æˆæœ¬åˆ†æå·¥å…·
   - ä¾›æ‡‰å•†ç¸¾æ•ˆåˆ†æ

2. **æ¶æ§‹å‡ç´š**
   - å¯¦æ–½ API æ¨™æº–åŒ–
   - å»ºç«‹å®Œæ•´çš„æ¸¬è©¦è¦†è“‹
   - å¯¦æ–½ç›£æ§å’Œæ—¥èªŒç³»çµ±

---

## ğŸ“Š 8. é æœŸæ•ˆç›Šåˆ†æ

### 8.1 é–‹ç™¼æ•ˆç‡æå‡

| æ”¹é€²é …ç›® | é æœŸæå‡ | è¡¡é‡æŒ‡æ¨™ |
|----------|----------|----------|
| ä»£ç¢¼é‡ç”¨æ€§ | 40-50% | é‡è¤‡ä»£ç¢¼è¡Œæ•¸æ¸›å°‘ |
| é–‹ç™¼é€Ÿåº¦ | 30% | æ–°åŠŸèƒ½é–‹ç™¼æ™‚é–“ |
| ç¶­è­·æ•ˆç‡ | 50% | Bug ä¿®å¾©æ™‚é–“ |
| ä»£ç¢¼å“è³ª | 35% | ä»£ç¢¼è¦†è“‹ç‡ã€éŒ¯èª¤ç‡ |

### 8.2 ç³»çµ±æ•ˆèƒ½æ”¹å–„

| æ•ˆèƒ½æŒ‡æ¨™ | ç›®æ¨™æ”¹å–„ | å¯¦æ–½æ–¹æ¡ˆ |
|----------|----------|----------|
| é é¢è¼‰å…¥æ™‚é–“ | æ¸›å°‘ 30% | ä»£ç¢¼åˆ†å‰²ã€å¿«å–ç­–ç•¥ |
| è³‡æ–™åº«æŸ¥è©¢æ•ˆç‡ | æå‡ 40% | ç´¢å¼•å„ªåŒ–ã€æ‰¹é‡æŸ¥è©¢ |
| ç”¨æˆ¶æ“ä½œå›æ‡‰ | æå‡ 25% | æ¨‚è§€æ›´æ–°ã€ç‹€æ…‹ç®¡ç† |

### 8.3 æˆæœ¬æ•ˆç›Š

**ä¸€æ¬¡æ€§æŠ•å…¥**:
- é–‹ç™¼æ™‚é–“ï¼šç´„ 100-120 å°æ™‚
- æ¸¬è©¦æ™‚é–“ï¼šç´„ 40-50 å°æ™‚
- ç¸½è¨ˆï¼šç´„ 140-170 å°æ™‚

**é•·æœŸæ•ˆç›Š**:
- å¹´åº¦ç¶­è­·æ™‚é–“æ¸›å°‘ï¼šç´„ 200+ å°æ™‚
- æ–°åŠŸèƒ½é–‹ç™¼åŠ é€Ÿï¼šç´„ 30% æ™‚é–“ç¯€çœ
- ç³»çµ±ç©©å®šæ€§æå‡ï¼šæ¸›å°‘ 40% çš„ç·šä¸Šå•é¡Œ

**æŠ•è³‡å›æ”¶æœŸ**ï¼šç´„ 2-3 å€‹æœˆ

---

## âœ… 9. å¯¦æ–½æª¢æŸ¥æ¸…å–®

### 9.1 ç«‹å³åŸ·è¡Œé …ç›® (æœ¬é€±)

- [ ] **ä»£ç¢¼æ¸…ç†**
  - [ ] ç§»é™¤ fragrances/page.tsx ä¸­çš„èª¿è©¦ä»£ç¢¼ (85-100è¡Œ)
  - [ ] æ¸…ç†å…¨å°ˆæ¡ˆä¸­çš„ console.log (ç›®æ¨™ï¼šæ¸›å°‘ 80%)
  - [ ] çµ±ä¸€ä½¿ç”¨ logger å·¥å…·æ›¿ä»£ console.log
  - [ ] æ¸›å°‘éåº¦çš„ toast é€šçŸ¥ (ç›®æ¨™ï¼šæ¸›å°‘ 50%)

- [ ] **æ–‡ä»¶æ¸…ç†**
  - [ ] åˆªé™¤ `src/app/dashboard/inventory-old/page.tsx`
  - [ ] åˆªé™¤ `src/app/emergency-fix/page.tsx`
  - [ ] åˆªé™¤ `src/app/fragrance-fix/page.tsx`
  - [ ] ç§»å‹• `check-products.js` åˆ° `scripts/` ç›®éŒ„

- [ ] **åŸºç¤æ¨™æº–åŒ–**
  - [x] å»ºç«‹ `src/hooks/useDataSearch.ts` âœ…
  - [ ] å»ºç«‹ `src/config/business.ts`
  - [ ] æ•´åˆé‡è¤‡çš„é¡å‹å®šç¾©åˆ° `src/types/entities.ts`

### 9.2 çŸ­æœŸåŸ·è¡Œé …ç›® (2-3é€±)

- [ ] **çµ„ä»¶æ¨™æº–åŒ–**
  - [ ] å»ºç«‹ `src/components/StandardDataTable.tsx`
  - [ ] å»ºç«‹ `src/components/StandardDataListPage.tsx`
  - [ ] å»ºç«‹ `src/hooks/useCartOperations.ts`
  - [x] å»ºç«‹ `src/utils/fragranceCalculations.ts` âœ…

- [ ] **æ¶æ§‹æ”¹é€²**
  - [ ] å¯¦æ–½çµ±ä¸€çš„ API å›æ‡‰æ ¼å¼
  - [ ] å»ºç«‹ `src/hooks/useAsyncData.ts`
  - [ ] å„ªåŒ–éŒ¯èª¤è™•ç†æ©Ÿåˆ¶

### 9.3 ä¸­æœŸåŸ·è¡Œé …ç›® (1-2å€‹æœˆ)

- [ ] **é«˜ç´šåŠŸèƒ½**
  - [ ] æ™ºèƒ½åº«å­˜é è­¦ç³»çµ±
  - [ ] é…æ–¹æˆæœ¬åˆ†æå·¥å…·
  - [ ] ä¾›æ‡‰å•†ç¸¾æ•ˆåˆ†æ
  - [ ] ç”Ÿç”¢æ•ˆç‡å„ªåŒ–å·¥å…·

- [ ] **æ•ˆèƒ½å„ªåŒ–**
  - [ ] å¯¦æ–½ä»£ç¢¼åˆ†å‰²
  - [ ] å»ºç«‹æ™ºèƒ½å¿«å–ç­–ç•¥
  - [ ] å„ªåŒ– Firestore ç´¢å¼•
  - [ ] å¯¦æ–½æ‰¹é‡æŸ¥è©¢å„ªåŒ–

---

## ğŸ¯ 10. çµè«–èˆ‡å»ºè­°

é¹¿é¹¿å°ä½œåŠå°ˆæ¡ˆå·²ç¶“å…·å‚™äº†è‰¯å¥½çš„åŠŸèƒ½åŸºç¤å’Œä½¿ç”¨é«”é©—ï¼Œä½†åœ¨ä»£ç¢¼çµ„ç¹”ã€é‡ç”¨æ€§å’Œç¶­è­·æ•ˆç‡æ–¹é¢å­˜åœ¨é¡¯è‘—çš„æ”¹é€²ç©ºé–“ã€‚é€šéç³»çµ±æ€§çš„é‡æ§‹å’Œæ¨™æº–åŒ–ï¼Œå¯ä»¥å¯¦ç¾ï¼š

### é—œéµæˆåŠŸå› ç´ 
1. **éšæ®µæ€§å¯¦æ–½**ï¼šå„ªå…ˆè™•ç†é«˜å½±éŸ¿ã€ä½é¢¨éšªçš„æ”¹é€²é …ç›®
2. **å‘ä¸‹ç›¸å®¹**ï¼šç¢ºä¿é‡æ§‹éç¨‹ä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½
3. **æ¸¬è©¦è¦†è“‹**ï¼šç‚ºé—œéµåŠŸèƒ½å»ºç«‹å®Œæ•´çš„æ¸¬è©¦æ¡ˆä¾‹
4. **æ–‡æª”åŒæ­¥**ï¼šæ›´æ–°é–‹ç™¼æ–‡æª”å’Œä½¿ç”¨èªªæ˜

### æœ€çµ‚ç›®æ¨™
- **ä»£ç¢¼å“è³ª**ï¼šå»ºç«‹ç¾ä»£åŒ–ã€å¯ç¶­è­·çš„ä»£ç¢¼æ¶æ§‹
- **é–‹ç™¼æ•ˆç‡**ï¼šé¡¯è‘—æå‡æ–°åŠŸèƒ½é–‹ç™¼å’Œç¶­è­·æ•ˆç‡
- **ç”¨æˆ¶é«”é©—**ï¼šæä¾›æ›´å¿«é€Ÿã€ä¸€è‡´çš„ç”¨æˆ¶é«”é©—
- **ç³»çµ±ç©©å®š**ï¼šæ¸›å°‘éŒ¯èª¤ã€æé«˜ç³»çµ±å¯é æ€§

### æ¨è–¦åŸ·è¡Œç­–ç•¥
å»ºè­°å„ªå…ˆåŸ·è¡Œé«˜å„ªå…ˆç´šé …ç›®ï¼Œå¿«é€Ÿå¯¦ç¾å¯è¦‹çš„æ”¹é€²æ•ˆæœï¼Œå†é€æ­¥æ¨é€²ä¸­é•·æœŸçš„æ¶æ§‹å‡ç´šã€‚é€™æ¨£æ—¢èƒ½å¿«é€Ÿæ”¹å–„ç¾ç‹€ï¼Œåˆèƒ½ç‚ºæœªä¾†çš„æ“´å±•å’Œç¶­è­·å¥ å®šå …å¯¦åŸºç¤ã€‚

---

**å ±å‘Šå®Œæˆæ™‚é–“**: 2025-09-09  
**ä¸‹æ¬¡å¯©æŸ¥å»ºè­°**: å¯¦æ–½ç¬¬ä¸€éšæ®µå¾Œ (ç´„ 1 é€±å¾Œ)  
**è¯çµ¡æ”¯æ´**: å¦‚éœ€å¯¦æ–½å”åŠ©ï¼Œè«‹å‚è€ƒ CLAUDE.md ä¸­çš„é–‹ç™¼æŒ‡å¼•