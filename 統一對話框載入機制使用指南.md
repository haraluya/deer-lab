# çµ±ä¸€å°è©±æ¡†è¼‰å…¥æ©Ÿåˆ¶ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—èªªæ˜å¦‚ä½•ä½¿ç”¨å®Œå…¨çµ±ä¸€åŒ–çš„å°è©±æ¡†è¼‰å…¥æ©Ÿåˆ¶ï¼Œç¢ºä¿æ‰€æœ‰CRUDå°è©±æ¡†éƒ½ä½¿ç”¨ç›¸åŒçš„æ¶æ§‹ï¼Œä¸¦ä¸”ä¸æœƒå‡ºç¾è¼‰å…¥å¡ä½çš„å•é¡Œã€‚

## ğŸš€ æ ¸å¿ƒçµ„ä»¶

### 1. useFormDataLoader Hook

**æª”æ¡ˆä½ç½®**: `src/hooks/useFormDataLoader.ts`

**åŠŸèƒ½**: çµ±ä¸€çš„è³‡æ–™è¼‰å…¥å™¨ï¼Œæ”¯æ´ä¸¦è¡Œè¼‰å…¥å¤šç¨®å¸¸ç”¨è³‡æ–™é¡å‹

**æ”¯æ´çš„è³‡æ–™é¡å‹**:
- `loadSuppliers`: ä¾›æ‡‰å•†è³‡æ–™
- `loadMaterialCategories`: ç‰©æ–™ä¸»åˆ†é¡
- `loadMaterialSubCategories`: ç‰©æ–™ç´°åˆ†åˆ†é¡  
- `loadUsers`: ä½¿ç”¨è€…è³‡æ–™
- `loadProducts`: ç”¢å“è³‡æ–™

### 2. StandardFormDialog å¢å¼·ç‰ˆ

**æª”æ¡ˆä½ç½®**: `src/components/StandardFormDialog.tsx`

**æ–°å¢åŠŸèƒ½**:
- `dataLoaderConfig` å±¬æ€§ï¼šé…ç½®éœ€è¦è¼‰å…¥çš„è³‡æ–™é¡å‹
- æ™ºèƒ½é¸é …ç”Ÿæˆå™¨ï¼šæ ¹æ“šæ¬„ä½åç¨±è‡ªå‹•æä¾›é¸é …è³‡æ–™
- å‘ä¸‹ç›¸å®¹ï¼šä¿ç•™åŸæœ‰çš„ `onDataLoad` å’Œ `skipDataLoading` æ”¯æ´

## ğŸ“– ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ç”¨æ³•

```tsx
import { StandardFormDialog, FormSectionConfig } from '@/components/StandardFormDialog';

// 1. å®šç¾©è¡¨å–®é…ç½®
const formSections: FormSectionConfig<FormData>[] = [
  {
    title: 'åŸºæœ¬è³‡æ–™',
    fields: [
      {
        name: 'supplierId',  // æ™ºèƒ½åŒ¹é…ï¼šè‡ªå‹•è¼‰å…¥ä¾›æ‡‰å•†é¸é …
        label: 'ä¾›æ‡‰å•†',
        type: 'select',
        // ä¸éœ€è¦æ‰‹å‹•è¨­å®š selectOptions
      },
      {
        name: 'category',    // æ™ºèƒ½åŒ¹é…ï¼šè‡ªå‹•è¼‰å…¥ä¸»åˆ†é¡é¸é …
        label: 'ä¸»åˆ†é¡',
        type: 'select',
      },
      {
        name: 'subCategory', // æ™ºèƒ½åŒ¹é…ï¼šè‡ªå‹•è¼‰å…¥ç´°åˆ†åˆ†é¡é¸é …
        label: 'ç´°åˆ†åˆ†é¡',
        type: 'select',
      }
    ]
  }
];

// 2. ä½¿ç”¨çµ±ä¸€å°è©±æ¡†
<StandardFormDialog<FormData>
  isOpen={isOpen}
  onOpenChange={onOpenChange}
  onSuccess={onUpdate}
  title="ç‰©æ–™"
  formSchema={formSchema}
  sections={formSections}
  defaultValues={defaultValues}
  editData={editData}
  dataLoaderConfig={{
    loadSuppliers: true,
    loadMaterialCategories: true,
    loadMaterialSubCategories: true,
  }}
  createFunctionName="createMaterial"
  updateFunctionName="updateMaterial"
/>
```

## ğŸ¯ æ™ºèƒ½é¸é …ç”Ÿæˆè¦å‰‡

ç³»çµ±æœƒæ ¹æ“šæ¬„ä½åç¨±è‡ªå‹•åŒ¹é…å°æ‡‰çš„è³‡æ–™ï¼š

| æ¬„ä½åç¨±æ¨¡å¼ | åŒ¹é…è³‡æ–™ | ç¯„ä¾‹ |
|-------------|----------|------|
| `supplier*` æˆ– `*Supplier*` | ä¾›æ‡‰å•†è³‡æ–™ | `supplierId`, `mainSupplier` |
| `category` æˆ– `*Category` | ä¸»åˆ†é¡è³‡æ–™ | `category`, `materialCategory` |
| `subCategory` æˆ– `*SubCategory` | ç´°åˆ†åˆ†é¡è³‡æ–™ | `subCategory`, `materialSubCategory` |
| `*person*` æˆ– `*user*` | ä½¿ç”¨è€…è³‡æ–™ | `liaisonPersonId`, `userId` |

## ğŸ“‚ å¯¦éš›æ‡‰ç”¨ç¯„ä¾‹

### ç‰©æ–™å°è©±æ¡† (MaterialDialog)

```tsx
// src/app/dashboard/materials/MaterialDialog.tsx
const formSections: FormSectionConfig<FormData>[] = [
  {
    title: 'åŸºæœ¬è³‡æ–™',
    icon: <Tag className="h-4 w-4" />,
    color: 'blue',
    fields: [
      {
        name: 'name',
        label: 'ç‰©æ–™åç¨±',
        type: 'text',
        required: true,
      },
      {
        name: 'category',        // è‡ªå‹•è¼‰å…¥ä¸»åˆ†é¡
        label: 'ä¸»åˆ†é¡',
        type: 'select',
        required: true,
      },
      {
        name: 'subCategory',     // è‡ªå‹•è¼‰å…¥ç´°åˆ†åˆ†é¡
        label: 'ç´°åˆ†åˆ†é¡',
        type: 'select',
        required: true,
      },
    ],
  },
  {
    title: 'ä¾›æ‡‰å•†è³‡è¨Š',
    icon: <Building className="h-4 w-4" />,
    color: 'green',
    fields: [
      {
        name: 'supplierId',      // è‡ªå‹•è¼‰å…¥ä¾›æ‡‰å•†ï¼ˆå«"ç„¡ä¾›æ‡‰å•†"é¸é …ï¼‰
        label: 'ä¾›æ‡‰å•†',
        type: 'select',
      },
    ],
  },
];

// ä½¿ç”¨çµ±ä¸€è¼‰å…¥æ©Ÿåˆ¶
<StandardFormDialog<FormData>
  // ... å…¶ä»–å±¬æ€§
  dataLoaderConfig={{
    loadSuppliers: true,
    loadMaterialCategories: true,
    loadMaterialSubCategories: true,
  }}
/>
```

### ä¾›æ‡‰å•†å°è©±æ¡† (SupplierDialog)

```tsx
// src/app/dashboard/suppliers/SupplierDialog.tsx
const formSections: FormSectionConfig<FormData>[] = [
  {
    title: 'è¯çµ¡è³‡è¨Š',
    fields: [
      {
        name: 'liaisonPersonId',  // è‡ªå‹•è¼‰å…¥ä½¿ç”¨è€…é¸é …
        label: 'å…§éƒ¨å°æ¥äººå“¡',
        type: 'select',
      },
    ],
  },
];

<StandardFormDialog<FormData>
  // ... å…¶ä»–å±¬æ€§
  dataLoaderConfig={{
    loadUsers: true,  // åªè¼‰å…¥éœ€è¦çš„è³‡æ–™
  }}
/>
```

## ğŸ”§ é€²éšé…ç½®

### è‡ªè¨‚é¸é …ï¼ˆè¦†è“‹æ™ºèƒ½åŒ¹é…ï¼‰

å¦‚æœéœ€è¦è‡ªè¨‚é¸é …ï¼Œå¯ä»¥æ‰‹å‹•è¨­å®š `selectOptions`ï¼š

```tsx
{
  name: 'unit',
  label: 'å–®ä½',
  type: 'select',
  selectOptions: [
    { value: 'å€‹', label: 'å€‹' },
    { value: 'KG', label: 'KG' },
    { value: 'å¼µ', label: 'å¼µ' },
  ],
}
```

### æ¢ä»¶è¼‰å…¥

åªè¼‰å…¥éœ€è¦çš„è³‡æ–™é¡å‹ä»¥æå‡æ•ˆèƒ½ï¼š

```tsx
dataLoaderConfig={{
  loadSuppliers: true,           // æœ‰ä¾›æ‡‰å•†æ¬„ä½æ‰è¼‰å…¥
  loadMaterialCategories: true,  // æœ‰åˆ†é¡æ¬„ä½æ‰è¼‰å…¥
  loadUsers: false,              // æ²’æœ‰ä½¿ç”¨è€…æ¬„ä½ï¼Œä¸è¼‰å…¥
}}
```

## ğŸš¨ é·ç§»æŒ‡å—

### å¾èˆŠç‰ˆå°è©±æ¡†é·ç§»

1. **ç§»é™¤æ‰‹å‹•è³‡æ–™è¼‰å…¥**ï¼š
   ```tsx
   // âŒ ç§»é™¤é€™äº›
   const [suppliers, setSuppliers] = useState([]);
   useEffect(() => {
     // è¼‰å…¥ä¾›æ‡‰å•†é‚è¼¯
   }, []);
   ```

2. **ç§»é™¤æ‰‹å‹•é¸é …è¨­å®š**ï¼š
   ```tsx
   // âŒ ç§»é™¤é€™äº›
   selectOptions: suppliers.map(s => ({ value: s.id, label: s.name }))
   ```

3. **æ·»åŠ è¼‰å…¥é…ç½®**ï¼š
   ```tsx
   // âœ… æ·»åŠ é€™å€‹
   dataLoaderConfig={{
     loadSuppliers: true,
     loadMaterialCategories: true,
   }}
   ```

4. **ç°¡åŒ–è¡¨å–®æ¬„ä½**ï¼š
   ```tsx
   // âœ… æ¬„ä½é…ç½®è®Šç°¡å–®
   {
     name: 'supplierId',
     label: 'ä¾›æ‡‰å•†',
     type: 'select',
     // selectOptions è‡ªå‹•ç”Ÿæˆ
   }
   ```

## ğŸ‰ å„ªå‹¢

1. **å®Œå…¨çµ±ä¸€åŒ–**ï¼šæ‰€æœ‰å°è©±æ¡†ä½¿ç”¨ç›¸åŒæ¶æ§‹
2. **çµ•ä¸å¡ä½**ï¼šç©©å®šçš„è¼‰å…¥æ©Ÿåˆ¶ï¼Œä¸æœƒå‡ºç¾ç„¡é™è¼‰å…¥
3. **æ™ºèƒ½åŒ–**ï¼šæ ¹æ“šæ¬„ä½åç¨±è‡ªå‹•åŒ¹é…è³‡æ–™
4. **é«˜æ•ˆèƒ½**ï¼šä¸¦è¡Œè¼‰å…¥ï¼Œåªè¼‰å…¥éœ€è¦çš„è³‡æ–™
5. **æ˜“ç¶­è­·**ï¼šçµ±ä¸€çš„è¼‰å…¥é‚è¼¯ï¼Œæ¸›å°‘é‡è¤‡ç¨‹å¼ç¢¼
6. **å‘ä¸‹ç›¸å®¹**ï¼šä¿ç•™èˆŠç‰ˆ API æ”¯æ´

## ğŸ”„ æ“´å±•èªªæ˜

### æ·»åŠ æ–°çš„è³‡æ–™é¡å‹

1. **åœ¨ useFormDataLoader.ts ä¸­æ·»åŠ æ–°é¡å‹**ï¼š
   ```tsx
   export interface FormDataLoaderConfig {
     // ... ç¾æœ‰é¡å‹
     loadNewDataType?: boolean;  // æ–°å¢
   }
   
   // åœ¨ hook ä¸­æ·»åŠ è¼‰å…¥é‚è¼¯
   if (config.loadNewDataType) {
     // è¼‰å…¥é‚è¼¯
   }
   ```

2. **åœ¨æ™ºèƒ½é¸é …ç”Ÿæˆå™¨ä¸­æ·»åŠ åŒ¹é…è¦å‰‡**ï¼š
   ```tsx
   // åœ¨ getSmartSelectOptions ä¸­æ·»åŠ 
   if (fieldName.includes('newType')) {
     return formDataLoader.newDataType.map(item => ({
       value: item.id,
       label: item.name
     }));
   }
   ```

## ğŸ“ æœ€ä½³å¯¦è¸

1. **æ¬„ä½å‘½å**ï¼šä½¿ç”¨èªç¾©åŒ–çš„æ¬„ä½åç¨±ä»¥åˆ©æ™ºèƒ½åŒ¹é…
2. **è¼‰å…¥é…ç½®**ï¼šåªè¼‰å…¥å¿…è¦çš„è³‡æ–™é¡å‹
3. **éŒ¯èª¤è™•ç†**ï¼šè¼‰å…¥å¤±æ•—æ™‚æœƒè‡ªå‹•è¨­ç‚ºç©ºé™£åˆ—ï¼Œä¸å½±éŸ¿è¡¨å–®é¡¯ç¤º
4. **æ•ˆèƒ½è€ƒé‡**ï¼šå¤§å‹è³‡æ–™é›†å¯è€ƒæ…®æ·»åŠ æœå°‹æˆ–åˆ†é åŠŸèƒ½

## ğŸ› æ•…éšœæ’é™¤

### é¸é …æ²’æœ‰é¡¯ç¤º
- æª¢æŸ¥ `dataLoaderConfig` æ˜¯å¦è¨­å®šæ­£ç¢º
- æª¢æŸ¥æ¬„ä½åç¨±æ˜¯å¦ç¬¦åˆæ™ºèƒ½åŒ¹é…è¦å‰‡
- æª¢æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰è¼‰å…¥éŒ¯èª¤è¨Šæ¯

### è¼‰å…¥ç·©æ…¢
- æª¢æŸ¥æ˜¯å¦åªè¼‰å…¥éœ€è¦çš„è³‡æ–™é¡å‹
- è€ƒæ…®å„ªåŒ– Firestore æŸ¥è©¢æˆ–æ·»åŠ ç´¢å¼•

### é¸é …é †åºä¸æ­£ç¢º
- ä¸»åˆ†é¡å’Œç´°åˆ†åˆ†é¡æœƒè‡ªå‹•æ’åº
- ä¾›æ‡‰å•†æŒ‰åŸå§‹é †åºé¡¯ç¤º
- å¦‚éœ€è‡ªè¨‚æ’åºï¼Œå¯æ‰‹å‹•è¨­å®š `selectOptions`