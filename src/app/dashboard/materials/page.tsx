'use client';

import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import { collection, getDocs, doc, deleteDoc } from 'firebase/firestore';
import { getFunctions, httpsCallable } from 'firebase/functions';
import { db } from '@/lib/firebase';
import { MaterialData } from '@/types/entities';
import { usePermission } from '@/hooks/usePermission';
import { useCartOperations } from '@/hooks/useCartOperations';
import { useDataSearch } from '@/hooks/useDataSearch';
import { StandardDataListPage, StandardColumn, StandardAction, StandardStats, QuickFilter } from '@/components/StandardDataListPage';
import { Package, DollarSign, AlertTriangle, Building, Eye, Edit, Trash2, ShoppingCart, Plus, Warehouse, MoreHorizontal, Tag, Layers, FolderOpen, Settings } from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { MaterialDialog } from './MaterialDialog';
import { ConfirmDialog } from '@/components/ConfirmDialog';

// æ“´å±• MaterialData ä»¥åŒ…å«ä¾›æ‡‰å•†è³‡è¨Š
interface MaterialWithSupplier extends MaterialData {
  supplierName: string;
  categoryName: string;
  subCategoryName: string;
  type: 'material';
  isLowStock: boolean;
}

export default function MaterialsPage() {
  const router = useRouter();
  const [materials, setMaterials] = useState<MaterialWithSupplier[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedRows, setSelectedRows] = useState<string[]>([]);
  const [stocktakeMode, setStocktakeMode] = useState(false);
  const [stocktakeUpdates, setStocktakeUpdates] = useState<Record<string, number>>({});
  
  // å°è©±æ¡†ç‹€æ…‹
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [isConfirmOpen, setIsConfirmOpen] = useState(false);
  const [selectedMaterial, setSelectedMaterial] = useState<MaterialData | null>(null);

  // æ¬Šé™æª¢æŸ¥
  const { hasPermission } = usePermission();
  const canViewMaterials = hasPermission('materials.view') || hasPermission('materials.manage');
  const canManageMaterials = hasPermission('materials.manage');

  // è³¼ç‰©è»Šæ“ä½œ
  const { addSingleItem: addToPurchaseCart } = useCartOperations(materials, { itemType: 'material' });

  // æœå°‹é…ç½®
  const searchConfig = {
    searchFields: [
      { key: 'name' as keyof MaterialWithSupplier },
      { key: 'code' as keyof MaterialWithSupplier },
      { key: 'supplierName' as keyof MaterialWithSupplier },
      { key: 'categoryName' as keyof MaterialWithSupplier },
      { key: 'subCategoryName' as keyof MaterialWithSupplier }
    ],
    filterConfigs: [
      {
        key: 'categoryName' as keyof MaterialWithSupplier,
        type: 'set' as const
      },
      {
        key: 'subCategoryName' as keyof MaterialWithSupplier,
        type: 'set' as const
      },
      {
        key: 'supplierName' as keyof MaterialWithSupplier,
        type: 'set' as const
      },
      {
        key: 'isLowStock' as keyof MaterialWithSupplier,
        type: 'boolean' as const
      }
    ]
  };

  const {
    searchTerm,
    setSearchTerm,
    activeFilters,
    setFilter,
    clearFilter,
    filteredData: filteredMaterials,
    totalCount,
    filteredCount
  } = useDataSearch(materials, searchConfig);

  // ç²å–ä¾›æ‡‰å•†å’Œåˆ†é¡è³‡æ–™
  const fetchRelatedData = useCallback(async () => {
    const suppliersMap = new Map<string, string>();
    const categoriesMap = new Map<string, string>();
    const subCategoriesMap = new Map<string, string>();
    
    try {
      if (!db) {
        console.error("Firebase db æœªåˆå§‹åŒ–");
        return { suppliersMap, categoriesMap, subCategoriesMap };
      }
      
      // ç²å–ä¾›æ‡‰å•†
      try {
        const suppliersSnapshot = await getDocs(collection(db, "suppliers"));
        console.log(`è¼‰å…¥ä¾›æ‡‰å•†è³‡æ–™ï¼š${suppliersSnapshot.size} ç­†`);
        suppliersSnapshot.forEach((doc) => {
          const supplierData = doc.data();
          if (supplierData.name) {
            suppliersMap.set(doc.id, supplierData.name);
          }
        });
        console.log("ä¾›æ‡‰å•†å°ç…§è¡¨:", Array.from(suppliersMap.entries()));
      } catch (error) {
        console.log("ä¾›æ‡‰å•†é›†åˆä¸å­˜åœ¨æˆ–è¼‰å…¥å¤±æ•—:", error);
      }
      
      // ç²å–ä¸»åˆ†é¡
      try {
        const categoriesSnapshot = await getDocs(collection(db, "materialCategories"));
        console.log(`è¼‰å…¥ä¸»åˆ†é¡è³‡æ–™ï¼š${categoriesSnapshot.size} ç­†`);
        categoriesSnapshot.forEach((doc) => {
          const categoryData = doc.data();
          if (categoryData.name) {
            categoriesMap.set(doc.id, categoryData.name);
          }
        });
      } catch (error) {
        console.log("ä¸»åˆ†é¡é›†åˆä¸å­˜åœ¨ï¼Œè·³é");
      }
      
      // ç²å–ç´°åˆ†é¡
      try {
        const subCategoriesSnapshot = await getDocs(collection(db, "materialSubCategories"));
        console.log(`è¼‰å…¥ç´°åˆ†é¡è³‡æ–™ï¼š${subCategoriesSnapshot.size} ç­†`);
        subCategoriesSnapshot.forEach((doc) => {
          const subCategoryData = doc.data();
          if (subCategoryData.name) {
            subCategoriesMap.set(doc.id, subCategoryData.name);
          }
        });
      } catch (error) {
        console.log("ç´°åˆ†é¡é›†åˆä¸å­˜åœ¨ï¼Œè·³é");
      }
      
    } catch (error) {
      console.error("ç²å–é—œè¯è³‡æ–™å¤±æ•—:", error);
    }
    
    return { suppliersMap, categoriesMap, subCategoriesMap };
  }, []);

  // ç²å–åŸæ–™è³‡æ–™
  const fetchMaterials = useCallback(async () => {
    setIsLoading(true);
    try {
      if (!db) {
        console.error("Firebase db æœªåˆå§‹åŒ–");
        setIsLoading(false);
        return;
      }
      
      const { suppliersMap, categoriesMap, subCategoriesMap } = await fetchRelatedData();
      const querySnapshot = await getDocs(collection(db, "materials"));
      
      const materialsData: MaterialWithSupplier[] = querySnapshot.docs.map((doc) => {
        const data = { id: doc.id, ...doc.data() } as MaterialData;
        
        // ç²å–ä¾›æ‡‰å•†åç¨±
        const supplierName = data.supplierId ? suppliersMap.get(data.supplierId) || 'æœªçŸ¥ä¾›æ‡‰å•†' : 'æœªæŒ‡å®š';
        
        // é™¤éŒ¯ï¼šæª¢æŸ¥ä¾›æ‡‰å•†åŒ¹é…æƒ…æ³
        if (data.supplierId && !suppliersMap.get(data.supplierId)) {
          console.warn(`åŸæ–™ ${data.name} çš„ä¾›æ‡‰å•†ID ${data.supplierId} æœªæ‰¾åˆ°å°æ‡‰ä¾›æ‡‰å•†`);
        }
        
        // ç²å–åˆ†é¡åç¨±
        let categoryName = '';
        let subCategoryName = '';
        
        if (data.category) {
          // å¦‚æœæ˜¯èˆŠæ ¼å¼çš„ categoryï¼Œç›´æ¥ä½¿ç”¨
          if (typeof data.category === 'string') {
            categoryName = data.category;
          }
        }
        
        // å¦‚æœæœ‰åˆ†é¡IDï¼Œå¾åˆ†é¡è³‡æ–™ä¸­ç²å–åç¨±
        if (data.mainCategoryId) {
          const mainCatName = categoriesMap.get(data.mainCategoryId);
          if (mainCatName) {
            categoryName = mainCatName;
          }
        }
        
        if (data.subCategoryId) {
          const subCatName = subCategoriesMap.get(data.subCategoryId);
          if (subCatName) {
            subCategoryName = subCatName;
          }
        }
        
        // å¦‚æœéƒ½æ²’æœ‰ï¼Œä½¿ç”¨ category å­—æ®µä¸­çš„åˆ†é¡
        if (!categoryName && data.category) {
          const categoryParts = data.category.split('/');
          categoryName = categoryParts[0] || '';
          if (categoryParts.length > 1) {
            subCategoryName = categoryParts[1] || '';
          }
        }
        
        return {
          ...data,
          supplierName: supplierName,
          categoryName: categoryName || 'æœªåˆ†é¡',
          subCategoryName: subCategoryName || '',
          type: 'material' as const,
          isLowStock: data.currentStock < data.minStock
        };
      });
      
      // æŒ‰åˆ†é¡å’Œåç¨±æ’åº
      const sortedMaterials = materialsData.sort((a, b) => {
        const categoryComparison = a.categoryName.localeCompare(b.categoryName);
        if (categoryComparison !== 0) return categoryComparison;
        return a.name.localeCompare(b.name);
      });
      
      setMaterials(sortedMaterials);
    } catch (error) {
      console.error("ç²å–åŸæ–™è³‡æ–™å¤±æ•—:", error);
      toast.error("è¼‰å…¥åŸæ–™è³‡æ–™å¤±æ•—");
    } finally {
      setIsLoading(false);
    }
  }, [fetchRelatedData]);

  // åˆå§‹è¼‰å…¥
  useEffect(() => {
    if (canViewMaterials) {
      fetchMaterials();
    }
  }, [canViewMaterials, fetchMaterials]);

  // å®šç¾©æ¬„ä½
  const columns: StandardColumn<MaterialWithSupplier>[] = [
    {
      key: 'name',
      title: 'ç‰©æ–™è³‡è¨Š',
      sortable: true,
      searchable: true,
      priority: 5,
      render: (value, record) => (
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-orange-500 to-blue-600 rounded-lg flex items-center justify-center">
            <Package className="h-5 w-5 text-white" />
          </div>
          <div>
            <div className="font-semibold text-foreground">{record.name}</div>
            <div className="text-xs text-blue-600 font-medium">{record.code}</div>
          </div>
        </div>
      ),
      mobileRender: (value, record) => (
        <div>
          <div className="font-medium text-gray-900">{record.name}</div>
          <div className="text-xs text-blue-600 font-medium">{record.code}</div>
        </div>
      )
    },
    {
      key: 'categoryName',
      title: 'åˆ†é¡',
      sortable: true,
      filterable: true,
      priority: 4,
      render: (value, record) => (
        <div className="space-y-1">
          {record.categoryName && record.categoryName !== 'æœªåˆ†é¡' ? (
            <Badge className="bg-blue-100 text-blue-800 border-blue-200">
              {record.subCategoryName ? 
                `${record.categoryName} + ${record.subCategoryName}` : 
                record.categoryName
              }
            </Badge>
          ) : (
            <span className="text-gray-400 text-sm">æœªåˆ†é¡</span>
          )}
        </div>
      ),
      mobileRender: (value, record) => (
        <div className="space-y-1">
          {record.categoryName && record.categoryName !== 'æœªåˆ†é¡' ? (
            <Badge className="bg-blue-100 text-blue-800 border-blue-200 text-xs">
              {record.subCategoryName ? 
                `${record.categoryName} + ${record.subCategoryName}` : 
                record.categoryName
              }
            </Badge>
          ) : (
            <span className="text-gray-400 text-xs">æœªåˆ†é¡</span>
          )}
        </div>
      )
    },
    {
      key: 'supplierName',
      title: 'ä¾›æ‡‰å•†',
      sortable: true,
      filterable: true,
      priority: 3,
      render: (value, record) => (
        <span className="text-sm font-medium text-foreground">
          {record.supplierName}
        </span>
      )
    },
    {
      key: 'currentStock',
      title: 'åº«å­˜ç‹€æ…‹',
      sortable: true,
      align: 'center',
      priority: 4,
      render: (value, record) => (
        <div className="text-center space-y-1">
          <div className={`font-semibold ${
            record.isLowStock ? 'text-red-600' : 'text-green-600'
          }`}>
            {record.currentStock} {record.unit}
          </div>
          <div className="text-xs text-gray-500">
            å®‰å…¨åº«å­˜: {record.minStock}
          </div>
          {record.isLowStock && (
            <Badge variant="destructive" className="text-xs">
              ä½åº«å­˜
            </Badge>
          )}
        </div>
      ),
      mobileRender: (value, record) => (
        <div className="text-right">
          <div className={`font-semibold ${
            record.isLowStock ? 'text-red-600' : 'text-green-600'
          }`}>
            {record.currentStock} {record.unit}
          </div>
          <div className="text-xs text-gray-500">
            æœ€ä½: {record.minStock}
          </div>
        </div>
      )
    },
    {
      key: 'costPerUnit',
      title: 'å–®ä½æˆæœ¬',
      sortable: true,
      align: 'right',
      priority: 2,
      hideOnMobile: true,
      render: (value) => (
        <span className="font-semibold text-foreground">
          ${value.toFixed(2)}
        </span>
      )
    }
  ];

  // å®šç¾©æ“ä½œ
  const actions: StandardAction<MaterialWithSupplier>[] = [
    {
      key: 'view',
      title: 'æŸ¥çœ‹è©³ç´°',
      icon: <Eye className="h-4 w-4" />,
      onClick: (material) => router.push(`/dashboard/materials/${material.id}`)
    },
    {
      key: 'addToCart',
      title: 'åŠ å…¥è³¼ç‰©è»Š',
      icon: <ShoppingCart className="h-4 w-4" />,
      onClick: async (material) => {
        try {
          await addToPurchaseCart(material);
          toast.success("å·²åŠ å…¥æ¡è³¼è»Š");
        } catch (error) {
          console.error("åŠ å…¥è³¼ç‰©è»Šå¤±æ•—:", error);
          toast.error("åŠ å…¥è³¼ç‰©è»Šå¤±æ•—");
        }
      }
    },
    ...(canManageMaterials ? [
      {
        key: 'edit',
        title: 'ç·¨è¼¯ç‰©æ–™',
        icon: <Edit className="h-4 w-4" />,
        onClick: (material: MaterialWithSupplier) => {
          setSelectedMaterial(material);
          setIsDialogOpen(true);
        }
      },
      {
        key: 'delete',
        title: 'åˆªé™¤ç‰©æ–™',
        icon: <Trash2 className="h-4 w-4" />,
        variant: 'destructive' as const,
        confirmMessage: 'ç¢ºå®šè¦åˆªé™¤æ­¤ç‰©æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚',
        onClick: (material: MaterialWithSupplier) => {
          setSelectedMaterial(material);
          setIsConfirmOpen(true);
        }
      }
    ] : [])
  ];

  // æ‰¹é‡æ“ä½œ
  const bulkActions: StandardAction<MaterialWithSupplier[]>[] = canManageMaterials ? [
    {
      key: 'batchAddToCart',
      title: 'æ‰¹é‡åŠ å…¥è³¼ç‰©è»Š',
      icon: <ShoppingCart className="h-4 w-4" />,
      onClick: async (materials) => {
        try {
          for (const material of materials) {
            await addToPurchaseCart(material);
          }
          toast.success(`å·²å°‡ ${materials.length} é …ç‰©æ–™åŠ å…¥è³¼ç‰©è»Š`);
        } catch (error) {
          toast.error("æ‰¹é‡åŠ å…¥è³¼ç‰©è»Šå¤±æ•—");
        }
      }
    }
  ] : [];

  // çµ±è¨ˆè³‡è¨Š
  const stats: StandardStats[] = useMemo(() => {
    const lowStockCount = materials.filter(m => m.isLowStock).length;
    const totalValue = materials.reduce((sum, m) => sum + (m.currentStock * m.costPerUnit), 0);
    const activeCount = materials.filter(m => m.isActive !== false).length;
    const categoryCount = new Set(materials.map(m => m.categoryName).filter(c => c && c !== 'æœªåˆ†é¡')).size;

    return [
      {
        title: 'ç¸½ç‰©æ–™æ•¸',
        value: materials.length,
        subtitle: 'æ‰€æœ‰ç‰©æ–™',
        icon: <Package className="h-4 w-4" />,
        color: 'blue'
      },
      {
        title: 'åº«å­˜ç¸½å€¼',
        value: `$${totalValue.toFixed(0)}`,
        subtitle: 'ç•¶å‰åº«å­˜åƒ¹å€¼',
        icon: <DollarSign className="h-4 w-4" />,
        color: 'green'
      },
      {
        title: 'ä½åº«å­˜',
        value: lowStockCount,
        subtitle: 'éœ€è¦è£œè²¨',
        icon: <AlertTriangle className="h-4 w-4" />,
        color: 'red'
      },
      {
        title: 'ç‰©æ–™åˆ†é¡',
        value: categoryCount,
        subtitle: 'åˆ†é¡ç¸½æ•¸',
        icon: <Tag className="h-4 w-4" />,
        color: 'purple'
      }
    ];
  }, [materials]);

  // å¿«é€Ÿç¯©é¸æ¨™ç±¤
  const quickFilters: QuickFilter[] = useMemo(() => {
    const categories = Array.from(new Set(materials.map(m => m.categoryName).filter(c => c && c !== 'æœªåˆ†é¡')));
    const subCategories = Array.from(new Set(materials.map(m => m.subCategoryName).filter(sc => sc && sc !== '')));
    const suppliers = Array.from(new Set(materials.map(m => m.supplierName).filter(s => s && s !== 'æœªæŒ‡å®š')));
    
    // å®šç¾©é¡è‰²æ˜ å°„ (åªä½¿ç”¨æ”¯æ´çš„é¡è‰²)
    const categoryColors: Array<'blue' | 'green' | 'purple' | 'orange' | 'yellow' | 'red' | 'gray'> = ['blue', 'green', 'purple', 'orange', 'yellow', 'red'];
    const subCategoryColors: Array<'blue' | 'green' | 'purple' | 'orange' | 'yellow' | 'red' | 'gray'> = ['blue', 'green', 'purple', 'orange', 'yellow', 'red'];
    
    return [
      // ç‹€æ…‹ç¯©é¸
      {
        key: 'isLowStock',
        label: 'ä½åº«å­˜',
        value: true,
        count: materials.filter(m => m.isLowStock).length,
        color: 'red'
      },
      // ä¸»åˆ†é¡ç¯©é¸ (é¡¯ç¤ºæ‰€æœ‰ä¸»åˆ†é¡)
      ...categories.map((category, index) => ({
        key: 'categoryName',
        label: `ğŸ“‚ ${category}`,
        value: category,
        count: materials.filter(m => m.categoryName === category).length,
        color: categoryColors[index % categoryColors.length]
      })),
      // ç´°åˆ†é¡ç¯©é¸ (é¡¯ç¤ºå‰6å€‹)
      ...subCategories.slice(0, 6).map((subCategory, index) => ({
        key: 'subCategoryName',
        label: `ğŸ“‹ ${subCategory}`,
        value: subCategory,
        count: materials.filter(m => m.subCategoryName === subCategory).length,
        color: subCategoryColors[index % subCategoryColors.length]
      })),
      // ä¾›æ‡‰å•†ç¯©é¸ (é¡¯ç¤ºå‰4å€‹)
      ...suppliers.slice(0, 4).map((supplier, index) => ({
        key: 'supplierName',
        label: `ğŸ¢ ${supplier}`,
        value: supplier,
        count: materials.filter(m => m.supplierName === supplier).length,
        color: 'gray' as const
      }))
    ];
  }, [materials]);

  // æ“ä½œè™•ç†å‡½å¼
  const handleAdd = () => {
    setSelectedMaterial(null);
    setIsDialogOpen(true);
  };

  const handleConfirmDelete = async () => {
    if (!selectedMaterial || !db) {
      toast.error("ç³»çµ±éŒ¯èª¤ï¼šè³‡æ–™åº«æœªåˆå§‹åŒ–");
      return;
    }
    const toastId = toast.loading("æ­£åœ¨åˆªé™¤ç‰©æ–™...");
    try {
      await deleteDoc(doc(db, "materials", selectedMaterial.id));
      toast.success(`ç‰©æ–™ ${selectedMaterial.name} å·²æˆåŠŸåˆªé™¤ã€‚`, { id: toastId });
      fetchMaterials();
    } catch (error) {
      console.error("åˆªé™¤ç‰©æ–™å¤±æ•—:", error);
      toast.error("åˆªé™¤ç‰©æ–™å¤±æ•—", { id: toastId });
    } finally {
      setIsConfirmOpen(false);
      setSelectedMaterial(null);
    }
  };

  // è™•ç†ç›¤é»å„²å­˜
  const handleStocktakeSave = async () => {
    if (!canManageMaterials || Object.keys(stocktakeUpdates).length === 0) {
      toast.error("æ²’æœ‰è®Šæ›´éœ€è¦å„²å­˜");
      return;
    }

    try {
      const functions = getFunctions();
      const batchUpdateInventory = httpsCallable(functions, 'batchUpdateInventory');
      
      await batchUpdateInventory({
        updates: Object.entries(stocktakeUpdates).map(([id, quantity]) => ({
          id,
          quantity,
          type: 'material'
        }))
      });

      toast.success(`å·²æ›´æ–° ${Object.keys(stocktakeUpdates).length} é …åŸæ–™åº«å­˜`);
      setStocktakeUpdates({});
      setStocktakeMode(false);
      fetchMaterials();
    } catch (error) {
      console.error("ç›¤é»å„²å­˜å¤±æ•—:", error);
      toast.error("ç›¤é»å„²å­˜å¤±æ•—");
    }
  };

  // å·¥å…·åˆ—é¡å¤–å‹•ä½œ
  const toolbarActions = (
    <>
      {canManageMaterials && (
        <Button 
          variant="outline" 
          onClick={() => router.push('/dashboard/material-categories')}
          className="border-blue-200 text-blue-600 hover:bg-blue-600 hover:text-white hover:border-blue-600 transition-all duration-200"
        >
          <Tag className="h-4 w-4 mr-2" />
          åˆ†é¡ç®¡ç†
        </Button>
      )}
      {canManageMaterials && (
        <Button 
          variant="outline" 
          onClick={() => setStocktakeMode(!stocktakeMode)}
          className={`transition-all duration-200 ${
            stocktakeMode 
              ? 'bg-orange-100 border-orange-300 text-orange-700 hover:bg-orange-200' 
              : 'border-orange-200 text-orange-600 hover:bg-orange-600 hover:text-white hover:border-orange-600'
          }`}
        >
          <Warehouse className="h-4 w-4 mr-2" />
          {stocktakeMode ? 'é€€å‡ºç›¤é»' : 'åº«å­˜ç›¤é»'}
        </Button>
      )}
    </>
  );

  if (!canViewMaterials) {
    return (
      <div className="text-center py-8">
        <p>æ‚¨æ²’æœ‰æ¬Šé™æŸ¥çœ‹æ­¤é é¢</p>
      </div>
    );
  }

  return (
    <div className="container mx-auto py-10">
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <div>
          <h1 className="text-3xl font-bold bg-gradient-to-r from-orange-600 to-blue-600 bg-clip-text text-transparent">
            åŸæ–™åº«ç®¡ç†
          </h1>
          <p className="text-gray-600 mt-2">ç®¡ç†åŸæ–™åº«å­˜ã€åˆ†é¡èˆ‡ä¾›æ‡‰å•†è³‡è¨Š</p>
        </div>
      </div>

      <StandardDataListPage
        data={filteredMaterials}
        loading={isLoading}
        columns={columns}
        actions={actions}
        bulkActions={bulkActions}
        onRowClick={(record) => router.push(`/dashboard/materials/${record.id}`)}
        
        // æœå°‹èˆ‡éæ¿¾
        searchable={true}
        searchPlaceholder="æœå°‹ç‰©æ–™åç¨±ã€ä»£è™Ÿã€åˆ†é¡æˆ–ä¾›æ‡‰å•†..."
        searchValue={searchTerm}
        onSearchChange={setSearchTerm}
        quickFilters={quickFilters}
        activeFilters={activeFilters}
        onFilterChange={(key, value) => {
          if (value === null) {
            clearFilter(key);
          } else {
            setFilter(key, value);
          }
        }}
        onClearFilters={() => {
          Object.keys(activeFilters).forEach(key => clearFilter(key));
        }}
        
        // é¸æ“‡åŠŸèƒ½
        selectable={true}
        selectedRows={selectedRows}
        onSelectionChange={(selected) => setSelectedRows(selected as string[])}
        rowKey="id"
        
        // çµ±è¨ˆè³‡è¨Š
        stats={stats}
        showStats={true}
        
        // å·¥å…·åˆ—åŠŸèƒ½
        showToolbar={true}
        toolbarActions={toolbarActions}
        showImportExport={canManageMaterials}
        onImport={() => toast.info('åŒ¯å…¥åŠŸèƒ½é–‹ç™¼ä¸­...')}
        onExport={() => toast.info('åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­...')}
        
        // æ–°å¢åŠŸèƒ½
        showAddButton={canManageMaterials}
        addButtonText="æ–°å¢ç‰©æ–™"
        onAdd={handleAdd}
        
        // ç›¤é»æ¨¡å¼
        stocktakeMode={stocktakeMode}
        onStocktakeModeChange={setStocktakeMode}
        stocktakeUpdates={stocktakeUpdates}
        onStocktakeUpdateChange={setStocktakeUpdates}
        onStocktakeSave={handleStocktakeSave}
        
        // æ¬Šé™æ§åˆ¶
        permissions={{
          view: canViewMaterials,
          create: canManageMaterials,
          edit: canManageMaterials,
          delete: canManageMaterials,
          export: canManageMaterials,
          import: canManageMaterials
        }}
        
        className="space-y-6"
      />

      <MaterialDialog
        isOpen={isDialogOpen}
        onOpenChange={(open) => {
          setIsDialogOpen(open);
          if (!open) setSelectedMaterial(null);
        }}
        onMaterialUpdate={() => {
          fetchMaterials();
        }}
        materialData={selectedMaterial}
      />

      {selectedMaterial && (
        <ConfirmDialog
          isOpen={isConfirmOpen}
          onOpenChange={setIsConfirmOpen}
          onConfirm={handleConfirmDelete}
          title="ç¢ºèªåˆªé™¤ç‰©æ–™"
          description={`æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ç‰©æ–™ã€Œ${selectedMaterial.name}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`}
        />
      )}
    </div>
  );
}