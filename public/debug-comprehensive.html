<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全面診斷測試</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 5px; 
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .loading { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover { background: #0056b3; }
        .login-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .login-form input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 5px; 
            overflow-x: auto; 
            font-size: 12px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-loading { background: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 全面診斷測試</h1>
        
        <div class="test-section">
            <h2>📋 測試控制面板</h2>
            <button onclick="runAllTests()">執行所有測試</button>
            <button onclick="testStaticFiles()">測試靜態檔案</button>
            <button onclick="testFirebaseConfig()">測試 Firebase 配置</button>
            <button onclick="testAuthentication()">測試認證流程</button>
            <button onclick="testRedirect()">測試重定向</button>
            <button onclick="clearResults()">清除結果</button>
        </div>

        <div class="test-section">
            <h2>🔐 登入測試</h2>
            <div class="login-form">
                <input type="email" id="email" placeholder="電子郵件" value="001@deer-lab.local">
                <input type="password" id="password" placeholder="密碼" value="123456">
                <button onclick="testLogin()">測試登入</button>
                <button onclick="testLogout()">測試登出</button>
            </div>
        </div>

        <div class="test-section">
            <h2>📊 測試結果</h2>
            <div id="results"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const resultsDiv = document.getElementById('results');
        let firebaseApp, auth, db;

        function addResult(type, title, content) {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            const statusClass = type === 'success' ? 'status-success' : 
                              type === 'error' ? 'status-error' : 
                              type === 'warning' ? 'status-warning' : 'status-loading';
            div.innerHTML = `
                <span class="status-indicator ${statusClass}"></span>
                <h3>${title}</h3>
                <pre>${content}</pre>
            `;
            resultsDiv.appendChild(div);
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        async function testStaticFiles() {
            addResult('loading', '🔄 測試靜態檔案載入...', '');
            
            const testFiles = [
                '/static/chunks/2117-5757fb862770af4e.js',
                '/static/chunks/fd9d1056-ae95b65e8096afde.js',
                '/static/css/ca0a7c8fcb67dc11.css',
                '/manifest.json'
            ];
            
            for (const file of testFiles) {
                try {
                    const response = await fetch(file);
                    const contentType = response.headers.get('content-type');
                    const status = response.status;
                    
                    if (status === 200) {
                        if (file.endsWith('.js') && contentType && contentType.includes('javascript')) {
                            addResult('success', `✅ ${file}`, `狀態: ${status}\nContent-Type: ${contentType}\n✅ 正確的 JavaScript MIME 類型`);
                        } else if (file.endsWith('.js') && contentType && contentType.includes('html')) {
                            addResult('error', `❌ ${file}`, `狀態: ${status}\nContent-Type: ${contentType}\n❌ 錯誤：JavaScript 檔案被當作 HTML 提供`);
                        } else if (file.endsWith('.css') && contentType && contentType.includes('css')) {
                            addResult('success', `✅ ${file}`, `狀態: ${status}\nContent-Type: ${contentType}\n✅ 正確的 CSS MIME 類型`);
                        } else {
                            addResult('success', `✅ ${file}`, `狀態: ${status}\nContent-Type: ${contentType}`);
                        }
                    } else {
                        addResult('error', `❌ ${file}`, `狀態: ${status}\nContent-Type: ${contentType}`);
                    }
                } catch (error) {
                    addResult('error', `❌ ${file}`, `載入失敗: ${error.message}`);
                }
            }
        }

        async function testFirebaseConfig() {
            addResult('loading', '🔄 測試 Firebase 配置...', '');
            
            try {
                // Firebase 配置
                const firebaseConfig = {
                    apiKey: "AIzaSyCMIAqNPsIyl3fJNllqNCuUJE2Rvcdf6fk",
                    authDomain: "deer-lab.firebaseapp.com",
                    projectId: "deer-lab",
                    storageBucket: "deer-lab.firebasestorage.app",
                    messagingSenderId: "554942047858",
                    appId: "1:554942047858:web:607d3e27bb438c898644eb"
                };

                // 初始化 Firebase
                firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);

                addResult('success', '✅ Firebase 初始化', `配置載入成功\nProject ID: ${firebaseConfig.projectId}\nAuth Domain: ${firebaseConfig.authDomain}`);
                
                // 測試認證狀態
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        addResult('success', '✅ 認證狀態', `使用者已登入: ${user.email}\nUID: ${user.uid}`);
                    } else {
                        addResult('warning', '⚠️ 認證狀態', '目前沒有使用者登入');
                    }
                });

            } catch (error) {
                addResult('error', '❌ Firebase 配置失敗', error.message);
            }
        }

        async function testAuthentication() {
            addResult('loading', '🔄 測試認證流程...', '');
            
            if (!auth) {
                addResult('error', '❌ 認證測試失敗', 'Firebase 尚未初始化');
                return;
            }

            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                addResult('loading', '🔄 嘗試登入...', `電子郵件: ${email}`);
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                addResult('success', '✅ 登入成功', `使用者: ${user.email}\nUID: ${user.uid}`);
                
                // 測試 Firestore 資料載入
                try {
                    const employeeId = email.split('@')[0];
                    const usersRef = collection(db, 'users');
                    const q = query(usersRef, where('employeeId', '==', employeeId));
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const userData = querySnapshot.docs[0].data();
                        addResult('success', '✅ Firestore 資料載入', `工號: ${userData.employeeId}\n姓名: ${userData.name}\n狀態: ${userData.status}`);
                    } else {
                        addResult('warning', '⚠️ Firestore 資料', `找不到工號 ${employeeId} 的使用者資料`);
                    }
                } catch (firestoreError) {
                    addResult('error', '❌ Firestore 資料載入失敗', firestoreError.message);
                }

            } catch (error) {
                addResult('error', '❌ 登入失敗', error.message);
            }
        }

        async function testRedirect() {
            addResult('loading', '🔄 測試重定向...', '');
            
            try {
                // 測試 dashboard 頁面載入
                const response = await fetch('/dashboard');
                const status = response.status;
                
                if (status === 200) {
                    addResult('success', '✅ Dashboard 頁面', `狀態: ${status}\n頁面可以正常載入`);
                } else {
                    addResult('warning', '⚠️ Dashboard 頁面', `狀態: ${status}\n可能需要認證`);
                }

                // 測試重定向邏輯
                if (auth && auth.currentUser) {
                    addResult('success', '✅ 重定向邏輯', '使用者已認證，應該可以重定向到 dashboard');
                    // 模擬重定向
                    setTimeout(() => {
                        addResult('success', '✅ 重定向執行', '正在導航到 dashboard...');
                        window.location.href = '/dashboard';
                    }, 1000);
                } else {
                    addResult('warning', '⚠️ 重定向邏輯', '使用者未認證，無法重定向');
                }

            } catch (error) {
                addResult('error', '❌ 重定向測試失敗', error.message);
            }
        }

        async function runAllTests() {
            clearResults();
            addResult('loading', '🚀 開始全面測試...', '');
            
            await testStaticFiles();
            await testFirebaseConfig();
            await testAuthentication();
            await testRedirect();
            
            addResult('success', '✅ 所有測試完成', '請查看上方結果');
        }

        async function testLogin() {
            await testAuthentication();
        }

        async function testLogout() {
            if (!auth) {
                addResult('error', '❌ 登出失敗', 'Firebase 尚未初始化');
                return;
            }

            try {
                await signOut(auth);
                addResult('success', '✅ 登出成功', '使用者已登出');
            } catch (error) {
                addResult('error', '❌ 登出失敗', error.message);
            }
        }

        // 頁面載入時自動初始化
        window.addEventListener('load', () => {
            addResult('loading', '📋 診斷工具已準備就緒', '點擊上方按鈕開始測試');
            testFirebaseConfig(); // 自動初始化 Firebase
        });

        // 暴露函數到全域
        window.testStaticFiles = testStaticFiles;
        window.testFirebaseConfig = testFirebaseConfig;
        window.testAuthentication = testAuthentication;
        window.testRedirect = testRedirect;
        window.runAllTests = runAllTests;
        window.clearResults = clearResults;
        window.testLogin = testLogin;
        window.testLogout = testLogout;
    </script>
</body>
</html>
