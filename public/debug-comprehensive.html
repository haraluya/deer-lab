<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨é¢è¨ºæ–·æ¸¬è©¦</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 5px; 
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .loading { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover { background: #0056b3; }
        .login-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .login-form input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 5px; 
            overflow-x: auto; 
            font-size: 12px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-loading { background: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å…¨é¢è¨ºæ–·æ¸¬è©¦</h1>
        
        <div class="test-section">
            <h2>ğŸ“‹ æ¸¬è©¦æ§åˆ¶é¢æ¿</h2>
            <button onclick="runAllTests()">åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
            <button onclick="testStaticFiles()">æ¸¬è©¦éœæ…‹æª”æ¡ˆ</button>
            <button onclick="testFirebaseConfig()">æ¸¬è©¦ Firebase é…ç½®</button>
            <button onclick="testAuthentication()">æ¸¬è©¦èªè­‰æµç¨‹</button>
            <button onclick="testRedirect()">æ¸¬è©¦é‡å®šå‘</button>
            <button onclick="clearResults()">æ¸…é™¤çµæœ</button>
        </div>

        <div class="test-section">
            <h2>ğŸ” ç™»å…¥æ¸¬è©¦</h2>
            <div class="login-form">
                <input type="email" id="email" placeholder="é›»å­éƒµä»¶" value="001@deer-lab.local">
                <input type="password" id="password" placeholder="å¯†ç¢¼" value="123456">
                <button onclick="testLogin()">æ¸¬è©¦ç™»å…¥</button>
                <button onclick="testLogout()">æ¸¬è©¦ç™»å‡º</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š æ¸¬è©¦çµæœ</h2>
            <div id="results"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const resultsDiv = document.getElementById('results');
        let firebaseApp, auth, db;

        function addResult(type, title, content) {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            const statusClass = type === 'success' ? 'status-success' : 
                              type === 'error' ? 'status-error' : 
                              type === 'warning' ? 'status-warning' : 'status-loading';
            div.innerHTML = `
                <span class="status-indicator ${statusClass}"></span>
                <h3>${title}</h3>
                <pre>${content}</pre>
            `;
            resultsDiv.appendChild(div);
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        async function testStaticFiles() {
            addResult('loading', 'ğŸ”„ æ¸¬è©¦éœæ…‹æª”æ¡ˆè¼‰å…¥...', '');
            
            const testFiles = [
                '/static/chunks/2117-5757fb862770af4e.js',
                '/static/chunks/fd9d1056-ae95b65e8096afde.js',
                '/static/css/ca0a7c8fcb67dc11.css',
                '/manifest.json'
            ];
            
            for (const file of testFiles) {
                try {
                    const response = await fetch(file);
                    const contentType = response.headers.get('content-type');
                    const status = response.status;
                    
                    if (status === 200) {
                        if (file.endsWith('.js') && contentType && contentType.includes('javascript')) {
                            addResult('success', `âœ… ${file}`, `ç‹€æ…‹: ${status}\nContent-Type: ${contentType}\nâœ… æ­£ç¢ºçš„ JavaScript MIME é¡å‹`);
                        } else if (file.endsWith('.js') && contentType && contentType.includes('html')) {
                            addResult('error', `âŒ ${file}`, `ç‹€æ…‹: ${status}\nContent-Type: ${contentType}\nâŒ éŒ¯èª¤ï¼šJavaScript æª”æ¡ˆè¢«ç•¶ä½œ HTML æä¾›`);
                        } else if (file.endsWith('.css') && contentType && contentType.includes('css')) {
                            addResult('success', `âœ… ${file}`, `ç‹€æ…‹: ${status}\nContent-Type: ${contentType}\nâœ… æ­£ç¢ºçš„ CSS MIME é¡å‹`);
                        } else {
                            addResult('success', `âœ… ${file}`, `ç‹€æ…‹: ${status}\nContent-Type: ${contentType}`);
                        }
                    } else {
                        addResult('error', `âŒ ${file}`, `ç‹€æ…‹: ${status}\nContent-Type: ${contentType}`);
                    }
                } catch (error) {
                    addResult('error', `âŒ ${file}`, `è¼‰å…¥å¤±æ•—: ${error.message}`);
                }
            }
        }

        async function testFirebaseConfig() {
            addResult('loading', 'ğŸ”„ æ¸¬è©¦ Firebase é…ç½®...', '');
            
            try {
                // Firebase é…ç½®
                const firebaseConfig = {
                    apiKey: "AIzaSyCMIAqNPsIyl3fJNllqNCuUJE2Rvcdf6fk",
                    authDomain: "deer-lab.firebaseapp.com",
                    projectId: "deer-lab",
                    storageBucket: "deer-lab.firebasestorage.app",
                    messagingSenderId: "554942047858",
                    appId: "1:554942047858:web:607d3e27bb438c898644eb"
                };

                // åˆå§‹åŒ– Firebase
                firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);

                addResult('success', 'âœ… Firebase åˆå§‹åŒ–', `é…ç½®è¼‰å…¥æˆåŠŸ\nProject ID: ${firebaseConfig.projectId}\nAuth Domain: ${firebaseConfig.authDomain}`);
                
                // æ¸¬è©¦èªè­‰ç‹€æ…‹
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        addResult('success', 'âœ… èªè­‰ç‹€æ…‹', `ä½¿ç”¨è€…å·²ç™»å…¥: ${user.email}\nUID: ${user.uid}`);
                    } else {
                        addResult('warning', 'âš ï¸ èªè­‰ç‹€æ…‹', 'ç›®å‰æ²’æœ‰ä½¿ç”¨è€…ç™»å…¥');
                    }
                });

            } catch (error) {
                addResult('error', 'âŒ Firebase é…ç½®å¤±æ•—', error.message);
            }
        }

        async function testAuthentication() {
            addResult('loading', 'ğŸ”„ æ¸¬è©¦èªè­‰æµç¨‹...', '');
            
            if (!auth) {
                addResult('error', 'âŒ èªè­‰æ¸¬è©¦å¤±æ•—', 'Firebase å°šæœªåˆå§‹åŒ–');
                return;
            }

            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                addResult('loading', 'ğŸ”„ å˜—è©¦ç™»å…¥...', `é›»å­éƒµä»¶: ${email}`);
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                addResult('success', 'âœ… ç™»å…¥æˆåŠŸ', `ä½¿ç”¨è€…: ${user.email}\nUID: ${user.uid}`);
                
                // æ¸¬è©¦ Firestore è³‡æ–™è¼‰å…¥
                try {
                    const employeeId = email.split('@')[0];
                    const usersRef = collection(db, 'users');
                    const q = query(usersRef, where('employeeId', '==', employeeId));
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const userData = querySnapshot.docs[0].data();
                        addResult('success', 'âœ… Firestore è³‡æ–™è¼‰å…¥', `å·¥è™Ÿ: ${userData.employeeId}\nå§“å: ${userData.name}\nç‹€æ…‹: ${userData.status}`);
                    } else {
                        addResult('warning', 'âš ï¸ Firestore è³‡æ–™', `æ‰¾ä¸åˆ°å·¥è™Ÿ ${employeeId} çš„ä½¿ç”¨è€…è³‡æ–™`);
                    }
                } catch (firestoreError) {
                    addResult('error', 'âŒ Firestore è³‡æ–™è¼‰å…¥å¤±æ•—', firestoreError.message);
                }

            } catch (error) {
                addResult('error', 'âŒ ç™»å…¥å¤±æ•—', error.message);
            }
        }

        async function testRedirect() {
            addResult('loading', 'ğŸ”„ æ¸¬è©¦é‡å®šå‘...', '');
            
            try {
                // æ¸¬è©¦ dashboard é é¢è¼‰å…¥
                const response = await fetch('/dashboard');
                const status = response.status;
                
                if (status === 200) {
                    addResult('success', 'âœ… Dashboard é é¢', `ç‹€æ…‹: ${status}\né é¢å¯ä»¥æ­£å¸¸è¼‰å…¥`);
                } else {
                    addResult('warning', 'âš ï¸ Dashboard é é¢', `ç‹€æ…‹: ${status}\nå¯èƒ½éœ€è¦èªè­‰`);
                }

                // æ¸¬è©¦é‡å®šå‘é‚è¼¯
                if (auth && auth.currentUser) {
                    addResult('success', 'âœ… é‡å®šå‘é‚è¼¯', 'ä½¿ç”¨è€…å·²èªè­‰ï¼Œæ‡‰è©²å¯ä»¥é‡å®šå‘åˆ° dashboard');
                    // æ¨¡æ“¬é‡å®šå‘
                    setTimeout(() => {
                        addResult('success', 'âœ… é‡å®šå‘åŸ·è¡Œ', 'æ­£åœ¨å°èˆªåˆ° dashboard...');
                        window.location.href = '/dashboard';
                    }, 1000);
                } else {
                    addResult('warning', 'âš ï¸ é‡å®šå‘é‚è¼¯', 'ä½¿ç”¨è€…æœªèªè­‰ï¼Œç„¡æ³•é‡å®šå‘');
                }

            } catch (error) {
                addResult('error', 'âŒ é‡å®šå‘æ¸¬è©¦å¤±æ•—', error.message);
            }
        }

        async function runAllTests() {
            clearResults();
            addResult('loading', 'ğŸš€ é–‹å§‹å…¨é¢æ¸¬è©¦...', '');
            
            await testStaticFiles();
            await testFirebaseConfig();
            await testAuthentication();
            await testRedirect();
            
            addResult('success', 'âœ… æ‰€æœ‰æ¸¬è©¦å®Œæˆ', 'è«‹æŸ¥çœ‹ä¸Šæ–¹çµæœ');
        }

        async function testLogin() {
            await testAuthentication();
        }

        async function testLogout() {
            if (!auth) {
                addResult('error', 'âŒ ç™»å‡ºå¤±æ•—', 'Firebase å°šæœªåˆå§‹åŒ–');
                return;
            }

            try {
                await signOut(auth);
                addResult('success', 'âœ… ç™»å‡ºæˆåŠŸ', 'ä½¿ç”¨è€…å·²ç™»å‡º');
            } catch (error) {
                addResult('error', 'âŒ ç™»å‡ºå¤±æ•—', error.message);
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åˆå§‹åŒ–
        window.addEventListener('load', () => {
            addResult('loading', 'ğŸ“‹ è¨ºæ–·å·¥å…·å·²æº–å‚™å°±ç·’', 'é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦');
            testFirebaseConfig(); // è‡ªå‹•åˆå§‹åŒ– Firebase
        });

        // æš´éœ²å‡½æ•¸åˆ°å…¨åŸŸ
        window.testStaticFiles = testStaticFiles;
        window.testFirebaseConfig = testFirebaseConfig;
        window.testAuthentication = testAuthentication;
        window.testRedirect = testRedirect;
        window.runAllTests = runAllTests;
        window.clearResults = clearResults;
        window.testLogin = testLogin;
        window.testLogout = testLogout;
    </script>
</body>
</html>
