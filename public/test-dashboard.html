<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>測試 Dashboard</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCMIAqNPsIyl3fJNllqNCuUJE2Rvcdf6fk",
            authDomain: "deer-lab.firebaseapp.com",
            projectId: "deer-lab",
            storageBucket: "deer-lab.firebasestorage.app",
            messagingSenderId: "554942047858",
            appId: "1:554942047858:web:607d3e27bb438c898644eb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.testAuth = async function() {
            try {
                console.log('Testing authentication...');
                
                // 檢查當前用戶
                const user = auth.currentUser;
                console.log('Current user:', user);
                
                if (user) {
                    console.log('User is authenticated:', user.uid);
                    
                    // 載入用戶資料
                    const employeeId = user.email?.split('@')[0];
                    console.log('Loading data for employeeId:', employeeId);
                    
                    const usersRef = collection(db, 'users');
                    const q = query(usersRef, where('employeeId', '==', employeeId));
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const userDoc = querySnapshot.docs[0];
                        const userData = userDoc.data();
                        console.log('User data loaded:', userData);
                        
                        document.getElementById('result').innerHTML = `
                            <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin: 10px 0;">
                                <h3>✅ 認證成功！</h3>
                                <p><strong>用戶名稱：</strong>${userData.name}</p>
                                <p><strong>工號：</strong>${userData.employeeId}</p>
                                <p><strong>狀態：</strong>${userData.status}</p>
                            </div>
                        `;
                    } else {
                        document.getElementById('result').innerHTML = `
                            <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin: 10px 0;">
                                <h3>❌ 用戶資料未找到</h3>
                                <p>工號 ${employeeId} 的資料不存在</p>
                            </div>
                        `;
                    }
                } else {
                    document.getElementById('result').innerHTML = `
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 10px 0;">
                            <h3>⚠️ 未登入</h3>
                            <p>請先前往 <a href="/" style="color: #007bff;">登入頁面</a></p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('result').innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin: 10px 0;">
                        <h3>❌ 錯誤</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        };

        // 監聽認證狀態變化
        onAuthStateChanged(auth, (user) => {
            console.log('Auth state changed:', user?.uid);
            if (user) {
                document.getElementById('auth-status').innerHTML = `
                    <span style="color: green;">✅ 已登入 (${user.uid})</span>
                `;
            } else {
                document.getElementById('auth-status').innerHTML = `
                    <span style="color: red;">❌ 未登入</span>
                `;
            }
        });
    </script>
</head>
<body>
    <div style="max-width: 800px; margin: 50px auto; padding: 20px; font-family: Arial, sans-serif;">
        <h1>Dashboard 測試頁面</h1>
        
        <div style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; margin: 20px 0;">
            <h3>認證狀態</h3>
            <div id="auth-status">載入中...</div>
        </div>
        
        <button onclick="testAuth()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px 0;">
            測試認證和資料載入
        </button>
        
        <div id="result"></div>
        
        <div style="margin-top: 30px;">
            <h3>導航連結</h3>
            <ul>
                <li><a href="/" style="color: #007bff;">登入頁面</a></li>
                <li><a href="/dashboard" style="color: #007bff;">Dashboard</a></li>
                <li><a href="/test-create-user.html" style="color: #007bff;">創建測試用戶</a></li>
            </ul>
        </div>
    </div>
</body>
</html>
