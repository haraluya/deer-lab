# 物料代碼系統說明

## 概述

新的物料代碼系統採用結構化的9位代碼，由三個部分組成：
- **主分類ID** (2位字母)
- **細分分類ID** (3位數字)  
- **隨機生成碼** (4位數字)

## 代碼結構

```
[主分類ID][細分分類ID][隨機生成碼]
  2位字母    3位數字    4位數字
    AB       123       4567
```

### 範例
- `AB1234567` - 主分類AB，細分分類123，隨機碼4567
- `XY7890123` - 主分類XY，細分分類789，隨機碼0123

## 系統特點

### 1. 自動生成
- 當選擇主分類和細分分類時，系統自動生成9位物料代號
- 確保代號的唯一性，避免重複

### 2. 智能更新
- 當物料的分類發生改變時，系統會：
  - 保持隨機生成碼不變
  - 只更新主分類ID和細分分類ID部分
  - 例如：`AB1234567` → `CD1234567` (只改變分類，隨機碼保持4567)

### 3. 分類管理
- 每個主分類都有唯一的2位字母ID
- 每個細分分類都有唯一的3位數字ID
- 分類ID與分類名稱一一對應

## 實現細節

### 前端實現
- `src/lib/utils.ts` - 包含所有代碼生成和解析函數
- `src/app/dashboard/materials/MaterialDialog.tsx` - 物料對話框，支援即時代碼生成
- `src/app/dashboard/material-categories/page.tsx` - 分類管理頁面，顯示分類ID

### 後端實現
- `functions/src/api/materials.ts` - 物料管理API，支援新代碼系統
- 自動創建分類ID
- 智能更新物料代號

### 資料庫結構
```javascript
// 物料資料結構
{
  code: "AB1234567",           // 9位物料代號
  name: "高級香精A",           // 物料名稱
  category: "香精",            // 主分類名稱
  subCategory: "高級香精",     // 細分分類名稱
  mainCategoryId: "AB",        // 主分類ID (2位字母)
  subCategoryId: "123",        // 細分分類ID (3位數字)
  // ... 其他欄位
}

// 主分類資料結構
{
  name: "香精",                // 分類名稱
  id: "AB",                   // 分類ID (2位字母)
  type: "category",           // 類型
  createdAt: timestamp        // 創建時間
}

// 細分分類資料結構
{
  name: "高級香精",           // 細分分類名稱
  id: "123",                  // 細分分類ID (3位數字)
  type: "subCategory",        // 類型
  parentCategory: "香精",     // 父分類
  createdAt: timestamp        // 創建時間
}
```

## 遷移指南

### 現有資料遷移
1. 執行遷移腳本 `migrate-material-codes.js`
2. 腳本會自動為現有物料生成新的9位代號
3. 為現有分類創建對應的ID

### 遷移腳本使用
```bash
# 1. 更新 Firebase 配置
# 編輯 migrate-material-codes.js 中的 firebaseConfig

# 2. 執行遷移
node migrate-material-codes.js
```

## 使用流程

### 新增物料
1. 選擇主分類和細分分類
2. 系統自動生成9位物料代號
3. 填寫其他物料資訊
4. 儲存物料

### 編輯物料
1. 修改物料資訊
2. 如果改變分類，代號會自動更新（保持隨機碼不變）
3. 儲存變更

### 分類管理
1. 在分類管理頁面查看所有分類
2. 每個分類都顯示對應的ID
3. 可以新增、編輯、刪除分類

## 優勢

1. **結構化** - 代碼包含分類資訊，便於識別和管理
2. **唯一性** - 9位代碼確保唯一性
3. **智能更新** - 分類改變時保持隨機碼不變
4. **可讀性** - 代碼結構清晰，便於理解
5. **擴展性** - 支援大量分類和物料

## 注意事項

1. 代號長度固定為9位
2. 主分類ID為2位大寫字母
3. 細分分類ID為3位數字
4. 隨機生成碼為4位數字
5. 分類改變時，隨機生成碼保持不變
6. 系統會自動檢查代號唯一性

## 技術支援

如有問題或需要協助，請聯繫開發團隊。
