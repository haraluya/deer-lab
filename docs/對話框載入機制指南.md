# 統一對話框載入機制使用指南

## 📋 概述

本指南說明如何使用完全統一化的對話框載入機制，確保所有CRUD對話框都使用相同的架構，並且不會出現載入卡住的問題。

## 🚀 核心組件

### 1. useFormDataLoader Hook

**檔案位置**: `src/hooks/useFormDataLoader.ts`

**功能**: 統一的資料載入器，支援並行載入多種常用資料類型

**支援的資料類型**:
- `loadSuppliers`: 供應商資料
- `loadMaterialCategories`: 物料主分類
- `loadMaterialSubCategories`: 物料細分分類  
- `loadUsers`: 使用者資料
- `loadProducts`: 產品資料

### 2. StandardFormDialog 增強版

**檔案位置**: `src/components/StandardFormDialog.tsx`

**新增功能**:
- `dataLoaderConfig` 屬性：配置需要載入的資料類型
- 智能選項生成器：根據欄位名稱自動提供選項資料
- 向下相容：保留原有的 `onDataLoad` 和 `skipDataLoading` 支援

## 📖 使用方式

### 基本用法

```tsx
import { StandardFormDialog, FormSectionConfig } from '@/components/StandardFormDialog';

// 1. 定義表單配置
const formSections: FormSectionConfig<FormData>[] = [
  {
    title: '基本資料',
    fields: [
      {
        name: 'supplierId',  // 智能匹配：自動載入供應商選項
        label: '供應商',
        type: 'select',
        // 不需要手動設定 selectOptions
      },
      {
        name: 'category',    // 智能匹配：自動載入主分類選項
        label: '主分類',
        type: 'select',
      },
      {
        name: 'subCategory', // 智能匹配：自動載入細分分類選項
        label: '細分分類',
        type: 'select',
      }
    ]
  }
];

// 2. 使用統一對話框
<StandardFormDialog<FormData>
  isOpen={isOpen}
  onOpenChange={onOpenChange}
  onSuccess={onUpdate}
  title="物料"
  formSchema={formSchema}
  sections={formSections}
  defaultValues={defaultValues}
  editData={editData}
  dataLoaderConfig={{
    loadSuppliers: true,
    loadMaterialCategories: true,
    loadMaterialSubCategories: true,
  }}
  createFunctionName="createMaterial"
  updateFunctionName="updateMaterial"
/>
```

## 🎯 智能選項生成規則

系統會根據欄位名稱自動匹配對應的資料：

| 欄位名稱模式 | 匹配資料 | 範例 |
|-------------|----------|------|
| `supplier*` 或 `*Supplier*` | 供應商資料 | `supplierId`, `mainSupplier` |
| `category` 或 `*Category` | 主分類資料 | `category`, `materialCategory` |
| `subCategory` 或 `*SubCategory` | 細分分類資料 | `subCategory`, `materialSubCategory` |
| `*person*` 或 `*user*` | 使用者資料 | `liaisonPersonId`, `userId` |

## 📂 實際應用範例

### 物料對話框 (MaterialDialog)

```tsx
// src/app/dashboard/materials/MaterialDialog.tsx
const formSections: FormSectionConfig<FormData>[] = [
  {
    title: '基本資料',
    icon: <Tag className="h-4 w-4" />,
    color: 'blue',
    fields: [
      {
        name: 'name',
        label: '物料名稱',
        type: 'text',
        required: true,
      },
      {
        name: 'category',        // 自動載入主分類
        label: '主分類',
        type: 'select',
        required: true,
      },
      {
        name: 'subCategory',     // 自動載入細分分類
        label: '細分分類',
        type: 'select',
        required: true,
      },
    ],
  },
  {
    title: '供應商資訊',
    icon: <Building className="h-4 w-4" />,
    color: 'green',
    fields: [
      {
        name: 'supplierId',      // 自動載入供應商（含"無供應商"選項）
        label: '供應商',
        type: 'select',
      },
    ],
  },
];

// 使用統一載入機制
<StandardFormDialog<FormData>
  // ... 其他屬性
  dataLoaderConfig={{
    loadSuppliers: true,
    loadMaterialCategories: true,
    loadMaterialSubCategories: true,
  }}
/>
```

### 供應商對話框 (SupplierDialog)

```tsx
// src/app/dashboard/suppliers/SupplierDialog.tsx
const formSections: FormSectionConfig<FormData>[] = [
  {
    title: '聯絡資訊',
    fields: [
      {
        name: 'liaisonPersonId',  // 自動載入使用者選項
        label: '內部對接人員',
        type: 'select',
      },
    ],
  },
];

<StandardFormDialog<FormData>
  // ... 其他屬性
  dataLoaderConfig={{
    loadUsers: true,  // 只載入需要的資料
  }}
/>
```

## 🔧 進階配置

### 自訂選項（覆蓋智能匹配）

如果需要自訂選項，可以手動設定 `selectOptions`：

```tsx
{
  name: 'unit',
  label: '單位',
  type: 'select',
  selectOptions: [
    { value: '個', label: '個' },
    { value: 'KG', label: 'KG' },
    { value: '張', label: '張' },
  ],
}
```

### 條件載入

只載入需要的資料類型以提升效能：

```tsx
dataLoaderConfig={{
  loadSuppliers: true,           // 有供應商欄位才載入
  loadMaterialCategories: true,  // 有分類欄位才載入
  loadUsers: false,              // 沒有使用者欄位，不載入
}}
```

## 🚨 遷移指南

### 從舊版對話框遷移

1. **移除手動資料載入**：
   ```tsx
   // ❌ 移除這些
   const [suppliers, setSuppliers] = useState([]);
   useEffect(() => {
     // 載入供應商邏輯
   }, []);
   ```

2. **移除手動選項設定**：
   ```tsx
   // ❌ 移除這些
   selectOptions: suppliers.map(s => ({ value: s.id, label: s.name }))
   ```

3. **添加載入配置**：
   ```tsx
   // ✅ 添加這個
   dataLoaderConfig={{
     loadSuppliers: true,
     loadMaterialCategories: true,
   }}
   ```

4. **簡化表單欄位**：
   ```tsx
   // ✅ 欄位配置變簡單
   {
     name: 'supplierId',
     label: '供應商',
     type: 'select',
     // selectOptions 自動生成
   }
   ```

## 🎉 優勢

1. **完全統一化**：所有對話框使用相同架構
2. **絕不卡住**：穩定的載入機制，不會出現無限載入
3. **智能化**：根據欄位名稱自動匹配資料
4. **高效能**：並行載入，只載入需要的資料
5. **易維護**：統一的載入邏輯，減少重複程式碼
6. **向下相容**：保留舊版 API 支援

## 🔄 擴展說明

### 添加新的資料類型

1. **在 useFormDataLoader.ts 中添加新類型**：
   ```tsx
   export interface FormDataLoaderConfig {
     // ... 現有類型
     loadNewDataType?: boolean;  // 新增
   }
   
   // 在 hook 中添加載入邏輯
   if (config.loadNewDataType) {
     // 載入邏輯
   }
   ```

2. **在智能選項生成器中添加匹配規則**：
   ```tsx
   // 在 getSmartSelectOptions 中添加
   if (fieldName.includes('newType')) {
     return formDataLoader.newDataType.map(item => ({
       value: item.id,
       label: item.name
     }));
   }
   ```

## 📝 最佳實踐

1. **欄位命名**：使用語義化的欄位名稱以利智能匹配
2. **載入配置**：只載入必要的資料類型
3. **錯誤處理**：載入失敗時會自動設為空陣列，不影響表單顯示
4. **效能考量**：大型資料集可考慮添加搜尋或分頁功能

## 🐛 故障排除

### 選項沒有顯示
- 檢查 `dataLoaderConfig` 是否設定正確
- 檢查欄位名稱是否符合智能匹配規則
- 檢查控制台是否有載入錯誤訊息

### 載入緩慢
- 檢查是否只載入需要的資料類型
- 考慮優化 Firestore 查詢或添加索引

### 選項順序不正確
- 主分類和細分分類會自動排序
- 供應商按原始順序顯示
- 如需自訂排序，可手動設定 `selectOptions`