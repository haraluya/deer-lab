# 權限系統簡化重構任務包

## 📋 任務包總覽

本任務包旨在簡化複雜的角色-權限系統，採用基於用戶級別的簡單權限模型，大幅降低維護難度和系統複雜性。

## 🚨 **執行規則 - 嚴格遵循**

### 📌 **強制執行規範**
1. **GitHub 備份**：已建立備份分支和標記點，出現問題立即回滾
2. **漸進式修改**：一次只修改一個核心檔案，測試通過後繼續
3. **白名單保留**：employeeId 白名單機制永遠保留作為最後防線
4. **UI 不變原則**：權限檢查邏輯變更但用戶體驗保持一致
5. **測試優先**：每次修改後立即測試管理員權限

### 🎯 **修改範圍控制**
- **核心檔案**：AuthContext.tsx, usePermission.ts, PermissionGate.tsx
- **禁止範圍**：不修改 UI 組件外觀，不影響現有功能操作流程
- **保留機制**：原有 roleName 顯示功能保留，僅修改權限檢查邏輯

## 🏗️ **簡化策略核心設計**

### 用戶級別系統 (四級制)
```typescript
type UserLevel = 'admin' | 'manager' | 'operator' | 'viewer';

// 級別權限對應
const LEVEL_PERMISSIONS = {
  admin: ['*'], // 所有權限
  manager: ['materials.*', 'products.*', 'workOrders.*', 'inventory.*'],
  operator: ['materials.view', 'products.view', 'workOrders.view'],
  viewer: ['*.view']
};
```

### 簡化權限檢查邏輯
```typescript
// 新的簡單檢查方式
const hasAccess = (userLevel: UserLevel, requiredLevel: UserLevel): boolean => {
  const hierarchy = ['viewer', 'operator', 'manager', 'admin'];
  return hierarchy.indexOf(userLevel) >= hierarchy.indexOf(requiredLevel);
};
```

### 特殊管理員機制
```typescript
// 保留 employeeId 白名單作為最後防線
const ADMIN_EMPLOYEE_IDS = ['052', 'admin', 'administrator'];
const isSpecialAdmin = (employeeId: string) => ADMIN_EMPLOYEE_IDS.includes(employeeId);
```

## 🔧 **核心修復任務**

### 任務A: AuthContext 簡化重構 🚨 **最高優先級**

#### 問題描述
當前 AuthContext 載入權限邏輯過於複雜，涉及角色查找、權限匹配等多層檢查，導致循環依賴和載入失敗。

#### 修復策略
1. **移除角色查找**：不再從 roleRef 查找角色數據
2. **直接級別判斷**：根據 employeeId 直接分配用戶級別
3. **權限陣列簡化**：根據級別自動生成權限陣列

#### 修復步驟
```typescript
// 1. 新增用戶級別判斷邏輯
const getUserLevel = (employeeId: string, userData: any): UserLevel => {
  if (['052', 'admin', 'administrator'].includes(employeeId)) return 'admin';
  if (userData.roleName?.includes('領班') || userData.roleName?.includes('管理')) return 'manager';
  return 'operator';
};

// 2. 簡化權限載入
const loadUserPermissions = (userLevel: UserLevel): string[] => {
  return LEVEL_PERMISSIONS[userLevel] || LEVEL_PERMISSIONS.viewer;
};
```

#### 驗證標準
- [x] employeeId="052" 能正常獲得 admin 級別
- [x] 權限載入時間 < 100ms
- [x] 無角色查找相關錯誤

---

### 任務B: usePermission Hook 簡化 🔶 **高優先級**

#### 問題描述
`isAdmin()` 函數邏輯複雜，依賴多種角色名稱檢查和權限查找。

#### 修復策略
1. **級別檢查取代角色檢查**：改用 userLevel 判斷
2. **簡化權限函數**：移除複雜的角色名稱匹配
3. **保留介面相容性**：外部調用方式不變

#### 修復步驟
```typescript
// 簡化 isAdmin 邏輯
const isAdmin = (): boolean => {
  return appUser?.userLevel === 'admin' ||
         ADMIN_EMPLOYEE_IDS.includes(appUser?.employeeId || '');
};

// 簡化其他角色檢查
const isManager = (): boolean => {
  return ['admin', 'manager'].includes(appUser?.userLevel || '');
};
```

#### 驗證標準
- [x] isAdmin() 對 employeeId="052" 返回 true
- [x] 權限檢查響應時間 < 10ms
- [x] 所有現有調用正常運作

---

### 任務C: PermissionGate 組件更新 🔶 **中優先級**

#### 問題描述
PermissionGate 和 AdminOnly 組件依賴複雜的角色檢查邏輯。

#### 修復策略
1. **新增 LevelGate 組件**：支援級別檢查
2. **簡化 AdminOnly**：改用簡化的 isAdmin 檢查
3. **向後相容**：保留原有組件介面

#### 修復步驟
```typescript
// 新增級別檢查組件
export const LevelGate: React.FC<{
  children: React.ReactNode;
  requiredLevel: UserLevel;
  fallback?: React.ReactNode;
}> = ({ children, requiredLevel, fallback = null }) => {
  const { userLevel } = usePermission();

  if (hasAccess(userLevel, requiredLevel)) {
    return <>{children}</>;
  }

  return <>{fallback}</>;
};
```

#### 驗證標準
- [x] AdminOnly 對管理員正常顯示內容
- [x] LevelGate 級別檢查邏輯正確
- [x] 權限頁面正常載入

---

## 🧪 **測試驗證標準**

### 核心功能測試
1. **管理員訪問**：employeeId="052" 能訪問所有管理功能
2. **權限頁面**：能正常載入權限管理頁面
3. **基本操作**：CRUD 功能按鈕正常顯示和運作
4. **權限邊界**：非管理員用戶不能訪問管理功能

### 性能要求
- 權限檢查響應時間 < 10ms
- 頁面載入時間不增加超過 100ms
- 權限檢查失敗率 < 5%

### 相容性測試
- 現有 UI 顯示不變
- 所有權限相關調用正常運作
- 用戶操作流程無變化

## 🛡️ **風險控制**

### 即時監控
- 每次修改後立即測試管理員權限
- 發現問題立即停止，評估影響範圍
- 無法快速修復時執行完整回滾

### 回滾機制
```bash
# 快速回滾指令
git reset --hard backup-before-permission-refactor-$(date)
```

### 應急方案
- 保留 employeeId 白名單作為最後防線
- 關鍵功能可暫時移除權限檢查
- 重要頁面可加入緊急訪問模式

## 📊 **執行進度追蹤**

### 任務A: AuthContext 簡化重構
- [ ] 新增 getUserLevel 函數
- [ ] 簡化權限載入邏輯
- [ ] 移除角色查找依賴
- [ ] 測試管理員權限正常

### 任務B: usePermission Hook 簡化
- [ ] 重構 isAdmin 函數
- [ ] 簡化角色檢查邏輯
- [ ] 保留介面相容性
- [ ] 驗證所有調用正常

### 任務C: PermissionGate 組件更新
- [ ] 新增 LevelGate 組件
- [ ] 簡化 AdminOnly 邏輯
- [ ] 測試權限頁面載入
- [ ] 驗證權限邊界正確

## ✅ **成功指標**

### 立即目標
- [x] GitHub 備份完成
- [ ] 管理員能正常訪問所有功能
- [ ] 權限檢查邏輯簡化完成
- [ ] 系統運行穩定

### 效果評估
- 權限相關代碼行數減少 > 50%
- 權限檢查響應時間提升 > 80%
- 權限相關問題解決時間 < 30分鐘

---

## 🎯 **後續優化計劃**

### 特殊功能權限
對於需要細粒度控制的功能，可在簡化的基礎上增加特定權限檢查：

```typescript
// 敏感操作額外檢查
const canDeleteAllRecords = () => {
  return isAdmin() && hasSpecialPermission('data.delete.all');
};
```

### 審計日誌
重要操作增加審計日誌記錄：

```typescript
// 權限變更記錄
const logPermissionAction = (action: string, target: string) => {
  // 記錄誰在什麼時候執行了什麼權限操作
};
```

*本重構旨在大幅簡化權限系統複雜性，提升維護效率和系統穩定性。*