# éƒ¨ç½²æ•…éšœæ’é™¤æŒ‡å—

## ğŸ“‹ ç›®éŒ„
- [å¸¸è¦‹ 500 éŒ¯èª¤](#å¸¸è¦‹-500-éŒ¯èª¤)
- [éƒ¨ç½²æª¢æŸ¥æ¸…å–®](#éƒ¨ç½²æª¢æŸ¥æ¸…å–®)
- [æ•…éšœæ¡ˆä¾‹è¨˜éŒ„](#æ•…éšœæ¡ˆä¾‹è¨˜éŒ„)

---

## ğŸš¨ å¸¸è¦‹ 500 éŒ¯èª¤

### 1. ç¼ºå°‘ prerender-manifest.json

#### ç—‡ç‹€
```
Next.js app preparation failed: Error: ENOENT: no such file or directory,
open '/workspace/.next/prerender-manifest.json'
```

#### åŸå› 
- Next.js 14 åœ¨æŸäº›é…ç½®ä¸‹ï¼ˆç‰¹åˆ¥æ˜¯æœ‰ç·¨è­¯éŒ¯èª¤æ™‚ï¼‰ä¸æœƒç”Ÿæˆ `prerender-manifest.json`
- å»ºæ§‹éç¨‹ä¸­çš„ `useContext` éŒ¯èª¤å¯èƒ½å°è‡´æª”æ¡ˆç”Ÿæˆä¸å®Œæ•´

#### è§£æ±ºæ–¹æ¡ˆ
```powershell
# æ‰‹å‹•å‰µå»º prerender-manifest.jsonï¼ˆæ³¨æ„ï¼šå¿…é ˆç„¡ BOMï¼‰
[System.IO.File]::WriteAllText(
  '.next\prerender-manifest.json',
  '{"version":4,"routes":{},"dynamicRoutes":{},"preview":{"previewModeId":""}}',
  [System.Text.UTF8Encoding]::new($false)
)
```

#### é é˜²æªæ–½
- åœ¨ `npm run build` å¾Œæª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨ï¼š
  ```powershell
  Test-Path '.next\prerender-manifest.json'
  ```
- å¦‚æœä¸å­˜åœ¨ï¼ŒåŸ·è¡Œä¸Šè¿°å‰µå»ºå‘½ä»¤

---

### 2. JSON æª”æ¡ˆ BOM å­—å…ƒå•é¡Œ

#### ç—‡ç‹€
```
Next.js app preparation failed: SyntaxError: Unexpected token 'ï»¿',
"ï»¿{"version"... is not valid JSON
```

#### åŸå› 
- ä½¿ç”¨ PowerShell `Out-File` å‰µå»ºçš„æª”æ¡ˆé è¨­åŒ…å« UTF-8 BOM
- Node.js çš„ JSON.parse() ç„¡æ³•è§£æå¸¶ BOM çš„ JSON

#### è§£æ±ºæ–¹æ¡ˆ
```powershell
# âŒ éŒ¯èª¤æ–¹å¼ï¼ˆæœƒç”¢ç”Ÿ BOMï¼‰
'{"version":4}' | Out-File -FilePath file.json -Encoding utf8

# âœ… æ­£ç¢ºæ–¹å¼ï¼ˆç„¡ BOMï¼‰
[System.IO.File]::WriteAllText('file.json', '{"version":4}', [System.Text.UTF8Encoding]::new($false))
```

---

### 3. æª”æ¡ˆè¤‡è£½ä¸å®Œæ•´

#### ç—‡ç‹€
- éƒ¨ç½²æˆåŠŸä½†é é¢ç„¡æ³•è¼‰å…¥
- æª”æ¡ˆæ•¸é‡ä¸ä¸€è‡´

#### æª¢æŸ¥æ–¹æ³•
```powershell
# æ¯”è¼ƒæª”æ¡ˆæ•¸é‡
$sourceCount = (Get-ChildItem -Path '.next' -Recurse -File).Count
$destCount = (Get-ChildItem -Path 'functions\.next' -Recurse -File).Count
Write-Host "Source: $sourceCount, Destination: $destCount"
```

#### è§£æ±ºæ–¹æ¡ˆ
```powershell
# å®Œæ•´è¤‡è£½ï¼ˆæ¨è–¦ï¼‰
Remove-Item -Path 'functions\.next' -Recurse -Force
Copy-Item -Path '.next' -Destination 'functions\.next' -Recurse -Force
Remove-Item -Path 'functions\.next\cache' -Recurse -Force -ErrorAction SilentlyContinue
```

---

## âœ… éƒ¨ç½²æª¢æŸ¥æ¸…å–®

### å»ºæ§‹å‰æª¢æŸ¥
- [ ] ç¢ºèªæ‰€æœ‰ TypeScript éŒ¯èª¤å·²ä¿®å¾©
- [ ] åŸ·è¡Œ `npm run lint` æª¢æŸ¥ç¨‹å¼ç¢¼å“è³ª
- [ ] æ¸…ç†èˆŠçš„ `.next` ç›®éŒ„

### å»ºæ§‹éšæ®µ
```powershell
# 1. æ¸…ç†èˆŠæª”æ¡ˆ
Remove-Item -Path '.next' -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item -Path 'functions\.next' -Recurse -Force -ErrorAction SilentlyContinue

# 2. åŸ·è¡Œå»ºæ§‹
npm run build

# 3. æª¢æŸ¥é—œéµæª”æ¡ˆ
$requiredFiles = @(
  '.next\prerender-manifest.json',
  '.next\BUILD_ID',
  '.next\server',
  '.next\static'
)

foreach ($file in $requiredFiles) {
  if (!(Test-Path $file)) {
    Write-Host "âŒ ç¼ºå°‘: $file" -ForegroundColor Red
  } else {
    Write-Host "âœ… å­˜åœ¨: $file" -ForegroundColor Green
  }
}
```

### è¤‡è£½éšæ®µ
```powershell
# 4. å‰µå»º prerender-manifest.jsonï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
if (!(Test-Path '.next\prerender-manifest.json')) {
  Write-Host "å‰µå»º prerender-manifest.json..." -ForegroundColor Yellow
  [System.IO.File]::WriteAllText(
    '.next\prerender-manifest.json',
    '{"version":4,"routes":{},"dynamicRoutes":{},"preview":{"previewModeId":""}}',
    [System.Text.UTF8Encoding]::new($false)
  )
}

# 5. è¤‡è£½åˆ° functions
Copy-Item -Path '.next' -Destination 'functions\.next' -Recurse -Force

# 6. æ¸…ç†å¿«å–
Remove-Item -Path 'functions\.next\cache' -Recurse -Force -ErrorAction SilentlyContinue

# 7. é©—è­‰è¤‡è£½çµæœ
$sourceCount = (Get-ChildItem -Path '.next' -Recurse -File | Where-Object { $_.FullName -notlike '*\cache\*' }).Count
$destCount = (Get-ChildItem -Path 'functions\.next' -Recurse -File).Count
Write-Host "æª”æ¡ˆæ•¸é‡ - ä¾†æº: $sourceCount, ç›®æ¨™: $destCount"
```

### éƒ¨ç½²éšæ®µ
```powershell
# 8. éƒ¨ç½²
firebase deploy --only functions:nextServer

# 9. ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ
Start-Sleep -Seconds 30

# 10. æª¢æŸ¥æ—¥èªŒ
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=nextserver AND severity>=ERROR AND timestamp>\"$(Get-Date -Format 'yyyy-MM-ddTHH:mm:ssZ')\"" --limit=5 --format=json --project=deer-lab
```

---

## ğŸ“ æ•…éšœæ¡ˆä¾‹è¨˜éŒ„

### Case 1: 2025-11-18 æ¡è³¼å–®æ•¸é‡é©—è­‰å„ªåŒ–éƒ¨ç½²å¤±æ•—

#### æ™‚é–“ç·š
- **14:06** - ç¬¬ä¸€æ¬¡éƒ¨ç½²å®Œæˆ
- **14:31** - ç”¨æˆ¶å›å ± 500 éŒ¯èª¤
- **14:38** - ç™¼ç¾ç¼ºå°‘ `prerender-manifest.json`
- **14:42** - å‰µå»ºæª”æ¡ˆä½†åŒ…å« BOM
- **14:59** - ç™¼ç¾ BOM å•é¡Œ
- **15:03** - ä¿®å¾© BOM ä¸¦é‡æ–°éƒ¨ç½²æˆåŠŸ

#### å•é¡Œ
1. Next.js build å›  `useContext` éŒ¯èª¤å°è‡´ `prerender-manifest.json` æœªç”Ÿæˆ
2. æ‰‹å‹•å‰µå»ºçš„ JSON æª”æ¡ˆåŒ…å« UTF-8 BOM å­—å…ƒ

#### éŒ¯èª¤è¨Šæ¯
```
// å•é¡Œ 1
Next.js app preparation failed: Error: ENOENT: no such file or directory,
open '/workspace/.next/prerender-manifest.json'

// å•é¡Œ 2
Next.js app preparation failed: SyntaxError: Unexpected token 'ï»¿',
"ï»¿{"version"... is not valid JSON
```

#### è§£æ±ºæ–¹æ¡ˆ
```powershell
# ä½¿ç”¨æ­£ç¢ºçš„æ–¹æ³•å‰µå»ºç„¡ BOM çš„ JSON æª”æ¡ˆ
[System.IO.File]::WriteAllText(
  '.next\prerender-manifest.json',
  '{"version":4,"routes":{},"dynamicRoutes":{},"preview":{"previewModeId":""}}',
  [System.Text.UTF8Encoding]::new($false)
)
```

#### ç¶“é©—æ•™è¨“
1. **å»ºæ§‹éŒ¯èª¤ä¸èƒ½å¿½è¦–**ï¼šå³ä½¿ build é¡¯ç¤ºæˆåŠŸï¼Œä»éœ€æª¢æŸ¥é—œéµæª”æ¡ˆ
2. **æª”æ¡ˆç·¨ç¢¼å¾ˆé‡è¦**ï¼šWindows PowerShell çš„é è¨­è¡Œç‚ºå¯èƒ½ç”¢ç”Ÿä¸ç›¸å®¹çš„æª”æ¡ˆ
3. **éƒ¨ç½²å‰é©—è­‰**ï¼šå¢åŠ æª”æ¡ˆå®Œæ•´æ€§æª¢æŸ¥æ­¥é©Ÿ
4. **ç›£æ§æ—¥èªŒ**ï¼šéƒ¨ç½²å¾Œç«‹å³æª¢æŸ¥ Cloud Run æ—¥èªŒ

#### é é˜²æªæ–½
- åœ¨ CLAUDE.md ä¸­åŠ å…¥éƒ¨ç½²æª¢æŸ¥æ¸…å–®
- å‰µå»ºè‡ªå‹•åŒ–éƒ¨ç½²è…³æœ¬è™•ç†ç‰¹æ®Šæƒ…æ³
- å»ºæ§‹å¾Œè‡ªå‹•æª¢æŸ¥ `prerender-manifest.json`

---

## ğŸ› ï¸ å¿«é€Ÿä¿®å¾©è…³æœ¬

å‰µå»º `scripts\safe-deploy.ps1`ï¼š

```powershell
# å®‰å…¨éƒ¨ç½²è…³æœ¬
Write-Host "ğŸš€ é–‹å§‹å®‰å…¨éƒ¨ç½²æµç¨‹..." -ForegroundColor Cyan

# 1. æ¸…ç†
Write-Host "1ï¸âƒ£ æ¸…ç†èˆŠæª”æ¡ˆ..." -ForegroundColor Yellow
Remove-Item -Path '.next' -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item -Path 'functions\.next' -Recurse -Force -ErrorAction SilentlyContinue

# 2. å»ºæ§‹
Write-Host "2ï¸âƒ£ åŸ·è¡Œå»ºæ§‹..." -ForegroundColor Yellow
npm run build
if ($LASTEXITCODE -ne 0) {
  Write-Host "âŒ å»ºæ§‹å¤±æ•—" -ForegroundColor Red
  exit 1
}

# 3. æª¢æŸ¥é—œéµæª”æ¡ˆ
Write-Host "3ï¸âƒ£ æª¢æŸ¥é—œéµæª”æ¡ˆ..." -ForegroundColor Yellow
if (!(Test-Path '.next\prerender-manifest.json')) {
  Write-Host "âš ï¸  ç¼ºå°‘ prerender-manifest.jsonï¼Œè‡ªå‹•å‰µå»º..." -ForegroundColor Yellow
  [System.IO.File]::WriteAllText(
    '.next\prerender-manifest.json',
    '{"version":4,"routes":{},"dynamicRoutes":{},"preview":{"previewModeId":""}}',
    [System.Text.UTF8Encoding]::new($false)
  )
}

# 4. è¤‡è£½æª”æ¡ˆ
Write-Host "4ï¸âƒ£ è¤‡è£½æª”æ¡ˆåˆ° functions..." -ForegroundColor Yellow
Copy-Item -Path '.next' -Destination 'functions\.next' -Recurse -Force
Remove-Item -Path 'functions\.next\cache' -Recurse -Force -ErrorAction SilentlyContinue

# 5. é©—è­‰
Write-Host "5ï¸âƒ£ é©—è­‰æª”æ¡ˆå®Œæ•´æ€§..." -ForegroundColor Yellow
$sourceCount = (Get-ChildItem -Path '.next' -Recurse -File | Where-Object { $_.FullName -notlike '*\cache\*' }).Count
$destCount = (Get-ChildItem -Path 'functions\.next' -Recurse -File).Count
Write-Host "   ä¾†æº: $sourceCount å€‹æª”æ¡ˆ" -ForegroundColor Cyan
Write-Host "   ç›®æ¨™: $destCount å€‹æª”æ¡ˆ" -ForegroundColor Cyan

# 6. éƒ¨ç½²
Write-Host "6ï¸âƒ£ éƒ¨ç½²åˆ° Firebase..." -ForegroundColor Yellow
firebase deploy --only functions:nextServer

if ($LASTEXITCODE -eq 0) {
  Write-Host "âœ… éƒ¨ç½²æˆåŠŸï¼" -ForegroundColor Green
  Write-Host "â³ ç­‰å¾… 30 ç§’è®“éƒ¨ç½²ç”Ÿæ•ˆ..." -ForegroundColor Cyan
  Start-Sleep -Seconds 30
  Write-Host "ğŸ‰ éƒ¨ç½²å®Œæˆï¼" -ForegroundColor Green
} else {
  Write-Host "âŒ éƒ¨ç½²å¤±æ•—" -ForegroundColor Red
  exit 1
}
```

ä½¿ç”¨æ–¹å¼ï¼š
```powershell
.\scripts\safe-deploy.ps1
```

---

## ğŸ” è¨ºæ–·å·¥å…·

### æª¢æŸ¥ç·šä¸ŠéŒ¯èª¤
```powershell
# æŸ¥çœ‹æœ€è¿‘çš„éŒ¯èª¤æ—¥èªŒ
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=nextserver AND severity>=ERROR" --limit=10 --format=json --project=deer-lab
```

### æª¢æŸ¥éƒ¨ç½²ç‹€æ…‹
```powershell
# æŸ¥çœ‹ç•¶å‰é‹è¡Œçš„ç‰ˆæœ¬
gcloud run revisions list --service=nextserver --region=us-central1 --project=deer-lab
```

### æ¸¬è©¦ Function URL
```powershell
# æ¸¬è©¦å¥åº·æª¢æŸ¥
curl https://nextserver-r5xqvv67jq-uc.a.run.app/
```

---

## ğŸ“ ç·Šæ€¥è™•ç†æµç¨‹

å¦‚æœç·šä¸Šå‡ºç¾ 500 éŒ¯èª¤ï¼š

1. **ç«‹å³æª¢æŸ¥æ—¥èªŒ**
   ```bash
   gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=nextserver AND severity>=ERROR" --limit=5 --format=json --project=deer-lab
   ```

2. **è­˜åˆ¥éŒ¯èª¤é¡å‹**
   - ç¼ºå°‘æª”æ¡ˆ â†’ è£œå……æª”æ¡ˆä¸¦é‡æ–°éƒ¨ç½²
   - JSON è§£æéŒ¯èª¤ â†’ æª¢æŸ¥æª”æ¡ˆç·¨ç¢¼
   - å…¶ä»–éŒ¯èª¤ â†’ æŸ¥çœ‹å®Œæ•´å †ç–Šè¿½è¹¤

3. **å›æ»¾åˆ°ä¸Šä¸€ç‰ˆæœ¬**ï¼ˆå¦‚æœéœ€è¦ï¼‰
   ```bash
   # æŸ¥çœ‹ç‰ˆæœ¬
   gcloud run revisions list --service=nextserver --region=us-central1 --project=deer-lab

   # å›æ»¾åˆ°ç‰¹å®šç‰ˆæœ¬
   gcloud run services update-traffic nextserver --to-revisions=REVISION_NAME=100 --region=us-central1 --project=deer-lab
   ```

4. **ä¿®å¾©ä¸¦é‡æ–°éƒ¨ç½²**
   ä½¿ç”¨ `safe-deploy.ps1` è…³æœ¬ç¢ºä¿æª”æ¡ˆå®Œæ•´æ€§

---

## ğŸ“š åƒè€ƒè³‡æ–™

- [Next.js éƒ¨ç½²æ–‡æª”](https://nextjs.org/docs/deployment)
- [Firebase Functions æ–‡æª”](https://firebase.google.com/docs/functions)
- [Cloud Run æ•…éšœæ’é™¤](https://cloud.google.com/run/docs/troubleshooting)
- [UTF-8 BOM å•é¡Œ](https://stackoverflow.com/questions/2223882/whats-the-difference-between-utf-8-and-utf-8-without-bom)

---

**æœ€å¾Œæ›´æ–°**: 2025-11-18
**ç¶­è­·è€…**: Claude Code
**ç›¸é—œæ–‡æª”**: [CLAUDE.md](../CLAUDE.md), [Firebaseæˆæœ¬å„ªåŒ–.md](./Firebaseæˆæœ¬å„ªåŒ–.md)
