# å¾·ç§‘æ–¯ç‰¹çš„å¯¦é©—å®¤ - å¤šç§Ÿæˆ¶ç³»çµ±æ”¹é€ è¨ˆåŠƒ

> **ç‰ˆæœ¬**: 1.0
> **å»ºç«‹æ—¥æœŸ**: 2025-09-16
> **ç›®çš„**: å°‡ç¾æœ‰ç”Ÿç”¢ç®¡ç†ç³»çµ±æ”¹é€ ç‚ºæ”¯æ´å¤šç§Ÿæˆ¶çš„ SaaS å¹³å°

---

## ğŸ“‹ ç›®éŒ„
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ–¹æ¡ˆåˆ†æ](#æ–¹æ¡ˆåˆ†æ)
3. [ç³»çµ±æ¶æ§‹è¨­è¨ˆ](#ç³»çµ±æ¶æ§‹è¨­è¨ˆ)
4. [å¯¦æ–½è¨ˆåŠƒ](#å¯¦æ–½è¨ˆåŠƒ)
5. [è³‡æ–™åº«åŒ¯å…¥åŒ¯å‡ºç³»çµ±](#è³‡æ–™åº«åŒ¯å…¥åŒ¯å‡ºç³»çµ±)
6. [æ½›åœ¨å›°é›£èˆ‡è§£æ±ºæ–¹æ¡ˆ](#æ½›åœ¨å›°é›£èˆ‡è§£æ±ºæ–¹æ¡ˆ)
7. [æˆæœ¬æ•ˆç›Šåˆ†æ](#æˆæœ¬æ•ˆç›Šåˆ†æ)

---

## ğŸ¯ æ¦‚è¿°

### ç•¶å‰ç³»çµ±ç¾ç‹€
ã€Œå¾·ç§‘æ–¯ç‰¹çš„å¯¦é©—å®¤ã€æ˜¯ä¸€å€‹åŸºæ–¼ Next.js + Firebase çš„å®Œæ•´ç”Ÿç”¢ç®¡ç†ç³»çµ±ï¼ŒåŒ…å«ï¼š

- **66å€‹ API ç«¯é»**ï¼ˆ33å€‹ä½¿ç”¨ä¸­ + 33å€‹å¯æ“´å±•ï¼‰
- **æ ¸å¿ƒæ¨¡çµ„**: ç‰©æ–™ã€é¦™ç²¾ã€åº«å­˜ã€å·¥å–®ã€æ¡è³¼ã€äººå“¡ç®¡ç†
- **çµ±ä¸€æ¶æ§‹**: StandardDataListPageã€StandardFormDialogã€çµ±ä¸€ API å®¢æˆ¶ç«¯
- **éƒ¨ç½²æ–¹å¼**: Firebase Functions é‹è¡Œ Next.js server

### æ”¹é€ ç›®æ¨™
å°‡ç³»çµ±æ”¹é€ ç‚ºæ”¯æ´å¤šç§Ÿæˆ¶çš„ SaaS å¹³å°ï¼Œå¯¦ç¾ï¼š
- âœ… ç¨‹å¼ç¢¼å…±ç”¨ï¼Œè³‡æ–™åº«ç¨ç«‹
- âœ… è‡ªå‹•åŠŸèƒ½æ›´æ–°åŒæ­¥
- âœ… æ–°ç§Ÿæˆ¶å¿«é€Ÿéƒ¨ç½²
- âœ… çµ±ä¸€ç¶­è­·ç®¡ç†

---

## ğŸ“Š æ–¹æ¡ˆåˆ†æ

### æ–¹æ¡ˆä¸€ï¼šå¤šç§Ÿæˆ¶æ¶æ§‹ï¼ˆæ¨è–¦ â­ï¸ï¼‰

#### æ¶æ§‹ç‰¹é»
- **ç¨‹å¼ç¢¼å±¤**: å–®ä¸€ç¨‹å¼ç¢¼åº«ï¼Œçµ±ä¸€éƒ¨ç½²
- **è³‡æ–™å±¤**: æ¯å€‹ç§Ÿæˆ¶ç¨ç«‹çš„ Firebase å°ˆæ¡ˆ
- **è­˜åˆ¥æ©Ÿåˆ¶**: åŸºæ–¼åŸŸåæˆ–è·¯å¾‘çš„ç§Ÿæˆ¶è­˜åˆ¥
- **é…ç½®ç®¡ç†**: å‹•æ…‹ Firebase é…ç½®åˆ‡æ›

#### å„ªå‹¢åˆ†æ
| å„ªå‹¢é …ç›® | è©³ç´°èªªæ˜ | æ•ˆç›Šè©•ä¼° |
|---------|----------|----------|
| ç¶­è­·æˆæœ¬ä½ | ä¸€å¥—ç¨‹å¼ç¢¼æœå‹™æ‰€æœ‰å®¢æˆ¶ | é™ä½ 80% ç¶­è­·æˆæœ¬ |
| è‡ªå‹•æ›´æ–° | åŠŸèƒ½æ›´æ–°è‡ªå‹•åŒæ­¥åˆ°æ‰€æœ‰ç§Ÿæˆ¶ | æå‡ 90% æ›´æ–°æ•ˆç‡ |
| å¿«é€Ÿéƒ¨ç½² | æ–°ç§Ÿæˆ¶ 30 åˆ†é˜å…§å®Œæˆç’°å¢ƒå»ºç«‹ | æ¸›å°‘ 95% è¨­ç½®æ™‚é–“ |
| ç‰ˆæœ¬ä¸€è‡´æ€§ | é¿å…ç‰ˆæœ¬åˆ†æ­§å•é¡Œ | é™ä½ 100% ç‰ˆæœ¬ç®¡ç†è¤‡é›œåº¦ |

### æ–¹æ¡ˆäºŒï¼šå®Œå…¨ç¨ç«‹éƒ¨ç½²

#### æ¶æ§‹ç‰¹é»
- **ç¨‹å¼ç¢¼å±¤**: æ¯å€‹å®¢æˆ¶ç¨ç«‹çš„ç¨‹å¼ç¢¼åº«
- **éƒ¨ç½²æ–¹å¼**: å®Œå…¨ç¨ç«‹çš„ Firebase å°ˆæ¡ˆ
- **å®¢è£½åŒ–**: å¯é‡å°å€‹åˆ¥éœ€æ±‚ä¿®æ”¹

#### åŠ£å‹¢åˆ†æ
- âŒ **ç¶­è­·æˆæœ¬æ¥µé«˜**: éœ€ç¶­è­·å¤šå¥—ç¨‹å¼ç¢¼åˆ†æ”¯
- âŒ **æ›´æ–°å›°é›£**: æ¯æ¬¡æ›´æ–°éœ€æ‰‹å‹•éƒ¨ç½²åˆ°æ‰€æœ‰ç’°å¢ƒ
- âŒ **ç‰ˆæœ¬åˆ†æ­§é¢¨éšª**: å®¹æ˜“ç”¢ç”Ÿä¸åŒç‰ˆæœ¬çš„ç³»çµ±
- âŒ **æŠ€è¡“å‚µå‹™**: éš¨æ™‚é–“ç´¯ç©å¤§é‡æŠ€è¡“å‚µå‹™

### çµè«–
**å¼·çƒˆæ¨è–¦æ¡ç”¨æ–¹æ¡ˆä¸€ï¼ˆå¤šç§Ÿæˆ¶æ¶æ§‹ï¼‰**ï¼Œå…·å‚™æœ€ä½³çš„æˆæœ¬æ•ˆç›Šæ¯”å’Œé•·æœŸå¯ç¶­è­·æ€§ã€‚

---

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹è¨­è¨ˆ

### 1. ç§Ÿæˆ¶è­˜åˆ¥ç³»çµ±

#### 1.1 ç§Ÿæˆ¶é…ç½®çµæ§‹
```typescript
interface TenantConfig {
  tenantId: string;                    // ç§Ÿæˆ¶å”¯ä¸€è­˜åˆ¥ç¢¼
  tenantName: string;                  // ç§Ÿæˆ¶åç¨±
  domain?: string;                     // è‡ªå®šç¾©åŸŸå
  firebaseConfig: {
    apiKey: string;
    authDomain: string;
    projectId: string;
    storageBucket: string;
    messagingSenderId: string;
    appId: string;
  };
  features: {
    enabledModules: string[];          // å•Ÿç”¨çš„æ¨¡çµ„åˆ—è¡¨
    customSettings: Record<string, any>; // å®¢è£½åŒ–è¨­å®š
    limitations: {
      maxUsers: number;                // ä½¿ç”¨è€…ä¸Šé™
      maxProducts: number;             // ç”¢å“ä¸Šé™
      storageQuota: number;            // å„²å­˜é…é¡
    };
  };
  billing: {
    planType: 'basic' | 'pro' | 'enterprise';
    expiryDate: string;
    isActive: boolean;
  };
  createdAt: string;
  updatedAt: string;
}
```

#### 1.2 ç§Ÿæˆ¶è­˜åˆ¥æ–¹å¼

**æ–¹å¼ä¸€ï¼šå­åŸŸåè­˜åˆ¥ï¼ˆæ¨è–¦ï¼‰**
```
https://company-a.deer-lab.app -> ç§Ÿæˆ¶ A
https://company-b.deer-lab.app -> ç§Ÿæˆ¶ B
```

**æ–¹å¼äºŒï¼šè·¯å¾‘è­˜åˆ¥**
```
https://deer-lab.app/tenant/company-a -> ç§Ÿæˆ¶ A
https://deer-lab.app/tenant/company-b -> ç§Ÿæˆ¶ B
```

**æ–¹å¼ä¸‰ï¼šæŸ¥è©¢åƒæ•¸è­˜åˆ¥**
```
https://deer-lab.app?tenant=company-a -> ç§Ÿæˆ¶ A
```

### 2. å‹•æ…‹ Firebase é…ç½®ç³»çµ±

#### 2.1 é…ç½®ç®¡ç†æœå‹™
```typescript
// src/services/TenantConfigService.ts
class TenantConfigService {
  private configCache: Map<string, TenantConfig> = new Map();

  /**
   * æ ¹æ“šç§Ÿæˆ¶ ID ç²å–é…ç½®
   */
  async getTenantConfig(tenantId: string): Promise<TenantConfig | null> {
    // å„ªå…ˆå¾å¿«å–ç²å–
    if (this.configCache.has(tenantId)) {
      return this.configCache.get(tenantId)!;
    }

    // å¾ä¸­å¤®é…ç½®è³‡æ–™åº«è¼‰å…¥
    const config = await this.loadConfigFromDatabase(tenantId);
    if (config) {
      this.configCache.set(tenantId, config);
    }

    return config;
  }

  /**
   * åˆå§‹åŒ–ç§Ÿæˆ¶çš„ Firebase å¯¦ä¾‹
   */
  async initializeTenantFirebase(tenantId: string) {
    const config = await this.getTenantConfig(tenantId);
    if (!config) {
      throw new Error(`Tenant ${tenantId} not found`);
    }

    // åˆå§‹åŒ– Firebase å¯¦ä¾‹
    return initializeApp(config.firebaseConfig, tenantId);
  }
}
```

#### 2.2 Firebase åˆå§‹åŒ–æ”¹é€ 
```typescript
// src/lib/firebase-multi-tenant.ts
import { initializeApp, getApps, getApp } from 'firebase/app';
import { getAuth } from 'firebase/auth';
import { getFirestore } from 'firebase/firestore';
import { getFunctions } from 'firebase/functions';

class MultiTenantFirebase {
  private tenantInstances: Map<string, any> = new Map();

  /**
   * ç²å–ç§Ÿæˆ¶å°ˆç”¨çš„ Firebase å¯¦ä¾‹
   */
  async getTenantFirebaseInstance(tenantId: string) {
    // æª¢æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
    if (this.tenantInstances.has(tenantId)) {
      return this.tenantInstances.get(tenantId);
    }

    // ç²å–ç§Ÿæˆ¶é…ç½®
    const config = await tenantConfigService.getTenantConfig(tenantId);
    if (!config) {
      throw new Error(`Tenant ${tenantId} not found`);
    }

    // åˆå§‹åŒ– Firebase å¯¦ä¾‹
    const app = initializeApp(config.firebaseConfig, tenantId);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app, 'us-central1');

    const instance = { app, auth, db, functions };
    this.tenantInstances.set(tenantId, instance);

    return instance;
  }

  /**
   * æ¸…ç†ç§Ÿæˆ¶å¯¦ä¾‹ï¼ˆç”¨æ–¼ç§Ÿæˆ¶åˆ‡æ›ï¼‰
   */
  clearTenantInstance(tenantId: string) {
    this.tenantInstances.delete(tenantId);
  }
}

export const multiTenantFirebase = new MultiTenantFirebase();
```

### 3. ä¸­é–“ä»¶ç³»çµ±

#### 3.1 ç§Ÿæˆ¶è­˜åˆ¥ä¸­é–“ä»¶
```typescript
// functions/src/middleware/tenant-auth.ts
export async function tenantAuthMiddleware(req: any, res: any, next: any) {
  try {
    // å¾è«‹æ±‚ä¸­æå–ç§Ÿæˆ¶ä¿¡æ¯
    const tenantId = extractTenantId(req);
    if (!tenantId) {
      return res.status(400).json({ error: 'Tenant ID is required' });
    }

    // é©—è­‰ç§Ÿæˆ¶æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
    const tenantConfig = await tenantConfigService.getTenantConfig(tenantId);
    if (!tenantConfig || !tenantConfig.billing.isActive) {
      return res.status(403).json({ error: 'Invalid or inactive tenant' });
    }

    // å°‡ç§Ÿæˆ¶ä¿¡æ¯é™„åŠ åˆ°è«‹æ±‚å°è±¡
    req.tenant = {
      id: tenantId,
      config: tenantConfig
    };

    // åˆå§‹åŒ–ç§Ÿæˆ¶å°ˆç”¨çš„ Firebase å¯¦ä¾‹
    req.tenantFirebase = await multiTenantFirebase.getTenantFirebaseInstance(tenantId);

    next();
  } catch (error) {
    console.error('Tenant auth middleware error:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
}

/**
 * å¾è«‹æ±‚ä¸­æå–ç§Ÿæˆ¶ ID
 */
function extractTenantId(req: any): string | null {
  // æ–¹å¼ä¸€ï¼šå¾å­åŸŸåæå–
  const host = req.get('host');
  if (host) {
    const subdomain = host.split('.')[0];
    if (subdomain !== 'www' && subdomain !== 'deer-lab') {
      return subdomain;
    }
  }

  // æ–¹å¼äºŒï¼šå¾è·¯å¾‘æå–
  const pathMatch = req.path.match(/^\/tenant\/([^\/]+)/);
  if (pathMatch) {
    return pathMatch[1];
  }

  // æ–¹å¼ä¸‰ï¼šå¾æŸ¥è©¢åƒæ•¸æå–
  return req.query.tenant || null;
}
```

### 4. API æ”¹é€ 

#### 4.1 çµ±ä¸€ API åŒ…è£å™¨æ›´æ–°
```typescript
// functions/src/utils/apiWrapper.ts
export function createTenantAwareAPI(handler: Function) {
  return async (req: any, res: any) => {
    try {
      // æ‡‰ç”¨ç§Ÿæˆ¶èªè­‰ä¸­é–“ä»¶
      await tenantAuthMiddleware(req, res, async () => {
        // ç¢ºä¿æ‰€æœ‰è³‡æ–™åº«æ“ä½œä½¿ç”¨ç§Ÿæˆ¶å°ˆç”¨å¯¦ä¾‹
        const result = await handler(req, res, req.tenantFirebase);

        // çµ±ä¸€å›æ‡‰æ ¼å¼
        res.json({
          success: true,
          data: result,
          tenant: req.tenant.id,
          timestamp: new Date().toISOString()
        });
      });
    } catch (error) {
      console.error(`API Error for tenant ${req.tenant?.id}:`, error);
      res.status(500).json({
        success: false,
        error: error.message,
        tenant: req.tenant?.id,
        timestamp: new Date().toISOString()
      });
    }
  };
}
```

---

## ğŸ“… å¯¦æ–½è¨ˆåŠƒ

### éšæ®µä¸€ï¼šåŸºç¤æ¶æ§‹å»ºè¨­ï¼ˆ2-3é€±ï¼‰

#### Week 1: ç§Ÿæˆ¶ç®¡ç†ç³»çµ±
- [ ] **Day 1-2**: è¨­è¨ˆç§Ÿæˆ¶é…ç½®è³‡æ–™æ¨¡å‹
- [ ] **Day 3-4**: å»ºç«‹ç§Ÿæˆ¶é…ç½®æœå‹™ (`TenantConfigService`)
- [ ] **Day 5-7**: å¯¦ä½œç§Ÿæˆ¶è­˜åˆ¥ä¸­é–“ä»¶

#### Week 2: Firebase å¤šç§Ÿæˆ¶æ”¯æ´
- [ ] **Day 1-3**: æ”¹é€  Firebase åˆå§‹åŒ–é‚è¼¯
- [ ] **Day 4-5**: å»ºç«‹ `MultiTenantFirebase` æœå‹™
- [ ] **Day 6-7**: æ›´æ–°æ‰€æœ‰ Firebase å¯¦ä¾‹èª¿ç”¨

#### Week 3: API ç³»çµ±æ”¹é€ 
- [ ] **Day 1-3**: æ›´æ–° API åŒ…è£å™¨æ”¯æ´å¤šç§Ÿæˆ¶
- [ ] **Day 4-5**: æ”¹é€ æ ¸å¿ƒ API ç«¯é»
- [ ] **Day 6-7**: å¯¦ä½œç§Ÿæˆ¶è³‡æ–™éš”é›¢é©—è­‰

### éšæ®µäºŒï¼šå‰ç«¯å¤šç§Ÿæˆ¶æ”¯æ´ï¼ˆ1-2é€±ï¼‰

#### Week 4: å‰ç«¯æ”¹é€ 
- [ ] **Day 1-2**: æ›´æ–° `useApiClient` æ”¯æ´ç§Ÿæˆ¶è­˜åˆ¥
- [ ] **Day 3-4**: æ”¹é€ è·¯ç”±ç³»çµ±æ”¯æ´ç§Ÿæˆ¶
- [ ] **Day 5-7**: æ›´æ–°æ‰€æœ‰é é¢çµ„ä»¶

#### Week 5: ç§Ÿæˆ¶ç®¡ç†ç•Œé¢
- [ ] **Day 1-3**: å»ºç«‹ç§Ÿæˆ¶è¨­å®šé é¢
- [ ] **Day 4-5**: å¯¦ä½œç§Ÿæˆ¶åŠŸèƒ½é–‹é—œæ§åˆ¶
- [ ] **Day 6-7**: å»ºç«‹ç§Ÿæˆ¶ä½¿ç”¨çµ±è¨ˆå„€è¡¨æ¿

### éšæ®µä¸‰ï¼šè‡ªå‹•åŒ–å·¥å…·é–‹ç™¼ï¼ˆ1-2é€±ï¼‰

#### Week 6: éƒ¨ç½²è‡ªå‹•åŒ–
- [ ] **Day 1-3**: é–‹ç™¼æ–°ç§Ÿæˆ¶å»ºç«‹è…³æœ¬
- [ ] **Day 4-5**: å»ºç«‹ä¸€éµéƒ¨ç½²å·¥å…·
- [ ] **Day 6-7**: å¯¦ä½œè³‡æ–™åº«å‚™ä»½èˆ‡é‚„åŸ

#### Week 7: ç®¡ç†å·¥å…·
- [ ] **Day 1-3**: å»ºç«‹ç§Ÿæˆ¶ç®¡ç†å¾Œå°
- [ ] **Day 4-5**: å¯¦ä½œæ‰¹é‡æ“ä½œå·¥å…·
- [ ] **Day 6-7**: å»ºç«‹ç›£æ§å’Œè­¦å ±ç³»çµ±

### éšæ®µå››ï¼šæ¸¬è©¦èˆ‡å„ªåŒ–ï¼ˆ1é€±ï¼‰

#### Week 8: å…¨é¢æ¸¬è©¦
- [ ] **Day 1-2**: å¤šç§Ÿæˆ¶åŠŸèƒ½æ¸¬è©¦
- [ ] **Day 3-4**: æ•ˆèƒ½èˆ‡å®‰å…¨æ€§æ¸¬è©¦
- [ ] **Day 5-7**: æ–‡æª”æ’°å¯«èˆ‡éƒ¨ç½²æº–å‚™

---

## ğŸ—„ï¸ è³‡æ–™åº«åŒ¯å…¥åŒ¯å‡ºç³»çµ±

### 1. ç³»çµ±æ¶æ§‹

#### 1.1 è³‡æ–™çµæ§‹å®šç¾©
```typescript
interface DatabaseExportSchema {
  metadata: {
    exportVersion: string;           // åŒ¯å‡ºç‰ˆæœ¬
    tenantId: string;               // ç§Ÿæˆ¶ ID
    exportDate: string;             // åŒ¯å‡ºæ™‚é–“
    dataVersion: string;            // è³‡æ–™ç‰ˆæœ¬
    totalRecords: number;           // ç¸½è¨˜éŒ„æ•¸
    collections: string[];          // åŒ…å«çš„é›†åˆåˆ—è¡¨
    checksum: string;               // è³‡æ–™æ ¡é©—ç¢¼
  };
  collections: {
    [collectionName: string]: {
      schema: CollectionSchema;      // é›†åˆçµæ§‹å®šç¾©
      data: any[];                  // å¯¦éš›è³‡æ–™
      indexes: IndexDefinition[];    // ç´¢å¼•å®šç¾©
      rules: SecurityRule[];        // å®‰å…¨è¦å‰‡
    };
  };
  relationships: {
    [relationshipName: string]: RelationshipDefinition;
  };
  systemConfig: {
    firebaseRules: string;          // Firestore è¦å‰‡
    storageRules: string;          // Storage è¦å‰‡
    environmentVariables: Record<string, string>;
  };
}
```

#### 1.2 æ”¯æ´çš„è³‡æ–™æ ¼å¼
- **JSON**: å®Œæ•´çµæ§‹åŒ–è³‡æ–™
- **CSV**: å€‹åˆ¥é›†åˆè³‡æ–™
- **SQL**: é—œè¯å¼è³‡æ–™åº«å…¼å®¹æ ¼å¼
- **Firebase Backup**: åŸç”Ÿ Firebase å‚™ä»½æ ¼å¼

### 2. åŒ¯å‡ºç³»çµ±è¨­è¨ˆ

#### 2.1 æ™ºèƒ½åŒ¯å‡ºæœå‹™
```typescript
// functions/src/services/DatabaseExportService.ts
class DatabaseExportService {
  /**
   * å®Œæ•´è³‡æ–™åº«åŒ¯å‡º
   */
  async exportFullDatabase(tenantId: string, options: ExportOptions): Promise<DatabaseExportSchema> {
    const firestore = await this.getTenantFirestore(tenantId);
    const exportData: DatabaseExportSchema = {
      metadata: {
        exportVersion: '2.0',
        tenantId,
        exportDate: new Date().toISOString(),
        dataVersion: await this.getDataVersion(tenantId),
        totalRecords: 0,
        collections: [],
        checksum: ''
      },
      collections: {},
      relationships: {},
      systemConfig: {}
    };

    // åŒ¯å‡ºæ‰€æœ‰é›†åˆ
    const collections = await this.getCollectionList(firestore);
    for (const collectionName of collections) {
      if (options.includeCollections?.includes(collectionName) || !options.includeCollections) {
        exportData.collections[collectionName] = await this.exportCollection(
          firestore,
          collectionName,
          options
        );
      }
    }

    // è¨ˆç®—æ ¡é©—ç¢¼
    exportData.metadata.checksum = this.calculateChecksum(exportData);
    exportData.metadata.totalRecords = this.countTotalRecords(exportData);
    exportData.metadata.collections = Object.keys(exportData.collections);

    return exportData;
  }

  /**
   * å¢é‡åŒ¯å‡ºï¼ˆåƒ…åŒ¯å‡ºè®Šæ›´è³‡æ–™ï¼‰
   */
  async exportIncremental(
    tenantId: string,
    lastExportDate: Date,
    options: ExportOptions
  ): Promise<DatabaseExportSchema> {
    // å¯¦ä½œå¢é‡åŒ¯å‡ºé‚è¼¯
    const firestore = await this.getTenantFirestore(tenantId);

    // æŸ¥æ‰¾æ‰€æœ‰åœ¨ lastExportDate ä¹‹å¾Œä¿®æ”¹çš„æ–‡æª”
    const changedDocuments = await this.findChangedDocuments(firestore, lastExportDate);

    // æ§‹å»ºå¢é‡åŒ¯å‡ºè³‡æ–™
    return this.buildIncrementalExport(tenantId, changedDocuments, options);
  }

  /**
   * è‡ªå®šç¾©æŸ¥è©¢åŒ¯å‡º
   */
  async exportByQuery(
    tenantId: string,
    queries: CustomQuery[],
    options: ExportOptions
  ): Promise<DatabaseExportSchema> {
    const firestore = await this.getTenantFirestore(tenantId);
    const exportData: DatabaseExportSchema = this.initializeExportSchema(tenantId);

    for (const query of queries) {
      const results = await this.executeCustomQuery(firestore, query);
      exportData.collections[query.collectionName] = {
        schema: await this.getCollectionSchema(firestore, query.collectionName),
        data: results,
        indexes: await this.getCollectionIndexes(firestore, query.collectionName),
        rules: await this.getCollectionRules(firestore, query.collectionName)
      };
    }

    return exportData;
  }

  /**
   * åŒ¯å‡ºå–®ä¸€é›†åˆ
   */
  private async exportCollection(
    firestore: any,
    collectionName: string,
    options: ExportOptions
  ) {
    const collectionRef = firestore.collection(collectionName);
    let query = collectionRef;

    // æ‡‰ç”¨ç¯©é¸æ¢ä»¶
    if (options.filters) {
      query = this.applyFilters(query, options.filters);
    }

    // æ‡‰ç”¨æ’åº
    if (options.orderBy) {
      query = query.orderBy(options.orderBy.field, options.orderBy.direction);
    }

    // æ‡‰ç”¨æ•¸é‡é™åˆ¶
    if (options.limit) {
      query = query.limit(options.limit);
    }

    const snapshot = await query.get();
    const documents = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      _exportMetadata: {
        exportedAt: new Date().toISOString(),
        documentPath: doc.ref.path
      }
    }));

    return {
      schema: await this.getCollectionSchema(firestore, collectionName),
      data: documents,
      indexes: await this.getCollectionIndexes(firestore, collectionName),
      rules: await this.getCollectionRules(firestore, collectionName)
    };
  }
}
```

#### 2.2 åŒ¯å‡ºé¸é …é…ç½®
```typescript
interface ExportOptions {
  format: 'json' | 'csv' | 'sql' | 'firebase-backup';
  includeCollections?: string[];     // æŒ‡å®šè¦åŒ¯å‡ºçš„é›†åˆ
  excludeCollections?: string[];     // æŒ‡å®šè¦æ’é™¤çš„é›†åˆ
  includeSubcollections?: boolean;   // æ˜¯å¦åŒ…å«å­é›†åˆ
  includeMetadata?: boolean;         // æ˜¯å¦åŒ…å«å…ƒè³‡æ–™
  includeIndexes?: boolean;          // æ˜¯å¦åŒ…å«ç´¢å¼•å®šç¾©
  includeRules?: boolean;            // æ˜¯å¦åŒ…å«å®‰å…¨è¦å‰‡
  compression?: 'none' | 'gzip' | 'brotli';
  encryption?: {
    enabled: boolean;
    algorithm: string;
    key?: string;
  };
  filters?: {
    [collectionName: string]: FirestoreFilter[];
  };
  orderBy?: {
    field: string;
    direction: 'asc' | 'desc';
  };
  limit?: number;
  batchSize?: number;               // æ‰¹æ¬¡è™•ç†å¤§å°
  progressCallback?: (progress: ExportProgress) => void;
}
```

### 3. åŒ¯å…¥ç³»çµ±è¨­è¨ˆ

#### 3.1 æ™ºèƒ½åŒ¯å…¥æœå‹™
```typescript
// functions/src/services/DatabaseImportService.ts
class DatabaseImportService {
  /**
   * å®Œæ•´è³‡æ–™åº«åŒ¯å…¥
   */
  async importFullDatabase(
    tenantId: string,
    importData: DatabaseExportSchema,
    options: ImportOptions
  ): Promise<ImportResult> {
    const firestore = await this.getTenantFirestore(tenantId);
    const importResult: ImportResult = {
      success: false,
      totalRecords: 0,
      importedRecords: 0,
      errors: [],
      warnings: [],
      duration: 0,
      collections: {}
    };

    const startTime = Date.now();

    try {
      // é©—è­‰åŒ¯å…¥è³‡æ–™
      await this.validateImportData(importData);

      // æª¢æŸ¥è³‡æ–™åº«å…¼å®¹æ€§
      await this.checkCompatibility(tenantId, importData);

      // å‚™ä»½ç¾æœ‰è³‡æ–™ï¼ˆå¦‚æœéœ€è¦ï¼‰
      if (options.backupBeforeImport) {
        await this.createBackup(tenantId);
      }

      // é–‹å§‹æ‰¹æ¬¡åŒ¯å…¥
      for (const [collectionName, collectionData] of Object.entries(importData.collections)) {
        try {
          const result = await this.importCollection(
            firestore,
            collectionName,
            collectionData,
            options
          );

          importResult.collections[collectionName] = result;
          importResult.importedRecords += result.importedRecords;

          // å›å ±é€²åº¦
          if (options.progressCallback) {
            options.progressCallback({
              currentCollection: collectionName,
              totalCollections: Object.keys(importData.collections).length,
              currentProgress: importResult.importedRecords / importData.metadata.totalRecords
            });
          }
        } catch (error) {
          importResult.errors.push({
            collection: collectionName,
            error: error.message
          });
        }
      }

      // é‡å»ºç´¢å¼•
      if (options.rebuildIndexes) {
        await this.rebuildIndexes(firestore, importData);
      }

      // æ‡‰ç”¨å®‰å…¨è¦å‰‡
      if (options.applySecurityRules) {
        await this.applySecurityRules(tenantId, importData.systemConfig);
      }

      importResult.success = true;
      importResult.totalRecords = importData.metadata.totalRecords;
      importResult.duration = Date.now() - startTime;

    } catch (error) {
      importResult.errors.push({
        collection: 'SYSTEM',
        error: error.message
      });
    }

    return importResult;
  }

  /**
   * å¢é‡åŒ¯å…¥ï¼ˆåƒ…åŒ¯å…¥è®Šæ›´ï¼‰
   */
  async importIncremental(
    tenantId: string,
    incrementalData: DatabaseExportSchema,
    options: ImportOptions
  ): Promise<ImportResult> {
    const firestore = await this.getTenantFirestore(tenantId);

    // å¯¦ä½œå¢é‡åŒ¯å…¥é‚è¼¯
    return this.performIncrementalImport(firestore, incrementalData, options);
  }

  /**
   * è³‡æ–™é©—è­‰èˆ‡æ¸…ç†åŒ¯å…¥
   */
  async importWithValidation(
    tenantId: string,
    importData: DatabaseExportSchema,
    validationRules: ValidationRule[],
    options: ImportOptions
  ): Promise<ImportResult> {
    // å°æ¯ç­†è³‡æ–™é€²è¡Œé©—è­‰å’Œæ¸…ç†
    const cleanedData = await this.validateAndCleanData(importData, validationRules);

    // åŸ·è¡ŒåŒ¯å…¥
    return this.importFullDatabase(tenantId, cleanedData, options);
  }

  /**
   * åŒ¯å…¥å–®ä¸€é›†åˆ
   */
  private async importCollection(
    firestore: any,
    collectionName: string,
    collectionData: any,
    options: ImportOptions
  ): Promise<CollectionImportResult> {
    const batch = firestore.batch();
    const collectionRef = firestore.collection(collectionName);
    let batchCount = 0;
    const batchSize = options.batchSize || 500;

    const result: CollectionImportResult = {
      collectionName,
      totalRecords: collectionData.data.length,
      importedRecords: 0,
      skippedRecords: 0,
      errors: []
    };

    for (const document of collectionData.data) {
      try {
        const { id, _exportMetadata, ...data } = document;

        // è™•ç†åŒ¯å…¥ç­–ç•¥
        const docRef = id ? collectionRef.doc(id) : collectionRef.doc();

        switch (options.conflictResolution) {
          case 'overwrite':
            batch.set(docRef, data);
            break;
          case 'skip':
            const exists = await docRef.get();
            if (!exists.exists) {
              batch.set(docRef, data);
            } else {
              result.skippedRecords++;
              continue;
            }
            break;
          case 'merge':
            batch.set(docRef, data, { merge: true });
            break;
          case 'update':
            batch.update(docRef, data);
            break;
        }

        result.importedRecords++;
        batchCount++;

        // åŸ·è¡Œæ‰¹æ¬¡å¯«å…¥
        if (batchCount >= batchSize) {
          await batch.commit();
          batchCount = 0;
        }

      } catch (error) {
        result.errors.push({
          documentId: document.id,
          error: error.message
        });
      }
    }

    // åŸ·è¡Œå‰©é¤˜çš„æ‰¹æ¬¡
    if (batchCount > 0) {
      await batch.commit();
    }

    return result;
  }
}
```

### 4. ä¸€éµæ“ä½œå·¥å…·

#### 4.1 å‘½ä»¤åˆ—å·¥å…·
```bash
# scripts/database-tools.bat
@echo off
echo ==========================================
echo     å¾·ç§‘æ–¯ç‰¹å¯¦é©—å®¤ - è³‡æ–™åº«ç®¡ç†å·¥å…·
echo ==========================================
echo.
echo é¸æ“‡æ“ä½œï¼š
echo [1] å®Œæ•´åŒ¯å‡ºè³‡æ–™åº«
echo [2] å¢é‡åŒ¯å‡ºè³‡æ–™åº«
echo [3] åŒ¯å‡ºæŒ‡å®šé›†åˆ
echo [4] åŒ¯å…¥è³‡æ–™åº«
echo [5] é©—è­‰è³‡æ–™å®Œæ•´æ€§
echo [6] å»ºç«‹å‚™ä»½
echo [7] é‚„åŸå‚™ä»½
echo [0] é›¢é–‹
echo.
set /p choice=è«‹é¸æ“‡æ“ä½œ (0-7):

if "%choice%"=="1" goto export_full
if "%choice%"=="2" goto export_incremental
if "%choice%"=="3" goto export_collections
if "%choice%"=="4" goto import_database
if "%choice%"=="5" goto validate_data
if "%choice%"=="6" goto create_backup
if "%choice%"=="7" goto restore_backup
if "%choice%"=="0" goto exit
goto menu

:export_full
echo æ­£åœ¨åŸ·è¡Œå®Œæ•´è³‡æ–™åº«åŒ¯å‡º...
node scripts/database-export.js --type=full --tenant=%TENANT_ID%
goto menu

:export_incremental
set /p last_date=è¼¸å…¥ä¸Šæ¬¡åŒ¯å‡ºæ—¥æœŸ (YYYY-MM-DD):
echo æ­£åœ¨åŸ·è¡Œå¢é‡åŒ¯å‡º...
node scripts/database-export.js --type=incremental --since=%last_date% --tenant=%TENANT_ID%
goto menu

:export_collections
set /p collections=è¼¸å…¥è¦åŒ¯å‡ºçš„é›†åˆåç¨± (ç”¨é€—è™Ÿåˆ†éš”):
echo æ­£åœ¨åŒ¯å‡ºæŒ‡å®šé›†åˆ...
node scripts/database-export.js --type=collections --include=%collections% --tenant=%TENANT_ID%
goto menu

:import_database
set /p import_file=è¼¸å…¥åŒ¯å…¥æª”æ¡ˆè·¯å¾‘:
echo æ­£åœ¨åŒ¯å…¥è³‡æ–™åº«...
node scripts/database-import.js --file=%import_file% --tenant=%TENANT_ID%
goto menu

:validate_data
echo æ­£åœ¨é©—è­‰è³‡æ–™å®Œæ•´æ€§...
node scripts/database-validate.js --tenant=%TENANT_ID%
goto menu

:create_backup
echo æ­£åœ¨å»ºç«‹å‚™ä»½...
node scripts/database-backup.js --tenant=%TENANT_ID%
goto menu

:restore_backup
set /p backup_file=è¼¸å…¥å‚™ä»½æª”æ¡ˆè·¯å¾‘:
echo æ­£åœ¨é‚„åŸå‚™ä»½...
node scripts/database-restore.js --file=%backup_file% --tenant=%TENANT_ID%
goto menu

:exit
echo æ„Ÿè¬ä½¿ç”¨ï¼
pause
```

#### 4.2 Web æ“ä½œç•Œé¢
```typescript
// src/app/admin/database/page.tsx
export default function DatabaseManagementPage() {
  const [exportProgress, setExportProgress] = useState(0);
  const [importProgress, setImportProgress] = useState(0);

  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold mb-8">è³‡æ–™åº«ç®¡ç†</h1>

      {/* åŒ¯å‡ºå€åŸŸ */}
      <Card className="mb-8">
        <CardHeader>
          <CardTitle>è³‡æ–™åŒ¯å‡º</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <Button
              onClick={() => handleExport('full')}
              className="w-full"
            >
              å®Œæ•´åŒ¯å‡º
            </Button>
            <Button
              onClick={() => handleExport('incremental')}
              variant="outline"
              className="w-full"
            >
              å¢é‡åŒ¯å‡º
            </Button>
            <Button
              onClick={() => handleExport('custom')}
              variant="outline"
              className="w-full"
            >
              è‡ªå®šç¾©åŒ¯å‡º
            </Button>
          </div>

          {exportProgress > 0 && (
            <div className="mt-4">
              <Progress value={exportProgress} className="w-full" />
              <p className="text-sm text-gray-600 mt-2">
                åŒ¯å‡ºé€²åº¦: {exportProgress}%
              </p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* åŒ¯å…¥å€åŸŸ */}
      <Card className="mb-8">
        <CardHeader>
          <CardTitle>è³‡æ–™åŒ¯å…¥</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
              <input
                type="file"
                accept=".json,.csv,.sql"
                onChange={handleFileSelect}
                className="hidden"
                id="import-file"
              />
              <label htmlFor="import-file" className="cursor-pointer">
                <div className="space-y-2">
                  <Upload className="h-12 w-12 text-gray-400 mx-auto" />
                  <p className="text-lg font-medium">é¸æ“‡åŒ¯å…¥æª”æ¡ˆ</p>
                  <p className="text-sm text-gray-600">
                    æ”¯æ´ JSONã€CSVã€SQL æ ¼å¼
                  </p>
                </div>
              </label>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-2">
                  è¡çªè™•ç†æ–¹å¼
                </label>
                <Select defaultValue="merge">
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="overwrite">è¦†è“‹ç¾æœ‰è³‡æ–™</SelectItem>
                    <SelectItem value="skip">è·³éé‡è¤‡è³‡æ–™</SelectItem>
                    <SelectItem value="merge">åˆä½µè³‡æ–™</SelectItem>
                    <SelectItem value="update">åƒ…æ›´æ–°ç¾æœ‰</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="flex items-center space-x-2">
                <Checkbox id="backup-before-import" />
                <label htmlFor="backup-before-import" className="text-sm">
                  åŒ¯å…¥å‰å…ˆå‚™ä»½
                </label>
              </div>
            </div>

            <Button
              onClick={handleImport}
              className="w-full"
              disabled={!selectedFile}
            >
              é–‹å§‹åŒ¯å…¥
            </Button>
          </div>

          {importProgress > 0 && (
            <div className="mt-4">
              <Progress value={importProgress} className="w-full" />
              <p className="text-sm text-gray-600 mt-2">
                åŒ¯å…¥é€²åº¦: {importProgress}%
              </p>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}
```

### 5. è‡ªå‹•åŒ–å‚™ä»½ç³»çµ±

#### 5.1 æ’ç¨‹å‚™ä»½æœå‹™
```typescript
// functions/src/services/ScheduledBackupService.ts
export const scheduledBackup = functions.pubsub.schedule('0 2 * * *') // æ¯å¤©å‡Œæ™¨2é»
  .timeZone('Asia/Taipei')
  .onRun(async (context) => {
    const tenants = await getAllActiveTenants();

    for (const tenant of tenants) {
      try {
        const backupData = await databaseExportService.exportFullDatabase(
          tenant.id,
          {
            format: 'json',
            compression: 'gzip',
            includeMetadata: true,
            includeIndexes: true
          }
        );

        // å„²å­˜åˆ° Cloud Storage
        await saveBackupToStorage(tenant.id, backupData);

        // æ¸…ç†èˆŠå‚™ä»½ï¼ˆä¿ç•™30å¤©ï¼‰
        await cleanupOldBackups(tenant.id, 30);

      } catch (error) {
        console.error(`Backup failed for tenant ${tenant.id}:`, error);

        // ç™¼é€è­¦å ±é€šçŸ¥
        await sendBackupFailureAlert(tenant.id, error.message);
      }
    }
  });
```

---

## âš ï¸ æ½›åœ¨å›°é›£èˆ‡è§£æ±ºæ–¹æ¡ˆ

### 1. æŠ€è¡“æŒ‘æˆ°

#### 1.1 Firebase å¤šå¯¦ä¾‹ç®¡ç†
**å›°é›£é»**ï¼š
- Firebase SDK ä¸ç›´æ¥æ”¯æ´åŒæ™‚é€£æ¥å¤šå€‹å°ˆæ¡ˆ
- å¯¦ä¾‹åˆå§‹åŒ–å’Œæ¸…ç†çš„è¨˜æ†¶é«”ç®¡ç†
- é€£æ¥æ± ç®¡ç†å’Œæ•ˆèƒ½å„ªåŒ–

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```typescript
// å¯¦ä½œé€£æ¥æ± ç®¡ç†
class FirebaseConnectionPool {
  private connections: Map<string, FirebaseConnection> = new Map();
  private maxConnections = 50;
  private connectionTimeout = 300000; // 5åˆ†é˜

  async getConnection(tenantId: string): Promise<FirebaseConnection> {
    // æª¢æŸ¥ç¾æœ‰é€£æ¥
    if (this.connections.has(tenantId)) {
      const connection = this.connections.get(tenantId)!;
      if (!connection.isExpired()) {
        return connection.refresh();
      }
    }

    // å»ºç«‹æ–°é€£æ¥
    if (this.connections.size >= this.maxConnections) {
      this.cleanup();
    }

    const connection = await this.createConnection(tenantId);
    this.connections.set(tenantId, connection);

    return connection;
  }

  private cleanup() {
    // æ¸…ç†éæœŸé€£æ¥
    for (const [tenantId, connection] of this.connections.entries()) {
      if (connection.isExpired()) {
        connection.close();
        this.connections.delete(tenantId);
      }
    }
  }
}
```

#### 1.2 è³‡æ–™åº«è·¨ç§Ÿæˆ¶æŸ¥è©¢
**å›°é›£é»**ï¼š
- æ„å¤–çš„è·¨ç§Ÿæˆ¶è³‡æ–™æ´©æ¼
- æŸ¥è©¢æ•ˆèƒ½å„ªåŒ–
- è³‡æ–™ä¸€è‡´æ€§ä¿è­‰

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```typescript
// å¯¦ä½œå®‰å…¨æŸ¥è©¢åŒ…è£å™¨
class SecureQueryWrapper {
  constructor(private tenantId: string, private firestore: any) {}

  collection(path: string) {
    // è‡ªå‹•æ·»åŠ ç§Ÿæˆ¶å‰ç¶´æˆ–é©—è­‰
    const securePath = this.validateAndSecurePath(path);
    return new SecureCollectionReference(this.tenantId, this.firestore.collection(securePath));
  }

  private validateAndSecurePath(path: string): string {
    // é©—è­‰è·¯å¾‘ä¸åŒ…å«å…¶ä»–ç§Ÿæˆ¶è³‡æ–™
    if (path.includes('..') || path.includes('/tenant/')) {
      throw new Error('Unauthorized path access detected');
    }

    // ç¢ºä¿æ‰€æœ‰æŸ¥è©¢éƒ½é™åˆ¶åœ¨ç•¶å‰ç§Ÿæˆ¶
    return `tenants/${this.tenantId}/data/${path}`;
  }
}
```

### 2. éƒ¨ç½²èˆ‡ç¶­è­·æŒ‘æˆ°

#### 2.1 ç’°å¢ƒè®Šæ•¸ç®¡ç†è¤‡é›œæ€§
**å›°é›£é»**ï¼š
- å¤§é‡ç§Ÿæˆ¶çš„ç’°å¢ƒè®Šæ•¸ç®¡ç†
- æ•æ„Ÿè³‡è¨Šå®‰å…¨å„²å­˜
- é…ç½®æ›´æ–°çš„ä¸€è‡´æ€§

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```typescript
// å¯¦ä½œåŠ å¯†é…ç½®ç®¡ç†ç³»çµ±
class EncryptedConfigManager {
  private encryptionKey: string;

  async storeTenantConfig(tenantId: string, config: TenantConfig) {
    // åŠ å¯†æ•æ„Ÿè³‡è¨Š
    const encryptedConfig = await this.encrypt(JSON.stringify(config));

    // å„²å­˜åˆ°å®‰å…¨çš„é…ç½®æœå‹™
    await this.configStorage.set(`tenant:${tenantId}`, encryptedConfig);
  }

  async getTenantConfig(tenantId: string): Promise<TenantConfig> {
    const encryptedConfig = await this.configStorage.get(`tenant:${tenantId}`);
    const decryptedConfig = await this.decrypt(encryptedConfig);

    return JSON.parse(decryptedConfig);
  }

  private async encrypt(data: string): Promise<string> {
    // ä½¿ç”¨ AES-256 åŠ å¯†
    const cipher = crypto.createCipher('aes-256-cbc', this.encryptionKey);
    let encrypted = cipher.update(data, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    return encrypted;
  }
}
```

#### 2.2 è³‡æ–™é·ç§»å’Œç‰ˆæœ¬å…¼å®¹æ€§
**å›°é›£é»**ï¼š
- ä¸åŒç‰ˆæœ¬é–“çš„è³‡æ–™çµæ§‹è®ŠåŒ–
- å¤§é‡è³‡æ–™çš„é·ç§»æ•ˆèƒ½
- é·ç§»å¤±æ•—çš„å›æ»¾æ©Ÿåˆ¶

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```typescript
// å¯¦ä½œç‰ˆæœ¬åŒ–é·ç§»ç³»çµ±
class DatabaseMigrationManager {
  private migrations: Migration[] = [];

  async runMigrations(tenantId: string, targetVersion: string) {
    const currentVersion = await this.getCurrentVersion(tenantId);
    const requiredMigrations = this.getMigrationsForVersion(currentVersion, targetVersion);

    // å»ºç«‹å‚™ä»½é»
    const backupId = await this.createMigrationBackup(tenantId);

    try {
      for (const migration of requiredMigrations) {
        await this.runMigration(tenantId, migration);
        await this.updateVersion(tenantId, migration.version);
      }
    } catch (error) {
      // å›æ»¾åˆ°å‚™ä»½é»
      await this.rollbackToBackup(tenantId, backupId);
      throw new Error(`Migration failed: ${error.message}`);
    }
  }

  private async runMigration(tenantId: string, migration: Migration) {
    const firestore = await this.getTenantFirestore(tenantId);

    // åˆ†æ‰¹è™•ç†å¤§é‡è³‡æ–™
    const batchSize = 1000;
    let processedCount = 0;

    while (true) {
      const batch = await this.getNextBatch(firestore, migration, batchSize, processedCount);
      if (batch.length === 0) break;

      await migration.process(batch);
      processedCount += batch.length;

      // å ±å‘Šé€²åº¦
      await this.reportProgress(tenantId, migration.version, processedCount);
    }
  }
}
```

### 3. å®‰å…¨æ€§æŒ‘æˆ°

#### 3.1 ç§Ÿæˆ¶è³‡æ–™éš”é›¢
**å›°é›£é»**ï¼š
- ç¢ºä¿ç§Ÿæˆ¶é–“è³‡æ–™å®Œå…¨éš”é›¢
- é˜²æ­¢æ¬Šé™æå‡æ”»æ“Š
- å¯©è¨ˆè¿½è¹¤å’Œç›£æ§

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```typescript
// å¯¦ä½œå¤šå±¤å®‰å…¨é©—è­‰
class TenantSecurityManager {
  async validateTenantAccess(userId: string, tenantId: string): Promise<boolean> {
    // ç¬¬ä¸€å±¤ï¼šç”¨æˆ¶ç§Ÿæˆ¶é—œè¯é©—è­‰
    const userTenants = await this.getUserTenants(userId);
    if (!userTenants.includes(tenantId)) {
      await this.logSecurityEvent('UNAUTHORIZED_TENANT_ACCESS', { userId, tenantId });
      return false;
    }

    // ç¬¬äºŒå±¤ï¼šç§Ÿæˆ¶ç‹€æ…‹é©—è­‰
    const tenantStatus = await this.getTenantStatus(tenantId);
    if (tenantStatus !== 'active') {
      await this.logSecurityEvent('INACTIVE_TENANT_ACCESS', { userId, tenantId });
      return false;
    }

    // ç¬¬ä¸‰å±¤ï¼šè«‹æ±‚é »ç‡é™åˆ¶
    const rateLimitOk = await this.checkRateLimit(userId, tenantId);
    if (!rateLimitOk) {
      await this.logSecurityEvent('RATE_LIMIT_EXCEEDED', { userId, tenantId });
      return false;
    }

    return true;
  }

  private async logSecurityEvent(eventType: string, details: any) {
    await this.auditLogger.log({
      timestamp: new Date().toISOString(),
      eventType,
      details,
      severity: 'WARNING'
    });
  }
}
```

### 4. æ•ˆèƒ½æŒ‘æˆ°

#### 4.1 å¤§é‡ç§Ÿæˆ¶çš„æ•ˆèƒ½å„ªåŒ–
**å›°é›£é»**ï¼š
- å†·å•Ÿå‹•å»¶é²å•é¡Œ
- è¨˜æ†¶é«”ä½¿ç”¨å„ªåŒ–
- è³‡æ–™åº«é€£æ¥æ± ç®¡ç†

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```typescript
// å¯¦ä½œæ™ºèƒ½é ç†±ç³»çµ±
class TenantPrewarmService {
  private prewarmedTenants: Set<string> = new Set();
  private prewarmScheduler: NodeJS.Timeout | null = null;

  async prewarmFrequentTenants() {
    // åˆ†æä½¿ç”¨é »ç‡
    const frequentTenants = await this.getFrequentlyAccessedTenants();

    for (const tenantId of frequentTenants) {
      if (!this.prewarmedTenants.has(tenantId)) {
        await this.prewarmTenant(tenantId);
        this.prewarmedTenants.add(tenantId);
      }
    }
  }

  private async prewarmTenant(tenantId: string) {
    // é å…ˆå»ºç«‹ Firebase é€£æ¥
    await multiTenantFirebase.getTenantFirebaseInstance(tenantId);

    // é è¼‰å…¥å¸¸ç”¨è³‡æ–™
    await this.preloadCommonData(tenantId);
  }

  startPrewarmScheduler() {
    this.prewarmScheduler = setInterval(() => {
      this.prewarmFrequentTenants();
    }, 300000); // æ¯5åˆ†é˜åŸ·è¡Œä¸€æ¬¡
  }
}
```

---

## ğŸ’° æˆæœ¬æ•ˆç›Šåˆ†æ

### 1. é–‹ç™¼æˆæœ¬å°æ¯”

| é …ç›® | å¤šç§Ÿæˆ¶æ¶æ§‹ | ç¨ç«‹éƒ¨ç½² | ç¯€çœæ¯”ä¾‹ |
|------|----------|----------|----------|
| åˆæœŸé–‹ç™¼ | 6-8é€± | 2-3é€± | -67% |
| é•·æœŸç¶­è­· | 1äººé€±/æœˆ | 5äººé€±/æœˆ | 80% |
| åŠŸèƒ½æ›´æ–° | 1æ¬¡éƒ¨ç½² | Næ¬¡éƒ¨ç½² | 90% |
| bugä¿®å¾© | çµ±ä¸€ä¿®å¾© | é€ä¸€ä¿®å¾© | 95% |
| æœå‹™å™¨æˆæœ¬ | å…±ç”¨è³‡æº | ç¨ç«‹è³‡æº | 70% |

### 2. æŠ•è³‡å ±é…¬ç‡è¨ˆç®—

**ç¬¬ä¸€å¹´**ï¼š
- é–‹ç™¼æˆæœ¬ï¼šè¼ƒé«˜ï¼ˆå¤šç§Ÿæˆ¶æ¶æ§‹å»ºè¨­ï¼‰
- ç¶­è­·æˆæœ¬ï¼šé–‹å§‹é¡¯ç¾ç¯€çœæ•ˆæœ
- ROIï¼š-20%ï¼ˆæŠ•è³‡æœŸï¼‰

**ç¬¬äºŒå¹´èµ·**ï¼š
- é–‹ç™¼æˆæœ¬ï¼šåŸºæœ¬ç‚ºé›¶
- ç¶­è­·æˆæœ¬ï¼šå¤§å¹…é™ä½
- ROIï¼š300%+ï¼ˆå¿«é€Ÿå›æ”¶æœŸï¼‰

**é•·æœŸæ•ˆç›Š**ï¼ˆ3å¹´ä»¥ä¸Šï¼‰ï¼š
- æ¯æ–°å¢ä¸€å€‹ç§Ÿæˆ¶çš„é‚Šéš›æˆæœ¬è¶¨è¿‘æ–¼é›¶
- ç³»çµ±ç©©å®šæ€§å’ŒåŠŸèƒ½å®Œæ•´æ€§æŒçºŒæå‡
- ROIï¼š1000%+ï¼ˆæˆç†ŸæœŸï¼‰

### 3. é¢¨éšªè©•ä¼°

| é¢¨éšªé¡å‹ | æ©Ÿç‡ | å½±éŸ¿ç¨‹åº¦ | ç·©è§£æªæ–½ |
|---------|------|----------|----------|
| æŠ€è¡“å¯¦æ–½è¤‡é›œæ€§ | ä¸­ç­‰ | é«˜ | åˆ†éšæ®µå¯¦æ–½ã€å……åˆ†æ¸¬è©¦ |
| è³‡æ–™éš”é›¢å¤±æ•ˆ | ä½ | æ¥µé«˜ | å¤šå±¤å®‰å…¨é©—è­‰ã€å¯©è¨ˆè¿½è¹¤ |
| æ•ˆèƒ½ç“¶é ¸ | ä¸­ç­‰ | ä¸­ç­‰ | é ç†±ç³»çµ±ã€ç›£æ§å„ªåŒ– |
| ç§Ÿæˆ¶éœ€æ±‚å·®ç•° | é«˜ | ä¸­ç­‰ | å¯é…ç½®æ¶æ§‹ã€åŠŸèƒ½é–‹é—œ |

---

## ğŸ“ˆ å¯¦æ–½å¾Œé æœŸæ•ˆæœ

### 1. çŸ­æœŸæ•ˆæœï¼ˆ3-6å€‹æœˆï¼‰
- âœ… æ–°ç§Ÿæˆ¶å»ºç«‹æ™‚é–“å¾æ•¸å¤©ç¸®çŸ­è‡³30åˆ†é˜
- âœ… åŠŸèƒ½æ›´æ–°åŒæ­¥ç‡é”åˆ°100%
- âœ… ç¶­è­·äººåŠ›éœ€æ±‚æ¸›å°‘50%
- âœ… ç³»çµ±ç©©å®šæ€§æå‡30%

### 2. ä¸­æœŸæ•ˆæœï¼ˆ6-12å€‹æœˆï¼‰
- âœ… æ”¯æ´ç§Ÿæˆ¶æ•¸é‡å¢åŠ åˆ°50+
- âœ… å¹³å‡éŸ¿æ‡‰æ™‚é–“æ”¹å–„40%
- âœ… éŒ¯èª¤ç‡é™ä½60%
- âœ… å®¢æˆ¶æ»¿æ„åº¦æå‡80%

### 3. é•·æœŸæ•ˆæœï¼ˆ1å¹´ä»¥ä¸Šï¼‰
- âœ… å…·å‚™æ”¯æ´1000+ç§Ÿæˆ¶çš„æ“´å±•èƒ½åŠ›
- âœ… ç¶­è­·æˆæœ¬é™ä½80%
- âœ… æ–°åŠŸèƒ½é–‹ç™¼é€Ÿåº¦æå‡200%
- âœ… å»ºç«‹å®Œæ•´çš„ SaaS ç”¢å“ç”Ÿæ…‹ç³»çµ±

---

## ğŸ¯ çµè«–èˆ‡å»ºè­°

### æ ¸å¿ƒå»ºè­°
1. **å„ªå…ˆæ¡ç”¨å¤šç§Ÿæˆ¶æ¶æ§‹**ï¼šåŸºæ–¼æˆæœ¬æ•ˆç›Šå’Œé•·æœŸç¶­è­·è€ƒé‡
2. **åˆ†éšæ®µå¯¦æ–½**ï¼šé™ä½æŠ€è¡“é¢¨éšªï¼Œç¢ºä¿ç³»çµ±ç©©å®šæ€§
3. **é‡è¦–å®‰å…¨æ€§**ï¼šå¯¦ä½œå¤šå±¤è³‡æ–™éš”é›¢å’Œå®‰å…¨é©—è­‰æ©Ÿåˆ¶
4. **å»ºç«‹å®Œå–„çš„ç›£æ§é«”ç³»**ï¼šç¢ºä¿ç³»çµ±å¥åº·å’Œæ•ˆèƒ½å„ªåŒ–
5. **æº–å‚™å……åˆ†çš„æ–‡æª”å’ŒåŸ¹è¨“**ï¼šä¿è­‰åœ˜éšŠèƒ½åŠ›èˆ‡ç³»çµ±è¤‡é›œåº¦åŒ¹é…

### æˆåŠŸé—œéµå› ç´ 
- **åœ˜éšŠæŠ€è¡“èƒ½åŠ›**ï¼šéœ€è¦å…·å‚™ Firebaseã€Node.jsã€TypeScript æ·±åº¦ç¶“é©—
- **æ¸¬è©¦è¦†è“‹ç‡**ï¼šå¤šç§Ÿæˆ¶ç³»çµ±éœ€è¦æ›´å…¨é¢çš„æ¸¬è©¦ç­–ç•¥
- **ç›£æ§å’Œé‹ç¶­**ï¼šå»ºç«‹å®Œæ•´çš„ç›£æ§ã€è­¦å ±å’Œæ•…éšœè™•ç†æ©Ÿåˆ¶
- **å®‰å…¨æ„è­˜**ï¼šå°‡è³‡æ–™éš”é›¢å’Œå®‰å…¨æ€§æ”¾åœ¨é¦–ä½

### é¢¨éšªæ§åˆ¶æªæ–½
- **æ¼¸é€²å¼é·ç§»**ï¼šå…ˆé¸æ“‡1-2å€‹æ¸¬è©¦ç§Ÿæˆ¶é€²è¡Œé©—è­‰
- **å‚™ä»½ç­–ç•¥**ï¼šæ‰€æœ‰æ“ä½œå‰å…ˆå»ºç«‹å®Œæ•´å‚™ä»½
- **å›æ»¾è¨ˆåŠƒ**ï¼šæº–å‚™å¿«é€Ÿå›æ»¾åˆ°åŸæœ‰æ¶æ§‹çš„æ‡‰æ€¥æ–¹æ¡ˆ
- **å°ˆæ¥­è«®è©¢**ï¼šå¿…è¦æ™‚å¼•å…¥ Firebase å°ˆæ¥­é¡§å•

---

**ğŸ“ æ–‡æª”ç¶­è­·**
æœ¬æ–‡æª”éœ€è¦éš¨è‘—å¯¦æ–½é€²åº¦æŒçºŒæ›´æ–°ï¼ŒåŒ…æ‹¬å¯¦éš›é‡åˆ°çš„å•é¡Œã€è§£æ±ºæ–¹æ¡ˆå’Œç¶“é©—ç¸½çµã€‚å»ºè­°æ¯å€‹å¯¦æ–½éšæ®µçµæŸå¾Œé€²è¡Œä¸€æ¬¡å…¨é¢æª¢è¦–å’Œæ›´æ–°ã€‚

**ğŸ”— ç›¸é—œè³‡æº**
- [Firebase å¤šå°ˆæ¡ˆç®¡ç†æœ€ä½³å¯¦è¸](https://firebase.google.com/docs/projects/multiprojects)
- [Node.js è¨˜æ†¶é«”ç®¡ç†å„ªåŒ–](https://nodejs.org/en/docs/guides/simple-profiling/)
- [TypeScript é¡å‹å®‰å…¨å¯¦è¸](https://www.typescriptlang.org/docs/)

---
*æœ€å¾Œæ›´æ–°ï¼š2025-09-16*